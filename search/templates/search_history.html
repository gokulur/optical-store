{% extends 'base.html' %}
{% load static %}
{% block title %}Search History - Al Ameen Optics{% endblock %}

{% block content %}
<style>
.breadcrumb__list{display:flex;gap:6px;list-style:none;margin:0;padding:0}
.breadcrumb__link{color:#666;text-decoration:none;font-size:.85rem}
.breadcrumb__separator{color:#ccc}
.breadcrumb__item--current .breadcrumb__link{color:#1a1a1a;font-weight:600}

/* ── Page Header ── */
.sh-page-header{display:flex;align-items:center;justify-content:space-between;
    margin-bottom:40px;flex-wrap:wrap;gap:16px}
.sh-page-header h1{font-size:3.2rem;font-weight:500;color:#1a1a1a;margin:0}
.btn-clear-hist{display:inline-flex;align-items:center;gap:8px;
    background:transparent;border:1.5px solid #e0e0e0;color:#888;
    padding:10px 20px;border-radius:8px;font-size:.8rem;font-weight:700;
    text-transform:uppercase;letter-spacing:.06em;cursor:pointer;transition:all .25s}
.btn-clear-hist:hover{border-color:#ff3b30;color:#ff3b30}

/* ── History List ── */
.history-list{display:flex;flex-direction:column;gap:0}
.history-item{display:flex;align-items:center;justify-content:space-between;gap:16px;
    padding:16px 22px;background:#fff;border-bottom:1px solid #f5f5f5;
    transition:background .2s;gap:16px}
.history-item:first-child{border-radius:12px 12px 0 0}
.history-item:last-child{border-radius:0 0 12px 12px;border-bottom:none}
.history-item:hover{background:#fafafa}

.history-item-left{display:flex;align-items:center;gap:14px;flex:1;min-width:0}
.hist-icon{width:36px;height:36px;border-radius:8px;background:#f5f5f5;
    display:flex;align-items:center;justify-content:center;flex-shrink:0}
.hist-icon svg{color:#999}
.hist-query{font-size:.95rem;font-weight:600;color:#1a1a1a;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.hist-query a{color:inherit;text-decoration:none}
.hist-query a:hover{color:#667eea}
.hist-meta{font-size:.75rem;color:#bbb;margin-top:2px;display:flex;align-items:center;gap:8px}
.hist-meta-dot{color:#ddd}

.history-item-right{display:flex;align-items:center;gap:10px;flex-shrink:0}
.hist-results-badge{background:#f5f5f5;color:#888;padding:3px 10px;border-radius:20px;
    font-size:.72rem;font-weight:600}
.btn-search-again{display:inline-flex;align-items:center;gap:6px;background:#1a1a1a;
    color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:.76rem;
    font-weight:700;text-decoration:none;transition:all .25s;white-space:nowrap}
.btn-search-again:hover{background:#333;color:#fff}

/* ── Wrapped Card ── */
.history-wrap{background:#fff;border-radius:12px;overflow:hidden;
    box-shadow:0 2px 12px rgba(0,0,0,.07)}

/* ── Empty State ── */
.sh-empty{text-align:center;padding:70px 30px}
.sh-empty svg{margin-bottom:18px}
.sh-empty h3{font-size:1.3rem;font-weight:600;color:#888;margin-bottom:8px}
.sh-empty p{color:#bbb;margin-bottom:24px}
.btn-start-search{display:inline-block;background:#1a1a1a;color:#fff;padding:13px 32px;
    border-radius:30px;font-size:.88rem;font-weight:700;text-decoration:none;
    text-transform:uppercase;letter-spacing:.06em;transition:all .3s}
.btn-start-search:hover{background:#333;color:#fff;transform:translateY(-2px)}

/* ── Confirm Toast ── */
.sh-toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(80px);
    background:#1a1a1a;color:#fff;padding:12px 24px;border-radius:40px;
    font-size:.85rem;font-weight:600;z-index:9999;
    transition:transform .35s cubic-bezier(.34,1.56,.64,1);
    display:flex;align-items:center;gap:9px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
.sh-toast.show{transform:translateX(-50%) translateY(0)}
.sh-toast-del{color:#ff5858}

/* confirm dialog */
.confirm-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);
    z-index:999;align-items:center;justify-content:center;backdrop-filter:blur(2px)}
.confirm-modal.open{display:flex}
.confirm-box{background:#fff;border-radius:14px;padding:32px;max-width:360px;width:90%;
    text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.2)}
.confirm-box h3{font-size:1.2rem;font-weight:700;margin-bottom:10px}
.confirm-box p{color:#888;font-size:.9rem;margin-bottom:24px}
.confirm-btns{display:flex;gap:10px;justify-content:center}
.btn-cancel-modal{flex:1;padding:12px;border:1.5px solid #e0e0e0;border-radius:8px;
    background:#fff;color:#888;font-size:.85rem;font-weight:600;cursor:pointer;transition:all .25s}
.btn-cancel-modal:hover{border-color:#1a1a1a;color:#1a1a1a}
.btn-confirm-modal{flex:1;padding:12px;border:none;border-radius:8px;background:#ff3b30;
    color:#fff;font-size:.85rem;font-weight:700;cursor:pointer;transition:background .25s}
.btn-confirm-modal:hover{background:#e02e24}

@media(max-width:580px){
    .sh-page-header h1{font-size:2rem}
    .history-item-right .btn-search-again{display:none}
    .hist-results-badge{display:none}
}
</style>

<!-- Breadcrumb -->
<div class="xo-section color-background-1" style="--margin:0;--pt:15;--pb:15;">
    <xo-container class="xo-container--box">
        <nav aria-label="breadcrumb" class="breadcrumb" role="navigation">
            <ol class="breadcrumb__list" style="--justify:flex-start">
                <li class="breadcrumb__item">
                    <a class="breadcrumb__link" href="{% url 'home' %}">Home</a>
                    <span class="breadcrumb__separator">/</span>
                </li>
                <li class="breadcrumb__item breadcrumb__item--current">
                    <a aria-current="page" class="breadcrumb__link">Search History</a>
                </li>
            </ol>
        </nav>
    </xo-container>
</div>

<!-- Content -->
<div class="xo-section color-background-1" style="--margin:0;--pt:50;--pb:80;background:#f8f9fa;">
    <xo-container class="xo-container--box">

        <div class="sh-page-header">
            <h1 class="product-v1__title" style="font-size:3.2rem;font-weight:500;margin:0;">Search History</h1>
            {% if searches %}
            <button class="btn-clear-hist" onclick="showConfirm()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/>
                    <path d="M10 11v6M14 11v6M9 6V4a1 1 0 011-1h4a1 1 0 011 1v2"/>
                </svg>
                Clear History
            </button>
            {% endif %}
        </div>

        {% if searches %}
        <div class="history-wrap">
            <div class="history-list">
                {% for search in searches %}
                <div class="history-item">
                    <div class="history-item-left">
                        <div class="hist-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
                            </svg>
                        </div>
                        <div>
                            <div class="hist-query">
                                <a href="{% url 'search:search' %}?q={{ search.query }}">{{ search.query }}</a>
                            </div>
                            <div class="hist-meta">
                                <span>{{ search.created_at|date:"d M Y" }}</span>
                                <span class="hist-meta-dot">·</span>
                                <span>{{ search.created_at|date:"H:i" }}</span>
                                {% if search.filters_applied %}
                                <span class="hist-meta-dot">·</span>
                                <span>Filtered</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="history-item-right">
                        <span class="hist-results-badge">{{ search.results_count }} result{{ search.results_count|pluralize }}</span>
                        <a href="{% url 'search:search' %}?q={{ search.query }}" class="btn-search-again">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                            Search Again
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        {% else %}
        <div class="history-wrap">
            <div class="sh-empty">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ddd" stroke-width="1.2">
                    <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
                    <path d="M11 8v3l2 2"/>
                </svg>
                <h3>No Search History</h3>
                <p>Your past searches will appear here</p>
                <a href="{% url 'search:search' %}" class="btn-start-search">Start Searching</a>
            </div>
        </div>
        {% endif %}

    </xo-container>
</div>

<!-- Confirm Modal -->
<div class="confirm-modal" id="confirmModal" onclick="hideConfirm(event)">
    <div class="confirm-box" onclick="event.stopPropagation()">
        <h3>Clear Search History?</h3>
        <p>This will permanently delete all your past searches. This action cannot be undone.</p>
        <div class="confirm-btns">
            <button class="btn-cancel-modal" onclick="hideConfirm()">Cancel</button>
            <button class="btn-confirm-modal" onclick="doClearHistory()">Clear All</button>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="sh-toast" id="shToast">
    <span class="sh-toast-del">✕</span>
    <span>Search history cleared</span>
</div>

<script>
function showConfirm() { document.getElementById('confirmModal').classList.add('open'); }
function hideConfirm(e) {
    if (!e || e.target === document.getElementById('confirmModal'))
        document.getElementById('confirmModal').classList.remove('open');
}
function doClearHistory() {
    fetch('{% url "search:clear_history" %}')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                hideConfirm();
                const t = document.getElementById('shToast');
                t.classList.add('show');
                setTimeout(() => { t.classList.remove('show'); location.reload(); }, 1800);
            }
        });
}
</script>
{% endblock %}