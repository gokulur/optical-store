{% extends 'admin-dashboard.html' %}
{% load static %}
{% block content %}

<style>
  .page-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
  .section-card { border-left: 4px solid #b66dff; margin-bottom: 24px; }
  .section-card .card-header { background: linear-gradient(90deg, rgba(182,109,255,.1), transparent); font-weight: 700; }
  .progress { height: 10px; border-radius: 10px; }
  .step-timeline { position: relative; padding-left: 32px; }
  .step-timeline::before { content: ''; position: absolute; left: 10px; top: 0; bottom: 0; width: 2px; background: #dee2e6; }
  .step-item { position: relative; margin-bottom: 20px; }
  .step-dot { position: absolute; left: -26px; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; }
  .step-dot.done    { background: #1bcfb4; color: #fff; }
  .step-dot.active  { background: #b66dff; color: #fff; }
  .step-dot.pending { background: #dee2e6; color: #666; }
  .rx-table td, .rx-table th { text-align: center; vertical-align: middle; }
  .info-row { display: flex; flex-wrap: wrap; gap: 0; }
  .info-item { flex: 0 0 50%; padding: 8px 12px; border-bottom: 1px solid #f0f0f0; }
  .info-item .label { font-size: 11px; text-transform: uppercase; letter-spacing: .05em; color: #888; }
  .info-item .value { font-weight: 600; color: #333; }
  .history-item { border-left: 3px solid #b66dff; padding: 10px 16px; margin-bottom: 12px; background: #fafafa; border-radius: 0 8px 8px 0; }
</style>

<div class="main-panel">
  <div class="content-wrapper">

    <div class="page-header">
      <div class="d-flex justify-content-between align-items-center w-100 flex-wrap">
        <div>
          <h3 class="mb-1"><i class="mdi mdi-briefcase-outline"></i> {{ job.job_number }}</h3>
          <p class="mb-0">{{ job.customer_name }} · {{ job.get_job_type_display }}</p>
        </div>
        <div class="d-flex gap-2 mt-2 mt-md-0">
          <a href="{% url 'adminpanel:job_edit' job.id %}" class="btn btn-light"><i class="mdi mdi-pencil"></i> Edit</a>
          <a href="{% url 'adminpanel:job_list' %}" class="btn btn-outline-light"><i class="mdi mdi-arrow-left"></i> All Jobs</a>
        </div>
      </div>
    </div>

    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">{{ message }}<button class="close" data-dismiss="alert"><span>&times;</span></button></div>
    {% endfor %}
    {% endif %}

    <!-- Progress Bar -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="font-weight-bold">Job Progress</span>
          <span class="badge badge-{{ job.status_display_class }} px-3 py-2">{{ job.get_status_display }}</span>
        </div>
        <div class="progress">
          <div class="progress-bar bg-success" style="width:{{ job.progress_percent }}%"></div>
        </div>
        <div class="d-flex justify-content-between mt-1">
          <small class="text-muted">Received</small>
          <small class="text-muted">{{ job.progress_percent }}%</small>
          <small class="text-muted">Delivered</small>
        </div>
      </div>
    </div>

    <div class="row">
      <!-- LEFT -->
      <div class="col-md-8">

        <!-- Customer & Job Info -->
        <div class="card section-card">
          <div class="card-header"><i class="mdi mdi-account-outline"></i> Customer & Job Info</div>
          <div class="card-body p-0">
            <div class="info-row">
              <div class="info-item"><div class="label">Customer</div><div class="value">{{ job.customer_name }}</div></div>
              <div class="info-item"><div class="label">Phone</div><div class="value">{{ job.customer_phone }}</div></div>
              <div class="info-item"><div class="label">Email</div><div class="value">{{ job.customer_email|default:"—" }}</div></div>
              <div class="info-item"><div class="label">Source</div><div class="value">{{ job.get_source_display }}</div></div>
              <div class="info-item"><div class="label">Priority</div><div class="value"><span class="badge badge-{% if job.priority == 'urgent' %}danger{% elif job.priority == 'express' %}warning{% else %}secondary{% endif %}">{{ job.get_priority_display }}</span></div></div>
              <div class="info-item"><div class="label">Assigned To</div><div class="value">{{ job.assigned_to.get_full_name|default:"Unassigned" }}</div></div>
              <div class="info-item"><div class="label">Promised Date</div><div class="value">{{ job.promised_date|date:"d M Y"|default:"—" }}</div></div>
              <div class="info-item"><div class="label">Created</div><div class="value">{{ job.created_at|date:"d M Y, H:i" }}</div></div>
            </div>
          </div>
        </div>

        <!-- Prescription -->
        <div class="card section-card">
          <div class="card-header"><i class="mdi mdi-glasses"></i> Prescription (Rx)</div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-bordered rx-table">
                <thead class="bg-light"><tr><th></th><th>Sphere</th><th>Cylinder</th><th>Axis</th><th>Add</th></tr></thead>
                <tbody>
                  <tr>
                    <td class="font-weight-bold bg-light">Right Eye (OD)</td>
                    <td>{{ job.re_sphere|default:"—" }}</td>
                    <td>{{ job.re_cylinder|default:"—" }}</td>
                    <td>{{ job.re_axis|default:"—" }}</td>
                    <td>{{ job.re_add|default:"—" }}</td>
                  </tr>
                  <tr>
                    <td class="font-weight-bold bg-light">Left Eye (OS)</td>
                    <td>{{ job.le_sphere|default:"—" }}</td>
                    <td>{{ job.le_cylinder|default:"—" }}</td>
                    <td>{{ job.le_axis|default:"—" }}</td>
                    <td>{{ job.le_add|default:"—" }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            {% if job.pd_distance or job.pd_near %}
            <p class="mt-2 mb-0"><strong>PD Distance:</strong> {{ job.pd_distance|default:"—" }} &nbsp;|&nbsp; <strong>PD Near:</strong> {{ job.pd_near|default:"—" }}</p>
            {% endif %}
            {% if job.prescription_file %}
            <a href="{{ job.prescription_file.url }}" target="_blank" class="btn btn-sm btn-outline-primary mt-2"><i class="mdi mdi-file-eye-outline"></i> View Prescription File</a>
            {% endif %}
          </div>
        </div>

        <!-- Lens Details -->
        <div class="card section-card">
          <div class="card-header"><i class="mdi mdi-eye-outline"></i> Lens & Frame Details</div>
          <div class="card-body p-0">
            <div class="info-row">
              <div class="info-item"><div class="label">Frame</div><div class="value">{{ job.frame_description|default:"—" }}</div></div>
              <div class="info-item"><div class="label">Lens Brand</div><div class="value">{{ job.lens_brand|default:"—" }}</div></div>
              <div class="info-item"><div class="label">Lens Type</div><div class="value">{{ job.lens_type|default:"—" }}</div></div>
              <div class="info-item"><div class="label">Index</div><div class="value">{{ job.lens_index|default:"—" }}</div></div>
              <div class="info-item"><div class="label">Coating</div><div class="value">{{ job.lens_coating|default:"—" }}</div></div>
              <div class="info-item"><div class="label">Colour/Tint</div><div class="value">{{ job.lens_color|default:"—" }}</div></div>
            </div>
          </div>
        </div>

        <!-- Notes -->
        {% if job.internal_notes or job.customer_notes %}
        <div class="card section-card">
          <div class="card-header"><i class="mdi mdi-note-text-outline"></i> Notes</div>
          <div class="card-body">
            {% if job.internal_notes %}
            <div class="mb-3">
              <div class="font-weight-bold small text-uppercase text-muted mb-1">Internal Notes</div>
              <p class="mb-0">{{ job.internal_notes }}</p>
            </div>
            {% endif %}
            {% if job.customer_notes %}
            <div>
              <div class="font-weight-bold small text-uppercase text-muted mb-1">Customer Notes</div>
              <p class="mb-0">{{ job.customer_notes }}</p>
            </div>
            {% endif %}
          </div>
        </div>
        {% endif %}

        <!-- Documents -->
        <div class="card section-card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="mdi mdi-paperclip"></i> Documents ({{ docs.count }})</span>
            <button class="btn btn-sm btn-outline-primary" data-toggle="modal" data-target="#uploadModal">
              <i class="mdi mdi-upload"></i> Upload
            </button>
          </div>
          <div class="card-body">
            {% if docs %}
            <div class="row">
              {% for doc in docs %}
              <div class="col-md-4 mb-3">
                <div class="card border text-center p-2">
                  <i class="mdi mdi-file-outline" style="font-size:32px;color:#b66dff;"></i>
                  <small class="d-block mt-1 font-weight-bold">{{ doc.get_doc_type_display }}</small>
                  <small class="text-muted">{{ doc.description|truncatechars:30 }}</small>
                  <a href="{{ doc.file.url }}" target="_blank" class="btn btn-xs btn-outline-primary mt-1">View</a>
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <p class="text-muted mb-0">No documents uploaded yet.</p>
            {% endif %}
          </div>
        </div>

      </div>

      <!-- RIGHT -->
      <div class="col-md-4">

        <!-- Payment -->
        <div class="card section-card">
          <div class="card-header"><i class="mdi mdi-cash-multiple"></i> Payment</div>
          <div class="card-body">
            <table class="table table-sm">
              <tr><td>Frame</td><td class="text-right">QAR {{ job.frame_price }}</td></tr>
              <tr><td>Lens</td><td class="text-right">QAR {{ job.lens_price }}</td></tr>
              <tr><td>Add-ons</td><td class="text-right">QAR {{ job.addon_price }}</td></tr>
              <tr><td>Discount</td><td class="text-right text-danger">- QAR {{ job.discount }}</td></tr>
              <tr class="font-weight-bold border-top"><td>Total</td><td class="text-right">QAR {{ job.total_amount }}</td></tr>
              <tr><td>Advance Paid</td><td class="text-right text-success">QAR {{ job.advance_paid }}</td></tr>
              <tr class="font-weight-bold {% if job.balance_due > 0 %}text-danger{% else %}text-success{% endif %}">
                <td>Balance Due</td><td class="text-right">QAR {{ job.balance_due }}</td>
              </tr>
            </table>
            {% if job.is_paid %}<div class="alert alert-success py-2 mb-0"><i class="mdi mdi-check-circle"></i> Fully Paid</div>{% endif %}
          </div>
        </div>

        <!-- Update Status -->
        <div class="card section-card">
          <div class="card-header"><i class="mdi mdi-update"></i> Update Status</div>
          <div class="card-body">
            <form method="POST" action="{% url 'adminpanel:job_update_status' job.id %}">
              {% csrf_token %}
              <div class="form-group">
                <select class="form-control" name="status">
                  {% for val, label in status_choices %}
                  <option value="{{ val }}" {% if job.status == val %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-group">
                <textarea class="form-control" name="note" rows="2" placeholder="Optional note about this status change..."></textarea>
              </div>
              <button type="submit" class="btn btn-primary btn-block"><i class="mdi mdi-check"></i> Update Status</button>
            </form>
          </div>
        </div>

        <!-- History -->
        <div class="card section-card">
          <div class="card-header"><i class="mdi mdi-history"></i> Status History</div>
          <div class="card-body">
            {% if history %}
            {% for h in history %}
            <div class="history-item">
              <div class="font-weight-bold small">{{ h.new_status|title }}</div>
              {% if h.old_status %}<small class="text-muted">from {{ h.old_status }}</small><br>{% endif %}
              {% if h.note %}<small>{{ h.note }}</small><br>{% endif %}
              <small class="text-muted">{{ h.created_at|date:"d M Y, H:i" }} · {{ h.changed_by.get_full_name|default:h.changed_by.email|default:"System" }}</small>
            </div>
            {% endfor %}
            {% else %}
            <p class="text-muted mb-0">No history yet.</p>
            {% endif %}
          </div>
        </div>

        <!-- Danger Zone -->
        <div class="card border-danger">
          <div class="card-header text-danger"><i class="mdi mdi-alert-circle-outline"></i> Danger Zone</div>
          <div class="card-body">
            <p class="text-muted small">Delete this job permanently. This cannot be undone.</p>
            <a href="{% url 'adminpanel:job_delete' job.id %}" class="btn btn-outline-danger btn-block"><i class="mdi mdi-delete"></i> Delete Job</a>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<!-- Upload Document Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="mdi mdi-upload"></i> Upload Document</h5>
        <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
      </div>
      <form method="POST" action="{% url 'adminpanel:job_upload_document' job.id %}" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-body">
          <div class="form-group">
            <label class="font-weight-bold">Document Type</label>
            <select class="form-control" name="doc_type">
              <option value="prescription">Prescription</option>
              <option value="photo">Photo</option>
              <option value="receipt">Receipt</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label class="font-weight-bold">File</label>
            <input type="file" class="form-control-file" name="file" required>
          </div>
          <div class="form-group">
            <label class="font-weight-bold">Description</label>
            <input type="text" class="form-control" name="description" placeholder="Optional description">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary"><i class="mdi mdi-upload"></i> Upload</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}