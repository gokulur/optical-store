{% extends 'admin-dashboard.html' %}
{% load static %}
{% block content %}

<style>
  .page-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
  .stats-card { border-left: 4px solid; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
  .stats-card.purple { border-left-color: #b66dff; background: rgba(182,109,255,.1); }
  .stats-card.info   { border-left-color: #17a2b8; background: rgba(23,162,184,.1); }
  .stats-card.success{ border-left-color: #1bcfb4; background: rgba(27,207,180,.1); }
  .stats-card.warning{ border-left-color: #fed713; background: rgba(254,215,19,.1); }
  .stats-card.danger { border-left-color: #fc424a; background: rgba(252,66,74,.1); }
  .filter-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
  .search-box { position: relative; }
  .search-box i { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #6c757d; }
  .search-box input { padding-left: 40px; }
  .badge { padding: 5px 10px; font-size: 11px; font-weight: 600; }
  .action-buttons .btn { padding: 4px 9px; font-size: 12px; margin-right: 3px; }
  .priority-urgent { background: #fc424a; color: #fff; }
  .priority-express { background: #b66dff; color: #fff; }
  .priority-normal  { background: #6c757d; color: #fff; }
</style>

<div class="main-panel">
  <div class="content-wrapper">

    <div class="page-header">
      <div class="d-flex justify-content-between align-items-center w-100">
        <div>
          <h3 class="mb-1"><i class="mdi mdi-briefcase-outline"></i> Job Orders</h3>
          <p class="mb-0">Manage all optical job orders &amp; track progress</p>
        </div>
        <a href="{% url 'adminpanel:job_add' %}" class="btn btn-light btn-lg">
          <i class="mdi mdi-plus"></i> New Job
        </a>
      </div>
    </div>

    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
    </div>
    {% endfor %}
    {% endif %}

    <!-- Stats Row -->
    <div class="row mb-3">
      <div class="col-6 col-md-3">
        <div class="stats-card purple">
          <div class="d-flex justify-content-between align-items-center">
            <div><h3 class="mb-0 font-weight-bold">{{ total }}</h3><p class="mb-0 text-muted small">Total Jobs</p></div>
            <i class="mdi mdi-briefcase-outline" style="font-size:36px;color:#b66dff;"></i>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stats-card info">
          <div class="d-flex justify-content-between align-items-center">
            <div><h3 class="mb-0 font-weight-bold">{{ pending }}</h3><p class="mb-0 text-muted small">In Progress</p></div>
            <i class="mdi mdi-progress-clock" style="font-size:36px;color:#17a2b8;"></i>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stats-card success">
          <div class="d-flex justify-content-between align-items-center">
            <div><h3 class="mb-0 font-weight-bold">{{ ready }}</h3><p class="mb-0 text-muted small">Ready</p></div>
            <i class="mdi mdi-check-circle-outline" style="font-size:36px;color:#1bcfb4;"></i>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stats-card danger">
          <div class="d-flex justify-content-between align-items-center">
            <div><h3 class="mb-0 font-weight-bold">{{ urgent }}</h3><p class="mb-0 text-muted small">Urgent</p></div>
            <i class="mdi mdi-alert-circle-outline" style="font-size:36px;color:#fc424a;"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filter-section">
      <form method="GET" action="">
        <div class="row align-items-end g-2">
          <div class="col-md-3">
            <label class="font-weight-bold small">Search</label>
            <div class="search-box">
              <i class="mdi mdi-magnify"></i>
              <input type="text" class="form-control" name="search" placeholder="Job #, name, phone..." value="{{ search }}">
            </div>
          </div>
          <div class="col-md-2">
            <label class="font-weight-bold small">Status</label>
            <select class="form-control" name="status">
              <option value="">All Statuses</option>
              {% for val, label in status_choices %}
              <option value="{{ val }}" {% if status == val %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label class="font-weight-bold small">Type</label>
            <select class="form-control" name="job_type">
              <option value="">All Types</option>
              {% for val, label in type_choices %}
              <option value="{{ val }}" {% if job_type == val %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label class="font-weight-bold small">Priority</label>
            <select class="form-control" name="priority">
              <option value="">All</option>
              {% for val, label in priority_choices %}
              <option value="{{ val }}" {% if priority == val %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-1">
            <label class="font-weight-bold small">From</label>
            <input type="date" class="form-control" name="date_from" value="{{ date_from }}">
          </div>
          <div class="col-md-1">
            <label class="font-weight-bold small">To</label>
            <input type="date" class="form-control" name="date_to" value="{{ date_to }}">
          </div>
          <div class="col-md-1 d-flex gap-1">
            <button type="submit" class="btn btn-primary btn-block"><i class="mdi mdi-filter"></i></button>
            <a href="{% url 'adminpanel:job_list' %}" class="btn btn-light btn-block"><i class="mdi mdi-refresh"></i></a>
          </div>
        </div>
      </form>
    </div>

    <!-- Table -->
    <div class="card">
      <div class="card-body p-0">
        {% if jobs %}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="bg-light">
              <tr>
                <th>Job #</th>
                <th>Customer</th>
                <th>Type</th>
                <th>Frame / Lens</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Promised</th>
                <th>Balance</th>
                <th class="text-right">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for job in jobs %}
              <tr>
                <td>
                  <a href="{% url 'adminpanel:job_detail' job.id %}" class="font-weight-bold text-primary">
                    {{ job.job_number }}
                  </a>
                  <br><small class="text-muted">{{ job.created_at|date:"d M Y" }}</small>
                </td>
                <td>
                  <div class="font-weight-medium">{{ job.customer_name }}</div>
                  <small class="text-muted">{{ job.customer_phone }}</small>
                </td>
                <td><span class="badge badge-dark">{{ job.get_job_type_display }}</span></td>
                <td>
                  <small>{{ job.frame_description|truncatewords:5|default:"—" }}</small><br>
                  <small class="text-muted">{{ job.lens_brand }} {{ job.lens_type }}</small>
                </td>
                <td>
                  <span class="badge priority-{{ job.priority }}">{{ job.get_priority_display }}</span>
                </td>
                <td>
                  <span class="badge badge-{{ job.status_display_class }}">{{ job.get_status_display }}</span>
                </td>
                <td>
                  {% if job.promised_date %}
                    {% if job.promised_date < today and job.status not in 'delivered,cancelled' %}
                    <span class="text-danger font-weight-bold">{{ job.promised_date|date:"d M" }}</span>
                    {% else %}
                    {{ job.promised_date|date:"d M Y" }}
                    {% endif %}
                  {% else %}—{% endif %}
                </td>
                <td>
                  {% if job.balance_due > 0 %}
                  <span class="text-danger font-weight-bold">QAR {{ job.balance_due }}</span>
                  {% else %}
                  <span class="text-success"><i class="mdi mdi-check"></i> Paid</span>
                  {% endif %}
                </td>
                <td class="text-right">
                  <div class="action-buttons">
                    <a href="{% url 'adminpanel:job_detail' job.id %}" class="btn btn-sm btn-outline-info" title="View"><i class="mdi mdi-eye"></i></a>
                    <a href="{% url 'adminpanel:job_edit' job.id %}" class="btn btn-sm btn-outline-warning" title="Edit"><i class="mdi mdi-pencil"></i></a>
                    <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete('{{ job.job_number|escapejs }}','{{ job.id }}')" title="Delete"><i class="mdi mdi-delete"></i></button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {% if jobs.has_other_pages %}
        <div class="p-3">
          <nav>
            <ul class="pagination justify-content-center mb-0">
              {% if jobs.has_previous %}<li class="page-item"><a class="page-link" href="?page={{ jobs.previous_page_number }}&search={{ search }}&status={{ status }}&job_type={{ job_type }}&priority={{ priority }}"><i class="mdi mdi-chevron-left"></i></a></li>{% endif %}
              {% for num in jobs.paginator.page_range %}
                {% if jobs.number == num %}<li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > jobs.number|add:'-3' and num < jobs.number|add:'3' %}<li class="page-item"><a class="page-link" href="?page={{ num }}&search={{ search }}&status={{ status }}">{{ num }}</a></li>{% endif %}
              {% endfor %}
              {% if jobs.has_next %}<li class="page-item"><a class="page-link" href="?page={{ jobs.next_page_number }}&search={{ search }}&status={{ status }}&job_type={{ job_type }}&priority={{ priority }}"><i class="mdi mdi-chevron-right"></i></a></li>{% endif %}
            </ul>
          </nav>
        </div>
        {% endif %}

        {% else %}
        <div class="text-center py-5">
          <i class="mdi mdi-briefcase-outline" style="font-size:80px;color:#ccc;"></i>
          <h4 class="mt-3 text-muted">No Jobs Found</h4>
          <p class="text-muted">Create your first job order to get started.</p>
          <a href="{% url 'adminpanel:job_add' %}" class="btn btn-primary"><i class="mdi mdi-plus"></i> Create Job</a>
        </div>
        {% endif %}
      </div>
    </div>

  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="mdi mdi-alert"></i> Confirm Delete</h5>
        <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete job <strong id="deleteJobNum"></strong>?</p>
        <p class="text-danger mb-0"><small>This action cannot be undone.</small></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-dismiss="modal">Cancel</button>
        <form id="deleteForm" method="POST" style="display:inline">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger"><i class="mdi mdi-delete"></i> Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
function confirmDelete(num, id) {
  document.getElementById('deleteJobNum').textContent = num;
  document.getElementById('deleteForm').action = "{% url 'adminpanel:job_delete' 0 %}".replace('/0/', '/' + id + '/');
  $('#deleteModal').modal('show');
}
</script>
{% endblock %}