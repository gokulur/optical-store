{% extends 'admin-dashboard.html' %}
{% load static %}
{% block content %}

<style>
  .page-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
  .form-control:focus { border-color: #b66dff; box-shadow: 0 0 0 .2rem rgba(182,109,255,.25); }
  .section-card { border-left: 4px solid #b66dff; }
  .section-card .card-header { background: linear-gradient(90deg, rgba(182,109,255,.1), transparent); font-weight: 700; }
  .rx-table input { text-align: center; }
  .btn-gradient-primary { background: linear-gradient(to right, #da8cff, #9a55ff); border: 0; color: white; }
  .btn-gradient-primary:hover { background: linear-gradient(to right, #9a55ff, #da8cff); color: white; }
  .customer-suggestion { position: absolute; z-index: 1000; width: 100%; background: #fff; border: 1px solid #dee2e6; border-radius: 4px; box-shadow: 0 4px 16px rgba(0,0,0,.1); max-height: 200px; overflow-y: auto; }
  .customer-suggestion .suggestion-item { padding: 10px 14px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
  .customer-suggestion .suggestion-item:hover { background: #f8f9fa; }
</style>

<div class="main-panel">
  <div class="content-wrapper">

    <div class="page-header">
      <h3 class="mb-1"><i class="mdi mdi-briefcase-plus-outline"></i> New Job Order</h3>
      <p class="mb-0">Create a new optical job for in-store or online</p>
    </div>

    <nav aria-label="breadcrumb">
      <ol class="breadcrumb bg-transparent p-0 mb-4">
        <li class="breadcrumb-item"><a href="{% url 'adminpanel:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'adminpanel:job_list' %}">Jobs</a></li>
        <li class="breadcrumb-item active">New Job</li>
      </ol>
    </nav>

    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}<button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
    </div>
    {% endfor %}
    {% endif %}

    <form method="POST" enctype="multipart/form-data" id="jobForm">
      {% csrf_token %}
      <div class="row">

        <!-- LEFT COLUMN -->
        <div class="col-md-8">

          <!-- Customer Info -->
          <div class="card section-card mb-4">
            <div class="card-header"><i class="mdi mdi-account-outline"></i> Customer Information</div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 form-group">
                  <label class="font-weight-bold">Customer Name <span class="text-danger">*</span></label>
                  <div style="position:relative">
                    <input type="text" class="form-control" name="customer_name" id="customerNameInput" placeholder="Type to search or enter name..." required autocomplete="off">
                    <input type="hidden" name="customer_id" id="customerId">
                    <div class="customer-suggestion" id="customerSuggestions" style="display:none;"></div>
                  </div>
                </div>
                <div class="col-md-3 form-group">
                  <label class="font-weight-bold">Phone <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" name="customer_phone" id="customerPhone" placeholder="+974 xxxx xxxx" required>
                </div>
                <div class="col-md-3 form-group">
                  <label class="font-weight-bold">Email</label>
                  <input type="email" class="form-control" name="customer_email" id="customerEmail" placeholder="email@example.com">
                </div>
              </div>
            </div>
          </div>

          <!-- Job Details -->
          <div class="card section-card mb-4">
            <div class="card-header"><i class="mdi mdi-clipboard-text-outline"></i> Job Details</div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-4 form-group">
                  <label class="font-weight-bold">Job Type <span class="text-danger">*</span></label>
                  <select class="form-control" name="job_type" required>
                    {% for val, label in type_choices %}
                    <option value="{{ val }}">{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-4 form-group">
                  <label class="font-weight-bold">Source</label>
                  <select class="form-control" name="source">
                    {% for val, label in source_choices %}
                    <option value="{{ val }}">{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-4 form-group">
                  <label class="font-weight-bold">Priority</label>
                  <select class="form-control" name="priority">
                    {% for val, label in priority_choices %}
                    <option value="{{ val }}">{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6 form-group">
                  <label class="font-weight-bold">Frame Description</label>
                  <input type="text" class="form-control" name="frame_description" placeholder="Brand, model, colour...">
                </div>
                <div class="col-md-3 form-group">
                  <label class="font-weight-bold">Promised Date</label>
                  <input type="date" class="form-control" name="promised_date">
                </div>
                <div class="col-md-3 form-group">
                  <label class="font-weight-bold">Assigned To</label>
                  <select class="form-control" name="assigned_to">
                    <option value="">— Unassigned —</option>
                    {% for staff in staff_users %}
                    <option value="{{ staff.id }}">{{ staff.get_full_name|default:staff.email }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- Prescription -->
          <div class="card section-card mb-4">
            <div class="card-header"><i class="mdi mdi-glasses"></i> Prescription (Rx)</div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-bordered rx-table">
                  <thead class="bg-light">
                    <tr><th></th><th>Sphere</th><th>Cylinder</th><th>Axis</th><th>Add</th></tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td class="font-weight-bold bg-light">Right Eye (OD)</td>
                      <td><input type="number" step="0.25" class="form-control form-control-sm" name="re_sphere" placeholder="0.00"></td>
                      <td><input type="number" step="0.25" class="form-control form-control-sm" name="re_cylinder" placeholder="0.00"></td>
                      <td><input type="number" class="form-control form-control-sm" name="re_axis" placeholder="0-180"></td>
                      <td><input type="number" step="0.25" class="form-control form-control-sm" name="re_add" placeholder="0.00"></td>
                    </tr>
                    <tr>
                      <td class="font-weight-bold bg-light">Left Eye (OS)</td>
                      <td><input type="number" step="0.25" class="form-control form-control-sm" name="le_sphere" placeholder="0.00"></td>
                      <td><input type="number" step="0.25" class="form-control form-control-sm" name="le_cylinder" placeholder="0.00"></td>
                      <td><input type="number" class="form-control form-control-sm" name="le_axis" placeholder="0-180"></td>
                      <td><input type="number" step="0.25" class="form-control form-control-sm" name="le_add" placeholder="0.00"></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="row mt-2">
                <div class="col-md-3 form-group">
                  <label class="font-weight-bold small">PD Distance</label>
                  <input type="number" step="0.5" class="form-control form-control-sm" name="pd_distance" placeholder="e.g. 64">
                </div>
                <div class="col-md-3 form-group">
                  <label class="font-weight-bold small">PD Near</label>
                  <input type="number" step="0.5" class="form-control form-control-sm" name="pd_near" placeholder="e.g. 61">
                </div>
                <div class="col-md-6 form-group">
                  <label class="font-weight-bold small">Upload Prescription File</label>
                  <input type="file" class="form-control-file" name="prescription_file" accept=".pdf,.jpg,.jpeg,.png">
                </div>
              </div>
            </div>
          </div>

          <!-- Lens Details -->
          <div class="card section-card mb-4">
            <div class="card-header"><i class="mdi mdi-eye-outline"></i> Lens Details</div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-4 form-group">
                  <label class="font-weight-bold small">Lens Brand</label>
                  <input type="text" class="form-control" name="lens_brand" placeholder="e.g. Essilor, Hoya">
                </div>
                <div class="col-md-4 form-group">
                  <label class="font-weight-bold small">Lens Type</label>
                  <input type="text" class="form-control" name="lens_type" placeholder="e.g. Single Vision, Progressive">
                </div>
                <div class="col-md-4 form-group">
                  <label class="font-weight-bold small">Index</label>
                  <input type="text" class="form-control" name="lens_index" placeholder="e.g. 1.60, 1.67">
                </div>
                <div class="col-md-4 form-group">
                  <label class="font-weight-bold small">Coating</label>
                  <input type="text" class="form-control" name="lens_coating" placeholder="e.g. Anti-Reflective, Blue Light">
                </div>
                <div class="col-md-4 form-group">
                  <label class="font-weight-bold small">Lens Colour/Tint</label>
                  <input type="text" class="form-control" name="lens_color" placeholder="e.g. Clear, Grey G15">
                </div>
              </div>
            </div>
          </div>

          <!-- Notes -->
          <div class="card section-card mb-4">
            <div class="card-header"><i class="mdi mdi-note-text-outline"></i> Notes</div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 form-group">
                  <label class="font-weight-bold small">Internal Notes (Staff only)</label>
                  <textarea class="form-control" name="internal_notes" rows="3" placeholder="Notes visible only to staff..."></textarea>
                </div>
                <div class="col-md-6 form-group">
                  <label class="font-weight-bold small">Customer Notes (visible on tracking)</label>
                  <textarea class="form-control" name="customer_notes" rows="3" placeholder="Notes visible to customer..."></textarea>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- RIGHT COLUMN: Financials -->
        <div class="col-md-4">
          <div class="card section-card mb-4 sticky-top" style="top:80px;">
            <div class="card-header"><i class="mdi mdi-cash-multiple"></i> Payment Summary</div>
            <div class="card-body">
              <div class="form-group">
                <label class="font-weight-bold small">Frame Price (QAR)</label>
                <input type="number" step="0.01" class="form-control calc-input" name="frame_price" id="framePrice" value="0.00" oninput="calcTotal()">
              </div>
              <div class="form-group">
                <label class="font-weight-bold small">Lens Price (QAR)</label>
                <input type="number" step="0.01" class="form-control calc-input" name="lens_price" id="lensPrice" value="0.00" oninput="calcTotal()">
              </div>
              <div class="form-group">
                <label class="font-weight-bold small">Add-ons (QAR)</label>
                <input type="number" step="0.01" class="form-control calc-input" name="addon_price" id="addonPrice" value="0.00" oninput="calcTotal()">
              </div>
              <div class="form-group">
                <label class="font-weight-bold small">Discount (QAR)</label>
                <input type="number" step="0.01" class="form-control calc-input" name="discount" id="discountVal" value="0.00" oninput="calcTotal()">
              </div>
              <hr>
              <div class="form-group">
                <label class="font-weight-bold">Total Amount (QAR)</label>
                <input type="number" step="0.01" class="form-control font-weight-bold" name="total_amount" id="totalAmount" value="0.00" readonly style="background:#f8f9fa;font-size:1.2rem;">
              </div>
              <div class="form-group">
                <label class="font-weight-bold small">Advance Paid (QAR)</label>
                <input type="number" step="0.01" class="form-control calc-input" name="advance_paid" id="advancePaid" value="0.00" oninput="calcBalance()">
              </div>
              <div class="form-group">
                <label class="font-weight-bold small">Balance Due (QAR)</label>
                <input type="number" step="0.01" class="form-control font-weight-bold text-danger" name="balance_due_display" id="balanceDue" value="0.00" readonly style="background:#fff3cd;">
              </div>
              <hr>
              <button type="submit" class="btn btn-gradient-primary btn-lg btn-block">
                <i class="mdi mdi-check"></i> Create Job Order
              </button>
              <a href="{% url 'adminpanel:job_list' %}" class="btn btn-light btn-block mt-2">
                <i class="mdi mdi-close"></i> Cancel
              </a>
            </div>
          </div>
        </div>

      </div>
    </form>

  </div>
</div>

<script>
function calcTotal() {
  var frame   = parseFloat(document.getElementById('framePrice').value)  || 0;
  var lens    = parseFloat(document.getElementById('lensPrice').value)   || 0;
  var addon   = parseFloat(document.getElementById('addonPrice').value)  || 0;
  var disc    = parseFloat(document.getElementById('discountVal').value) || 0;
  var total   = Math.max(0, frame + lens + addon - disc);
  document.getElementById('totalAmount').value = total.toFixed(2);
  calcBalance();
}
function calcBalance() {
  var total   = parseFloat(document.getElementById('totalAmount').value)  || 0;
  var advance = parseFloat(document.getElementById('advancePaid').value)  || 0;
  var balance = Math.max(0, total - advance);
  document.getElementById('balanceDue').value = balance.toFixed(2);
}

// Customer autocomplete
var searchTimer;
document.getElementById('customerNameInput').addEventListener('input', function() {
  clearTimeout(searchTimer);
  var q = this.value.trim();
  var sugBox = document.getElementById('customerSuggestions');
  if (q.length < 2) { sugBox.style.display = 'none'; return; }
  searchTimer = setTimeout(function() {
    fetch('{% url "adminpanel:job_customer_search" %}?q=' + encodeURIComponent(q), {
      headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(function(r){ return r.json(); })
    .then(function(data) {
      sugBox.innerHTML = '';
      if (data.results.length === 0) { sugBox.style.display = 'none'; return; }
      data.results.forEach(function(c) {
        var div = document.createElement('div');
        div.className = 'suggestion-item';
        div.innerHTML = '<strong>' + c.name + '</strong><br><small class="text-muted">' + c.email + ' · ' + c.phone + '</small>';
        div.addEventListener('click', function() {
          document.getElementById('customerNameInput').value = c.name;
          document.getElementById('customerId').value = c.id;
          document.getElementById('customerPhone').value = c.phone;
          document.getElementById('customerEmail').value = c.email;
          sugBox.style.display = 'none';
        });
        sugBox.appendChild(div);
      });
      sugBox.style.display = 'block';
    });
  }, 300);
});
document.addEventListener('click', function(e) {
  if (!e.target.closest('#customerNameInput')) {
    document.getElementById('customerSuggestions').style.display = 'none';
  }
});
</script>
{% endblock %}