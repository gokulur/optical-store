{% extends 'admin-dashboard.html' %}
{% load static %}
{% block content %}
<style>
.page-header-promo { background: linear-gradient(135deg, #f857a6 0%, #ff5858 100%); padding: 22px 26px; border-radius: 10px; margin-bottom: 24px; color: #fff; }
.page-header-promo h3 { margin: 0 0 4px; font-size: 1.3rem; font-weight: 700; }
.page-header-promo p  { margin: 0; opacity: .8; font-size: .85rem; }
.form-card { background: #fff; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,.07); overflow: hidden; }
.form-card-header { padding: 18px 22px; border-bottom: 1px solid #f0f0f0; }
.form-card-header h5 { margin: 0; font-weight: 700; font-size: .95rem; }
.form-card-body { padding: 24px 22px; }
.section-title { font-size: .72rem; font-weight: 800; text-transform: uppercase; letter-spacing: .1em; color: #aaa; margin-bottom: 14px; padding-bottom: 8px; border-bottom: 2px solid #f0f0f0; }
.form-control { border-radius: 8px; border: 1.5px solid #e5e5e5; font-size: .88rem; padding: 10px 13px; transition: all .2s; }
.form-control:focus { border-color: #f857a6; box-shadow: 0 0 0 3px rgba(248,87,166,.12); outline: none; }
.form-label { font-size: .82rem; font-weight: 700; color: #555; margin-bottom: 5px; display: block; }
.req { color: #f857a6; }
.help-text { font-size: .76rem; color: #bbb; margin-top: 4px; }
.type-cards { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; margin-bottom: 6px; }
.type-card { border: 2px solid #e5e5e5; border-radius: 10px; padding: 14px 12px; cursor: pointer; transition: all .2s; text-align: center; position: relative; }
.type-card:hover { border-color: #f857a6; }
.type-card input { position: absolute; opacity: 0; pointer-events: none; }
.type-card input:checked + .type-card-inner { color: #f857a6; }
.type-card.selected { border-color: #f857a6; background: rgba(248,87,166,.05); }
.type-card i { font-size: 22px; display: block; margin-bottom: 5px; }
.type-card span { font-size: .78rem; font-weight: 700; }
.form-check-flat .form-check-label { display: flex; align-items: center; gap: 8px; font-size: .88rem; font-weight: 600; cursor: pointer; }
.form-check-flat .form-check-label input { width: 18px; height: 18px; cursor: pointer; }
.btn-save { background: linear-gradient(135deg, #f857a6 0%, #ff5858 100%); border: none; color: #fff; border-radius: 8px; padding: 11px 28px; font-weight: 700; font-size: .9rem; }
.btn-save:hover { opacity: .9; color: #fff; }
.side-info { background: linear-gradient(135deg, rgba(248,87,166,.06) 0%, rgba(255,88,88,.06) 100%); border: 1.5px dashed #f8b4d4; border-radius: 10px; padding: 18px; }
.side-info h6 { font-size: .8rem; font-weight: 800; text-transform: uppercase; letter-spacing: .06em; color: #f857a6; margin-bottom: 10px; }
.side-info li { font-size: .82rem; color: #666; margin-bottom: 6px; }
</style>

<div class="main-panel">
  <div class="content-wrapper">

    <div class="page-header-promo d-flex justify-content-between align-items-center flex-wrap" style="gap:12px;">
      <div>
        <h3><i class="mdi mdi-tag-plus"></i> Add New Coupon</h3>
        <p>Create a discount coupon for your customers</p>
      </div>
      <a href="{% url 'adminpanel:coupon_list' %}" class="btn btn-light btn-sm">
        <i class="mdi mdi-arrow-left"></i> Back to List
      </a>
    </div>

    <nav aria-label="breadcrumb">
      <ol class="breadcrumb bg-transparent p-0 mb-4">
        <li class="breadcrumb-item"><a href="{% url 'adminpanel:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'adminpanel:coupon_list' %}">Promotions</a></li>
        <li class="breadcrumb-item active">Add Coupon</li>
      </ol>
    </nav>

    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
      {{ message }}<button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
    </div>
    {% endfor %}
    {% endif %}

    <form method="POST" id="couponForm">
      {% csrf_token %}
      <div class="row">

        <!-- LEFT: Main form -->
        <div class="col-md-8">

          <!-- Basic Info -->
          <div class="form-card mb-4">
            <div class="form-card-header"><h5><i class="mdi mdi-tag text-pink" style="color:#f857a6;"></i> Basic Information</h5></div>
            <div class="form-card-body">
              <div class="section-title">Coupon Identity</div>
              <div class="row">
                <div class="col-md-6 form-group">
                  <label class="form-label">Coupon Code <span class="req">*</span></label>
                  <div class="input-group">
                    <input type="text" class="form-control text-uppercase font-weight-bold" name="code" id="codeInput" placeholder="e.g. SAVE20" required style="letter-spacing:.1em; font-family: monospace;" value="{{ form_data.code|default:'' }}">
                    <div class="input-group-append">
                      <button type="button" class="btn btn-outline-secondary" onclick="generateCode()" title="Generate random code">
                        <i class="mdi mdi-autorenew"></i>
                      </button>
                    </div>
                  </div>
                  <p class="help-text">Unique code customers enter at checkout</p>
                </div>
                <div class="col-md-6 form-group">
                  <label class="form-label">Coupon Name <span class="req">*</span></label>
                  <input type="text" class="form-control" name="name" placeholder="e.g. Summer Sale 20% Off" required value="{{ form_data.name|default:'' }}">
                  <p class="help-text">Internal label for this coupon</p>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-control" name="description" rows="2" placeholder="Optional: explain what this coupon offersâ€¦">{{ form_data.description|default:'' }}</textarea>
              </div>
            </div>
          </div>

          <!-- Discount Type -->
          <div class="form-card mb-4">
            <div class="form-card-header"><h5><i class="mdi mdi-percent" style="color:#667eea;"></i> Discount Type</h5></div>
            <div class="form-card-body">
              <div class="section-title">Choose Type</div>
              <div class="type-cards" id="typeCards">
                <label class="type-card {% if form_data.discount_type == 'percentage' or not form_data.discount_type %}selected{% endif %}" onclick="selectType(this,'percentage')">
                  <input type="radio" name="discount_type" value="percentage" {% if form_data.discount_type == 'percentage' or not form_data.discount_type %}checked{% endif %}>
                  <i class="mdi mdi-percent" style="color:#667eea;"></i>
                  <span>Percentage</span>
                </label>
                <label class="type-card {% if form_data.discount_type == 'fixed_amount' %}selected{% endif %}" onclick="selectType(this,'fixed_amount')">
                  <input type="radio" name="discount_type" value="fixed_amount" {% if form_data.discount_type == 'fixed_amount' %}checked{% endif %}>
                  <i class="mdi mdi-cash" style="color:#1bcfb4;"></i>
                  <span>Fixed Amount</span>
                </label>
                <label class="type-card {% if form_data.discount_type == 'free_shipping' %}selected{% endif %}" onclick="selectType(this,'free_shipping')">
                  <input type="radio" name="discount_type" value="free_shipping" {% if form_data.discount_type == 'free_shipping' %}checked{% endif %}>
                  <i class="mdi mdi-truck" style="color:#fd7e14;"></i>
                  <span>Free Shipping</span>
                </label>
              </div>

              <div class="row mt-3" id="discountValueRow">
                <div class="col-md-6 form-group">
                  <label class="form-label" id="discountValueLabel">Discount Value <span class="req">*</span></label>
                  <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text" id="valuePrefix">%</span></div>
                    <input type="number" class="form-control" name="discount_value" id="discountValueInput" placeholder="0" step="0.01" min="0" value="{{ form_data.discount_value|default:'' }}">
                  </div>
                </div>
                <div class="col-md-6 form-group">
                  <label class="form-label">Maximum Discount Cap (QAR)</label>
                  <input type="number" class="form-control" name="maximum_discount_amount" placeholder="Leave blank for no cap" step="0.01" min="0" value="{{ form_data.maximum_discount_amount|default:'' }}">
                  <p class="help-text">Only applies to percentage discounts</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Conditions -->
          <div class="form-card mb-4">
            <div class="form-card-header"><h5><i class="mdi mdi-filter" style="color:#1bcfb4;"></i> Conditions & Limits</h5></div>
            <div class="form-card-body">
              <div class="section-title">Order Conditions</div>
              <div class="row">
                <div class="col-md-6 form-group">
                  <label class="form-label">Minimum Order Amount (QAR)</label>
                  <input type="number" class="form-control" name="minimum_order_amount" placeholder="Leave blank for no minimum" step="0.01" min="0" value="{{ form_data.minimum_order_amount|default:'' }}">
                </div>
              </div>
              <div class="section-title mt-3">Usage Limits</div>
              <div class="row">
                <div class="col-md-6 form-group">
                  <label class="form-label">Total Usage Limit</label>
                  <input type="number" class="form-control" name="usage_limit" placeholder="Leave blank for unlimited" min="1" value="{{ form_data.usage_limit|default:'' }}">
                  <p class="help-text">Total times this coupon can be used across all customers</p>
                </div>
                <div class="col-md-6 form-group">
                  <label class="form-label">Limit Per Customer</label>
                  <input type="number" class="form-control" name="usage_limit_per_customer" placeholder="Leave blank for unlimited" min="1" value="{{ form_data.usage_limit_per_customer|default:'' }}">
                  <p class="help-text">How many times each customer can use this coupon</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Validity -->
          <div class="form-card mb-4">
            <div class="form-card-header"><h5><i class="mdi mdi-calendar" style="color:#fd7e14;"></i> Validity Period</h5></div>
            <div class="form-card-body">
              <div class="row">
                <div class="col-md-6 form-group">
                  <label class="form-label">Valid From <span class="req">*</span></label>
                  <input type="datetime-local" class="form-control" name="valid_from" required value="{{ form_data.valid_from|default:'' }}">
                </div>
                <div class="col-md-6 form-group">
                  <label class="form-label">Valid Until <span class="req">*</span></label>
                  <input type="datetime-local" class="form-control" name="valid_until" required value="{{ form_data.valid_until|default:'' }}">
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- RIGHT: Sidebar -->
        <div class="col-md-4">
          <div class="form-card mb-4">
            <div class="form-card-header"><h5><i class="mdi mdi-cog" style="color:#f857a6;"></i> Settings</h5></div>
            <div class="form-card-body">
              <div class="form-check form-check-flat mb-3">
                <label class="form-check-label">
                  <input type="checkbox" class="form-check-input" name="is_active" {% if not form_data or form_data.is_active %}checked{% endif %}>
                  Active (visible to customers)
                  <i class="input-helper"></i>
                </label>
              </div>
              <div class="form-check form-check-flat mb-3">
                <label class="form-check-label">
                  <input type="checkbox" class="form-check-input" name="applicable_to_all" {% if not form_data or form_data.applicable_to_all %}checked{% endif %}>
                  Apply to all products
                  <i class="input-helper"></i>
                </label>
              </div>
              <hr>
              <button type="submit" class="btn-save btn btn-block">
                <i class="mdi mdi-check"></i> Save Coupon
              </button>
              <a href="{% url 'adminpanel:coupon_list' %}" class="btn btn-light btn-block mt-2" style="border-radius:8px;">
                Cancel
              </a>
            </div>
          </div>

          <div class="side-info">
            <h6><i class="mdi mdi-lightbulb-on"></i> Tips</h6>
            <ul class="list-unstyled mb-0">
              <li><i class="mdi mdi-check text-success mr-1"></i> Use ALL CAPS codes (e.g. SAVE20)</li>
              <li><i class="mdi mdi-check text-success mr-1"></i> Set a usage limit to create urgency</li>
              <li><i class="mdi mdi-check text-success mr-1"></i> Min. order amount increases cart value</li>
              <li><i class="mdi mdi-check text-success mr-1"></i> Percentage discounts auto-cap with max</li>
              <li><i class="mdi mdi-check text-success mr-1"></i> Deactivate instead of deleting used coupons</li>
            </ul>
          </div>
        </div>

      </div>
    </form>

  </div>
</div>

<script>
function selectType(label, type) {
    document.querySelectorAll('.type-card').forEach(function(c){ c.classList.remove('selected'); });
    label.classList.add('selected');
    var prefix = document.getElementById('valuePrefix');
    var valLabel = document.getElementById('discountValueLabel');
    var valInput = document.getElementById('discountValueInput');
    var row = document.getElementById('discountValueRow');
    if (type === 'percentage') {
        prefix.textContent = '%'; valLabel.innerHTML = 'Discount Value <span class="req">*</span>';
        valInput.placeholder = '0'; row.style.display = '';
        valInput.max = 100;
    } else if (type === 'fixed_amount') {
        prefix.textContent = 'QAR'; valLabel.innerHTML = 'Discount Amount <span class="req">*</span>';
        valInput.placeholder = '0.00'; row.style.display = '';
        valInput.removeAttribute('max');
    } else {
        row.style.display = 'none';
    }
}

function generateCode() {
    var chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    var code = '';
    for (var i = 0; i < 8; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
    document.getElementById('codeInput').value = code;
}

document.getElementById('codeInput').addEventListener('input', function() {
    this.value = this.value.toUpperCase().replace(/[^A-Z0-9\-_]/g,'');
});

// Init on load
document.addEventListener('DOMContentLoaded', function() {
    var selected = document.querySelector('input[name="discount_type"]:checked');
    if (selected && selected.value === 'free_shipping') {
        document.getElementById('discountValueRow').style.display = 'none';
    }
});
</script>
{% endblock %}