{% extends 'admin-dashboard.html' %}
{% load static %}
{% block content %}
<style>
.page-header-promo { background: linear-gradient(135deg, #f857a6 0%, #ff5858 100%); padding: 22px 26px; border-radius: 10px; margin-bottom: 24px; color: #fff; }
.page-header-promo h3 { margin: 0 0 4px; font-size: 1.3rem; font-weight: 700; }
.page-header-promo p  { margin: 0; opacity: .8; font-size: .85rem; }

/* ── Dark form cards ── */
.form-card { background: #2a2a2a; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,.3); overflow: hidden; }
.form-card-header { padding: 18px 22px; border-bottom: 1px solid #3a3a3a; }
.form-card-header h5 { margin: 0; font-weight: 700; font-size: .95rem; color: #fff; }
.form-card-body { padding: 24px 22px; }

.section-title { font-size: .72rem; font-weight: 800; text-transform: uppercase; letter-spacing: .1em; color: #666; margin-bottom: 14px; padding-bottom: 8px; border-bottom: 2px solid #3a3a3a; }

/* Dark inputs */
.form-control {
    border-radius: 8px; border: 1.5px solid #444;
    background: #1e1e1e; color: #eee;
    font-size: .88rem; padding: 10px 13px; transition: all .2s;
}
.form-control:focus { border-color: #f857a6; box-shadow: 0 0 0 3px rgba(248,87,166,.15); outline: none; background: #1e1e1e; color: #eee; }
.form-control::placeholder { color: #555; }
/* Fix datetime-local in dark mode */
input[type="datetime-local"] { color-scheme: dark; }
.input-group-text { background: #1e1e1e; border-color: #444; color: #aaa; }
.input-group-append .btn { background: #333; border-color: #444; color: #aaa; }
.input-group-append .btn:hover { background: #444; color: #fff; }

.form-label { font-size: .82rem; font-weight: 700; color: #aaa; margin-bottom: 5px; display: block; }
.req { color: #f857a6; }
.help-text { font-size: .76rem; color: #555; margin-top: 4px; }

/* Type cards */
.type-cards { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; margin-bottom: 6px; }
.type-card { border: 2px solid #3a3a3a; border-radius: 10px; padding: 14px 12px; cursor: pointer; transition: all .2s; text-align: center; position: relative; background: #1e1e1e; }
.type-card:hover { border-color: #f857a6; }
.type-card input { position: absolute; opacity: 0; pointer-events: none; }
.type-card.selected { border-color: #f857a6; background: rgba(248,87,166,.08); }
.type-card i { font-size: 22px; display: block; margin-bottom: 5px; }
.type-card span { font-size: .78rem; font-weight: 700; color: #ccc; }

/* Checkbox */
.form-check-flat .form-check-label { display: flex; align-items: center; gap: 8px; font-size: .88rem; font-weight: 600; cursor: pointer; color: #ccc; }
.form-check-flat .form-check-label input { width: 18px; height: 18px; cursor: pointer; accent-color: #f857a6; }

/* Save button */
.btn-save { background: linear-gradient(135deg, #f857a6 0%, #ff5858 100%); border: none; color: #fff; border-radius: 8px; padding: 11px 28px; font-weight: 700; font-size: .9rem; }
.btn-save:hover { opacity: .9; color: #fff; }

/* Side info */
.side-info { background: rgba(248,87,166,.07); border: 1.5px dashed rgba(248,87,166,.3); border-radius: 10px; padding: 18px; }
.side-info h6 { font-size: .8rem; font-weight: 800; text-transform: uppercase; letter-spacing: .06em; color: #f857a6; margin-bottom: 10px; }
.side-info li { font-size: .82rem; color: #aaa; margin-bottom: 6px; }

/* Cancel btn */
.btn-cancel { background: #333; border: 1px solid #444; color: #aaa; border-radius: 8px; }
.btn-cancel:hover { background: #3a3a3a; color: #fff; }
</style>

<div class="main-panel">
  <div class="content-wrapper">

    <div class="page-header-promo d-flex justify-content-between align-items-center flex-wrap" style="gap:12px;">
      <div>
        <h3><i class="mdi mdi-tag-plus"></i> Add New Coupon</h3>
        <p>Create a discount coupon for your customers</p>
      </div>
      <a href="{% url 'adminpanel:coupon_list' %}" class="btn btn-light btn-sm">
        <i class="mdi mdi-arrow-left"></i> Back to List
      </a>
    </div>

    <nav aria-label="breadcrumb">
      <ol class="breadcrumb bg-transparent p-0 mb-4">
        <li class="breadcrumb-item"><a href="{% url 'adminpanel:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'adminpanel:coupon_list' %}">Promotions</a></li>
        <li class="breadcrumb-item active" style="color:#aaa;">Add Coupon</li>
      </ol>
    </nav>

    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
      {{ message }}<button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
    </div>
    {% endfor %}
    {% endif %}

    <form method="POST" id="couponForm">
      {% csrf_token %}
      <div class="row">

        <!-- LEFT: Main form -->
        <div class="col-md-8">

          <!-- Basic Info -->
          <div class="form-card mb-4">
            <div class="form-card-header"><h5><i class="mdi mdi-tag" style="color:#f857a6;"></i> Basic Information</h5></div>
            <div class="form-card-body">
              <div class="section-title">Coupon Identity</div>
              <div class="row">
                <div class="col-md-6 form-group">
                  <label class="form-label">Coupon Code <span class="req">*</span></label>
                  <div class="input-group">
                    <input type="text" class="form-control font-weight-bold"
                           name="code" id="codeInput"
                           placeholder="e.g. SAVE20" required
                           style="letter-spacing:.1em; font-family:monospace; text-transform:uppercase;"
                           value="{{ form_data.code|default:'' }}">
                    <div class="input-group-append">
                      <button type="button" class="btn" onclick="generateCode()" title="Generate random code">
                        <i class="mdi mdi-autorenew"></i>
                      </button>
                    </div>
                  </div>
                  <p class="help-text">Unique code customers enter at checkout</p>
                </div>
                <div class="col-md-6 form-group">
                  <label class="form-label">Coupon Name <span class="req">*</span></label>
                  <input type="text" class="form-control" name="name"
                         placeholder="e.g. Summer Sale 20% Off" required
                         value="{{ form_data.name|default:'' }}">
                  <p class="help-text">Internal label for this coupon</p>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-control" name="description" rows="2"
                          placeholder="Optional: explain what this coupon offers…">{{ form_data.description|default:'' }}</textarea>
              </div>
            </div>
          </div>

          <!-- Discount Type -->
          <div class="form-card mb-4">
            <div class="form-card-header"><h5><i class="mdi mdi-percent" style="color:#667eea;"></i> Discount Type</h5></div>
            <div class="form-card-body">
              <div class="section-title">Choose Type</div>
              <div class="type-cards" id="typeCards">
                <label class="type-card {% if form_data.discount_type == 'percentage' or not form_data.discount_type %}selected{% endif %}" onclick="selectType(this,'percentage')">
                  <input type="radio" name="discount_type" value="percentage"
                         {% if form_data.discount_type == 'percentage' or not form_data.discount_type %}checked{% endif %}>
                  <i class="mdi mdi-percent" style="color:#667eea;"></i>
                  <span>Percentage</span>
                </label>
                <label class="type-card {% if form_data.discount_type == 'fixed_amount' %}selected{% endif %}" onclick="selectType(this,'fixed_amount')">
                  <input type="radio" name="discount_type" value="fixed_amount"
                         {% if form_data.discount_type == 'fixed_amount' %}checked{% endif %}>
                  <i class="mdi mdi-cash" style="color:#1bcfb4;"></i>
                  <span>Fixed Amount</span>
                </label>
                <label class="type-card {% if form_data.discount_type == 'free_shipping' %}selected{% endif %}" onclick="selectType(this,'free_shipping')">
                  <input type="radio" name="discount_type" value="free_shipping"
                         {% if form_data.discount_type == 'free_shipping' %}checked{% endif %}>
                  <i class="mdi mdi-truck" style="color:#fd7e14;"></i>
                  <span>Free Shipping</span>
                </label>
              </div>

              <div class="row mt-3" id="discountValueRow">
                <div class="col-md-6 form-group">
                  <label class="form-label" id="discountValueLabel">Discount Value <span class="req">*</span></label>
                  <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text" id="valuePrefix">%</span></div>
                    <input type="number" class="form-control" name="discount_value" id="discountValueInput"
                           placeholder="0" step="0.01" min="0"
                           value="{{ form_data.discount_value|default:'' }}">
                  </div>
                </div>
                <div class="col-md-6 form-group">
                  <label class="form-label">Maximum Discount Cap (QAR)</label>
                  <input type="number" class="form-control" name="maximum_discount_amount"
                         placeholder="Leave blank for no cap" step="0.01" min="0"
                         value="{{ form_data.maximum_discount_amount|default:'' }}">
                  <p class="help-text">Only applies to percentage discounts</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Conditions -->
          <div class="form-card mb-4">
            <div class="form-card-header"><h5><i class="mdi mdi-filter" style="color:#1bcfb4;"></i> Conditions & Limits</h5></div>
            <div class="form-card-body">
              <div class="section-title">Order Conditions</div>
              <div class="row">
                <div class="col-md-6 form-group">
                  <label class="form-label">Minimum Order Amount (QAR)</label>
                  <input type="number" class="form-control" name="minimum_order_amount"
                         placeholder="Leave blank for no minimum" step="0.01" min="0"
                         value="{{ form_data.minimum_order_amount|default:'' }}">
                </div>
              </div>
              <div class="section-title mt-3">Usage Limits</div>
              <div class="row">
                <div class="col-md-6 form-group">
                  <label class="form-label">Total Usage Limit</label>
                  <input type="number" class="form-control" name="usage_limit"
                         placeholder="Leave blank for unlimited" min="1"
                         value="{{ form_data.usage_limit|default:'' }}">
                  <p class="help-text">Total times this coupon can be used across all customers</p>
                </div>
                <div class="col-md-6 form-group">
                  <label class="form-label">Limit Per Customer</label>
                  <input type="number" class="form-control" name="usage_limit_per_customer"
                         placeholder="Leave blank for unlimited" min="1"
                         value="{{ form_data.usage_limit_per_customer|default:'' }}">
                  <p class="help-text">How many times each customer can use this coupon</p>
                </div>
              </div>
            </div>
          </div>

          <!-- ── VALIDITY (FIXED) ── -->
          <div class="form-card mb-4">
            <div class="form-card-header"><h5><i class="mdi mdi-calendar" style="color:#fd7e14;"></i> Validity Period</h5></div>
            <div class="form-card-body">
              <div class="row">
                <div class="col-md-6 form-group">
                  <label class="form-label">Valid From <span class="req">*</span></label>
                  <!--
                    FIX: datetime-local needs value in "YYYY-MM-DDTHH:MM" format.
                    We use a plain date input + time input and combine them server-side,
                    OR we use datetime-local with JS to pre-fill today as default.
                  -->
                  <input type="datetime-local" class="form-control" name="valid_from" id="validFrom" required
                         value="{{ form_data.valid_from|default:'' }}">
                  <p class="help-text">Format: YYYY-MM-DD HH:MM (e.g. 2025-06-01 00:00)</p>
                </div>
                <div class="col-md-6 form-group">
                  <label class="form-label">Valid Until <span class="req">*</span></label>
                  <input type="datetime-local" class="form-control" name="valid_until" id="validUntil" required
                         value="{{ form_data.valid_until|default:'' }}">
                  <p class="help-text">Format: YYYY-MM-DD HH:MM (e.g. 2025-12-31 23:59)</p>
                </div>
              </div>
              <!-- Quick date shortcuts -->
              <div class="d-flex flex-wrap gap-2 mt-1" style="gap:8px;">
                <span style="font-size:.77rem;color:#666;margin-right:4px;align-self:center;">Quick set end date:</span>
                <button type="button" class="btn btn-sm btn-outline-secondary" style="font-size:.75rem;border-color:#444;color:#aaa;" onclick="setEndDate(7)">+7 days</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" style="font-size:.75rem;border-color:#444;color:#aaa;" onclick="setEndDate(30)">+30 days</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" style="font-size:.75rem;border-color:#444;color:#aaa;" onclick="setEndDate(90)">+90 days</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" style="font-size:.75rem;border-color:#444;color:#aaa;" onclick="setEndDate(365)">+1 year</button>
              </div>
            </div>
          </div>

        </div>

        <!-- RIGHT: Settings Sidebar -->
        <div class="col-md-4">
          <div class="form-card mb-4">
            <div class="form-card-header"><h5><i class="mdi mdi-cog" style="color:#f857a6;"></i> Settings</h5></div>
            <div class="form-card-body">
              <div class="form-check form-check-flat mb-3">
                <label class="form-check-label">
                  <input type="checkbox" class="form-check-input" name="is_active"
                         {% if not form_data or form_data.is_active %}checked{% endif %}>
                  Active (visible to customers)
                </label>
              </div>
              <div class="form-check form-check-flat mb-3">
                <label class="form-check-label">
                  <input type="checkbox" class="form-check-input" name="applicable_to_all"
                         {% if not form_data or form_data.applicable_to_all %}checked{% endif %}>
                  Apply to all products
                </label>
              </div>
              <hr style="border-color:#3a3a3a;">
              <button type="submit" class="btn-save btn btn-block">
                <i class="mdi mdi-check"></i> Save Coupon
              </button>
              <a href="{% url 'adminpanel:coupon_list' %}" class="btn btn-cancel btn-block mt-2">
                Cancel
              </a>
            </div>
          </div>

          <div class="side-info">
            <h6><i class="mdi mdi-lightbulb-on"></i> Tips</h6>
            <ul class="list-unstyled mb-0">
              <li><i class="mdi mdi-check text-success mr-1"></i> Use ALL CAPS codes (e.g. SAVE20)</li>
              <li><i class="mdi mdi-check text-success mr-1"></i> Set a usage limit to create urgency</li>
              <li><i class="mdi mdi-check text-success mr-1"></i> Min. order amount increases cart value</li>
              <li><i class="mdi mdi-check text-success mr-1"></i> Percentage discounts auto-cap with max</li>
              <li><i class="mdi mdi-check text-success mr-1"></i> Deactivate instead of deleting used coupons</li>
            </ul>
          </div>
        </div>

      </div>
    </form>

  </div>
</div>

<script>
// ── Auto-set "Valid From" to now on page load if empty ──
document.addEventListener('DOMContentLoaded', function() {
    var fromField = document.getElementById('validFrom');
    var untilField = document.getElementById('validUntil');

    // Pre-fill valid_from with current datetime if empty
    if (!fromField.value) {
        var now = new Date();
        fromField.value = toDatetimeLocal(now);
    }

    // Init discount type display
    var selected = document.querySelector('input[name="discount_type"]:checked');
    if (selected && selected.value === 'free_shipping') {
        document.getElementById('discountValueRow').style.display = 'none';
    } else if (selected && selected.value === 'fixed_amount') {
        document.getElementById('valuePrefix').textContent = 'QAR';
    }
});

function toDatetimeLocal(dt) {
    // Returns "YYYY-MM-DDTHH:MM" for datetime-local input
    var pad = function(n){ return String(n).padStart(2,'0'); };
    return dt.getFullYear() + '-' + pad(dt.getMonth()+1) + '-' + pad(dt.getDate()) +
           'T' + pad(dt.getHours()) + ':' + pad(dt.getMinutes());
}

function setEndDate(days) {
    var fromVal = document.getElementById('validFrom').value;
    var base = fromVal ? new Date(fromVal) : new Date();
    base.setDate(base.getDate() + days);
    document.getElementById('validUntil').value = toDatetimeLocal(base);
}

function selectType(label, type) {
    document.querySelectorAll('.type-card').forEach(function(c){ c.classList.remove('selected'); });
    label.classList.add('selected');
    var prefix = document.getElementById('valuePrefix');
    var valLabel = document.getElementById('discountValueLabel');
    var valInput = document.getElementById('discountValueInput');
    var row = document.getElementById('discountValueRow');
    if (type === 'percentage') {
        prefix.textContent = '%';
        valLabel.innerHTML = 'Discount Value <span class="req">*</span>';
        valInput.placeholder = '0'; row.style.display = '';
        valInput.max = 100;
    } else if (type === 'fixed_amount') {
        prefix.textContent = 'QAR';
        valLabel.innerHTML = 'Discount Amount <span class="req">*</span>';
        valInput.placeholder = '0.00'; row.style.display = '';
        valInput.removeAttribute('max');
    } else {
        row.style.display = 'none';
    }
}

function generateCode() {
    var chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    var code = '';
    for (var i = 0; i < 8; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
    document.getElementById('codeInput').value = code;
}

document.getElementById('codeInput').addEventListener('input', function() {
    this.value = this.value.toUpperCase().replace(/[^A-Z0-9\-_]/g,'');
});

// Validate dates on submit
document.getElementById('couponForm').addEventListener('submit', function(e) {
    var from  = document.getElementById('validFrom').value;
    var until = document.getElementById('validUntil').value;
    if (!from || !until) {
        e.preventDefault();
        alert('Please set both Valid From and Valid Until dates.');
        return;
    }
    if (new Date(until) <= new Date(from)) {
        e.preventDefault();
        alert('Valid Until must be after Valid From.');
        return;
    }
});
</script>
{% endblock %}