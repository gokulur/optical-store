{% extends 'admin-dashboard.html' %}
{% load static %}
{% block content %}
<style>
.page-header-promo { background: linear-gradient(135deg, #f857a6 0%, #ff5858 100%); padding: 22px 26px; border-radius: 10px; margin-bottom: 24px; color: #fff; }
.page-header-promo h3 { margin: 0 0 4px; font-size: 1.3rem; font-weight: 700; }
.page-header-promo p  { margin: 0; opacity: .8; font-size: .85rem; }
.main-card { background: #fff; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,.07); overflow: hidden; }
.main-card-header { padding: 18px 22px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
.main-card-header h5 { margin: 0; font-weight: 700; font-size: 1rem; }
.table thead th { background: #f8f9fa; font-size: .75rem; font-weight: 700; text-transform: uppercase; letter-spacing: .06em; color: #888; border: none; padding: 12px 16px; }
.table tbody td { padding: 13px 16px; vertical-align: middle; border-color: #f5f5f5; font-size: .875rem; }
.coupon-code-badge { font-family: monospace; background: linear-gradient(135deg, #1a1a1a, #333); color: #fff; padding: 4px 10px; border-radius: 5px; font-size: .78rem; font-weight: 700; letter-spacing: .08em; }
.discount-chip { background: rgba(248,87,166,.1); color: #f857a6; padding: 4px 12px; border-radius: 20px; font-size: .8rem; font-weight: 700; }
.stats-row { display: grid; grid-template-columns: repeat(3,1fr); gap: 16px; margin-bottom: 24px; }
.stat-box { background: #fff; border-radius: 10px; padding: 18px 20px; box-shadow: 0 2px 10px rgba(0,0,0,.07); border-left: 4px solid; display: flex; align-items: center; gap: 14px; }
.stat-box.pink  { border-left-color: #f857a6; }
.stat-box.green { border-left-color: #1bcfb4; }
.stat-box.blue  { border-left-color: #667eea; }
.stat-icon { width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
.stat-box.pink  .stat-icon { background: rgba(248,87,166,.12); color: #f857a6; }
.stat-box.green .stat-icon { background: rgba(27,207,180,.12); color: #1bcfb4; }
.stat-box.blue  .stat-icon { background: rgba(102,126,234,.12); color: #667eea; }
.stat-label { font-size: .74rem; color: #999; font-weight: 600; text-transform: uppercase; }
.stat-value { font-size: 1.4rem; font-weight: 800; color: #1a1a1a; }
.filter-card { background: #fff; border-radius: 10px; padding: 16px 20px; box-shadow: 0 2px 8px rgba(0,0,0,.06); margin-bottom: 22px; }
.filter-card .form-control { border-radius: 8px; border: 1.5px solid #e0e0e0; font-size: .86rem; }
.filter-card .form-control:focus { border-color: #f857a6; box-shadow: 0 0 0 3px rgba(248,87,166,.15); }
</style>

<div class="main-panel">
  <div class="content-wrapper">

    <div class="page-header-promo d-flex justify-content-between align-items-center flex-wrap" style="gap:12px;">
      <div>
        <h3><i class="mdi mdi-history"></i> Coupon Usage History</h3>
        <p>Every time a coupon was applied to an order</p>
      </div>
      <a href="{% url 'adminpanel:coupon_list' %}" class="btn btn-light btn-sm">
        <i class="mdi mdi-arrow-left"></i> Back to Coupons
      </a>
    </div>

    <nav aria-label="breadcrumb">
      <ol class="breadcrumb bg-transparent p-0 mb-4">
        <li class="breadcrumb-item"><a href="{% url 'adminpanel:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'adminpanel:coupon_list' %}">Promotions</a></li>
        <li class="breadcrumb-item active">Usage History</li>
      </ol>
    </nav>

    <div class="stats-row">
      <div class="stat-box pink">
        <div class="stat-icon"><i class="mdi mdi-history"></i></div>
        <div><div class="stat-label">Total Uses</div><div class="stat-value">{{ usage.paginator.count }}</div></div>
      </div>
      <div class="stat-box green">
        <div class="stat-icon"><i class="mdi mdi-cash-multiple"></i></div>
        <div><div class="stat-label">Total Discounts Given</div><div class="stat-value">{{ total_discount|floatformat:2 }} QAR</div></div>
      </div>
      <div class="stat-box blue">
        <div class="stat-icon"><i class="mdi mdi-account-group"></i></div>
        <div><div class="stat-label">Unique Customers</div><div class="stat-value">{{ unique_customers }}</div></div>
      </div>
    </div>

    <div class="filter-card">
      <form method="GET">
        <div class="row align-items-end">
          <div class="col-md-5">
            <div class="input-group">
              <div class="input-group-prepend"><span class="input-group-text bg-white"><i class="mdi mdi-magnify"></i></span></div>
              <input type="text" class="form-control" name="search" placeholder="Coupon code, order #, or customer email…" value="{{ search }}">
            </div>
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-primary btn-block" style="border-radius:8px;"><i class="mdi mdi-filter"></i> Search</button>
          </div>
          <div class="col-md-2">
            <a href="{% url 'adminpanel:coupon_usage_history' %}" class="btn btn-light btn-block" style="border-radius:8px;"><i class="mdi mdi-refresh"></i> Reset</a>
          </div>
        </div>
      </form>
    </div>

    <div class="main-card">
      <div class="main-card-header">
        <h5><i class="mdi mdi-table text-muted mr-1"></i> Usage Records</h5>
        <small class="text-muted">{{ usage.paginator.count }} record{{ usage.paginator.count|pluralize }}</small>
      </div>
      <div class="card-body p-0">
        {% if usage %}
        <div class="table-responsive">
          <table class="table mb-0">
            <thead>
              <tr>
                <th>#</th>
                <th>Coupon Code</th>
                <th>Customer</th>
                <th>Order</th>
                <th>Discount Given</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              {% for record in usage %}
              <tr>
                <td class="text-muted">{{ forloop.counter }}</td>
                <td><span class="coupon-code-badge">{{ record.coupon.code }}</span></td>
                <td>
                  <div style="font-size:.88rem;font-weight:600;">{{ record.user.get_full_name|default:record.user.username }}</div>
                  <small class="text-muted">{{ record.user.email }}</small>
                </td>
                <td>
                  <a href="{% url 'adminpanel:order_detail' record.order.id %}" class="text-primary font-weight-600">
                    #{{ record.order.order_number }}
                  </a>
                </td>
                <td><span class="discount-chip">-{{ record.discount_amount }} QAR</span></td>
                <td><small class="text-muted">{{ record.created_at|date:"d M Y, H:i" }}</small></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {% if usage.has_other_pages %}
        <div class="px-4 py-3">
          <nav>
            <ul class="pagination justify-content-center mb-0">
              {% if usage.has_previous %}
              <li class="page-item"><a class="page-link" href="?page={{ usage.previous_page_number }}{% if search %}&search={{ search }}{% endif %}">‹</a></li>
              {% endif %}
              {% for num in usage.paginator.page_range %}
              {% if usage.number == num %}<li class="page-item active"><span class="page-link">{{ num }}</span></li>
              {% elif num > usage.number|add:'-3' and num < usage.number|add:'3' %}
              <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
              {% endif %}
              {% endfor %}
              {% if usage.has_next %}
              <li class="page-item"><a class="page-link" href="?page={{ usage.next_page_number }}{% if search %}&search={{ search }}{% endif %}">›</a></li>
              {% endif %}
            </ul>
          </nav>
        </div>
        {% endif %}

        {% else %}
        <div style="padding:60px 20px;text-align:center;color:#ccc;">
          <i class="mdi mdi-history" style="font-size:56px;"></i>
          <h5 class="mt-3 text-muted">No usage records yet</h5>
        </div>
        {% endif %}
      </div>
    </div>

  </div>
</div>
{% endblock %}