{% extends 'admin-dashboard.html' %}
{% load static %}
{% block content %}

<style>
  /* Reuse your existing styles */
  .form-control:focus { border-color: #b66dff; box-shadow: 0 0 0 0.2rem rgba(182, 109, 255, 0.25); }
  .card { box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); transition: all 0.3s ease; }
  .image-preview { max-width: 200px; max-height: 200px; margin-top: 10px; border-radius: 8px; }
  .current-logo { max-width: 150px; max-height: 80px; object-fit: contain; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 5px; }
  .custom-file-label::after { content: "Browse"; }
  .btn-gradient-primary { background: linear-gradient(to right, #da8cff, #9a55ff); border: 0; color: white; }
  .btn-gradient-primary:hover { background: linear-gradient(to right, #9a55ff, #da8cff); color: white; }
  .page-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
  
  /* Availability Checkbox Cards */
  .availability-section { background-color: #f8f9fa; padding: 20px; border-radius: 8px; border: 2px solid #e9ecef; }
  .checkbox-card { background: white; padding: 15px; border-radius: 8px; border: 2px solid #e9ecef; transition: all 0.3s ease; cursor: pointer; height: 100%; }
  .checkbox-card:hover { border-color: #b66dff; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(182, 109, 255, 0.2); }
  .checkbox-card.checked { border-color: #b66dff; background-color: rgba(182, 109, 255, 0.1); }
  .checkbox-card input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
  .checkbox-card label { cursor: pointer; margin-bottom: 0; }
  .icon-box { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-bottom: 10px; }
  
  .icon-box.sunglasses { background-color: rgba(255, 193, 7, 0.2); color: #ffc107; }
  .icon-box.eyeglasses { background-color: rgba(0, 123, 255, 0.2); color: #007bff; }
  .icon-box.kids { background-color: rgba(40, 167, 69, 0.2); color: #28a745; }
  .icon-box.contact-lenses { background-color: rgba(23, 162, 184, 0.2); color: #17a2b8; }
</style>

<div class="main-panel">
  <div class="content-wrapper">

    <div class="page-header">
      <h3 class="mb-2"><i class="mdi mdi-pencil"></i> Edit Brand</h3>
      <p class="mb-0">Update brand details - <strong>{{ brand.name }}</strong></p>
    </div>

    <nav aria-label="breadcrumb">
      <ol class="breadcrumb bg-transparent p-0 mb-4">
        <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="#">Catalog</a></li>
        <li class="breadcrumb-item"><a href="{% url 'adminpanel:brand_list' %}">Brands</a></li>
        <li class="breadcrumb-item active" aria-current="page">Edit Brand</li>
      </ol>
    </nav>

    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      <strong>
        {% if message.tags == 'success' %} <i class="mdi mdi-check-circle"></i>
        {% elif message.tags == 'error' %} <i class="mdi mdi-alert-circle"></i>
        {% else %} <i class="mdi mdi-information"></i> {% endif %}
      </strong>
      {{ message }}
      <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    {% endfor %}
    {% endif %}

    <div class="row">
      <div class="col-md-12 grid-margin stretch-card">
        <div class="card">
          <div class="card-body">
            <h4 class="card-title mb-4"><i class="mdi mdi-form-select"></i> Brand Information</h4>

            <form method="POST" enctype="multipart/form-data" id="brandForm">
              {% csrf_token %}

              <div class="row">
                <div class="col-md-6">
                  
                  <div class="form-group">
                    <label for="name" class="font-weight-bold">Brand Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control form-control-lg" id="name" name="name" 
                           placeholder="Enter brand name" value="{{ brand.name }}" required>
                  </div>

                  <div class="form-group">
                    <label for="slug" class="font-weight-bold">Slug <span class="text-danger">*</span></label>
                    <input type="text" class="form-control form-control-lg" id="slug" name="slug" 
                           placeholder="brand-slug" value="{{ brand.slug }}" required>
                  </div>

                  <div class="form-group">
                    <label class="font-weight-bold">Brand Logo</label>
                    
                    {% if brand.logo %}
                    <div class="mb-2">
                        <label class="d-block text-muted small">Current Logo:</label>
                        <img src="{{ brand.logo.url }}" alt="{{ brand.name }}" class="current-logo">
                    </div>
                    {% endif %}

                    <div class="custom-file">
                      <input type="file" class="custom-file-input" id="logo" name="logo" accept="image/*" onchange="previewImage(event)">
                      <label class="custom-file-label" for="logo">{% if brand.logo %}Change Logo...{% else %}Choose Logo...{% endif %}</label>
                    </div>
                    <small class="form-text text-muted">Recommended: 400x200px (PNG)</small>
                    <img id="imagePreview" class="image-preview" style="display: none;" alt="New Logo Preview">
                  </div>

                  <div class="form-group">
                    <label for="description" class="font-weight-bold">Description</label>
                    <textarea class="form-control" id="description" name="description" rows="5">{{ brand.description }}</textarea>
                  </div>

                </div>

                <div class="col-md-6">

                  <div class="form-group">
                    <label class="font-weight-bold mb-3"><i class="mdi mdi-checkbox-multiple-marked"></i> Brand Availability</label>
                    
                    <div class="availability-section">
                      <div class="row">
                        <div class="col-md-6 mb-3">
                          <div class="checkbox-card {% if brand.available_for_sunglasses %}checked{% endif %}" onclick="toggleCheckbox('sunglasses', event)">
                            <div class="text-center">
                              <div class="icon-box sunglasses mx-auto"><i class="mdi mdi-sunglasses"></i></div>
                              <div class="form-check">
                                <label class="form-check-label">
                                  <input type="checkbox" class="form-check-input" name="available_for_sunglasses" id="sunglasses"
                                         {% if brand.available_for_sunglasses %}checked{% endif %}>
                                  <span class="font-weight-bold">Sunglasses</span>
                                  <i class="input-helper"></i>
                                </label>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div class="col-md-6 mb-3">
                          <div class="checkbox-card {% if brand.available_for_eyeglasses %}checked{% endif %}" onclick="toggleCheckbox('eyeglasses', event)">
                            <div class="text-center">
                              <div class="icon-box eyeglasses mx-auto"><i class="mdi mdi-glasses"></i></div>
                              <div class="form-check">
                                <label class="form-check-label">
                                  <input type="checkbox" class="form-check-input" name="available_for_eyeglasses" id="eyeglasses"
                                         {% if brand.available_for_eyeglasses %}checked{% endif %}>
                                  <span class="font-weight-bold">Eyeglasses</span>
                                  <i class="input-helper"></i>
                                </label>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div class="col-md-6 mb-3">
                          <div class="checkbox-card {% if brand.available_for_kids %}checked{% endif %}" onclick="toggleCheckbox('kids', event)">
                            <div class="text-center">
                              <div class="icon-box kids mx-auto"><i class="mdi mdi-human-child"></i></div>
                              <div class="form-check">
                                <label class="form-check-label">
                                  <input type="checkbox" class="form-check-input" name="available_for_kids" id="kids"
                                         {% if brand.available_for_kids %}checked{% endif %}>
                                  <span class="font-weight-bold">Kids</span>
                                  <i class="input-helper"></i>
                                </label>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div class="col-md-6 mb-3">
                          <div class="checkbox-card {% if brand.available_for_contact_lenses %}checked{% endif %}" onclick="toggleCheckbox('contact_lenses', event)">
                            <div class="text-center">
                              <div class="icon-box contact-lenses mx-auto"><i class="mdi mdi-eye"></i></div>
                              <div class="form-check">
                                <label class="form-check-label">
                                  <input type="checkbox" class="form-check-input" name="available_for_contact_lenses" id="contact_lenses"
                                         {% if brand.available_for_contact_lenses %}checked{% endif %}>
                                  <span class="font-weight-bold">Contact Lenses</span>
                                  <i class="input-helper"></i>
                                </label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="form-group mt-3">
                    <label for="display_order" class="font-weight-bold">Display Order</label>
                    <input type="number" class="form-control form-control-lg" id="display_order" name="display_order" value="{{ brand.display_order }}" min="0">
                  </div>

                  <div class="form-group">
                    <div class="form-check form-check-success">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" name="is_active" {% if brand.is_active %}checked{% endif %}>
                        <span class="font-weight-bold">Active</span>
                        <i class="input-helper"></i>
                      </label>
                    </div>
                  </div>

                </div>
              </div>

              <div class="row mt-4">
                <div class="col-12">
                  <hr>
                  <button type="submit" class="btn btn-gradient-primary btn-lg mr-2">
                    <i class="mdi mdi-check"></i> Update Brand
                  </button>
                  <a href="{% url 'adminpanel:brand_list' %}" class="btn btn-light btn-lg">
                    <i class="mdi mdi-close"></i> Cancel
                  </a>
                </div>
              </div>

            </form>

          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  // 1. Slug Generator
  document.getElementById('name').addEventListener('input', function(e) {
    const slug = e.target.value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
    document.getElementById('slug').value = slug;
  });

  // 2. Image Preview
  function previewImage(event) {
    const reader = new FileReader();
    const imagePreview = document.getElementById('imagePreview');
    const file = event.target.files[0];
    if (file) {
      reader.onload = function(e) {
        imagePreview.src = e.target.result;
        imagePreview.style.display = 'block';
      };
      reader.readAsDataURL(file);
      event.target.nextElementSibling.textContent = file.name;
    }
  }

  // 3. âœ… FIXED: Toggle Checkbox logic
  function toggleCheckbox(id, event) {
    // If user clicked the actual checkbox input or label, let browser handle it
    // We only manually toggle if they clicked the 'card' background
    if (event.target.type === 'checkbox' || event.target.tagName === 'LABEL') {
       // Just update style based on new state
       const checkbox = document.getElementById(id);
       const card = checkbox.closest('.checkbox-card');
       if (checkbox.checked) card.classList.add('checked');
       else card.classList.remove('checked');
       return;
    }

    // Manual toggle for card click
    const checkbox = document.getElementById(id);
    const card = checkbox.closest('.checkbox-card');
    
    checkbox.checked = !checkbox.checked;
    
    if (checkbox.checked) {
      card.classList.add('checked');
    } else {
      card.classList.remove('checked');
    }
  }
</script>

{% endblock %}