{% extends 'admin-dashboard.html' %}
{% load static %}
{% block content %}

<style>
  .form-control:focus { border-color: #b66dff; box-shadow: 0 0 0 0.2rem rgba(182,109,255,0.25); }
  .card { box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075); }
  .btn-gradient-primary { background: linear-gradient(to right, #da8cff, #9a55ff); border: 0; color: white; }
  .btn-gradient-primary:hover { background: linear-gradient(to right, #9a55ff, #da8cff); color: white; }
  .page-header { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
  .info-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 18px 20px; border-radius: 8px; margin-bottom: 20px; }
  .section-card { border-radius: 8px; padding: 20px; margin-bottom: 20px; }
  .section-card.purple { background: #f3eeff; border: 1px solid #c9a8ff; }
  .section-card.yellow { background: #fff8e1; border: 1px solid #ffe082; }
  .section-card.green  { background: #e8f5e9; border: 1px solid #a5d6a7; }
  .section-card.blue   { background: #e3f2fd; border: 1px solid #90caf9; }
  .section-title { font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 15px; }
  .image-preview-box { border: 2px dashed #dee2e6; border-radius: 8px; padding: 12px; background: #f8f9fa; min-height: 100px; display: flex; align-items: center; justify-content: center; flex-direction: column; }
  .image-preview-box img { max-width: 100%; max-height: 150px; border-radius: 6px; }
  .current-img { max-width: 100%; max-height: 150px; border-radius: 6px; border: 2px solid #e0e0e0; }
  .custom-file-label::after { content: "Browse"; }
  .remove-btn { font-size: 11px; margin-top: 6px; }
</style>

<div class="main-panel">
  <div class="content-wrapper">

    <div class="page-header">
      <h3 class="mb-2"><i class="mdi mdi-pencil"></i> Edit Banner</h3>
      <p class="mb-0">Updating: <strong>{{ banner.title }}</strong></p>
    </div>

    <nav aria-label="breadcrumb">
      <ol class="breadcrumb bg-transparent p-0 mb-3">
        <li class="breadcrumb-item"><a href="{% url 'adminpanel:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'adminpanel:banner_list' %}">Banners</a></li>
        <li class="breadcrumb-item active">Edit Banner</li>
      </ol>
    </nav>

    <!-- Info bar -->
    <div class="info-card d-flex justify-content-between align-items-center">
      <div>
        <p class="mb-1"><i class="mdi mdi-tag-outline"></i> <strong>ID:</strong> #{{ banner.id }} &nbsp;|&nbsp;
           <i class="mdi mdi-clock-outline"></i> <strong>Updated:</strong> {{ banner.updated_at|date:"d M Y, h:i A" }}
        </p>
        <p class="mb-0">
          <span class="badge badge-light text-dark mr-1">{{ banner.get_banner_type_display }}</span>
          <span class="badge badge-light text-dark">{{ banner.get_placement_display }}</span>
        </p>
      </div>
      <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#deleteModal">
        <i class="mdi mdi-delete"></i> Delete
      </button>
    </div>

    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
      {{ message }}
      <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
    </div>
    {% endfor %}
    {% endif %}

    <form method="POST" enctype="multipart/form-data" id="bannerForm">
      {% csrf_token %}
      <div class="row">

        <!-- ── LEFT COLUMN ── -->
        <div class="col-md-6">

          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-4"><i class="mdi mdi-information-outline text-primary"></i> Basic Info</h5>

              <div class="form-group">
                <label class="font-weight-bold">Banner Title <span class="text-danger">*</span></label>
                <input type="text" class="form-control form-control-lg" name="title" value="{{ banner.title }}" required>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="font-weight-bold">Banner Type <span class="text-danger">*</span></label>
                    <select class="form-control form-control-lg" name="banner_type" required>
                      {% for value, label in banner_types %}
                      <option value="{{ value }}" {% if banner.banner_type == value %}selected{% endif %}>{{ label }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="font-weight-bold">Placement <span class="text-danger">*</span></label>
                    <select class="form-control form-control-lg" name="placement" required>
                      {% for value, label in placement_choices %}
                      <option value="{{ value }}" {% if banner.placement == value %}selected{% endif %}>{{ label }}</option>
                      {% endfor %}
                    </select>
                    <small class="text-muted">Use <strong>Main Slider</strong> to show on homepage hero</small>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="font-weight-bold">Display Order</label>
                    <input type="number" class="form-control" name="display_order" value="{{ banner.display_order }}" min="0">
                  </div>
                </div>
                <div class="col-md-6 d-flex align-items-center">
                  <div class="form-check form-check-flat form-check-primary mt-3">
                    <label class="form-check-label">
                      <input type="checkbox" class="form-check-input" name="is_active" {% if banner.is_active %}checked{% endif %}>
                      <span class="font-weight-bold">Active</span>
                      <i class="input-helper"></i>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Slide Text -->
          <div class="section-card purple">
            <p class="section-title"><i class="mdi mdi-text-box-outline"></i> Slide Text Content</p>
            <div class="form-group">
              <label class="font-weight-bold">Slide Heading</label>
              <input type="text" class="form-control" name="slide_heading" value="{{ banner.slide_heading }}">
            </div>
            <div class="form-group">
              <label class="font-weight-bold">Slide Description</label>
              <textarea class="form-control" name="slide_description" rows="2">{{ banner.slide_description }}</textarea>
            </div>
            <div class="form-group mb-0">
              <label class="font-weight-bold">CTA Button Text</label>
              <input type="text" class="form-control" name="cta_text" value="{{ banner.cta_text }}">
            </div>
          </div>

          <!-- Link Settings -->
          <div class="section-card blue mt-3">
            <p class="section-title"><i class="mdi mdi-link-variant"></i> Link Settings</p>
            <div class="form-group">
              <label class="font-weight-bold">Link Type</label>
              <select class="form-control" name="link_type">
                <option value="">-- No Link --</option>
                {% for value, label in link_type_choices %}
                <option value="{{ value }}" {% if banner.link_type == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group">
              <label class="font-weight-bold">Link URL</label>
              <input type="text" class="form-control" name="link_url" value="{{ banner.link_url }}">
            </div>
            <div class="form-group mb-0">
              <label class="font-weight-bold">Linked Product ID</label>
              <input type="number" class="form-control" name="linked_product_id" value="{{ banner.linked_product_id|default:'' }}">
            </div>
          </div>

        </div>

        <!-- ── RIGHT COLUMN ── -->
        <div class="col-md-6">

          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-4"><i class="mdi mdi-image-multiple text-success"></i> Banner Images</h5>

              <!-- Desktop -->
              <div class="form-group">
                <label class="font-weight-bold">Desktop Image <span class="text-danger">*</span></label>
                {% if banner.image_desktop %}
                <div class="mb-2 text-center">
                  <img src="{{ banner.image_desktop.url }}" class="current-img" alt="Current desktop">
                  <br><small class="text-muted">Current image</small>
                </div>
                {% endif %}
                <div class="custom-file">
                  <input type="file" class="custom-file-input" name="image_desktop" id="image_desktop" accept="image/*"
                    onchange="previewImg(event,'desktopPreview','desktopPreviewBox','desktopLabel')">
                  <label class="custom-file-label" id="desktopLabel" for="image_desktop">
                    {% if banner.image_desktop %}Replace image...{% else %}Choose desktop image...{% endif %}
                  </label>
                </div>
                <div class="image-preview-box mt-2" id="desktopPreviewBox" style="display:none;">
                  <img id="desktopPreview" alt="New preview">
                  <small class="text-muted mt-1">New image preview</small>
                </div>
              </div>

              <!-- Mobile -->
              <div class="form-group">
                <label class="font-weight-bold">Mobile Image <small class="text-muted">(optional)</small></label>
                {% if banner.image_mobile %}
                <div class="mb-2 text-center">
                  <img src="{{ banner.image_mobile.url }}" class="current-img" style="max-height:80px;" alt="Current mobile">
                  <br>
                  <button type="button" class="btn btn-outline-danger btn-sm remove-btn" onclick="removeImg('remove_image_mobile', this)">
                    <i class="mdi mdi-close"></i> Remove mobile image
                  </button>
                  <input type="hidden" name="remove_image_mobile" id="remove_image_mobile" value="0">
                </div>
                {% endif %}
                <div class="custom-file">
                  <input type="file" class="custom-file-input" name="image_mobile" id="image_mobile" accept="image/*"
                    onchange="previewImg(event,'mobilePreview','mobilePreviewBox','mobileLabel')">
                  <label class="custom-file-label" id="mobileLabel" for="image_mobile">Choose mobile image...</label>
                </div>
                <div class="image-preview-box mt-2" id="mobilePreviewBox" style="display:none;">
                  <img id="mobilePreview" alt="Preview" style="max-height:80px;">
                </div>
              </div>

              <!-- Tablet -->
              <div class="form-group mb-0">
                <label class="font-weight-bold">Tablet Image <small class="text-muted">(optional)</small></label>
                {% if banner.image_tablet %}
                <div class="mb-2 text-center">
                  <img src="{{ banner.image_tablet.url }}" class="current-img" style="max-height:80px;" alt="Current tablet">
                  <br>
                  <button type="button" class="btn btn-outline-danger btn-sm remove-btn" onclick="removeImg('remove_image_tablet', this)">
                    <i class="mdi mdi-close"></i> Remove tablet image
                  </button>
                  <input type="hidden" name="remove_image_tablet" id="remove_image_tablet" value="0">
                </div>
                {% endif %}
                <div class="custom-file">
                  <input type="file" class="custom-file-input" name="image_tablet" id="image_tablet" accept="image/*"
                    onchange="previewImg(event,'tabletPreview','tabletPreviewBox','tabletLabel')">
                  <label class="custom-file-label" id="tabletLabel" for="image_tablet">Choose tablet image...</label>
                </div>
                <div class="image-preview-box mt-2" id="tabletPreviewBox" style="display:none;">
                  <img id="tabletPreview" alt="Preview" style="max-height:80px;">
                </div>
              </div>
            </div>
          </div>

          <!-- Schedule -->
          <div class="section-card yellow">
            <p class="section-title text-warning"><i class="mdi mdi-calendar-clock"></i> Schedule</p>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group mb-0">
                  <label class="font-weight-bold small">Start Date & Time</label>
                  <input type="datetime-local" class="form-control" name="start_date"
                    value="{% if banner.start_date %}{{ banner.start_date|date:'Y-m-d' }}T{{ banner.start_date|date:'H:i' }}{% endif %}">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group mb-0">
                  <label class="font-weight-bold small">End Date & Time</label>
                  <input type="datetime-local" class="form-control" name="end_date"
                    value="{% if banner.end_date %}{{ banner.end_date|date:'Y-m-d' }}T{{ banner.end_date|date:'H:i' }}{% endif %}">
                </div>
              </div>
            </div>
          </div>

          <!-- Slider Settings -->
          <div class="section-card green mt-3">
            <p class="section-title text-success"><i class="mdi mdi-play-circle-outline"></i> Slider Settings</p>
            <div class="form-check form-check-flat form-check-primary mb-2">
              <label class="form-check-label">
                <input type="checkbox" class="form-check-input" name="auto_slide" id="auto_slide"
                  {% if banner.auto_slide %}checked{% endif %} onchange="toggleDuration()">
                <span class="font-weight-bold">Enable Auto-Slide</span>
                <i class="input-helper"></i>
              </label>
            </div>
            <div id="durationGroup" {% if not banner.auto_slide %}style="display:none;"{% endif %}>
              <label class="font-weight-bold small">Slide Duration (seconds)</label>
              <input type="number" class="form-control" name="slide_duration" value="{{ banner.slide_duration }}" min="1" max="60">
            </div>
          </div>

        </div>
      </div>

      <!-- Submit -->
      <div class="row mt-3">
        <div class="col-12">
          <hr>
          <button type="submit" class="btn btn-gradient-primary btn-lg mr-2">
            <i class="mdi mdi-check"></i> Update Banner
          </button>
          <a href="{% url 'adminpanel:banner_list' %}" class="btn btn-light btn-lg">
            <i class="mdi mdi-close"></i> Cancel
          </a>
        </div>
      </div>

    </form>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="mdi mdi-alert"></i> Confirm Delete</h5>
        <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete <strong>{{ banner.title }}</strong>?</p>
        <p class="text-danger mb-0"><small><i class="mdi mdi-alert"></i> This cannot be undone!</small></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-dismiss="modal">Cancel</button>
        <form action="{% url 'adminpanel:banner_delete' banner.id %}" method="POST" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger"><i class="mdi mdi-delete"></i> Yes, Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  function previewImg(event, previewId, boxId, labelId) {
    var file = event.target.files[0];
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById(previewId).src = e.target.result;
      document.getElementById(boxId).style.display = 'flex';
    };
    reader.readAsDataURL(file);
    document.getElementById(labelId).textContent = file.name;
  }

  function removeImg(fieldId, btn) {
    document.getElementById(fieldId).value = '1';
    btn.closest('div').style.display = 'none';
  }

  function toggleDuration() {
    document.getElementById('durationGroup').style.display =
      document.getElementById('auto_slide').checked ? 'block' : 'none';
  }
</script>

{% endblock %}