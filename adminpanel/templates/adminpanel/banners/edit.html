{% extends 'admin-dashboard.html' %}
{% load static %}
{% block content %}
<style>
  .form-control:focus { border-color: #b66dff; box-shadow: 0 0 0 0.2rem rgba(182,109,255,0.25); }
  .card { box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075); }
  .btn-gradient-primary { background: linear-gradient(to right, #da8cff, #9a55ff); border: 0; color: white; }
  .btn-gradient-primary:hover { background: linear-gradient(to right, #9a55ff, #da8cff); color: white; }
  .page-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
  .info-card { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
  .custom-file-label::after { content: "Browse"; }
  .section-card { border-radius: 10px; padding: 20px; margin-bottom: 20px; }
  .section-card.blue   { background: #e8f0fe; border: 1px solid #c5d5fb; }
  .section-card.orange { background: #fff3e0; border: 1px solid #ffcc80; }
  .section-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 14px; }
  .image-drop-zone { border: 2px dashed #c5d5fb; border-radius: 10px; padding: 15px; background: #f8fbff; min-height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; cursor: pointer; transition: border-color 0.2s; }
  .image-drop-zone:hover { border-color: #9a55ff; }
  .current-img { max-width: 100%; max-height: 150px; border-radius: 8px; border: 2px solid #e0e0e0; }
  .img-remove-btn { background: #dc3545; color: #fff; border: none; border-radius: 20px; padding: 3px 12px; font-size: 12px; cursor: pointer; margin-top: 6px; }
  .slide-preview-box { border-radius: 10px; padding: 30px 25px; color: #fff; min-height: 180px; position: relative; overflow: hidden; transition: all 0.3s; }
  .slide-preview-box .preview-title { font-size: 1.6rem; font-weight: 600; margin-bottom: 8px; text-shadow: 1px 1px 4px rgba(0,0,0,0.3); }
  .slide-preview-box .preview-desc { font-size: 0.85rem; opacity: 0.9; margin-bottom: 16px; }
  .slide-preview-box .preview-btn { display: inline-block; background: rgba(255,255,255,0.2); border: 1.5px solid rgba(255,255,255,0.7); border-radius: 8px; padding: 7px 18px; font-size: 0.8rem; font-weight: 600; color: #fff; }
  .slide-preview-box .preview-label { position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,0.2); border-radius: 6px; padding: 3px 10px; font-size: 11px; font-weight: 600; }
  .gradient-presets { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
  .gradient-chip { width: 36px; height: 36px; border-radius: 8px; cursor: pointer; border: 3px solid transparent; transition: all 0.2s; }
  .gradient-chip:hover, .gradient-chip.active { border-color: #333; transform: scale(1.1); }
</style>

<div class="main-panel">
  <div class="content-wrapper">

    <div class="page-header">
      <h3 class="mb-2"><i class="mdi mdi-image-edit"></i> Edit Slide</h3>
      <p class="mb-0">Editing — <strong>{{ banner.title }}</strong></p>
    </div>

    <nav aria-label="breadcrumb">
      <ol class="breadcrumb bg-transparent p-0 mb-4">
        <li class="breadcrumb-item"><a href="{% url 'adminpanel:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'adminpanel:banner_list' %}">Hero Banners</a></li>
        <li class="breadcrumb-item active">Edit Slide</li>
      </ol>
    </nav>

    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
      {{ message }}
      <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
    </div>
    {% endfor %}
    {% endif %}

    <!-- Info bar -->
    <div class="info-card">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h5 class="mb-1"><i class="mdi mdi-information"></i> Slide Info</h5>
          <p class="mb-1"><strong>ID:</strong> #{{ banner.id }} &nbsp;|&nbsp; <strong>Order:</strong> {{ banner.display_order }}</p>
          <p class="mb-0"><strong>Last Updated:</strong> {{ banner.updated_at|date:"d M Y, h:i A" }}</p>
        </div>
        <div class="col-md-4 text-right">
          <button type="button" class="btn btn-danger btn-lg" data-toggle="modal" data-target="#deleteModal">
            <i class="mdi mdi-delete"></i> Delete Slide
          </button>
        </div>
      </div>
    </div>

    <form method="POST" enctype="multipart/form-data" id="bannerForm">
      {% csrf_token %}
      <input type="hidden" name="remove_image_mobile" id="remove_image_mobile" value="0">
      <input type="hidden" name="remove_image_tablet" id="remove_image_tablet" value="0">

      <div class="row">

        <!-- ── LEFT COLUMN ── -->
        <div class="col-md-7">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-4"><i class="mdi mdi-text"></i> Slide Content</h5>

              <div class="form-group">
                <label class="font-weight-bold">Internal Title (Admin Only) <span class="text-danger">*</span></label>
                <input type="text" class="form-control form-control-lg" name="title" id="title"
                       value="{{ banner.title }}" required oninput="updatePreview()">
              </div>

              <div class="section-card blue">
                <p class="section-label text-primary"><i class="mdi mdi-format-title"></i> Slide Text (shown on homepage)</p>
                <div class="form-group mb-3">
                  <label class="font-weight-bold">Heading</label>
                  <input type="text" class="form-control" name="slide_heading" id="slide_heading"
                         value="{{ banner.slide_heading|default:'' }}"
                         placeholder="e.g. Your Vision Matters More" oninput="updatePreview()">
                  <small class="text-muted">Maps to <code>slideshow-v56__title</code></small>
                </div>
                <div class="form-group mb-3">
                  <label class="font-weight-bold">Description</label>
                  <textarea class="form-control" name="slide_description" id="slide_description" rows="3"
                            placeholder="Slide sub-text..." oninput="updatePreview()">{{ banner.slide_description|default:'' }}</textarea>
                  <small class="text-muted">Maps to <code>slideshow-v56__description</code></small>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group mb-0">
                      <label class="font-weight-bold">CTA Button Text</label>
                      <input type="text" class="form-control" name="cta_text" id="cta_text"
                             value="{{ banner.cta_text|default:'' }}" placeholder="Read More" oninput="updatePreview()">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group mb-0">
                      <label class="font-weight-bold">CTA Button URL</label>
                      <input type="text" class="form-control" name="link_url" id="link_url"
                             value="{{ banner.link_url }}" placeholder="/about/">
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-group mt-3">
                <label class="font-weight-bold">Link Type</label>
                <select class="form-control" name="link_type">
                  <option value="">-- None --</option>
                  {% for value, label in link_type_choices %}
                  <option value="{{ value }}" {% if banner.link_type == value %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="font-weight-bold">Banner Type <span class="text-danger">*</span></label>
                    <select class="form-control" name="banner_type" required>
                      {% for value, label in banner_types %}
                      <option value="{{ value }}" {% if banner.banner_type == value %}selected{% endif %}>{{ label }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="font-weight-bold">Placement <span class="text-danger">*</span></label>
                    <select class="form-control" name="placement" required>
                      {% for value, label in placement_choices %}
                      <option value="{{ value }}" {% if banner.placement == value %}selected{% endif %}>{{ label }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Settings -->
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-4"><i class="mdi mdi-cog"></i> Settings & Schedule</h5>
              <div class="row">
                <div class="col-md-4">
                  <div class="form-group">
                    <label class="font-weight-bold">Display Order</label>
                    <input type="number" class="form-control" name="display_order" value="{{ banner.display_order }}" min="0">
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label class="font-weight-bold">Slide Duration (sec)</label>
                    <input type="number" class="form-control" name="slide_duration" value="{{ banner.slide_duration }}" min="1" max="30">
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label class="font-weight-bold d-block">Options</label>
                    <div class="form-check mt-2">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" name="is_active" {% if banner.is_active %}checked{% endif %}>
                        <span>Active (Live)</span><i class="input-helper"></i>
                      </label>
                    </div>
                    <div class="form-check mt-1">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" name="auto_slide" {% if banner.auto_slide %}checked{% endif %}>
                        <span>Auto-slide</span><i class="input-helper"></i>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
              <div class="section-card orange">
                <p class="section-label" style="color:#e65100;"><i class="mdi mdi-calendar-clock"></i> Schedule</p>
                <div class="row">
                  <div class="col-md-6">
                    <label class="font-weight-bold small">Start Date & Time</label>
                    <input type="datetime-local" class="form-control" name="start_date"
                           value="{% if banner.start_date %}{{ banner.start_date|date:'Y-m-d' }}T{{ banner.start_date|date:'H:i' }}{% endif %}">
                  </div>
                  <div class="col-md-6">
                    <label class="font-weight-bold small">End Date & Time</label>
                    <input type="datetime-local" class="form-control" name="end_date"
                           value="{% if banner.end_date %}{{ banner.end_date|date:'Y-m-d' }}T{{ banner.end_date|date:'H:i' }}{% endif %}">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ── RIGHT COLUMN ── -->
        <div class="col-md-5">

          <!-- Live Preview -->
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3"><i class="mdi mdi-eye"></i> Live Preview</h5>
              <div class="slide-preview-box" id="slidePreviewBox" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);">
                <span class="preview-label" id="previewLabel">{{ banner.title }}</span>
                <div class="preview-title" id="previewTitle">{{ banner.slide_heading|default:'Your slide heading' }}</div>
                <div class="preview-desc" id="previewDesc">{{ banner.slide_description|default:'Slide description...' }}</div>
                <span class="preview-btn" id="previewBtn">{{ banner.cta_text|default:'Read More' }}</span>
              </div>
              <p class="text-muted mt-2 mb-1" style="font-size:12px;">Gradient fallback colour:</p>
              <div class="gradient-presets">
                <div class="gradient-chip active" style="background:linear-gradient(135deg,#667eea,#764ba2);" data-gradient="linear-gradient(135deg,#667eea 0%,#764ba2 100%)"></div>
                <div class="gradient-chip" style="background:linear-gradient(135deg,#f093fb,#f5576c);" data-gradient="linear-gradient(135deg,#f093fb 0%,#f5576c 100%)"></div>
                <div class="gradient-chip" style="background:linear-gradient(135deg,#4facfe,#00f2fe);" data-gradient="linear-gradient(135deg,#4facfe 0%,#00f2fe 100%)"></div>
                <div class="gradient-chip" style="background:linear-gradient(135deg,#43e97b,#38f9d7);" data-gradient="linear-gradient(135deg,#43e97b 0%,#38f9d7 100%)"></div>
                <div class="gradient-chip" style="background:linear-gradient(135deg,#fa709a,#fee140);" data-gradient="linear-gradient(135deg,#fa709a 0%,#fee140 100%)"></div>
                <div class="gradient-chip" style="background:linear-gradient(135deg,#2c3e50,#34495e);" data-gradient="linear-gradient(135deg,#2c3e50 0%,#34495e 100%)"></div>
              </div>
            </div>
          </div>

          <!-- Images -->
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3"><i class="mdi mdi-image"></i> Slide Images</h5>

              <!-- Desktop -->
              <div class="form-group">
                <label class="font-weight-bold">Desktop Image</label>
                {% if banner.image_desktop %}
                <div class="text-center mb-2">
                  <img src="{{ banner.image_desktop.url }}" class="current-img" alt="Current desktop">
                  <br><small class="text-success"><i class="mdi mdi-check-circle"></i> Current image</small>
                </div>
                {% endif %}
                <div class="image-drop-zone" style="min-height:80px;" onclick="document.getElementById('image_desktop').click()">
                  <img id="desktopPreview" alt="" style="max-height:100px;display:none;">
                  <i class="mdi mdi-monitor-screenshot" style="font-size:28px;color:#ccc;" id="desktopIcon"></i>
                  <small class="text-muted" id="desktopHint">{% if banner.image_desktop %}Replace desktop image{% else %}Upload desktop image (1920×700){% endif %}</small>
                </div>
                <input type="file" id="image_desktop" name="image_desktop" accept="image/*" style="display:none"
                       onchange="previewImg(event,'desktopPreview','desktopIcon','desktopHint')">
              </div>

              <!-- Mobile -->
              <div class="form-group">
                <label class="font-weight-bold">Mobile Image <small class="text-muted">(optional)</small></label>
                {% if banner.image_mobile %}
                <div class="text-center mb-2" id="mobileCurrentWrapper">
                  <img src="{{ banner.image_mobile.url }}" class="current-img" style="max-height:80px;" alt="Current mobile">
                  <br>
                  <button type="button" class="img-remove-btn" onclick="removeImg('remove_image_mobile','mobileCurrentWrapper')">
                    <i class="mdi mdi-close"></i> Remove
                  </button>
                </div>
                {% endif %}
                <div class="image-drop-zone" style="min-height:70px;" onclick="document.getElementById('image_mobile').click()">
                  <img id="mobilePreview" alt="" style="max-height:70px;display:none;">
                  <i class="mdi mdi-cellphone" style="font-size:22px;color:#ccc;" id="mobileIcon"></i>
                  <small class="text-muted" id="mobileHint">768×500px</small>
                </div>
                <input type="file" id="image_mobile" name="image_mobile" accept="image/*" style="display:none"
                       onchange="previewImg(event,'mobilePreview','mobileIcon','mobileHint')">
              </div>

            </div>
          </div>

        </div>
      </div>

      <!-- Submit -->
      <div class="row">
        <div class="col-12">
          <hr>
          <button type="submit" class="btn btn-gradient-primary btn-lg mr-2">
            <i class="mdi mdi-check"></i> Update Slide
          </button>
          <a href="{% url 'adminpanel:banner_list' %}" class="btn btn-light btn-lg">
            <i class="mdi mdi-close"></i> Cancel
          </a>
        </div>
      </div>
    </form>

  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="mdi mdi-alert"></i> Delete Slide?</h5>
        <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
      </div>
      <div class="modal-body">
        <p>Delete <strong>{{ banner.title }}</strong>? This cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-dismiss="modal">Cancel</button>
        <form action="{% url 'adminpanel:banner_delete' banner.id %}" method="POST">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger"><i class="mdi mdi-delete"></i> Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  function updatePreview() {
    document.getElementById('previewTitle').textContent = document.getElementById('slide_heading').value || 'Your slide heading';
    document.getElementById('previewDesc').textContent  = document.getElementById('slide_description').value || 'Slide description...';
    document.getElementById('previewBtn').textContent   = document.getElementById('cta_text').value || 'Read More';
    document.getElementById('previewLabel').textContent = document.getElementById('title').value || 'Slide';
  }

  document.querySelectorAll('.gradient-chip').forEach(chip => {
    chip.addEventListener('click', function() {
      document.querySelectorAll('.gradient-chip').forEach(c => c.classList.remove('active'));
      this.classList.add('active');
      document.getElementById('slidePreviewBox').style.background = this.dataset.gradient;
    });
  });

  function previewImg(event, previewId, iconId, hintId) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      const img = document.getElementById(previewId);
      img.src = e.target.result;
      img.style.display = 'block';
      document.getElementById(iconId).style.display = 'none';
      document.getElementById(hintId).textContent = file.name;
    };
    reader.readAsDataURL(file);
  }

  function removeImg(hiddenFieldId, wrapperId) {
    if (confirm('Remove this image?')) {
      document.getElementById(hiddenFieldId).value = '1';
      document.getElementById(wrapperId).style.display = 'none';
    }
  }
</script>
{% endblock %}