{% extends 'base.html' %}
{% load static %}
{% block title %}Order #{{ order.order_number }}{% endblock %}
{% block content %}
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
:root{
  --lav:#e8dff5;--amber:#fef3c7;--mint:#d1fae5;--pink:#fce7f3;
  --bg:#fafaf9;--white:#fff;--ink:#1f2937;--ink2:#374151;--muted:#6b7280;
  --rule:#e5e7eb;--green:#10b981;--red:#ef4444;
  --r:12px;--r-lg:18px;--sh:0 2px 12px rgba(0,0,0,.04);--sh-lg:0 8px 32px rgba(0,0,0,.06);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
.od{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;padding:40px 20px 80px}
.od-con{max-width:1100px;margin:0 auto}
.od-hd{margin-bottom:32px}
.od-bc{display:flex;align-items:center;gap:8px;margin-bottom:16px}
.od-bc a,.od-bc span{font-size:11px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);text-decoration:none}
.od-bc a:hover{color:var(--ink)}
.od-bc__sep{font-size:10px;color:var(--muted)}
.od-bc span:last-child{color:var(--ink)}
.od-tr{display:flex;align-items:flex-start;justify-content:space-between;gap:24px;flex-wrap:wrap}
.od-lbl{font-size:10px;font-weight:800;letter-spacing:.2em;text-transform:uppercase;color:var(--muted);margin-bottom:8px;display:block}
.od-title{font-family:'DM Mono',monospace;font-size:clamp(1.8rem,4vw,2.8rem);font-weight:500;color:var(--ink);letter-spacing:.02em;margin-bottom:8px;line-height:1.1}
.od-date{font-size:13px;color:var(--muted)}
.od-ta{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.od-badge{display:inline-flex;align-items:center;gap:8px;padding:10px 18px;border-radius:100px;font-size:11px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;box-shadow:var(--sh)}
.od-badge__dot{width:8px;height:8px;border-radius:50%;animation:pulse 2s ease-in-out infinite}
.b-pending{background:var(--amber);color:#92400e}.b-pending .od-badge__dot{background:#f59e0b}
.b-confirmed{background:var(--mint);color:#065f46}.b-confirmed .od-badge__dot{background:var(--green)}
.b-processing{background:var(--lav);color:#5b21b6}.b-processing .od-badge__dot{background:#8b5cf6}
.b-shipped{background:var(--pink);color:#9f1239}.b-shipped .od-badge__dot{background:#ec4899}
.b-delivered{background:var(--mint);color:#065f46}.b-delivered .od-badge__dot{background:var(--green)}
.b-cancelled{background:#fee2e2;color:#991b1b}.b-cancelled .od-badge__dot{background:var(--red)}
.od-track-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;background:var(--ink);color:#fff;border:none;border-radius:100px;font-family:inherit;font-size:11px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;text-decoration:none;transition:.25s;box-shadow:var(--sh)}
.od-track-btn:hover{opacity:.85;transform:translateY(-2px);color:#fff;text-decoration:none}
.od-layout{display:grid;grid-template-columns:1fr 360px;gap:28px;align-items:start}
.od-main{min-width:0}
.od-card{background:var(--white);border-radius:var(--r-lg);padding:32px;box-shadow:var(--sh);margin-bottom:24px;opacity:0;transform:translateY(16px);transition:opacity .6s,transform .6s}
.od-card.in{opacity:1;transform:none}
.od-ch{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;padding-bottom:16px;border-bottom:2px solid var(--rule)}
.od-ct{font-size:12px;font-weight:800;letter-spacing:.2em;text-transform:uppercase;color:var(--ink)}
.od-cc{font-size:11px;font-weight:600;color:var(--muted);background:var(--lav);padding:4px 12px;border-radius:100px}
.od-items{display:flex;flex-direction:column}
.od-item{display:flex;gap:20px;padding:20px 0;border-bottom:1px solid var(--rule);transition:background .2s}
.od-item:last-child{border-bottom:none}
.od-item:hover{background:var(--lav);margin:0 -16px;padding:20px 16px;border-radius:var(--r)}
.od-item-img{width:90px;min-width:90px;height:90px;border-radius:var(--r);overflow:hidden;background:var(--bg);flex-shrink:0;display:flex;align-items:center;justify-content:center}
.od-item-img img{width:100%;height:100%;object-fit:contain;padding:8px}
.od-item-body{flex:1;min-width:0}
.od-item-name{font-size:1rem;font-weight:700;color:var(--ink);line-height:1.3;margin-bottom:4px}
.od-item-meta{display:flex;flex-wrap:wrap;gap:12px;font-size:12px;color:var(--muted);margin-bottom:6px}
.od-item-meta-lbl{font-weight:600;color:var(--ink2)}
.od-item-pills{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
.pill-lens{padding:4px 10px;background:var(--pink);border-radius:6px;font-size:10px;font-weight:600;color:#9f1239}
.pill-addon{padding:4px 10px;background:var(--mint);border-radius:6px;font-size:10px;font-weight:600;color:#065f46}
.od-item-right{display:flex;flex-direction:column;align-items:flex-end;gap:6px;flex-shrink:0}
.od-item-qty{font-size:12px;color:var(--muted);font-weight:500}
.od-item-each{font-size:12px;color:var(--muted)}
.od-item-total{font-family:'DM Mono',monospace;font-size:1.1rem;font-weight:500;color:var(--ink)}
.od-addr{background:var(--lav);padding:20px;border-radius:var(--r);line-height:1.8}
.od-addr-name{font-weight:700;color:var(--ink);margin-bottom:4px}
.od-addr-line{font-size:14px;color:var(--ink2)}
.od-addr-phone{font-size:13px;color:var(--muted);margin-top:8px;display:flex;align-items:center;gap:6px}
.od-pay-rows{display:flex;flex-direction:column;gap:12px}
.od-pay-row{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--amber);border-radius:var(--r)}
.od-pay-lbl{font-size:12px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#92400e}
.od-pay-val{font-family:'DM Mono',monospace;font-size:14px;font-weight:500;color:var(--ink)}
.ps{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:100px;font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase}
.ps-completed{background:var(--mint);color:#065f46}
.ps-pending{background:var(--amber);color:#92400e}
.ps-failed{background:#fee2e2;color:#991b1b}
.ps-processing{background:var(--lav);color:#5b21b6}
.od-tl{display:flex;flex-direction:column;position:relative}
.od-tl::before{content:'';position:absolute;top:28px;bottom:28px;left:7px;width:2px;background:var(--rule)}
.od-tl-item{display:flex;gap:16px;padding:16px 0;position:relative}
.od-tl-dot-wrap{position:relative;flex-shrink:0;z-index:2}
.od-tl-dot{width:16px;height:16px;border-radius:50%;background:var(--white);border:3px solid var(--rule);transition:.3s}
.od-tl-item:hover .od-tl-dot{border-color:var(--green);transform:scale(1.2)}
.od-tl-item.cur .od-tl-dot{border-color:var(--green);background:var(--green);box-shadow:0 0 0 4px rgba(16,185,129,.15)}
.od-tl-body{flex:1;padding-top:2px}
.od-tl-status{font-size:14px;font-weight:700;color:var(--ink);margin-bottom:4px}
.od-tl-time{font-size:12px;color:var(--muted);margin-bottom:4px}
.od-tl-notes{font-size:13px;color:var(--ink2);line-height:1.6}
.od-sidebar{position:sticky;top:24px}
.od-sum{background:var(--white);border-radius:var(--r-lg);padding:28px;box-shadow:var(--sh);margin-bottom:20px}
.od-sum-title{font-size:12px;font-weight:800;letter-spacing:.2em;text-transform:uppercase;color:var(--ink);margin-bottom:20px;padding-bottom:12px;border-bottom:2px solid var(--rule)}
.od-sum-rows{display:flex;flex-direction:column;gap:12px}
.od-sum-row{display:flex;align-items:center;justify-content:space-between;font-size:14px}
.od-sum-row-lbl{color:var(--muted);font-weight:500}
.od-sum-row-val{font-family:'DM Mono',monospace;color:var(--ink);font-weight:500}
.od-sum-div{height:1px;background:var(--rule);margin:8px 0}
.od-sum-total{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;background:var(--lav);border-radius:var(--r);margin-top:12px}
.od-sum-total-lbl{font-size:12px;font-weight:800;letter-spacing:.14em;text-transform:uppercase;color:#5b21b6}
.od-sum-total-val{font-family:'DM Mono',monospace;font-size:1.6rem;font-weight:500;color:var(--ink)}
.od-acts{background:var(--white);border-radius:var(--r-lg);padding:24px;box-shadow:var(--sh);display:flex;flex-direction:column;gap:10px}
.od-btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:14px 24px;border-radius:100px;font-family:inherit;font-size:11px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;text-decoration:none;border:none;cursor:pointer;transition:.3s;text-align:center}
.od-btn-primary{background:var(--ink);color:#fff;box-shadow:var(--sh)}.od-btn-primary:hover{opacity:.85;transform:translateY(-2px);color:#fff;text-decoration:none}
.od-btn-outline{background:transparent;color:var(--ink);border:2px solid var(--rule)}.od-btn-outline:hover{border-color:var(--ink);background:var(--lav);text-decoration:none;color:var(--ink)}
.od-btn-danger{background:#fee2e2;color:#991b1b;border:2px solid #fecaca}.od-btn-danger:hover{background:#fecaca;border-color:var(--red)}
.od-help{background:var(--mint);border-radius:var(--r-lg);padding:20px;margin-top:20px}
.od-help-title{font-size:12px;font-weight:800;letter-spacing:.14em;text-transform:uppercase;color:#065f46;margin-bottom:8px}
.od-help-text{font-size:13px;color:#064e3b;line-height:1.6;margin-bottom:12px}
.od-help-link{font-size:12px;font-weight:700;color:var(--green);text-decoration:none;display:inline-flex;align-items:center;gap:6px}
.od-help-link:hover{gap:10px}
@keyframes pulse{0%,100%{opacity:.6;transform:scale(1)}50%{opacity:1;transform:scale(1.2)}}
@media(max-width:1024px){.od-layout{grid-template-columns:1fr}.od-sidebar{position:relative;top:auto}}
@media(max-width:768px){.od{padding:28px 16px 60px}.od-card{padding:24px 18px}.od-sum{padding:20px}.od-tr{flex-direction:column;align-items:flex-start}.od-item{flex-direction:column}.od-item-right{flex-direction:row;align-items:center;width:100%;justify-content:space-between}}
</style>

<div class="od">
<div class="od-con">

  <div class="od-hd">
    <nav class="od-bc">
      <a href="/">Home</a><span class="od-bc__sep">/</span>
      <a href="{% url 'orders:order_list' %}">Orders</a><span class="od-bc__sep">/</span>
      <span>#{{ order.order_number }}</span>
    </nav>
    <div class="od-tr">
      <div>
        <span class="od-lbl">Order Details</span>
        <h1 class="od-title">#{{ order.order_number }}</h1>
        <p class="od-date">Placed on {{ order.created_at|date:"F j, Y" }} at {{ order.created_at|time:"g:i A" }}</p>
      </div>
      <div class="od-ta">
        <span class="od-badge b-{{ order.status }}">
          <span class="od-badge__dot"></span>{{ order.get_status_display }}
        </span>
        <a href="{% url 'orders:track_order' order.order_number %}" class="od-track-btn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          Track Order
        </a>
      </div>
    </div>
  </div>

  <div class="od-layout">
  <main class="od-main">

    <!-- Items -->
    <section class="od-card">
      <div class="od-ch">
        <h2 class="od-ct">Order Items</h2>
        <span class="od-cc">{{ order_items|length }} item(s)</span>
      </div>
      <div class="od-items">
        {% for item in order_items %}
        <article class="od-item">
          <div class="od-item-img">
            {% if item.product.images.first %}
              <img src="{{ item.product.images.first.image.url }}" alt="{{ item.product_name }}" loading="lazy">
            {% elif item.product.image %}
              <img src="{{ item.product.image.url }}" alt="{{ item.product_name }}" loading="lazy">
            {% else %}
              <span style="font-size:30px">üëì</span>
            {% endif %}
          </div>
          <div class="od-item-body">
            <h3 class="od-item-name">{{ item.product_name }}</h3>
            <div class="od-item-meta">
              {% if item.product_sku %}<span><span class="od-item-meta-lbl">SKU:</span> {{ item.product_sku }}</span>{% endif %}
              {% if item.variant_details.color %}<span><span class="od-item-meta-lbl">Color:</span> {{ item.variant_details.color }}</span>{% endif %}
              {% if item.variant_details.size %}<span><span class="od-item-meta-lbl">Size:</span> {{ item.variant_details.size }}</span>{% endif %}
            </div>
            {% if item.lens_option_name or item.lens_addons.all %}
            <div class="od-item-pills">
              {% if item.lens_option_name %}<span class="pill-lens">üîç {{ item.lens_option_name }} ({{ order.currency }} {{ item.lens_price }})</span>{% endif %}
              {% for addon in item.lens_addons.all %}<span class="pill-addon">+ {{ addon.addon_name }} ({{ order.currency }} {{ addon.price }})</span>{% endfor %}
            </div>
            {% endif %}
            {% if item.special_instructions %}<p style="font-size:12px;color:var(--muted);margin-top:8px;font-style:italic">Note: {{ item.special_instructions }}</p>{% endif %}
          </div>
          <div class="od-item-right">
            <span class="od-item-qty">Qty: {{ item.quantity }}</span>
            <span class="od-item-each">{{ order.currency }} {{ item.unit_price }} each</span>
            <span class="od-item-total">{{ order.currency }} {{ item.subtotal }}</span>
          </div>
        </article>
        {% endfor %}
      </div>
    </section>

    <!-- Shipping -->
    <section class="od-card">
      <div class="od-ch"><h2 class="od-ct">Shipping Address</h2></div>
      <div class="od-addr">
        <p class="od-addr-name">{{ order.customer_name }}</p>
        <p class="od-addr-line">{{ order.shipping_address_line1 }}</p>
        {% if order.shipping_address_line2 %}<p class="od-addr-line">{{ order.shipping_address_line2 }}</p>{% endif %}
        <p class="od-addr-line">{{ order.shipping_city }}{% if order.shipping_state %}, {{ order.shipping_state }}{% endif %}{% if order.shipping_postal_code %} {{ order.shipping_postal_code }}{% endif %}</p>
        <p class="od-addr-line">{{ order.shipping_country }}</p>
        {% if order.customer_phone %}<p class="od-addr-phone">üìû {{ order.customer_phone }}</p>{% endif %}
      </div>
    </section>

    <!-- Payment -->
    <section class="od-card">
      <div class="od-ch"><h2 class="od-ct">Payment Information</h2></div>
      <div class="od-pay-rows">
        <div class="od-pay-row">
          <span class="od-pay-lbl">Method</span>
          <span class="od-pay-val">
            {% if order.payment_method == 'cash_on_delivery' %}üíµ Cash on Delivery
            {% elif order.payment_method == 'sadad' %}üíö Sadad
            {% elif order.payment_method == 'stripe' %}üí≥ Credit/Debit Card
            {% elif order.payment_method == 'razorpay' %}üè¶ Razorpay
            {% elif order.payment_method == 'paypal' %}üåê PayPal
            {% else %}{{ order.payment_method }}{% endif %}
          </span>
        </div>
        <div class="od-pay-row">
          <span class="od-pay-lbl">Status</span>
          <span class="ps ps-{{ order.payment_status }}">{{ order.get_payment_status_display }}</span>
        </div>
        {% if order.payment_transaction_id %}
        <div class="od-pay-row">
          <span class="od-pay-lbl">Transaction ID</span>
          <span class="od-pay-val" style="font-size:11px;word-break:break-all">{{ order.payment_transaction_id }}</span>
        </div>
        {% endif %}
        {% if order.paid_at %}
        <div class="od-pay-row">
          <span class="od-pay-lbl">Paid At</span>
          <span class="od-pay-val" style="font-size:12px">{{ order.paid_at|date:"M j, Y g:i A" }}</span>
        </div>
        {% endif %}
      </div>
    </section>

    <!-- Timeline -->
    {% if status_history %}
    <section class="od-card">
      <div class="od-ch"><h2 class="od-ct">Order History</h2></div>
      <div class="od-tl">
        {% for h in status_history %}
        <div class="od-tl-item {% if forloop.first %}cur{% endif %}">
          <div class="od-tl-dot-wrap"><div class="od-tl-dot"></div></div>
          <div class="od-tl-body">
            <p class="od-tl-status">{% if h.from_status %}{{ h.from_status|title }} ‚Üí {% endif %}{{ h.to_status|title }}</p>
            <p class="od-tl-time">{{ h.created_at|date:"M j, Y g:i A" }}</p>
            {% if h.notes %}<p class="od-tl-notes">{{ h.notes }}</p>{% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}

  </main>

  <aside class="od-sidebar">
    <div class="od-sum">
      <h3 class="od-sum-title">Order Summary</h3>
      <div class="od-sum-rows">
        <div class="od-sum-row"><span class="od-sum-row-lbl">Subtotal</span><span class="od-sum-row-val">{{ order.currency }} {{ order.subtotal }}</span></div>
        {% if order.discount_amount > 0 %}<div class="od-sum-row"><span class="od-sum-row-lbl">Discount</span><span class="od-sum-row-val" style="color:var(--green)">-{{ order.currency }} {{ order.discount_amount }}</span></div>{% endif %}
        <div class="od-sum-row"><span class="od-sum-row-lbl">Shipping</span><span class="od-sum-row-val">{% if order.shipping_amount > 0 %}{{ order.currency }} {{ order.shipping_amount }}{% else %}Free{% endif %}</span></div>
        <div class="od-sum-row"><span class="od-sum-row-lbl">Tax</span><span class="od-sum-row-val">{{ order.currency }} {{ order.tax_amount }}</span></div>
        <div class="od-sum-div"></div>
        <div class="od-sum-total"><span class="od-sum-total-lbl">Total</span><span class="od-sum-total-val">{{ order.currency }} {{ order.total_amount }}</span></div>
      </div>
    </div>

    <div class="od-acts">
      {% if order.can_be_cancelled %}
      <form method="POST" action="{% url 'orders:cancel_order' order.order_number %}" onsubmit="return confirm('Cancel this order?');" style="margin:0">
        {% csrf_token %}
        <button type="submit" class="od-btn od-btn-danger" style="width:100%">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
          Cancel Order
        </button>
      </form>
      {% endif %}
      <a href="{% url 'orders:track_order' order.order_number %}" class="od-btn od-btn-primary">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        Track Shipment
      </a>
      <a href="{% url 'orders:order_list' %}" class="od-btn od-btn-outline">‚Üê All Orders</a>
    </div>

    <div class="od-help">
      <h4 class="od-help-title">Need Help?</h4>
      <p class="od-help-text">Our support team is ready to assist with any questions about your order.</p>
      <a href="/" class="od-help-link">Contact Support ‚Üí</a>
    </div>
  </aside>
  </div>
</div>
</div>

<script>
(function(){
  var cards = document.querySelectorAll('.od-card');
  if('IntersectionObserver' in window){
    var io = new IntersectionObserver(function(entries){
      entries.forEach(function(e){if(e.isIntersecting){e.target.classList.add('in');io.unobserve(e.target);}});
    },{threshold:.04});
    cards.forEach(function(el){io.observe(el);});
  } else {
    cards.forEach(function(el){el.classList.add('in');});
  }
})();
</script>
{% endblock %}