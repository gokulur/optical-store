 
<style>
    /* ═══════════════════════════════════════════════════════════════
   AA PRODUCT GALLERY — Universal, Amazon/Flipkart grade
   Include this in base.html or per product detail page
   ═══════════════════════════════════════════════════════════════ */

/* ── Gallery Layout ── */
.aa-gal {
  display: grid;
  grid-template-columns: 86px 1fr;
  gap: 14px;
  position: sticky;
  top: 88px;
  align-self: start;
}
@media (max-width: 900px) { .aa-gal { position: static; } }
@media (max-width: 540px) {
  .aa-gal {
    grid-template-columns: 1fr;
    grid-template-rows: 1fr auto;
  }
}

/* ── Rail ── */
.aa-gal__rail {
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: 520px;
  overflow-y: auto;
  overflow-x: hidden;
  scrollbar-width: thin;
  scrollbar-color: #d4b896 transparent;
  padding: 2px;
}
.aa-gal__rail::-webkit-scrollbar { width: 3px; }
.aa-gal__rail::-webkit-scrollbar-thumb { background: #d4b896; border-radius: 99px; }
@media (max-width: 540px) {
  .aa-gal__rail {
    order: 2;
    flex-direction: row;
    max-height: none;
    max-width: 100%;
    overflow-y: hidden;
    overflow-x: auto;
    scrollbar-width: thin;
  }
}

/* ── Thumb ── */
.aa-gal__thumb {
  flex-shrink: 0;
  width: 82px;
  height: 82px;
  border-radius: 10px;
  overflow: hidden;
  border: 2px solid #e8e2d8;
  background: #f7f3ed;
  cursor: pointer;
  position: relative;
  transition: border-color 0.22s, box-shadow 0.22s, transform 0.22s;
  outline: none;
  padding: 0;
}
@media (max-width: 540px) { .aa-gal__thumb { width: 70px; height: 70px; } }
.aa-gal__thumb img {
  width: 100%; height: 100%;
  object-fit: contain;
  padding: 5px;
  transition: transform 0.3s ease;
  display: block;
  pointer-events: none;
}
.aa-gal__thumb:hover {
  border-color: #b8976a;
  box-shadow: 0 0 0 1px #b8976a;
  transform: translateX(3px);
}
@media (max-width: 540px) { .aa-gal__thumb:hover { transform: translateY(-2px); } }
.aa-gal__thumb:hover img { transform: scale(1.06); }
.aa-gal__thumb.is-active {
  border-color: #0d0d0d;
  box-shadow: 0 0 0 1px #0d0d0d;
}
.aa-gal__thumb.is-active::after {
  content: '';
  position: absolute;
  inset: 0;
  background: rgba(13,13,13,0.04);
  border-radius: 8px;
  pointer-events: none;
}
.aa-gal__thumb-label {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  background: rgba(13,13,13,0.72);
  color: #fff;
  font-size: 9px;
  font-weight: 700;
  text-align: center;
  padding: 3px 4px;
  letter-spacing: 0.03em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  opacity: 0;
  transition: opacity 0.2s;
}
.aa-gal__thumb:hover .aa-gal__thumb-label,
.aa-gal__thumb.is-active .aa-gal__thumb-label { opacity: 1; }

/* ── Stage wrap ── */
.aa-gal__stage-wrap {
  position: relative;
  display: flex;
  align-items: flex-start;
}

/* ── Stage ── */
.aa-gal__stage {
  position: relative;
  width: 100%;
  aspect-ratio: 1 / 1;
  border-radius: 16px;
  overflow: hidden;
  background: #f7f3ed;
  background-image:
    radial-gradient(ellipse at 20% 20%, rgba(255,255,255,0.7) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 80%, rgba(184,151,106,0.07) 0%, transparent 50%);
  cursor: crosshair;
  outline: none;
  user-select: none;
  -webkit-user-select: none;
}

/* ── Image frame & main image ── */
.aa-gal__img-frame {
  width: 100%; height: 100%;
  position: relative;
  overflow: hidden;
}
.aa-gal__main {
  width: 100%; height: 100%;
  object-fit: contain;
  padding: 28px;
  display: block;
  transition: opacity 0.18s ease, transform 0.18s ease;
  will-change: transform;
  pointer-events: none;
  -webkit-user-drag: none;
}
.aa-gal__main.is-loading {
  opacity: 0;
  transform: scale(0.97);
}

/* ── Placeholder ── */
.aa-gal__placeholder {
  width: 100%; height: 100%;
  display: flex; align-items: center; justify-content: center;
}
.aa-gal__placeholder svg { width: 40%; height: 40%; opacity: 0.4; }

/* ── Zoom lens ── */
.aa-gal__zoom-lens {
  position: absolute;
  border: 2px solid rgba(184,151,106,0.6);
  background: rgba(255,255,255,0.25);
  backdrop-filter: blur(1px);
  border-radius: 4px;
  display: none;
  pointer-events: none;
  z-index: 10;
}
.aa-gal__stage.is-zooming .aa-gal__zoom-lens { display: block; }

/* ── Zoom pane ── */
.aa-gal__zoom-pane {
  position: absolute;
  left: calc(100% + 16px);
  top: 0;
  width: 440px;
  height: 440px;
  border-radius: 14px;
  overflow: hidden;
  background: #f7f3ed;
  border: 1px solid #e8e2d8;
  box-shadow: 0 8px 40px rgba(0,0,0,0.14);
  display: none;
  z-index: 100;
  pointer-events: none;
}
.aa-gal__zoom-pane img {
  position: absolute;
  display: block;
  pointer-events: none;
  -webkit-user-drag: none;
}
.aa-gal__stage.is-zooming ~ .aa-gal__zoom-pane,
.aa-gal__stage-wrap:hover .aa-gal__zoom-pane { display: block; }
/* Hide pane on small screens */
@media (max-width: 1280px) {
  .aa-gal__zoom-pane { display: none !important; }
  .aa-gal__stage { cursor: zoom-in; }
  .aa-gal__stage.is-tap-zoomed { cursor: zoom-out; }
}

/* ── Tap zoom (mobile fallback) ── */
.aa-gal__stage.is-tap-zoomed .aa-gal__main {
  padding: 0;
  object-fit: cover;
  transition: none;
}

/* ── Arrows ── */
.aa-gal__arrow {
  position: absolute;
  top: 50%; transform: translateY(-50%);
  width: 40px; height: 40px; border-radius: 50%;
  background: rgba(255,255,255,0.92);
  backdrop-filter: blur(6px);
  border: 1px solid rgba(0,0,0,0.08);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; z-index: 20;
  box-shadow: 0 2px 12px rgba(0,0,0,0.12);
  transition: all 0.2s ease;
  opacity: 0; pointer-events: none;
  color: #1a1a1a;
}
.aa-gal__stage:hover .aa-gal__arrow,
.aa-gal__stage:focus-within .aa-gal__arrow { opacity: 1; pointer-events: auto; }
.aa-gal__arrow:hover { background: #fff; box-shadow: 0 4px 20px rgba(0,0,0,0.18); }
.aa-gal__arrow--prev { left: 12px; }
.aa-gal__arrow--prev:hover { transform: translateY(-50%) translateX(-2px); }
.aa-gal__arrow--next { right: 12px; }
.aa-gal__arrow--next:hover { transform: translateY(-50%) translateX(2px); }
.aa-gal__arrow.is-hidden { display: none !important; }

/* ── Counter ── */
.aa-gal__counter {
  position: absolute; bottom: 14px; left: 50%;
  transform: translateX(-50%);
  background: rgba(10,10,10,0.45);
  backdrop-filter: blur(6px);
  color: #fff; font-size: 11px; font-weight: 700;
  letter-spacing: 0.1em; padding: 4px 12px;
  border-radius: 99px; pointer-events: none;
  transition: opacity 0.2s;
  white-space: nowrap;
}
.aa-gal__counter.is-single { display: none; }

/* ── Fullscreen button ── */
.aa-gal__fullscreen {
  position: absolute; bottom: 14px; right: 14px;
  width: 36px; height: 36px; border-radius: 8px;
  background: rgba(255,255,255,0.88);
  backdrop-filter: blur(6px);
  border: 1px solid rgba(0,0,0,0.07);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; z-index: 20;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  opacity: 0; pointer-events: none;
  transition: all 0.2s;
  color: #333;
}
.aa-gal__stage:hover .aa-gal__fullscreen { opacity: 1; pointer-events: auto; }
.aa-gal__fullscreen:hover { background: #fff; transform: scale(1.08); }

/* ── Zoom hint ── */
.aa-gal__zoom-hint {
  position: absolute; bottom: 14px; left: 14px;
  display: flex; align-items: center; gap: 5px;
  background: rgba(255,255,255,0.88);
  backdrop-filter: blur(6px);
  border: 1px solid rgba(0,0,0,0.07);
  color: #555; font-size: 11px; font-weight: 600;
  padding: 5px 10px; border-radius: 6px;
  box-shadow: 0 1px 6px rgba(0,0,0,0.08);
  opacity: 0; pointer-events: none;
  transition: opacity 0.3s 0.8s;
}
.aa-gal__stage:hover .aa-gal__zoom-hint { opacity: 1; }
@media (max-width: 1280px) { .aa-gal__zoom-hint { display: none; } }

/* ── Lightbox ── */
.aa-gal__lb {
  display: none;
  position: fixed; inset: 0; z-index: 99999;
  background: rgba(6,6,6,0.96);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  flex-direction: column;
  align-items: center; justify-content: center;
  gap: 20px;
}
.aa-gal__lb.is-open { display: flex; }
.aa-gal__lb-close {
  position: fixed; top: 20px; right: 24px;
  width: 46px; height: 46px; border-radius: 50%;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  color: #fff; display: flex; align-items: center; justify-content: center;
  cursor: pointer; transition: background 0.2s; z-index: 2;
}
.aa-gal__lb-close:hover { background: rgba(255,255,255,0.2); }
.aa-gal__lb-main {
  display: flex; flex-direction: column; align-items: center; gap: 18px;
  max-width: 90vw;
}
.aa-gal__lb-img {
  max-width: 88vw; max-height: 75vh;
  object-fit: contain; border-radius: 12px;
  animation: aaLbIn 0.28s ease;
}
@keyframes aaLbIn { from { opacity:0; transform:scale(0.94); } to { opacity:1; transform:scale(1); } }
.aa-gal__lb-nav {
  position: fixed; top: 50%; transform: translateY(-50%);
  width: 52px; height: 52px; border-radius: 50%;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.18);
  color: #fff; display: flex; align-items: center; justify-content: center;
  cursor: pointer; transition: background 0.2s, transform 0.2s; z-index: 2;
}
.aa-gal__lb-nav:hover { background: rgba(255,255,255,0.22); }
.aa-gal__lb-nav--prev { left: 20px; }
.aa-gal__lb-nav--prev:hover { transform: translateY(-50%) translateX(-2px); }
.aa-gal__lb-nav--next { right: 20px; }
.aa-gal__lb-nav--next:hover { transform: translateY(-50%) translateX(2px); }
.aa-gal__lb-strip {
  display: flex; gap: 10px; overflow-x: auto; max-width: 90vw;
  padding: 4px 2px;
  scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.3) transparent;
}
.aa-gal__lb-dot {
  flex-shrink: 0; width: 62px; height: 62px;
  border-radius: 8px; overflow: hidden;
  border: 2.5px solid rgba(255,255,255,0.15);
  cursor: pointer;
  transition: border-color 0.2s, transform 0.2s;
}
.aa-gal__lb-dot img { width:100%; height:100%; object-fit:contain; padding:3px; }
.aa-gal__lb-dot.is-active { border-color: #d4b896; transform: scale(1.1); }
.aa-gal__lb-count {
  position: fixed; top: 26px; left: 50%; transform: translateX(-50%);
  color: rgba(255,255,255,0.5); font-size: 13px; font-weight: 600;
  letter-spacing: 0.1em; pointer-events: none;
}
</style>

<div class="aa-gal" id="aaGal">

  <!-- Thumbnail Rail -->
  <div class="aa-gal__rail" id="aaGalRail" role="listbox" aria-label="Product images">
    {% if main_image %}
    <button class="aa-gal__thumb is-active" role="option" aria-selected="true"
            data-src="{{ main_image.url }}" data-zoom="{{ main_image.url }}"
            data-idx="0" tabindex="0">
      <img src="{{ main_image.url }}" alt="Product main view" loading="eager" />
    </button>
    {% endif %}
    {% for img in images %}
    <button class="aa-gal__thumb" role="option" aria-selected="false"
            data-src="{{ img.image.url }}" data-zoom="{{ img.image.url }}"
            data-idx="{{ forloop.counter }}" tabindex="-1">
      <img src="{{ img.image.url }}" alt="View {{ forloop.counter }}" loading="lazy" />
    </button>
    {% endfor %}
    {% for v in variants %}
      {% if v.images.exists %}
        {% with vi=v.images.first %}
        <button class="aa-gal__thumb aa-gal__thumb--variant" role="option" aria-selected="false"
                data-src="{{ vi.image.url }}" data-zoom="{{ vi.image.url }}"
                data-variant-id="{{ v.id }}"
                data-idx="{{ forloop.parentloop.counter|add:images|length|add:1 }}"
                tabindex="-1" title="{{ v.color_name }}">
          <img src="{{ vi.image.url }}" alt="{{ v.color_name }}" loading="lazy" />
          {% if v.color_name %}
          <span class="aa-gal__thumb-label">{{ v.color_name }}</span>
          {% endif %}
        </button>
        {% endwith %}
      {% endif %}
    {% endfor %}
  </div>

  <!-- Main Stage -->
  <div class="aa-gal__stage-wrap">
    <div class="aa-gal__stage" id="aaGalStage"
         role="img" aria-label="Product image"
         tabindex="0">

      <!-- Main image -->
      <div class="aa-gal__img-frame">
        {% if main_image %}
        <img class="aa-gal__main" id="aaGalMain"
             src="{{ main_image.url }}"
             alt="{{ product.name }}"
             draggable="false" />
        {% else %}
        <div class="aa-gal__placeholder">
          <svg viewBox="0 0 120 120" fill="none"><rect x="10" y="10" width="100" height="100" rx="8" stroke="#d4b896" stroke-width="2"/><circle cx="42" cy="44" r="12" stroke="#d4b896" stroke-width="2"/><path d="M10 80 L36 56 L56 74 L76 52 L110 80" stroke="#d4b896" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
        {% endif %}
        <!-- Zoom lens overlay -->
        <div class="aa-gal__zoom-lens" id="aaZoomLens"></div>
      </div>

      <!-- Zoom preview pane (appears beside stage on hover) -->
      <div class="aa-gal__zoom-pane" id="aaZoomPane">
        <img id="aaZoomImg" src="" alt="" />
      </div>

      <!-- Arrow navigation -->
      <button class="aa-gal__arrow aa-gal__arrow--prev" id="aaGalPrev" aria-label="Previous image" type="button">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg>
      </button>
      <button class="aa-gal__arrow aa-gal__arrow--next" id="aaGalNext" aria-label="Next image" type="button">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="9 18 15 12 9 6"/></svg>
      </button>

      <!-- Counter pill -->
      <span class="aa-gal__counter" id="aaGalCounter">1 / 1</span>

      <!-- Fullscreen button -->
      <button class="aa-gal__fullscreen" id="aaGalFullscreen" aria-label="View fullscreen" type="button">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
      </button>

      <!-- Zoom hint -->
      <div class="aa-gal__zoom-hint" id="aaZoomHint">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
        Hover to zoom
      </div>
    </div>
  </div>
</div>

<!-- Lightbox -->
<div class="aa-gal__lb" id="aaGalLb" role="dialog" aria-modal="true" aria-label="Image lightbox">
  <button class="aa-gal__lb-close" onclick="window.__aaGal && window.__aaGal.closeLb()" aria-label="Close lightbox">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
  </button>
  <button class="aa-gal__lb-nav aa-gal__lb-nav--prev" onclick="window.__aaGal && window.__aaGal.lbNav(-1)" aria-label="Previous">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg>
  </button>
  <div class="aa-gal__lb-main">
    <img class="aa-gal__lb-img" id="aaLbImg" src="" alt="" />
    <div class="aa-gal__lb-strip" id="aaLbStrip"></div>
  </div>
  <button class="aa-gal__lb-nav aa-gal__lb-nav--next" onclick="window.__aaGal && window.__aaGal.lbNav(1)" aria-label="Next">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="9 18 15 12 9 6"/></svg>
  </button>
  <span class="aa-gal__lb-count" id="aaLbCount"></span>
</div>

<script>
    /**
 * AA Product Gallery — Universal, Amazon/Flipkart grade
 * Self-initializing. Works with any .aa-gal container.
 * Exposes window.__aaGal for external control.
 */
(function () {
  'use strict';

  function AaGallery() {
    var gal = document.getElementById('aaGal');
    if (!gal) return;

    var rail       = document.getElementById('aaGalRail');
    var stage      = document.getElementById('aaGalStage');
    var mainImg    = document.getElementById('aaGalMain');
    var zoomLens   = document.getElementById('aaZoomLens');
    var zoomPane   = document.getElementById('aaZoomPane');
    var zoomImg    = document.getElementById('aaZoomImg');
    var counter    = document.getElementById('aaGalCounter');
    var prevBtn    = document.getElementById('aaGalPrev');
    var nextBtn    = document.getElementById('aaGalNext');
    var fullBtn    = document.getElementById('aaGalFullscreen');
    var lb         = document.getElementById('aaGalLb');
    var lbImg      = document.getElementById('aaLbImg');
    var lbStrip    = document.getElementById('aaLbStrip');
    var lbCount    = document.getElementById('aaLbCount');

    if (!stage || !mainImg) return;

    var thumbs  = Array.from(rail.querySelectorAll('.aa-gal__thumb'));
    var srcs    = thumbs.map(function(t) { return t.dataset.src || ''; });
    var total   = srcs.length;
    var cur     = 0;
    var isMobile = window.innerWidth <= 1280;
    var tapZoomed = false;

    // ── Build lightbox strip ──
    srcs.forEach(function(src, i) {
      var dot = document.createElement('div');
      dot.className = 'aa-gal__lb-dot' + (i === 0 ? ' is-active' : '');
      var im = document.createElement('img');
      im.src = src; im.loading = 'lazy';
      dot.appendChild(im);
      dot.addEventListener('click', function() { lbGoTo(i); });
      lbStrip.appendChild(dot);
    });

    // ── Arrow / counter visibility ──
    if (total <= 1) {
      prevBtn && prevBtn.classList.add('is-hidden');
      nextBtn && nextBtn.classList.add('is-hidden');
      counter && counter.classList.add('is-single');
    }
    updateCounter();

    // ── Go to index ──
    function goTo(idx, force) {
      if (!force && idx === cur) return;
      if (idx < 0) idx = total - 1;
      if (idx >= total) idx = 0;

      var newSrc = srcs[idx];
      if (!newSrc) return;

      mainImg.classList.add('is-loading');

      var tmp = new Image();
      tmp.onload = function() {
        mainImg.src = newSrc;
        zoomImg.src = newSrc;
        mainImg.classList.remove('is-loading');
      };
      tmp.onerror = function() {
        mainImg.src = newSrc;
        zoomImg.src = newSrc;
        mainImg.classList.remove('is-loading');
      };
      tmp.src = newSrc;

      // Update thumbs
      thumbs.forEach(function(t, i) {
        t.classList.toggle('is-active', i === idx);
        t.setAttribute('aria-selected', i === idx ? 'true' : 'false');
        t.tabIndex = i === idx ? 0 : -1;
      });
      // Scroll active thumb into view
      if (thumbs[idx]) {
        thumbs[idx].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      }

      cur = idx;
      updateCounter();

      // If lightbox open, sync it
      if (lb.classList.contains('is-open')) {
        lbGoTo(idx);
      }
    }

    function updateCounter() {
      if (counter) counter.textContent = (cur + 1) + ' / ' + total;
      var lbDots = Array.from(lbStrip.querySelectorAll('.aa-gal__lb-dot'));
      lbDots.forEach(function(d, i) { d.classList.toggle('is-active', i === cur); });
      if (lbCount) lbCount.textContent = (cur + 1) + ' / ' + total;
    }

    // ── Thumbnail clicks ──
    thumbs.forEach(function(t, i) {
      t.addEventListener('click', function() { goTo(i, true); });
      t.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); goTo(i, true); }
        if (e.key === 'ArrowDown' || e.key === 'ArrowRight') { e.preventDefault(); if (thumbs[i+1]) thumbs[i+1].focus(); }
        if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') { e.preventDefault(); if (thumbs[i-1]) thumbs[i-1].focus(); }
      });
    });

    // ── Arrow buttons ──
    prevBtn && prevBtn.addEventListener('click', function(e) { e.stopPropagation(); goTo(cur - 1); });
    nextBtn && nextBtn.addEventListener('click', function(e) { e.stopPropagation(); goTo(cur + 1); });

    // ── Stage keyboard ──
    stage.addEventListener('keydown', function(e) {
      if (e.key === 'ArrowLeft')  { e.preventDefault(); goTo(cur - 1); }
      if (e.key === 'ArrowRight') { e.preventDefault(); goTo(cur + 1); }
      if (e.key === 'Enter' || e.key === 'f') { openLb(); }
      if (e.key === 'Escape') { stage.classList.remove('is-zooming'); }
    });

    // ── Fullscreen ──
    fullBtn && fullBtn.addEventListener('click', function(e) { e.stopPropagation(); openLb(); });

    // ── Zoom (desktop) ──
    var ZOOM_FACTOR = 2.8;
    var lensW = 120, lensH = 120;

    function setupZoom() {
      if (!mainImg) return;
      // Set pane dimensions based on stage size
      var sr = stage.getBoundingClientRect();
      zoomPane && (zoomPane.style.width = (sr.width * 0.85) + 'px');
      zoomPane && (zoomPane.style.height = (sr.height * 0.85) + 'px');
      if (zoomImg && mainImg.src) zoomImg.src = mainImg.src;
    }

    stage.addEventListener('mouseenter', function() {
      isMobile = window.innerWidth <= 1280;
      if (isMobile) return;
      if (!srcs[cur]) return;
      zoomImg.src = srcs[cur];
      stage.classList.add('is-zooming');
      setupZoom();
    });

    stage.addEventListener('mouseleave', function() {
      stage.classList.remove('is-zooming');
    });

    stage.addEventListener('mousemove', function(e) {
      isMobile = window.innerWidth <= 1280;
      if (isMobile || !stage.classList.contains('is-zooming')) return;

      var sr = stage.getBoundingClientRect();
      var mx = e.clientX - sr.left;
      var my = e.clientY - sr.top;

      // Clamp
      var lx = Math.max(lensW/2, Math.min(mx, sr.width - lensW/2));
      var ly = Math.max(lensH/2, Math.min(my, sr.height - lensH/2));

      // Position lens
      zoomLens.style.left   = (lx - lensW/2) + 'px';
      zoomLens.style.top    = (ly - lensH/2) + 'px';
      zoomLens.style.width  = lensW + 'px';
      zoomLens.style.height = lensH + 'px';

      // Position zoom image inside pane
      var paneW = zoomPane.offsetWidth;
      var paneH = zoomPane.offsetHeight;

      // Natural image size estimate
      var imgNatW = mainImg.naturalWidth || sr.width * ZOOM_FACTOR;
      var imgNatH = mainImg.naturalHeight || sr.height * ZOOM_FACTOR;
      var scaleW  = paneW / (sr.width / imgNatW);
      var scaleH  = paneH / (sr.height / imgNatH);

      var ratio = Math.min(scaleW, scaleH);
      var rW = imgNatW * (paneW / (lensW * (imgNatW / sr.width)));
      var rH = imgNatH * (paneH / (lensH * (imgNatH / sr.height)));

      // Simpler: scale image to fill pane × ZOOM_FACTOR
      var scaledW = sr.width * ZOOM_FACTOR;
      var scaledH = sr.height * ZOOM_FACTOR;

      var bgX = -((lx / sr.width) * scaledW - paneW / 2);
      var bgY = -((ly / sr.height) * scaledH - paneH / 2);

      // Clamp bg offset
      bgX = Math.min(0, Math.max(bgX, -(scaledW - paneW)));
      bgY = Math.min(0, Math.max(bgY, -(scaledH - paneH)));

      zoomImg.style.width    = scaledW + 'px';
      zoomImg.style.height   = scaledH + 'px';
      zoomImg.style.left     = bgX + 'px';
      zoomImg.style.top      = bgY + 'px';
    });

    // ── Tap zoom (mobile — pinch-style tap) ──
    stage.addEventListener('click', function(e) {
      if (e.target.closest('.aa-gal__arrow, .aa-gal__fullscreen')) return;
      isMobile = window.innerWidth <= 1280;
      if (!isMobile) return;

      if (!tapZoomed) {
        // Open lightbox on mobile tap
        openLb();
      }
    });

    // ── Touch swipe ──
    var txStart = 0, tyStart = 0;
    stage.addEventListener('touchstart', function(e) {
      txStart = e.changedTouches[0].screenX;
      tyStart = e.changedTouches[0].screenY;
    }, { passive: true });
    stage.addEventListener('touchend', function(e) {
      var dx = txStart - e.changedTouches[0].screenX;
      var dy = tyStart - e.changedTouches[0].screenY;
      if (Math.abs(dx) > 50 && Math.abs(dy) < 60) {
        dx > 0 ? goTo(cur + 1) : goTo(cur - 1);
      }
    }, { passive: true });

    // ── Lightbox ──
    function openLb() {
      lbGoTo(cur);
      lb.classList.add('is-open');
      document.body.style.overflow = 'hidden';
    }
    function closeLb() {
      lb.classList.remove('is-open');
      document.body.style.overflow = '';
    }
    function lbGoTo(idx) {
      if (idx < 0) idx = total - 1;
      if (idx >= total) idx = 0;
      lbImg.style.cssText = 'opacity:0;transform:scale(0.94);transition:opacity .22s,transform .22s;';
      var src = srcs[idx];
      setTimeout(function() {
        lbImg.src = src;
        lbImg.style.cssText = 'opacity:1;transform:scale(1);transition:opacity .22s,transform .22s;';
      }, 120);
      cur = idx;
      updateCounter();
      var dots = lbStrip.querySelectorAll('.aa-gal__lb-dot');
      dots.forEach(function(d, i) {
        d.classList.toggle('is-active', i === idx);
      });
      if (dots[idx]) dots[idx].scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
    }

    lb.addEventListener('click', function(e) {
      if (e.target === lb) closeLb();
    });

    document.addEventListener('keydown', function(e) {
      if (!lb.classList.contains('is-open')) return;
      if (e.key === 'ArrowLeft')  lbGoTo(cur - 1);
      if (e.key === 'ArrowRight') lbGoTo(cur + 1);
      if (e.key === 'Escape') closeLb();
    });

    // ── Public API ──
    window.__aaGal = {
      goTo: goTo,
      goToSrc: function(src) {
        var idx = srcs.indexOf(src);
        if (idx !== -1) { goTo(idx, true); return; }
        // src not in list — inject it temporarily
        mainImg.classList.add('is-loading');
        setTimeout(function() {
          mainImg.src = src;
          zoomImg && (zoomImg.src = src);
          mainImg.classList.remove('is-loading');
        }, 100);
      },
      next: function() { goTo(cur + 1); },
      prev: function() { goTo(cur - 1); },
      openLb: openLb,
      closeLb: closeLb,
      lbNav: function(d) { lbGoTo(cur + d); }
    };

    // ── Init zoom image ──
    zoomImg && mainImg && (zoomImg.src = mainImg.src);

    window.addEventListener('resize', function() {
      isMobile = window.innerWidth <= 1280;
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', AaGallery);
  } else {
    AaGallery();
  }
})();
</script>