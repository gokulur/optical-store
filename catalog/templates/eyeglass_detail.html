{% extends 'base.html' %}
{% block title %}{{ product.name }} | {{ product.brand.name }}{% endblock %}
{% load static %}

{% block content %}
<style>
    /* --- THEME OVERRIDES FOR EYEGLASSES --- */
    
    .brand-label {
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 1.5px;
        color: #666;
        margin-bottom: 5px;
        display: block;
        font-weight: 600;
    }

    .vto-trigger {
        position: absolute;
        bottom: 20px;
        left: 20px;
        z-index: 10;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #000;
        padding: 10px 20px;
        border-radius: 30px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .vto-trigger:hover {
        background: #000;
        color: #fff;
    }

    /* Size Guide / Frame Dimensions */
    .frame-dimensions {
        display: flex;
        gap: 15px;
        margin: 15px 0 25px 0;
        padding: 15px;
        background: #f8f8f8;
        border-radius: 8px;
        justify-content: center;
    }
    
    .dimension-item {
        text-align: center;
        font-size: 0.8rem;
    }
    
    .dimension-item span {
        display: block;
        font-weight: bold;
        font-size: 1rem;
        margin-top: 4px;
    }

    .shopify-payment-button__button {
        height: clamp(25px, var(--shopify-accelerated-checkout-button-block-size, 44px), 55px);
        min-height: clamp(25px, var(--shopify-accelerated-checkout-button-block-size, 44px), 55px);
        border-radius: 0px;
        width: 100%;
        border: none;
        color: #fff;
        cursor: pointer;
        display: block;
        font-size: 1em;
        font-weight: 500;
        text-align: center;
    }

    /* Lens Modal Styles (Simplified for inclusion) */
    .lens-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
    .lens-modal-content { background-color: #fff; margin: 5% auto; padding: 30px; border-radius: 8px; width: 90%; max-width: 600px; position: relative; }
    .close { position: absolute; right: 20px; top: 10px; font-size: 28px; cursor: pointer; }
</style>

<main class="content-for-layout focus-none" id="xo-main-content" role="main" tabindex="-1">
    <section class="shopify-section section">
        <div class="xo-section color-background-1" style="--margin: 0;--pt: 15;--pb: 15;">
            <xo-container class="xo-container--box">
                <nav aria-label="breadcrumb" class="breadcrumb" role="navigation">
                    <ol class="breadcrumb__list" style="--justify:flex-start">
                        <li class="breadcrumb__item"><a class="breadcrumb__link" href="{% url 'home' %}">Home</a><span class="breadcrumb__separator">/</span></li>
                        <li class="breadcrumb__item"><a class="breadcrumb__link" href="#">Eyeglasses</a><span class="breadcrumb__separator">/</span></li>
                        {% if product.brand %}
                        <li class="breadcrumb__item"><a class="breadcrumb__link" href="#">{{ product.brand.name }}</a><span class="breadcrumb__separator">/</span></li>
                        {% endif %}
                        <li class="breadcrumb__item breadcrumb__item--current"><a aria-current="page" class="breadcrumb__link breadcrumb--current">{{ product.name }}</a></li>
                    </ol>
                </nav>
            </xo-container>
        </div>
    </section>

    <section class="shopify-section section">
        <div class="xo-section color-background-1" style="--margin: 0;--pt: 0;--pb: 0;">
            <xo-container class="xo-container--box">
                <xo-grid>
                    <xo-animate style="--xs: 12; --md: 7">
                        <div class="xo-product-info-media-style3" style="position: sticky; position: -webkit-sticky; top: 20px;">
                            
                            <button class="vto-trigger">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                                Try On
                            </button>

                            <xo-gallery aria-label="Gallery Viewer">
                                <xo-carousel xo-name="product-information-desktop">
                                    <div class="xo-product-info-media-style3__top">
                                        <xo-carousel-inner>
                                            <xo-carousel-list aria-label="Slider" role="list">
                                                {% if product.image %}
                                                <xo-carousel-slide class="xo-product-info-media-style3__slide">
                                                    <xo-image-zoom xo-use-wheel="false" xo-zoom="3">
                                                        <xo-gallery-item>
                                                            <div class="xo-product-info-media-style3__image">
                                                                <div class="xo-media" style="--media-aspect-ratio: 1/1">
                                                                    <div class="xo-image" style="--xo-ratio-percent: 1/1;">
                                                                        <img src="{{ product.image.url }}" alt="{{ product.name }}" loading="lazy" />
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </xo-gallery-item>
                                                    </xo-image-zoom>
                                                </xo-carousel-slide>
                                                {% endif %}
                                                {% for image in product.images.all %}
                                                <xo-carousel-slide class="xo-product-info-media-style3__slide">
                                                    <xo-image-zoom xo-use-wheel="false" xo-zoom="3">
                                                        <xo-gallery-item>
                                                            <div class="xo-product-info-media-style3__image">
                                                                <div class="xo-media" style="--media-aspect-ratio: 1/1">
                                                                    <div class="xo-image" style="--xo-ratio-percent: 1/1;">
                                                                        <img src="{{ image.image.url }}" alt="{{ product.name }}" loading="lazy" />
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </xo-gallery-item>
                                                    </xo-image-zoom>
                                                </xo-carousel-slide>
                                                {% endfor %}
                                            </xo-carousel-list>
                                        </xo-carousel-inner>
                                        <xo-carousel-prev class="xo-product-info-media-style3__arrow xo-product-info-media-style3__arrow--left"><button><svg height="12" viewBox="0 0 320 512"><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z" fill="currentColor"></path></svg></button></xo-carousel-prev>
                                        <xo-carousel-next class="xo-product-info-media-style3__arrow xo-product-info-media-style3__arrow--right"><button><svg height="12" viewBox="0 0 320 512"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg></button></xo-carousel-next>
                                    </div>
                                    <xo-carousel-thumbnail class="xo-product-info-media-style3__thumbnails" xo-gap="10" xo-per-view="5">
                                        <xo-carousel-inner>
                                            <xo-carousel-list>
                                                {% if product.image %}
                                                <xo-carousel-slide class="xo-product-info-media-style3__thumb-slide">
                                                    <div class="xo-media" style="--media-aspect-ratio: 1/1"><div class="xo-image"><img src="{{ product.image.url }}" alt="thumb"/></div></div>
                                                </xo-carousel-slide>
                                                {% endif %}
                                                {% for image in product.images.all %}
                                                <xo-carousel-slide class="xo-product-info-media-style3__thumb-slide">
                                                    <div class="xo-media" style="--media-aspect-ratio: 1/1"><div class="xo-image"><img src="{{ image.image.url }}" alt="thumb"/></div></div>
                                                </xo-carousel-slide>
                                                {% endfor %}
                                            </xo-carousel-list>
                                        </xo-carousel-inner>
                                    </xo-carousel-thumbnail>
                                </xo-carousel>
                            </xo-gallery>
                        </div>
                    </xo-animate>

                    <xo-animate class="main-product__right" style="--xs: 12; --md: 5">
                        <div class="xo-product-info-content" style="position: sticky; top: 9.3rem">
                            
                            <div class="xo-product-info-content__header">
                                {% if product.brand %}
                                    <span class="brand-label">{{ product.brand.name }}</span>
                                {% endif %}
                                <h1 class="xo-product-info-content__title" style="--fz:2.2rem; margin-top:0;">
                                    {{ product.name }}
                                </h1>
                                <button class="wishlist-btn circle-btn" data-product-id="{{ product.id }}">
                                    {% if product in request.user.wishlist.products.all %}
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="red"><path d="M12 21s-6.7-4.4-10-9c-3.3-4.6.2-11 6-9 2 .6 4 2.4 4 2.4s2-1.8 4-2.4c5.8-2 9.3 4.4 6 9-3.3 4.6-10 9-10 9z"/></svg>
                                    {% else %}
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2"><path d="M12 21s-6.7-4.4-10-9c-3.3-4.6.2-11 6-9 2 .6 4 2.4 4 2.4s2-1.8 4-2.4c5.8-2 9.3 4.4 6 9-3.3 4.6-10 9-10 9z"/></svg>
                                    {% endif %}
                                </button>
                            </div>

                            <div class="xo-product-info-content__price" style="padding: 10px 0 20px;">
                                <div class="xo-price xo-price--larger">
                                    <span class="xo-price__item xo-price__item--accent">QAR {{ product.base_price }}</span>
                                    <span style="font-size:0.8rem; color:#666; display:block; font-weight:normal;">(Frame Only)</span>
                                </div>
                            </div>

                            <div class="frame-dimensions">
                                <div class="dimension-item">
                                    Lens Width
                                    <span>{{ product.lens_width|default:"50" }} mm</span>
                                </div>
                                <div class="dimension-item" style="border-left: 1px solid #ddd; border-right:1px solid #ddd; padding:0 15px;">
                                    Bridge
                                    <span>{{ product.bridge_width|default:"20" }} mm</span>
                                </div>
                                <div class="dimension-item">
                                    Temple
                                    <span>{{ product.temple_length|default:"140" }} mm</span>
                                </div>
                            </div>

                            <form method="POST" id="product_form_{{ product.id }}">
                                {% csrf_token %}
                                <input type="hidden" name="product_id" value="{{ product.id }}">

                                <button type="button" 
                                        onclick="window.location.href=''"
                                        class="xo-btn xo-btn--light xo-btn--primary xo-btn--block"
                                        style="margin-bottom: 10px; background-color: #000; color: #fff;">
                                    <span class="xo-btn__content">
                                        <span class="xo-btn__text">Select Lenses</span>
                                    </span>
                                </button>

                                <button type="button" 
                                        class="xo-btn xo-btn--light xo-btn--block add-to-cart-btn"
                                        data-url=""
                                        style="background-color: transparent; border: 1px solid #000; color: #000;">
                                    <span class="xo-btn__content">
                                        <span class="xo-btn__text">Buy Frame Only</span>
                                    </span>
                                </button>

                            </form>

                            <div class="shipping" style="margin-top: 30px;">
                                <div class="shipping_item" style="display: flex; gap: 15px; margin-bottom: 15px;">
                                    <svg height="27" width="24" viewBox="0 0 150 150"><path d="M139.75,121.3c-0.34,0.71-0.59,1.47-1.03,2.12..." fill="currentColor"/></svg>
                                    <p style="margin: 0;">1 Year Warranty on Frames.</p>
                                </div>
                                <div class="shipping_item" style="display: flex; gap: 15px;">
                                    <svg height="27" width="22" viewBox="0 0 150 150"><path d="M94.51,19.67c0,0.77,0,1.36,0,1.96..." fill="currentColor"/></svg>
                                    <p style="margin: 0;">Free Lens Cleaning Kit included.</p>
                                </div>
                            </div>

                        </div>
                    </xo-animate>
                </xo-grid>
            </xo-container>
        </div>
    </section>

    <section class="shopify-section section">
        <div class="xo-section color-background-1" style="--pt: 50; --pb: 50;">
            <xo-container class="xo-container--box">
                <xo-tabs>
                    <xo-list class="product-information-tabs__header">
                        <xo-list-item><xo-tabs-trigger class="product-information-tabs__trigger" xo-active xo-name="tab-desc">Description</xo-tabs-trigger></xo-list-item>
                        <xo-list-item><xo-tabs-trigger class="product-information-tabs__trigger" xo-name="tab-specs">Specifications</xo-tabs-trigger></xo-list-item>
                    </xo-list>
                    <xo-tabs-content>
                        <xo-tabs-pane xo-name="tab-desc">
                            <div style="padding: 20px;">{{ product.description|linebreaksbr }}</div>
                        </xo-tabs-pane>
                        <xo-tabs-pane xo-name="tab-specs">
                            <div style="padding: 20px;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <tr style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 10px; font-weight: bold;">Frame Material</td>
                                        <td style="padding: 10px;">{{ product.frame_material|default:"Acetate" }}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 10px; font-weight: bold;">Frame Shape</td>
                                        <td style="padding: 10px;">{{ product.frame_shape|default:"Rectangle" }}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 10px; font-weight: bold;">Gender</td>
                                        <td style="padding: 10px;">{{ product.get_gender_display }}</td>
                                    </tr>
                                    {% for spec in specifications %}
                                    <tr style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 10px; font-weight: bold;">{{ spec.name }}</td>
                                        <td style="padding: 10px;">{{ spec.value }}</td>
                                    </tr>
                                    {% endfor %}
                                </table>
                            </div>
                        </xo-tabs-pane>
                    </xo-tabs-content>
                </xo-tabs>
            </xo-container>
        </div>
    </section>

    {% if related_products %}
    <section class="shopify-section section">
        <div class="xo-section color-background-1" style="--pt: 50; --pb: 50;">
            <xo-container class="xo-container--box">
                <h2 class="xo-section-heading__title" style="text-align: center; margin-bottom: 30px;">Similar Styles</h2>
                <xo-grid style="--xs: 1; --sm: 2; --md: 4; gap: 20px;">
                    {% for rp in related_products %}
                    <div class="product-card">
                        <a href="{% url 'catalog:eyeglass_detail' rp.slug %}">
                            {% if rp.image %}
                            <img src="{{ rp.image.url }}" alt="{{ rp.name }}" style="width: 100%; border-radius: 8px;"/>
                            {% endif %}
                            <h3 style="margin-top: 10px; font-size: 16px;">{{ rp.name }}</h3>
                            <p style="font-weight: bold;">QAR {{ rp.base_price }}</p>
                        </a>
                    </div>
                    {% endfor %}
                </xo-grid>
            </xo-container>
        </div>
    </section>
    {% endif %}
</main>

<script>
// ------------------------------
// Add to Cart AJAX (Frame Only)
// ------------------------------
document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const form = this.closest('form');
        const url = this.dataset.url;
        const formData = new FormData(form);

        // Visual feedback
        const btnText = this.querySelector('.xo-btn__text');
        const originalText = btnText.innerText;
        btnText.innerText = 'Adding...';

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
            },
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // Assuming you have a global function for notifications
                if(typeof showNotification === "function") {
                    showNotification('Frame added to cart successfully', 'success');
                } else {
                    alert('Frame added to cart!');
                }
            } else {
                alert(data.message || 'Something went wrong');
            }
        })
        .catch(() => {
            alert('Server error. Try again.');
        })
        .finally(() => {
            btnText.innerText = originalText;
        });
    });
});
</script>
{% endblock %}