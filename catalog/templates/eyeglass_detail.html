{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %}{{ product.name }} ‚Äì Al Ameen Optics{% endblock %}

{% block content %}
<style>
:root {
  --aa-ink:#0d0d0d;--aa-ink-soft:#555;--aa-gold:#b8976a;--aa-gold-lt:#d4b896;
  --aa-sand:#f7f3ed;--aa-muted:#8a8580;--aa-border:#e8e2d8;
  --aa-green:#2a7a2a;--aa-green-bg:#f0f7ee;
  --aa-radius:12px;--aa-shadow:0 4px 24px rgba(0,0,0,.08);
  --aa-ease:cubic-bezier(.4,0,.2,1);--aa-t:.26s;
}

/* ‚ïê‚ïê GAL GALLERY ‚ïê‚ïê */
.gal{display:grid;grid-template-columns:88px 1fr;gap:12px;position:sticky;top:90px;align-self:start;}
@media(max-width:960px){.gal{position:static;}}
@media(max-width:540px){.gal{grid-template-columns:1fr;}}
.gal__rail{display:flex;flex-direction:column;gap:8px;max-height:520px;overflow-y:auto;overflow-x:hidden;scrollbar-width:thin;scrollbar-color:#d4b896 transparent;padding:2px;}
.gal__rail::-webkit-scrollbar{width:3px;}
.gal__rail::-webkit-scrollbar-thumb{background:#d4b896;border-radius:99px;}
@media(max-width:540px){.gal__rail{flex-direction:row;max-height:none;overflow-y:hidden;overflow-x:auto;order:2;}}
.gal__thumb{flex-shrink:0;width:84px;height:84px;border-radius:10px;overflow:hidden;border:2px solid var(--aa-border);background:var(--aa-sand);cursor:pointer;transition:border-color .2s,transform .2s;}
@media(max-width:540px){.gal__thumb{width:68px;height:68px;}}
.gal__thumb img{width:100%;height:100%;object-fit:contain;padding:4px;display:block;}
.gal__thumb:hover{border-color:var(--aa-gold);transform:translateX(2px);}
@media(max-width:540px){.gal__thumb:hover{transform:translateY(-2px);}}
.gal__thumb.is-active{border-color:var(--aa-ink);box-shadow:0 0 0 1px var(--aa-ink);}
.gal__stage-wrap{position:relative;}
.gal__stage{position:relative;width:100%;aspect-ratio:1/1;border-radius:16px;overflow:hidden;background:var(--aa-sand);cursor:zoom-in;}
.gal__img{width:100%;height:100%;object-fit:contain;padding:24px;display:block;transition:opacity .18s ease;}
.gal__img.fading{opacity:0;}
.gal__placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--aa-gold);}
.gal__arr{position:absolute;top:50%;transform:translateY(-50%);width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,.9);border:1px solid rgba(0,0,0,.08);display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:10;box-shadow:0 2px 10px rgba(0,0,0,.12);opacity:0;pointer-events:none;transition:opacity .2s;color:#1a1a1a;}
.gal__stage:hover .gal__arr{opacity:1;pointer-events:auto;}
.gal__arr--prev{left:10px;}
.gal__arr--next{right:10px;}
.gal__arr.hidden{display:none!important;}
.gal__counter{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);background:rgba(10,10,10,.45);backdrop-filter:blur(6px);color:#fff;font-size:11px;font-weight:700;letter-spacing:.1em;padding:4px 12px;border-radius:99px;pointer-events:none;}
.gal__counter.solo{display:none;}
.gal__fs{position:absolute;bottom:12px;right:12px;width:34px;height:34px;border-radius:8px;background:rgba(255,255,255,.88);border:1px solid rgba(0,0,0,.07);display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:10;opacity:0;pointer-events:none;transition:opacity .2s;}
.gal__stage:hover .gal__fs{opacity:1;pointer-events:auto;}
.gal__lb{display:none;position:fixed;inset:0;z-index:99999;background:rgba(6,6,6,.96);backdrop-filter:blur(16px);flex-direction:column;align-items:center;justify-content:center;gap:18px;}
.gal__lb.open{display:flex;}
.gal__lb-close{position:fixed;top:18px;right:22px;width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;}
.gal__lb-img{max-width:88vw;max-height:76vh;object-fit:contain;border-radius:12px;}
.gal__lb-nav{position:fixed;top:50%;transform:translateY(-50%);width:50px;height:50px;border-radius:50%;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.18);color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;}
.gal__lb-nav--prev{left:18px;}
.gal__lb-nav--next{right:18px;}
.gal__lb-strip{display:flex;gap:8px;overflow-x:auto;max-width:90vw;scrollbar-width:thin;}
.gal__lb-dot{flex-shrink:0;width:58px;height:58px;border-radius:8px;overflow:hidden;border:2.5px solid rgba(255,255,255,.15);cursor:pointer;transition:border-color .2s;}
.gal__lb-dot img{width:100%;height:100%;object-fit:contain;padding:3px;}
.gal__lb-dot.active{border-color:#d4b896;}
.gal__lb-count{position:fixed;top:24px;left:50%;transform:translateX(-50%);color:rgba(255,255,255,.5);font-size:13px;font-weight:600;letter-spacing:.1em;}

/* ‚ïê‚ïê PAGE ‚ïê‚ïê */
.pd-page{max-width:1340px;margin:0 auto;padding:0 24px 100px;}
.pd-crumb{display:flex;align-items:center;gap:6px;flex-wrap:wrap;padding:16px 0 28px;font-size:12px;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:var(--aa-muted);}
.pd-crumb a{color:var(--aa-muted);text-decoration:none;transition:color var(--aa-t);}
.pd-crumb a:hover{color:var(--aa-ink);}
.pd-crumb-sep{font-size:10px;color:#ccc;}
.pd-grid{display:grid;grid-template-columns:1fr 1fr;gap:60px;align-items:start;}
@media(max-width:960px){.pd-grid{grid-template-columns:1fr;gap:32px;}}
.pi{display:flex;flex-direction:column;}
.pi__badges{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:14px;}
.pi__badge{font-size:10px;font-weight:800;letter-spacing:.1em;text-transform:uppercase;padding:4px 10px;border-radius:4px;}
.pi__badge--brand{background:var(--aa-sand);color:var(--aa-gold);}
.pi__badge--sale{background:var(--aa-green-bg);color:var(--aa-green);}
.pi__badge--gender{background:#f0f0ff;color:#5558a8;}
.pi__title{font-size:clamp(22px,2.6vw,32px);font-weight:800;line-height:1.15;color:var(--aa-ink);letter-spacing:-.03em;margin:0 0 10px;}
.pi__meta{display:flex;align-items:center;gap:14px;margin-bottom:6px;flex-wrap:wrap;}
.pi__brand{font-size:13px;color:var(--aa-muted);}
.pi__brand strong{color:var(--aa-ink);}
.pi__sku{font-size:11px;color:#c5c0b8;letter-spacing:.06em;}
.pi__wish{margin-left:auto;flex-shrink:0;width:44px;height:44px;border-radius:50%;background:var(--aa-sand);border:2px solid var(--aa-border);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all var(--aa-t);}
.pi__wish:hover,.pi__wish.is-on{border-color:#e05f5f;background:#fff5f5;}
.pi__wish svg{width:18px;height:18px;transition:fill var(--aa-t),stroke var(--aa-t);}
.pi__price-box{display:flex;align-items:baseline;gap:12px;flex-wrap:wrap;padding:18px 22px;border-radius:var(--aa-radius);background:var(--aa-sand);border:1px solid rgba(184,151,106,.18);margin:20px 0 22px;}
.pi__price{font-size:34px;font-weight:900;color:var(--aa-ink);letter-spacing:-.04em;}
.pi__price-was{font-size:17px;color:var(--aa-muted);text-decoration:line-through;}
.pi__price-save{font-size:12px;font-weight:800;background:var(--aa-green);color:#fff;padding:3px 9px;border-radius:4px;letter-spacing:.04em;}
.pi__desc{font-size:14px;line-height:1.78;color:var(--aa-ink-soft);margin-bottom:22px;}
.pi__lbl{font-size:11px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--aa-muted);margin-bottom:10px;}
.pi__swatches{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:24px;}
.pi__swatch{display:flex;flex-direction:column;align-items:center;gap:5px;cursor:pointer;outline:none;}
.pi__swatch-dot{width:36px;height:36px;border-radius:50%;border:3px solid transparent;box-shadow:0 0 0 1.5px var(--aa-border);transition:all var(--aa-t);}
.pi__swatch:hover .pi__swatch-dot,.pi__swatch.is-on .pi__swatch-dot{box-shadow:0 0 0 2.5px var(--aa-gold);transform:scale(1.1);}
.pi__swatch-name{font-size:10px;color:var(--aa-muted);font-weight:500;}
.pi__select{width:100%;padding:13px 16px;margin-bottom:22px;border:2px solid var(--aa-border);border-radius:var(--aa-radius);font-size:14px;font-weight:600;color:var(--aa-ink);background:#fff;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%238a8580' stroke-width='1.6' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 16px center;transition:border-color var(--aa-t);}
.pi__select:focus{border-color:var(--aa-gold);outline:none;}
.pi__qty-wrap{margin-bottom:22px;}
.pi__qty{display:inline-flex;align-items:center;border:2px solid var(--aa-border);border-radius:var(--aa-radius);overflow:hidden;}
.pi__qty-btn{width:46px;height:46px;border:none;background:var(--aa-sand);font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--aa-ink);transition:background var(--aa-t);line-height:1;}
.pi__qty-btn:hover{background:var(--aa-border);}
.pi__qty-num{width:56px;height:46px;border:none;border-left:2px solid var(--aa-border);border-right:2px solid var(--aa-border);text-align:center;font-size:16px;font-weight:700;color:var(--aa-ink);background:#fff;}
.pi__qty-num:focus{outline:none;}
.pi__lens-ok{display:none;align-items:center;gap:8px;background:var(--aa-green-bg);border:1px solid #3a8a2e;color:#2a6a20;border-radius:8px;padding:10px 14px;font-size:13px;font-weight:600;margin-bottom:14px;}
.pi__lens-ok.is-show{display:flex;}
.pi__lens-ok button{margin-left:auto;background:none;border:none;color:#2a6a20;font-size:12px;font-weight:700;cursor:pointer;text-decoration:underline;}
.pi__cta{display:flex;flex-direction:column;gap:12px;margin-bottom:26px;}
.pi__btn{width:100%;padding:17px 24px;border-radius:50px;font-size:14px;font-weight:800;letter-spacing:.06em;text-transform:uppercase;cursor:pointer;transition:all var(--aa-t);border:2px solid transparent;}
.pi__btn--lens{background:#fff;border-color:var(--aa-gold);color:var(--aa-gold);}
.pi__btn--lens:hover{background:var(--aa-gold);color:#fff;}
.pi__btn--cart{background:var(--aa-ink);border-color:var(--aa-ink);color:#fff;}
.pi__btn--cart:hover{background:#2a2a2a;}
.pi__btn--buy{background:var(--aa-gold);border-color:var(--aa-gold);color:#fff;}
.pi__btn--buy:hover{background:#a07050;border-color:#a07050;}
.pi__trust{background:var(--aa-sand);border-radius:var(--aa-radius);padding:16px 20px;display:flex;flex-direction:column;gap:12px;border:1px solid rgba(184,151,106,.18);margin-bottom:24px;}
.pi__trust-row{display:flex;align-items:center;gap:12px;font-size:13px;color:var(--aa-ink);}
.pi__trust-icon{width:34px;height:34px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 1px 6px rgba(0,0,0,.07);}
.pi__trust-icon svg{width:15px;height:15px;color:var(--aa-gold);}
.pi__specs-table{width:100%;border-collapse:collapse;font-size:14px;margin-top:8px;}
.pi__specs-table tr{border-bottom:1px solid var(--aa-border);}
.pi__specs-table td{padding:10px 0;vertical-align:top;}
.pi__specs-table td:first-child{font-weight:600;color:var(--aa-ink);width:44%;}
.pi__specs-table td:last-child{color:var(--aa-muted);}
.pd-section{padding:52px 0;border-top:1px solid var(--aa-border);}
.pd-section__h{font-size:22px;font-weight:800;color:var(--aa-ink);margin-bottom:18px;letter-spacing:-.02em;}
.pd-section__body{font-size:15px;line-height:1.85;color:var(--aa-ink-soft);}
.pd-rel-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:18px;margin-top:24px;}
@media(max-width:860px){.pd-rel-grid{grid-template-columns:repeat(2,1fr);}}
.pd-rel-card{text-decoration:none;color:inherit;display:block;border-radius:var(--aa-radius);overflow:hidden;border:1px solid var(--aa-border);background:#fff;transition:all var(--aa-t);}
.pd-rel-card:hover{transform:translateY(-4px);box-shadow:var(--aa-shadow);border-color:var(--aa-gold-lt);}
.pd-rel-card__img{aspect-ratio:1/1;background:var(--aa-sand);overflow:hidden;}
.pd-rel-card__img img{width:100%;height:100%;object-fit:contain;padding:10px;transition:transform .4s;display:block;}
.pd-rel-card:hover .pd-rel-card__img img{transform:scale(1.06);}
.pd-rel-card__info{padding:14px;}
.pd-rel-card__brand{font-size:10px;color:var(--aa-gold);font-weight:700;text-transform:uppercase;letter-spacing:.08em;}
.pd-rel-card__name{font-size:14px;font-weight:700;margin:4px 0;color:var(--aa-ink);line-height:1.3;}
.pd-rel-card__price{font-size:15px;font-weight:800;color:var(--aa-ink);}
.pd-toast{position:fixed;bottom:28px;right:28px;z-index:99999;padding:14px 22px;border-radius:var(--aa-radius);font-size:14px;font-weight:700;color:#fff;box-shadow:0 8px 32px rgba(0,0,0,.2);pointer-events:none;transform:translateY(70px);opacity:0;transition:all .32s var(--aa-ease);max-width:320px;background:var(--aa-ink);}
.pd-toast.is-show{transform:translateY(0);opacity:1;}
.pd-toast--ok{background:var(--aa-green)!important;}
.pd-toast--err{background:#c03020!important;}

/* ‚ïê‚ïê LENS MODAL ‚ïê‚ïê */
.lm-ov{display:none;position:fixed;inset:0;z-index:8888;background:rgba(13,13,13,.55);backdrop-filter:blur(5px);align-items:flex-start;justify-content:center;padding:24px 16px;overflow-y:auto;}
.lm-ov.is-open{display:flex;}
.lm-box{background:#fff;width:100%;max-width:900px;border-radius:20px;overflow:hidden;box-shadow:0 24px 80px rgba(0,0,0,.2);animation:lmIn .3s var(--aa-ease);margin:auto;}
@keyframes lmIn{from{opacity:0;transform:translateY(22px) scale(.97);}to{opacity:1;transform:none;}}
.lm-head{padding:22px 28px 0;display:flex;align-items:center;justify-content:space-between;}
.lm-head h3{margin:0;font-size:20px;font-weight:800;}
.lm-close{background:none;border:none;font-size:26px;cursor:pointer;color:var(--aa-muted);line-height:1;padding:0 4px;}
.lm-close:hover{color:var(--aa-ink);}
.lm-tabs{display:flex;border-bottom:2px solid var(--aa-border);overflow-x:auto;padding:0 28px;margin-top:18px;scrollbar-width:none;gap:0;}
.lm-tabs::-webkit-scrollbar{display:none;}
.lm-tab{padding:12px 18px;border:none;background:transparent;font-size:13px;font-weight:700;color:var(--aa-muted);cursor:pointer;white-space:nowrap;border-bottom:3px solid transparent;margin-bottom:-2px;transition:all var(--aa-t);letter-spacing:.01em;}
.lm-tab:hover{color:var(--aa-ink);}
.lm-tab.active{color:var(--aa-ink);border-bottom-color:var(--aa-ink);}
.lm-panel{display:none;padding:22px 28px 0;}
.lm-panel.active{display:block;}
.lm-panel-h{font-size:15px;font-weight:800;color:var(--aa-ink);margin-bottom:16px;}
.lm-opt{border:2px solid var(--aa-border);border-radius:var(--aa-radius);padding:16px 20px;margin-bottom:10px;cursor:pointer;transition:all var(--aa-t);}
.lm-opt:hover{border-color:#aaa;box-shadow:var(--aa-shadow);}
.lm-opt.is-on{border-color:var(--aa-ink);background:var(--aa-sand);}
.lm-opt-top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:5px;}
.lm-opt-left{display:flex;align-items:center;gap:12px;}
.lm-radio{width:20px;height:20px;border-radius:50%;border:2px solid var(--aa-border);flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all var(--aa-t);}
.lm-opt.is-on .lm-radio{border-color:var(--aa-ink);background:var(--aa-ink);}
.lm-radio::after{content:'';width:8px;height:8px;border-radius:50%;background:#fff;display:none;}
.lm-opt.is-on .lm-radio::after{display:block;}
.lm-opt-name{font-size:14px;font-weight:700;}
.lm-opt-idx{font-size:12px;color:var(--aa-muted);margin-top:2px;}
.lm-opt-price{font-size:17px;font-weight:800;white-space:nowrap;flex-shrink:0;}
.lm-feats{list-style:none;padding:0;margin:6px 0 0 32px;display:flex;flex-wrap:wrap;gap:6px;}
.lm-feats li{font-size:12px;background:#fff;border:1px solid var(--aa-border);border-radius:4px;padding:3px 8px;color:#444;}
.lm-addons{margin:12px 0 0 32px;padding-top:12px;border-top:1px solid var(--aa-border);display:none;}
.lm-opt.is-on .lm-addons{display:block;}
.lm-addon-lbl{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:8px;cursor:pointer;font-size:13px;transition:background var(--aa-t);margin-bottom:3px;}
.lm-addon-lbl:hover{background:#f0f0f0;}
.lm-addon-lbl input{accent-color:var(--aa-ink);}
.lm-addon-n{flex:1;font-weight:500;}
.lm-addon-p{color:var(--aa-gold);font-weight:700;font-size:12px;}
.lm-addon-lbl.is-on{background:#fff8f0;}
.reading-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(76px,1fr));gap:10px;margin-bottom:18px;}
.pwr-chip{padding:12px 6px;border:2px solid var(--aa-border);border-radius:8px;text-align:center;cursor:pointer;font-size:14px;font-weight:600;transition:all var(--aa-t);background:#fff;}
.pwr-chip:hover{border-color:var(--aa-gold);}
.pwr-chip.is-on{border-color:var(--aa-ink);background:var(--aa-ink);color:#fff;}
.rx-section{background:var(--aa-sand);border-radius:var(--aa-radius);padding:18px;margin:18px 0;}
.rx-lbl{font-size:11px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--aa-muted);margin-bottom:12px;}
.rx-tbl{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden;}
.rx-tbl th{background:var(--aa-ink);color:#fff;padding:9px 12px;font-size:13px;font-weight:600;text-align:left;}
.rx-tbl td{padding:9px 12px;border-bottom:1px solid var(--aa-border);}
.rx-tbl tr:last-child td{border-bottom:none;}
.rx-tbl td:first-child{font-weight:600;font-size:13px;white-space:nowrap;}
.rx-inp{width:100%;padding:7px 9px;border:1.5px solid var(--aa-border);border-radius:6px;font-size:13px;min-width:60px;transition:border-color var(--aa-t);}
.rx-inp:focus{border-color:var(--aa-gold);outline:none;}
.lm-foot{padding:18px 28px 24px;border-top:1px solid var(--aa-border);background:#fff;position:sticky;bottom:0;}
.lm-total{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.lm-total-lbl{font-size:14px;font-weight:600;}
.lm-total-val{font-size:24px;font-weight:900;letter-spacing:-.03em;}
.lm-confirm{width:100%;padding:15px;background:var(--aa-ink);color:#fff;border:none;border-radius:50px;font-size:15px;font-weight:800;cursor:pointer;transition:background var(--aa-t);letter-spacing:.04em;}
.lm-confirm:hover{background:#2a2a2a;}
</style>

<div class="pd-page">

  <nav class="pd-crumb">
    <a href="{% url 'home' %}">Home</a>
    <span class="pd-crumb-sep">‚Ä∫</span>
    <a href="{% url 'catalog:eyeglasses_list' %}">Eyeglasses</a>
    <span class="pd-crumb-sep">‚Ä∫</span>
    <span>{{ product.name }}</span>
  </nav>

  <div class="pd-grid">

    <!-- ‚ïê‚ïê GALLERY ‚ïê‚ïê -->
    <div>
      <div class="gal" id="galRoot">

        <!-- Thumbnail Rail -->
        <div class="gal__rail" id="galRail">
          {% if primary_image %}
          <div class="gal__thumb is-active" data-src="{{ primary_image.image.url }}" tabindex="0">
            <img src="{{ primary_image.image.url }}" alt="{{ product.name }}" loading="eager">
          </div>
          {% endif %}
          {% for img in images %}
          <div class="gal__thumb" data-src="{{ img.image.url }}" tabindex="0">
            <img src="{{ img.image.url }}" alt="{{ product.name }}" loading="lazy">
          </div>
          {% endfor %}
          {% for v in variants %}{% if v.images.exists %}
          <div class="gal__thumb" data-src="{{ v.images.first.image.url }}" data-variant="{{ v.id }}" tabindex="0" title="{{ v.color_name }}">
            <img src="{{ v.images.first.image.url }}" alt="{{ v.color_name }}" loading="lazy">
          </div>
          {% endif %}{% endfor %}
        </div>

        <!-- Main Stage -->
        <div class="gal__stage-wrap">
          <div class="gal__stage" id="galStage" tabindex="0">
            {% if primary_image %}
            <img class="gal__img" id="galMain" src="{{ primary_image.image.url }}" alt="{{ product.name }}">
            {% else %}
            <div class="gal__placeholder">
              <svg width="80" height="80" viewBox="0 0 80 80" fill="none"><rect x="8" y="8" width="64" height="64" rx="6" stroke="currentColor" stroke-width="2"/><circle cx="30" cy="32" r="8" stroke="currentColor" stroke-width="2"/><path d="M8 55l20-18 14 12 10-10 20 16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            {% endif %}
            <button class="gal__arr gal__arr--prev hidden" id="galPrev" type="button" aria-label="Previous image">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg>
            </button>
            <button class="gal__arr gal__arr--next hidden" id="galNext" type="button" aria-label="Next image">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="9 18 15 12 9 6"/></svg>
            </button>
            <span class="gal__counter solo" id="galCounter">1 / 1</span>
            <button class="gal__fs" id="galFs" type="button" aria-label="Fullscreen">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê PRODUCT INFO ‚ïê‚ïê -->
    <div class="pi">
      <div style="display:flex;align-items:flex-start;gap:10px;margin-bottom:12px;">
        <div class="pi__badges">
          {% if product.brand %}<span class="pi__badge pi__badge--brand">{{ product.brand.name }}</span>{% endif %}
          {% if product.compare_at_price %}<span class="pi__badge pi__badge--sale">Sale</span>{% endif %}
          {% if product.gender != 'unisex' %}<span class="pi__badge pi__badge--gender">{{ product.gender|capfirst }}</span>{% endif %}
        </div>
        <button class="pi__wish{% if product in request.user.wishlist.products.all %} is-on{% endif %}" id="piWishBtn" data-product-id="{{ product.id }}" aria-label="Wishlist">
          <svg viewBox="0 0 24 24" fill="{% if product in request.user.wishlist.products.all %}#e05f5f{% else %}none{% endif %}" stroke="{% if product in request.user.wishlist.products.all %}#e05f5f{% else %}currentColor{% endif %}" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
        </button>
      </div>

      <h1 class="pi__title">{{ product.name }}</h1>
      <div class="pi__meta">
        {% if product.brand %}<span class="pi__brand">Brand: <strong>{{ product.brand.name }}</strong></span>{% endif %}
        {% if product.sku %}<span class="pi__sku">SKU: {{ product.sku }}</span>{% endif %}
      </div>

      <div class="pi__price-box">
        <span class="pi__price" id="dispPrice">QAR {{ product.base_price }}</span>
        {% if product.compare_at_price %}
        <span class="pi__price-was">QAR {{ product.compare_at_price }}</span>
        <span class="pi__price-save">Save QAR {{ product.compare_at_price|floatformat:0 }}</span>
        {% endif %}
      </div>

      {% if product.short_description %}<p class="pi__desc">{{ product.short_description }}</p>{% endif %}

      <form id="pdForm" onsubmit="return false;">
        {% csrf_token %}
        <input type="hidden" name="product_id" value="{{ product.id }}">
        <input type="hidden" name="selected_variant_id" id="hdVariant" value="">
        <input type="hidden" name="selected_lens_option" id="hdLensOpt" value="">
        <input type="hidden" name="lens_addon" id="hdLensAddon" value="">
        <input type="hidden" name="total_lens_price" id="hdLensPrice" value="0">
        <input type="hidden" name="lens_category" id="hdLensCat" value="">
        <input type="hidden" name="right_sph" id="h_rSph">
        <input type="hidden" name="right_cyl" id="h_rCyl">
        <input type="hidden" name="right_axis" id="h_rAxis">
        <input type="hidden" name="right_add" id="h_rAdd">
        <input type="hidden" name="left_sph" id="h_lSph">
        <input type="hidden" name="left_cyl" id="h_lCyl">
        <input type="hidden" name="left_axis" id="h_lAxis">
        <input type="hidden" name="left_add" id="h_lAdd">

        {% if variants %}
        <p class="pi__lbl">Frame Color</p>
        <div class="pi__swatches">
          {% for v in variants %}
          <div class="pi__swatch{% if forloop.first %} is-on{% endif %}"
               data-variant="{{ v.id }}"
               data-img="{% if v.images.exists %}{{ v.images.first.image.url }}{% endif %}"
               onclick="pickVariant(this)" tabindex="0" role="button">
            <div class="pi__swatch-dot" style="background:{% if v.color_code %}{{ v.color_code }}{% else %}linear-gradient(135deg,#ccc,#999){% endif %};"></div>
            <span class="pi__swatch-name">{{ v.color_name }}</span>
          </div>
          {% endfor %}
        </div>
        {% endif %}

        {% if variants.0.size %}
        <p class="pi__lbl">Frame Size</p>
        <select class="pi__select" name="selected_size">
          <option value="">Select size</option>
          {% for v in variants %}{% if v.size %}<option value="{{ v.size }}">{{ v.size }}</option>{% endif %}{% endfor %}
        </select>
        {% endif %}

        <p class="pi__lbl">Quantity</p>
        <div class="pi__qty-wrap">
          <div class="pi__qty">
            <button type="button" class="pi__qty-btn" onclick="chQty(-1)">‚àí</button>
            <input class="pi__qty-num" type="number" id="qtyVal" name="quantity" value="1" min="1" max="{{ product.stock_quantity|default:99 }}" readonly>
            <button type="button" class="pi__qty-btn" onclick="chQty(1)">+</button>
          </div>
        </div>

        <div class="pi__lens-ok" id="lensOk">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
          <span id="lensOkTxt">Lens selected</span>
          <button type="button" onclick="openLm()">Change</button>
        </div>

        <div class="pi__cta">
          <button type="button" class="pi__btn pi__btn--lens" onclick="openLm()">üîç Select Lenses (Required)</button>
          <button type="button" class="pi__btn pi__btn--cart" id="cartBtn" onclick="addCart()">
            <svg style="width:16px;height:16px;vertical-align:middle;margin-right:6px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg>Add to Cart
          </button>
          <button type="button" class="pi__btn pi__btn--buy" onclick="buyNow()">Buy it Now ‚Üí</button>
        </div>
      </form>

      <div class="pi__trust">
        <div class="pi__trust-row"><div class="pi__trust-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13" rx="1"/><path d="M16 8h4l3 5v3h-7V8z"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg></div><span>Delivery in <strong>3‚Äì6 business days</strong> ¬∑ Qatar / GCC</span></div>
        <div class="pi__trust-row"><div class="pi__trust-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></div><span>Free returns within <strong>45 days</strong></span></div>
        <div class="pi__trust-row"><div class="pi__trust-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M9 12l2 2 4-4"/></svg></div><span><strong>100% Authentic</strong> guaranteed</span></div>
      </div>

      {% if specifications %}
      <p class="pi__lbl">Specifications</p>
      <table class="pi__specs-table">
        {% for s in specifications %}<tr><td>{{ s.spec_key }}</td><td>{{ s.spec_value }}</td></tr>{% endfor %}
      </table>
      {% endif %}
    </div>
  </div>

  {% if product.description %}
  <div class="pd-section">
    <h2 class="pd-section__h">About This Product</h2>
    <div class="pd-section__body">{{ product.description|linebreaksbr }}</div>
  </div>
  {% endif %}

  {% if related_products %}
  <div class="pd-section">
    <h2 class="pd-section__h">You May Also Like</h2>
    <div class="pd-rel-grid">
      {% for r in related_products %}
      <a href="{% url 'catalog:eyeglass_detail' r.slug %}" class="pd-rel-card">
        <div class="pd-rel-card__img">
          {% with r.images.first as rimg %}
            {% if rimg %}<img src="{{ rimg.image.url }}" alt="{{ r.name }}" loading="lazy">{% endif %}
          {% endwith %}
        </div>
        <div class="pd-rel-card__info">
          {% if r.brand %}<p class="pd-rel-card__brand">{{ r.brand.name }}</p>{% endif %}
          <p class="pd-rel-card__name">{{ r.name }}</p>
          <p class="pd-rel-card__price">QAR {{ r.base_price }}</p>
        </div>
      </a>
      {% endfor %}
    </div>
  </div>
  {% endif %}

</div><!-- /pd-page -->

<!-- ‚ïê‚ïê LENS MODAL ‚ïê‚ïê -->
<div class="lm-ov" id="lmOv" onclick="if(event.target===this)closeLm()">
  <div class="lm-box">
    <div class="lm-head">
      <h3>Select Your Lenses</h3>
      <button class="lm-close" onclick="closeLm()">√ó</button>
    </div>
    <div class="lm-tabs">
      <button class="lm-tab active" onclick="showPanel('p-sv',this)">Single Vision</button>
      <button class="lm-tab" onclick="showPanel('p-prog',this)">Progressive & Bifocal</button>
      <button class="lm-tab" onclick="showPanel('p-rd',this)">Reading</button>
      <button class="lm-tab" onclick="showPanel('p-np',this)">No Prescription</button>
    </div>

    <!-- Single Vision -->
    <div id="p-sv" class="lm-panel active">
      <p class="lm-panel-h">Single-Vision Lenses</p>
      <div class="lm-opt" onclick="selCard(this,'regular_basic',150,'sv')">
        <div class="lm-opt-top"><div class="lm-opt-left"><div class="lm-radio"></div><div><div class="lm-opt-name">Regular Lens (Basic)</div><div class="lm-opt-idx">Index 1.56</div></div></div><div class="lm-opt-price">150 QAR</div></div>
        <ul class="lm-feats"><li>Anti-reflection</li><li>Power ¬±4.00 / CYL ¬±2.00</li></ul>
        <div class="lm-addons">
          <div class="lm-addon-lbl" onclick="pickAddon(event,this,0)"><input type="radio" name="a_rb" value="none" checked><span class="lm-addon-n">Regular</span><span class="lm-addon-p">Included</span></div>
          <div class="lm-addon-lbl" onclick="pickAddon(event,this,100)"><input type="radio" name="a_rb" value="blue_uv"><span class="lm-addon-n">Blue UV Protection</span><span class="lm-addon-p">+100 QAR</span></div>
          <div class="lm-addon-lbl" onclick="pickAddon(event,this,100)"><input type="radio" name="a_rb" value="photochromic"><span class="lm-addon-n">Photochromic</span><span class="lm-addon-p">+100 QAR</span></div>
        </div>
      </div>
      <div class="lm-opt" onclick="selCard(this,'essilor_easy_pro',270,'sv')">
        <div class="lm-opt-top"><div class="lm-opt-left"><div class="lm-radio"></div><div><div class="lm-opt-name">Essilor Crizal Easy Pro</div><div class="lm-opt-idx">Index 1.56</div></div></div><div class="lm-opt-price">270 QAR</div></div>
        <ul class="lm-feats"><li>Anti-reflection & UV</li><li>Easy cleaning</li><li>Power ¬±3.00</li></ul>
        <div class="lm-addons">
          <div class="lm-addon-lbl" onclick="pickAddon(event,this,0)"><input type="radio" name="a_ep" value="none" checked><span class="lm-addon-n">Regular</span><span class="lm-addon-p">Included</span></div>
          <div class="lm-addon-lbl" onclick="pickAddon(event,this,60)"><input type="radio" name="a_ep" value="blue"><span class="lm-addon-n">Premium Blue Filtration</span><span class="lm-addon-p">+60 QAR</span></div>
          <div class="lm-addon-lbl" onclick="pickAddon(event,this,90)"><input type="radio" name="a_ep" value="transition"><span class="lm-addon-n">Transition Classic</span><span class="lm-addon-p">+90 QAR</span></div>
        </div>
      </div>
      <div class="lm-opt" onclick="selCard(this,'essilor_sapphire',525,'sv')">
        <div class="lm-opt-top"><div class="lm-opt-left"><div class="lm-radio"></div><div><div class="lm-opt-name">Essilor Crizal Sapphire</div><div class="lm-opt-idx">Index 1.56</div></div></div><div class="lm-opt-price">525 QAR</div></div>
        <ul class="lm-feats"><li>High transparency</li><li>Durable resistance</li><li>Power ¬±3.00</li></ul>
        <div class="lm-addons">
          <div class="lm-addon-lbl" onclick="pickAddon(event,this,0)"><input type="radio" name="a_sp" value="none" checked><span class="lm-addon-n">Regular</span><span class="lm-addon-p">Included</span></div>
          <div class="lm-addon-lbl" onclick="pickAddon(event,this,850)"><input type="radio" name="a_sp" value="transition_gens"><span class="lm-addon-n">Transition Gen-S</span><span class="lm-addon-p">+850 QAR</span></div>
        </div>
      </div>
      <div class="rx-section">
        <p class="rx-lbl">Enter Prescription (Optional)</p>
        <div style="overflow-x:auto;">
          <table class="rx-tbl">
            <thead><tr><th>Eye</th><th>SPH</th><th>CYL</th><th>AXIS</th><th>ADD</th></tr></thead>
            <tbody>
              <tr><td><strong>Right (OD)</strong></td><td><input class="rx-inp" type="number" step="0.25" placeholder="-1.50" id="m_rSph"></td><td><input class="rx-inp" type="number" step="0.25" placeholder="-0.50" id="m_rCyl"></td><td><input class="rx-inp" type="number" min="0" max="180" placeholder="0‚Äì180" id="m_rAxis"></td><td><input class="rx-inp" type="number" step="0.25" placeholder="+1.00" id="m_rAdd"></td></tr>
              <tr><td><strong>Left (OS)</strong></td><td><input class="rx-inp" type="number" step="0.25" placeholder="-2.00" id="m_lSph"></td><td><input class="rx-inp" type="number" step="0.25" placeholder="-0.75" id="m_lCyl"></td><td><input class="rx-inp" type="number" min="0" max="180" placeholder="0‚Äì180" id="m_lAxis"></td><td><input class="rx-inp" type="number" step="0.25" placeholder="+1.00" id="m_lAdd"></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Progressive -->
    <div id="p-prog" class="lm-panel">
      <p class="lm-panel-h">Progressive & Bifocal Lenses</p>
      <div class="lm-opt" onclick="selCard(this,'regular_progressive',250,'prog')">
        <div class="lm-opt-top"><div class="lm-opt-left"><div class="lm-radio"></div><div><div class="lm-opt-name">Regular Progressive</div><div class="lm-opt-idx">Index 1.56</div></div></div><div class="lm-opt-price">250 QAR</div></div>
        <ul class="lm-feats"><li>Near, intermediate & far vision</li><li>Power ¬±6.00</li></ul>
      </div>
      <div class="lm-opt" onclick="selCard(this,'essilor_espace',600,'prog')">
        <div class="lm-opt-top"><div class="lm-opt-left"><div class="lm-radio"></div><div><div class="lm-opt-name">Essilor Espace Crizal Easy Pro</div><div class="lm-opt-idx">Index 1.56</div></div></div><div class="lm-opt-price">600 QAR</div></div>
        <ul class="lm-feats"><li>Wide vision area</li><li>Enhanced comfort</li></ul>
      </div>
      <div class="lm-opt" onclick="selCard(this,'essilor_liberty',900,'prog')">
        <div class="lm-opt-top"><div class="lm-opt-left"><div class="lm-radio"></div><div><div class="lm-opt-name">Essilor Liberty 3.0 Crizal Easy Pro</div><div class="lm-opt-idx">Index 1.56</div></div></div><div class="lm-opt-price">900 QAR</div></div>
        <ul class="lm-feats"><li>Larger field of vision</li><li>Sharp focus</li><li>Power ¬±7.00</li></ul>
      </div>
      <div class="rx-section">
        <p class="rx-lbl">Enter Prescription (Optional)</p>
        <div style="overflow-x:auto;">
          <table class="rx-tbl"><thead><tr><th>Eye</th><th>SPH</th><th>CYL</th><th>AXIS</th><th>ADD</th></tr></thead>
          <tbody>
            <tr><td><strong>Right</strong></td><td><input class="rx-inp" type="number" step="0.25" placeholder="-1.50" id="p_rSph"></td><td><input class="rx-inp" type="number" step="0.25" placeholder="-0.50" id="p_rCyl"></td><td><input class="rx-inp" type="number" min="0" max="180" placeholder="0‚Äì180" id="p_rAxis"></td><td><input class="rx-inp" type="number" step="0.25" placeholder="+1.00" id="p_rAdd"></td></tr>
            <tr><td><strong>Left</strong></td><td><input class="rx-inp" type="number" step="0.25" placeholder="-2.00" id="p_lSph"></td><td><input class="rx-inp" type="number" step="0.25" placeholder="-0.75" id="p_lCyl"></td><td><input class="rx-inp" type="number" min="0" max="180" placeholder="0‚Äì180" id="p_lAxis"></td><td><input class="rx-inp" type="number" step="0.25" placeholder="+1.00" id="p_lAdd"></td></tr>
          </tbody></table>
        </div>
      </div>
    </div>

    <!-- Reading -->
    <div id="p-rd" class="lm-panel">
      <p class="lm-panel-h">Reading Glasses ‚Äî Select Power</p>
      <div class="reading-grid" id="rdGrid"></div>
      <p style="font-size:13px;color:var(--aa-muted);">All reading powers: <strong>150 QAR</strong></p>
    </div>

    <!-- No Prescription -->
    <div id="p-np" class="lm-panel">
      <p class="lm-panel-h">Without Prescription Lenses</p>
      <div class="lm-opt" onclick="selCard(this,'clear_lens',100,'nopow')"><div class="lm-opt-top"><div class="lm-opt-left"><div class="lm-radio"></div><div><div class="lm-opt-name">Clear Lens</div><div class="lm-opt-idx">Basic lens without power</div></div></div><div class="lm-opt-price">100 QAR</div></div></div>
      <div class="lm-opt" onclick="selCard(this,'zero_blue',250,'nopow')"><div class="lm-opt-top"><div class="lm-opt-left"><div class="lm-radio"></div><div><div class="lm-opt-name">Zero Power Blue</div><div class="lm-opt-idx">Blue light protection</div></div></div><div class="lm-opt-price">250 QAR</div></div></div>
      <div class="lm-opt" onclick="selCard(this,'crizal_premium_np',470,'nopow')"><div class="lm-opt-top"><div class="lm-opt-left"><div class="lm-radio"></div><div><div class="lm-opt-name">Essilor Crizal Premium</div><div class="lm-opt-idx">Advanced blue-light filtration</div></div></div><div class="lm-opt-price">470 QAR</div></div></div>
    </div>

    <div class="lm-foot">
      <div class="lm-total"><span class="lm-total-lbl">Total Lens Price:</span><span class="lm-total-val" id="lmTotal">‚Äî QAR</span></div>
      <button class="lm-confirm" onclick="confirmLens()">Confirm Lens Selection ‚Üí</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê LIGHTBOX ‚ïê‚ïê -->
<div class="gal__lb" id="galLb">
  <button class="gal__lb-close" onclick="GAL.closeLb()" aria-label="Close">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
  </button>
  <button class="gal__lb-nav gal__lb-nav--prev" onclick="GAL.lbNav(-1)">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg>
  </button>
  <img class="gal__lb-img" id="lbImg" src="" alt="">
  <button class="gal__lb-nav gal__lb-nav--next" onclick="GAL.lbNav(1)">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="9 18 15 12 9 6"/></svg>
  </button>
  <div class="gal__lb-strip" id="lbStrip"></div>
  <span class="gal__lb-count" id="lbCount"></span>
</div>

<div class="pd-toast" id="pdToast"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GAL ‚Äî Inline Gallery Engine
   Reads images from #galRail .gal__thumb[data-src]
   No external dependencies.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var GAL = (function () {
  var thumbs, srcs, cur = 0, total = 0;
  var mainImg, counter, lb, lbImg, lbStrip, lbCount;

  function init() {
    thumbs  = Array.from(document.querySelectorAll('#galRail .gal__thumb'));
    srcs    = thumbs.map(function (t) { return t.dataset.src || ''; });
    total   = srcs.length;
    mainImg = document.getElementById('galMain');
    counter = document.getElementById('galCounter');
    lb      = document.getElementById('galLb');
    lbImg   = document.getElementById('lbImg');
    lbStrip = document.getElementById('lbStrip');
    lbCount = document.getElementById('lbCount');
    if (!mainImg || total === 0) return;

    /* build lightbox thumbnail strip */
    srcs.forEach(function (src, i) {
      var d  = document.createElement('div');
      d.className = 'gal__lb-dot' + (i === 0 ? ' active' : '');
      var im = document.createElement('img'); im.src = src; im.loading = 'lazy';
      d.appendChild(im);
      d.addEventListener('click', function () { lbGoTo(i); });
      lbStrip.appendChild(d);
    });

    if (total > 1) {
      document.getElementById('galPrev').classList.remove('hidden');
      document.getElementById('galNext').classList.remove('hidden');
      counter.classList.remove('solo');
    }
    updateCounter();

    thumbs.forEach(function (t, i) {
      t.addEventListener('click', function () { goTo(i); });
      t.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); goTo(i); }
      });
    });
    document.getElementById('galPrev').addEventListener('click', function (e) { e.stopPropagation(); goTo(cur - 1); });
    document.getElementById('galNext').addEventListener('click', function (e) { e.stopPropagation(); goTo(cur + 1); });
    document.getElementById('galFs').addEventListener('click',   function (e) { e.stopPropagation(); openLb(); });
    document.getElementById('galStage').addEventListener('click', function (e) {
      if (e.target.closest('#galPrev,#galNext,#galFs')) return; openLb();
    });
    document.getElementById('galStage').addEventListener('keydown', function (e) {
      if (e.key === 'ArrowLeft')  goTo(cur - 1);
      if (e.key === 'ArrowRight') goTo(cur + 1);
      if (e.key === 'Enter')      openLb();
    });
    var tx0 = 0;
    document.getElementById('galStage').addEventListener('touchstart', function (e) { tx0 = e.changedTouches[0].screenX; }, { passive: true });
    document.getElementById('galStage').addEventListener('touchend',   function (e) {
      var dx = tx0 - e.changedTouches[0].screenX;
      if (Math.abs(dx) > 50) { dx > 0 ? goTo(cur + 1) : goTo(cur - 1); }
    }, { passive: true });
    lb.addEventListener('click', function (e) { if (e.target === lb) closeLb(); });
  }

  function goTo(idx) {
    if (idx < 0) idx = total - 1;
    if (idx >= total) idx = 0;
    var newSrc = srcs[idx]; if (!newSrc) return;
    mainImg.classList.add('fading');
    var tmp = new Image();
    tmp.onload = tmp.onerror = function () { mainImg.src = newSrc; mainImg.classList.remove('fading'); };
    tmp.src = newSrc;
    thumbs.forEach(function (t, i) { t.classList.toggle('is-active', i === idx); });
    if (thumbs[idx]) thumbs[idx].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    cur = idx; updateCounter();
    if (lb.classList.contains('open')) lbGoTo(idx);
  }

  /* Called by pickVariant() ‚Äî switches to a URL not necessarily in the rail */
  function goToSrc(src) {
    var idx = srcs.indexOf(src);
    if (idx !== -1) { goTo(idx); return; }
    mainImg.classList.add('fading');
    setTimeout(function () { mainImg.src = src; mainImg.classList.remove('fading'); }, 100);
  }

  function updateCounter() {
    if (counter) counter.textContent = (cur + 1) + ' / ' + total;
    var dots = lbStrip ? lbStrip.querySelectorAll('.gal__lb-dot') : [];
    Array.from(dots).forEach(function (d, i) { d.classList.toggle('active', i === cur); });
    if (lbCount) lbCount.textContent = (cur + 1) + ' / ' + total;
  }

  function openLb()  { lbGoTo(cur); lb.classList.add('open'); document.body.style.overflow = 'hidden'; }
  function closeLb() { lb.classList.remove('open'); document.body.style.overflow = ''; }

  function lbGoTo(idx) {
    if (idx < 0) idx = total - 1; if (idx >= total) idx = 0;
    lbImg.style.cssText = 'opacity:0;transform:scale(.94);transition:opacity .22s,transform .22s';
    setTimeout(function () {
      lbImg.src = srcs[idx];
      lbImg.style.cssText = 'opacity:1;transform:scale(1);transition:opacity .22s,transform .22s';
    }, 110);
    cur = idx; updateCounter();
    var dots = lbStrip.querySelectorAll('.gal__lb-dot');
    Array.from(dots).forEach(function (d, i) { d.classList.toggle('active', i === idx); });
    if (dots[idx]) dots[idx].scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
  }

  document.addEventListener('keydown', function (e) {
    if (!lb || !lb.classList.contains('open')) return;
    if (e.key === 'ArrowLeft')  lbGoTo(cur - 1);
    if (e.key === 'ArrowRight') lbGoTo(cur + 1);
    if (e.key === 'Escape')     closeLb();
  });

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();

  return { goTo: goTo, goToSrc: goToSrc, openLb: openLb, closeLb: closeLb, lbNav: function (d) { lbGoTo(cur + d); } };
})();

/* ‚ïê‚ïê Page Logic ‚ïê‚ïê */
var BASE_PRICE    = parseFloat('{{ product.base_price|default:0 }}');
var activePan     = 'p-sv', lensOpt = '', lensAddon = '', lensCat = 'sv';
var lensBase      = 0, addonP = 0, lensConfirmed = false;

function getCsrf() {
  var m = document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/);
  return m ? decodeURIComponent(m[1]) : '';
}
var _tt;
function toast(msg, type) {
  if (typeof window.showToast === 'function') { window.showToast(msg, type === 'ok' ? 'success' : type === 'err' ? 'error' : 'info'); return; }
  var t = document.getElementById('pdToast');
  t.textContent = msg; t.className = 'pd-toast is-show' + (type ? ' pd-toast--' + type : '');
  clearTimeout(_tt); _tt = setTimeout(function () { t.classList.remove('is-show'); }, 3400);
}
function pickVariant(el) {
  document.querySelectorAll('.pi__swatch').forEach(function (s) { s.classList.remove('is-on'); });
  el.classList.add('is-on');
  document.getElementById('hdVariant').value = el.dataset.variant || '';
  var img = el.dataset.img; if (img) GAL.goToSrc(img);
}
function chQty(d) {
  var i = document.getElementById('qtyVal');
  i.value = Math.min(Math.max(1, parseInt(i.value) + d), parseInt(i.max) || 99);
}
function openLm()  { document.getElementById('lmOv').classList.add('is-open'); document.body.style.overflow = 'hidden'; }
function closeLm() { document.getElementById('lmOv').classList.remove('is-open'); document.body.style.overflow = ''; }
function showPanel(id, btn) {
  document.querySelectorAll('.lm-panel').forEach(function (p) { p.classList.remove('active'); });
  document.querySelectorAll('.lm-tab').forEach(function (b) { b.classList.remove('active'); });
  document.getElementById(id).classList.add('active'); btn.classList.add('active');
  activePan = id; lensOpt = ''; lensAddon = ''; lensBase = 0; addonP = 0;
  document.querySelectorAll('.lm-opt').forEach(function (c) { c.classList.remove('is-on'); });
  document.querySelectorAll('.pwr-chip').forEach(function (c) { c.classList.remove('is-on'); });
  updTotal();
}
function selCard(card, val, price, cat) {
  card.closest('.lm-panel').querySelectorAll('.lm-opt').forEach(function (c) { c.classList.remove('is-on'); });
  card.classList.add('is-on');
  lensOpt = val; lensBase = price; lensCat = cat; addonP = 0;
  var first = card.querySelector('.lm-addon-lbl');
  if (first) {
    var r = first.querySelector('input[type=radio]'); if (r) r.checked = true;
    card.querySelectorAll('.lm-addon-lbl').forEach(function (l) { l.classList.remove('is-on'); });
    first.classList.add('is-on');
  }
  updTotal();
}
function pickAddon(ev, lbl, price) {
  ev.stopPropagation();
  var r = lbl.querySelector('input[type=radio]'); if (r) r.checked = true;
  lbl.closest('.lm-opt').querySelectorAll('.lm-addon-lbl').forEach(function (l) { l.classList.remove('is-on'); });
  lbl.classList.add('is-on'); addonP = price; lensAddon = r ? r.value : ''; updTotal();
}
function updTotal() { document.getElementById('lmTotal').textContent = lensOpt ? (lensBase + addonP) + ' QAR' : '‚Äî QAR'; }
function rdGrid_init() {
  var g = document.getElementById('rdGrid'); if (!g) return;
  ['+0.75','+1.00','+1.25','+1.50','+1.75','+2.00','+2.25','+2.50','+2.75','+3.00'].forEach(function (p) {
    var c = document.createElement('div'); c.className = 'pwr-chip'; c.textContent = p;
    c.addEventListener('click', function () {
      document.querySelectorAll('.pwr-chip').forEach(function (x) { x.classList.remove('is-on'); });
      c.classList.add('is-on');
      lensOpt = 'reading_' + p.replace('+', 'p').replace('.', '_');
      lensBase = 150; lensCat = 'reading'; addonP = 0; updTotal();
    }); g.appendChild(c);
  });
}
function confirmLens() {
  if (!lensOpt) { toast('Please select a lens option', 'err'); return; }
  var total = lensBase + addonP;
  document.getElementById('hdLensOpt').value   = lensOpt;
  document.getElementById('hdLensAddon').value = lensAddon;
  document.getElementById('hdLensPrice').value = total;
  document.getElementById('hdLensCat').value   = lensCat;
  var pfx = activePan === 'p-sv' ? 'm_' : activePan === 'p-prog' ? 'p_' : null;
  if (pfx) {
    ['rSph','rCyl','rAxis','rAdd','lSph','lCyl','lAxis','lAdd'].forEach(function (k) {
      var el = document.getElementById(pfx + k);
      document.getElementById('h_' + k).value = el ? el.value : '';
    });
  }
  lensConfirmed = true;
  document.getElementById('dispPrice').textContent = 'QAR ' + (BASE_PRICE + total).toFixed(2);
  var ok = document.getElementById('lensOk'); ok.classList.add('is-show');
  document.getElementById('lensOkTxt').textContent = lensOpt.replace(/_/g, ' ') + ' ¬∑ ' + total + ' QAR';
  closeLm(); toast('Lens confirmed! +' + total + ' QAR', 'ok');
}
function buildFd() {
  var fd = new FormData();
  fd.append('csrfmiddlewaretoken', getCsrf());
  fd.append('product_id',          '{{ product.id }}');
  fd.append('quantity',             document.getElementById('qtyVal').value);
  fd.append('selected_variant_id',  document.getElementById('hdVariant').value);
  fd.append('selected_lens_option', document.getElementById('hdLensOpt').value);
  fd.append('lens_addon',           document.getElementById('hdLensAddon').value);
  fd.append('total_lens_price',     document.getElementById('hdLensPrice').value);
  fd.append('lens_category',        document.getElementById('hdLensCat').value);
  return fd;
}
function addCart() {
  if (!lensConfirmed) { toast('Please select your lenses first', 'err'); openLm(); return; }
  var btn = document.getElementById('cartBtn'), orig = btn.innerHTML;
  btn.textContent = 'Adding‚Ä¶'; btn.disabled = true;
  fetch("{% url 'cart:add_eyeglass_to_cart' %}", { method: 'POST', body: buildFd(), headers: { 'X-Requested-With': 'XMLHttpRequest' } })
    .then(function (r) { return r.json(); })
    .then(function (d) {
      btn.innerHTML = orig; btn.disabled = false;
      if (d.success) { toast('üõí Added to cart!', 'ok'); var cc = document.querySelector('[data-cart-count]'); if (cc && d.cart_count) cc.textContent = d.cart_count; }
      else { toast(d.message || 'Error', 'err'); }
    }).catch(function () { btn.innerHTML = orig; btn.disabled = false; toast('Network error', 'err'); });
}
function buyNow() {
  if (!lensConfirmed) { toast('Please select your lenses first', 'err'); openLm(); return; }
  fetch("{% url 'cart:add_eyeglass_to_cart' %}", { method: 'POST', body: buildFd(), headers: { 'X-Requested-With': 'XMLHttpRequest' } })
    .then(function (r) { return r.json(); })
    .then(function (d) { if (d.success) window.location.href = "{% url 'orders:checkout' %}"; else toast(d.message || 'Error', 'err'); })
    .catch(function () { toast('Network error', 'err'); });
}
document.getElementById('piWishBtn').addEventListener('click', function () {
  var btn = this, pid = btn.dataset.productId, csrf = getCsrf();
  fetch("{% url 'wishlist:toggle' 0 %}".replace('/0/', '/' + pid + '/'), {
    method: 'POST', credentials: 'same-origin',
    headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrf, 'Content-Type': 'application/x-www-form-urlencoded' },
    body: 'csrfmiddlewaretoken=' + encodeURIComponent(csrf)
  }).then(function (r) { return r.json(); })
    .then(function (d) {
      var svg = btn.querySelector('svg');
      if (d.added) { btn.classList.add('is-on'); svg.setAttribute('fill', '#e05f5f'); svg.setAttribute('stroke', '#e05f5f'); toast('‚ù§Ô∏è Added to wishlist!', 'ok'); }
      else { btn.classList.remove('is-on'); svg.setAttribute('fill', 'none'); svg.setAttribute('stroke', 'currentColor'); toast('Removed from wishlist', ''); }
    }).catch(function () { toast('Please log in', ''); });
});
document.addEventListener('keydown', function (e) { if (e.key === 'Escape') { closeLm(); GAL.closeLb(); } });
document.addEventListener('DOMContentLoaded', function () {
  rdGrid_init();
  var first = document.querySelector('.pi__swatch');
  if (first) document.getElementById('hdVariant').value = first.dataset.variant || '';
});
</script>
{% endblock %}