{% extends 'base.html' %}
{% load static %}
{% block title %}{{ product.name }} - Contact Lenses{% endblock %}

{% block content %}

<style>
  /* â”€â”€â”€ DESIGN TOKENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  :root {
    --black: #0a0a0a;
    --white: #fafafa;
    --gold: #b8976a;
    --gold-light: #d4b896;
    --sand: #f5f0e8;
    --muted: #888;
    --border: #e5e0d8;
    --radius: 10px;
    --shadow: 0 4px 24px rgba(0,0,0,0.08);
    --transition: all 0.28s cubic-bezier(0.4,0,0.2,1);
    --green: #2a7a2a;
    --green-bg: #f0f7ee;
    --orange: #c76a00;
    --orange-bg: #fff8f0;
  }

  /* â”€â”€â”€ BREADCRUMB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .cl-breadcrumb {
    padding: 14px 0;
    font-size: 13px;
    color: var(--muted);
    letter-spacing: 0.02em;
  }
  .cl-breadcrumb a { color: var(--muted); text-decoration: none; }
  .cl-breadcrumb a:hover { color: var(--black); }
  .cl-breadcrumb span { margin: 0 6px; }

  /* â”€â”€â”€ PRODUCT LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .cl-product-wrap {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 48px;
    align-items: start;
    padding: 0 0 60px;
  }
  @media (max-width: 900px) {
    .cl-product-wrap { grid-template-columns: 1fr; gap: 28px; }
  }

  /* â”€â”€â”€ GALLERY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .cl-gallery { position: sticky; top: 100px; }
  .cl-main-img {
    width: 100%;
    aspect-ratio: 1/1;
    border-radius: 16px;
    overflow: hidden;
    background: var(--sand);
    margin-bottom: 14px;
    cursor: zoom-in;
  }
  .cl-main-img img {
    width: 100%; height: 100%;
    object-fit: contain;
    transition: transform 0.4s ease;
    display: block;
  }
  .cl-main-img:hover img { transform: scale(1.04); }
  .cl-thumbs { display: flex; gap: 10px; flex-wrap: wrap; }
  .cl-thumb {
    width: 72px; height: 72px;
    border-radius: 8px;
    overflow: hidden;
    background: var(--sand);
    border: 2px solid transparent;
    cursor: pointer;
    transition: var(--transition);
    flex-shrink: 0;
  }
  .cl-thumb img { width: 100%; height: 100%; object-fit: contain; display: block; }
  .cl-thumb.active, .cl-thumb:hover { border-color: var(--gold); }

  /* â”€â”€â”€ INFO SIDE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .cl-badges { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; }
  .cl-badge {
    font-size: 11px; font-weight: 600;
    letter-spacing: 0.08em; text-transform: uppercase;
    padding: 4px 10px; border-radius: 4px;
    background: var(--sand); color: var(--gold);
  }
  .cl-badge.color-badge { background: #f3eeff; color: #7c3aed; }
  .cl-badge.clear-badge { background: #e8f4ff; color: #1a56a8; }
  .cl-badge.daily-badge { background: var(--green-bg); color: var(--green); }
  .cl-badge.monthly-badge { background: var(--orange-bg); color: var(--orange); }

  .cl-title-row {
    display: flex; align-items: flex-start;
    justify-content: space-between; gap: 12px; margin-bottom: 6px;
  }
  .cl-title {
    font-size: clamp(22px, 2.4vw, 30px);
    font-weight: 700; line-height: 1.2;
    color: var(--black); letter-spacing: -0.02em; margin: 0;
  }
  .cl-wishlist-btn {
    background: none; border: 2px solid var(--border);
    border-radius: 50%; width: 44px; height: 44px; flex-shrink: 0;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: var(--transition);
  }
  .cl-wishlist-btn:hover { border-color: #e05f5f; background: #fff0f0; }
  .cl-wishlist-btn.active { border-color: #e05f5f; background: #fff0f0; }

  .cl-brand { font-size: 13px; color: var(--muted); margin-bottom: 4px; }
  .cl-brand strong { color: var(--black); }
  .cl-sku { font-size: 12px; color: #bbb; margin-bottom: 20px; }

  .cl-price-row {
    display: flex; align-items: baseline;
    gap: 10px; margin-bottom: 8px;
    padding: 16px 20px;
    background: var(--sand); border-radius: var(--radius);
  }
  .cl-price { font-size: 28px; font-weight: 800; color: var(--black); letter-spacing: -0.03em; }
  .cl-price-old { font-size: 16px; color: var(--muted); text-decoration: line-through; }
  .cl-pack-note { font-size: 13px; color: var(--muted); margin-bottom: 20px; padding-left: 4px; }

  .cl-section-label {
    font-size: 12px; font-weight: 700;
    letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--muted); margin-bottom: 10px;
  }

  /* â”€â”€â”€ SPECS TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .cl-specs-table {
    width: 100%; border-collapse: collapse;
    font-size: 14px; margin-bottom: 24px;
  }
  .cl-specs-table tr { border-bottom: 1px solid var(--border); }
  .cl-specs-table td { padding: 10px 0; vertical-align: top; }
  .cl-specs-table td:first-child { font-weight: 500; color: var(--muted); width: 44%; }
  .cl-specs-table td:last-child { font-weight: 700; color: var(--black); }

  /* â”€â”€â”€ CONFIRMED BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .cl-confirmed-badge {
    display: none; align-items: center; gap: 8px;
    background: var(--green-bg); border: 1px solid #3a8a2e;
    color: #2a6a20; border-radius: 8px;
    padding: 10px 14px; font-size: 13px; font-weight: 600;
    margin-bottom: 14px;
  }
  .cl-confirmed-badge.show { display: flex; }

  /* â”€â”€â”€ QUANTITY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .cl-qty-row {
    display: flex; align-items: center;
    width: fit-content;
    border: 2px solid var(--border);
    border-radius: var(--radius); overflow: hidden;
    margin-bottom: 20px;
  }
  .cl-qty-btn {
    width: 44px; height: 44px; border: none;
    background: var(--sand); cursor: pointer;
    font-size: 20px; display: flex;
    align-items: center; justify-content: center;
    transition: var(--transition); color: var(--black);
  }
  .cl-qty-btn:hover { background: var(--border); }
  .cl-qty-input {
    width: 52px; height: 44px; border: none;
    border-left: 2px solid var(--border);
    border-right: 2px solid var(--border);
    text-align: center; font-size: 16px; font-weight: 600;
    color: var(--black); background: white;
  }
  .cl-qty-input:focus { outline: none; }

  /* â”€â”€â”€ ACTION BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .cl-actions { display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px; }

  .cl-btn-select {
    padding: 14px 24px;
    background: white; border: 2px solid var(--gold);
    border-radius: var(--radius);
    font-size: 15px; font-weight: 700; color: var(--gold);
    cursor: pointer; transition: var(--transition);
    letter-spacing: 0.02em; text-align: center;
  }
  .cl-btn-select:hover { background: var(--gold); color: white; }

  .cl-btn-cart {
    padding: 16px 24px; background: var(--black);
    border: 2px solid var(--black); border-radius: var(--radius);
    font-size: 15px; font-weight: 700; color: white;
    cursor: pointer; transition: var(--transition);
    letter-spacing: 0.04em; text-transform: uppercase;
  }
  .cl-btn-cart:hover { background: #333; border-color: #333; }
  .cl-btn-cart.loading { pointer-events: none; opacity: 0.7; }

  .cl-btn-buy {
    padding: 16px 24px; background: var(--gold);
    border: 2px solid var(--gold); border-radius: var(--radius);
    font-size: 15px; font-weight: 700; color: white;
    cursor: pointer; transition: var(--transition);
    letter-spacing: 0.04em; text-transform: uppercase; width: 100%;
  }
  .cl-btn-buy:hover { background: #a37d55; border-color: #a37d55; }

  /* â”€â”€â”€ SHIPPING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .cl-shipping {
    background: var(--sand); border-radius: var(--radius);
    padding: 16px 20px; display: flex;
    flex-direction: column; gap: 12px; margin-bottom: 24px;
  }
  .cl-shipping-item {
    display: flex; align-items: center; gap: 12px;
    font-size: 13px; color: var(--black);
  }
  .cl-shipping-icon {
    width: 32px; height: 32px; background: white;
    border-radius: 50%; display: flex;
    align-items: center; justify-content: center; flex-shrink: 0;
  }

  /* â”€â”€â”€ DESCRIPTION / RELATED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .cl-desc-section { padding: 40px 0; border-top: 1px solid var(--border); }
  .cl-section-title { font-size: 20px; font-weight: 700; margin-bottom: 16px; color: var(--black); }
  .cl-desc-body { font-size: 15px; line-height: 1.8; color: #555; }

  .cl-related-section { padding: 40px 0; border-top: 1px solid var(--border); }
  .cl-related-grid {
    display: grid; grid-template-columns: repeat(4, 1fr);
    gap: 20px; margin-top: 24px;
  }
  @media (max-width: 900px) { .cl-related-grid { grid-template-columns: repeat(2, 1fr); } }

  .cl-product-card {
    text-decoration: none; color: inherit; display: block;
    border-radius: 12px; overflow: hidden;
    border: 1px solid var(--border); transition: var(--transition); background: white;
  }
  .cl-product-card:hover { transform: translateY(-4px); box-shadow: var(--shadow); border-color: var(--gold-light); }
  .cl-card-img { aspect-ratio: 1/1; background: var(--sand); overflow: hidden; }
  .cl-card-img img { width: 100%; height: 100%; object-fit: contain; transition: transform 0.4s ease; display: block; }
  .cl-product-card:hover .cl-card-img img { transform: scale(1.06); }
  .cl-card-info { padding: 14px; }
  .cl-card-brand { font-size: 11px; color: var(--gold); font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; }
  .cl-card-name { font-size: 14px; font-weight: 600; margin: 4px 0; color: var(--black); }
  .cl-card-price { font-size: 15px; font-weight: 700; color: var(--black); }

  .cl-container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     POWER / COLOR MODAL
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .power-modal-overlay {
    display: none; position: fixed; inset: 0;
    z-index: 9999; background: rgba(0,0,0,0.55);
    backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
    align-items: flex-start; justify-content: center;
    padding: 24px 16px; overflow-y: auto;
  }
  .power-modal-overlay.open { display: flex; }

  .power-modal-box {
    background: white; width: 100%; max-width: 780px;
    border-radius: 20px; overflow: hidden;
    box-shadow: 0 24px 80px rgba(0,0,0,0.2);
    animation: modalIn 0.3s ease; margin: auto;
  }
  @keyframes modalIn {
    from { opacity: 0; transform: translateY(24px) scale(0.97); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
  }

  .power-modal-header {
    padding: 22px 28px 20px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .power-modal-header h2 { margin: 0; font-size: 20px; font-weight: 700; }
  .power-modal-close {
    background: none; border: none; font-size: 28px;
    cursor: pointer; color: var(--muted); line-height: 1; padding: 0 4px;
  }
  .power-modal-close:hover { color: var(--black); }

  .power-modal-body { padding: 24px 28px; }

  /* â”€â”€ Color grid â”€â”€ */
  .color-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 12px;
    margin-bottom: 24px;
  }
  .color-chip {
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 12px 10px;
    cursor: pointer;
    transition: var(--transition);
    text-align: center;
    position: relative;
  }
  .color-chip:hover { border-color: #aaa; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  .color-chip.selected { border-color: var(--black); background: var(--sand); }

  .color-chip-img {
    width: 100%; aspect-ratio: 1/1;
    object-fit: cover; border-radius: 8px;
    margin-bottom: 8px; display: block;
  }
  .color-chip-name { font-size: 13px; font-weight: 600; color: var(--black); }
  .color-chip-tag {
    display: inline-block; font-size: 10px; font-weight: 700;
    padding: 3px 7px; border-radius: 4px; margin-top: 5px;
    letter-spacing: 0.04em; text-transform: uppercase;
  }
  .tag-plano { background: var(--orange-bg); color: var(--orange); }
  .tag-power { background: var(--green-bg); color: var(--green); }

  /* â”€â”€ Selected color info â”€â”€ */
  .cl-selected-info {
    display: none; align-items: center; gap: 10px;
    background: #e8f4ff; border: 1px solid #90c8f5;
    border-radius: 8px; padding: 12px 16px;
    font-size: 13px; font-weight: 600;
    color: #1a56a8; margin-bottom: 20px;
  }
  .cl-selected-info.show { display: flex; }

  /* â”€â”€ Power section â”€â”€ */
  .power-section {
    background: var(--sand); border-radius: 12px;
    padding: 20px; margin-bottom: 20px;
  }
  .power-section-title {
    font-size: 13px; font-weight: 700;
    letter-spacing: 0.08em; text-transform: uppercase;
    color: var(--muted); margin-bottom: 16px;
  }

  .eye-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
  }
  @media (max-width: 580px) { .eye-grid { grid-template-columns: 1fr; } }

  .eye-box {
    background: white; border: 2px solid var(--border);
    border-radius: 10px; padding: 18px;
  }
  .eye-box-title {
    font-size: 14px; font-weight: 700;
    color: var(--black); margin-bottom: 12px;
    padding-bottom: 10px; border-bottom: 2px solid var(--black);
  }
  .eye-box label {
    display: block; font-size: 12px; font-weight: 600;
    color: var(--muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.06em;
  }
  .eye-box select {
    width: 100%; padding: 10px 12px;
    border: 2px solid var(--border); border-radius: 8px;
    font-size: 15px; font-weight: 600; color: var(--black);
    background: white; cursor: pointer; appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23888' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 12px center;
    transition: var(--transition);
  }
  .eye-box select:focus { border-color: var(--gold); outline: none; }
  .eye-box select:disabled { background-color: #f5f5f5; color: var(--muted); cursor: not-allowed; }

  .same-power-row {
    display: flex; align-items: center; gap: 12px;
    padding: 12px 16px; background: #fff8e8;
    border: 1px solid var(--gold-light); border-radius: 8px;
    cursor: pointer; margin-top: 14px;
    font-size: 13px; font-weight: 600; color: var(--black);
  }
  .same-power-row input[type="checkbox"] {
    width: 18px; height: 18px; cursor: pointer; accent-color: var(--black);
  }

  /* â”€â”€ Notify section â”€â”€ */
  .notify-section {
    background: #f0f7ff; border: 1px solid #c8e1ff;
    border-radius: 12px; padding: 18px 20px;
    margin-bottom: 20px;
  }
  .notify-title { font-size: 13px; font-weight: 700; color: var(--black); margin-bottom: 4px; }
  .notify-sub { font-size: 12px; color: var(--muted); margin-bottom: 12px; }
  .notify-inputs { display: flex; gap: 10px; flex-wrap: wrap; }
  .notify-input {
    flex: 1; min-width: 140px; padding: 10px 12px;
    border: 2px solid var(--border); border-radius: 8px;
    font-size: 14px; color: var(--black); transition: var(--transition);
  }
  .notify-input:focus { border-color: var(--gold); outline: none; }
  .notify-btn {
    padding: 10px 18px; background: #1a56a8; color: white;
    border: none; border-radius: 8px; font-size: 13px;
    font-weight: 700; cursor: pointer; transition: var(--transition);
    white-space: nowrap;
  }
  .notify-btn:hover { background: #154599; }

  /* â”€â”€ Modal footer â”€â”€ */
  .power-modal-footer {
    padding: 18px 28px 24px;
    border-top: 1px solid var(--border);
    background: white; position: sticky; bottom: 0;
  }
  .power-confirm-btn {
    width: 100%; padding: 16px;
    background: var(--black); color: white;
    border: none; border-radius: 10px;
    font-size: 16px; font-weight: 700; cursor: pointer;
    transition: var(--transition); letter-spacing: 0.04em;
  }
  .power-confirm-btn:hover { background: #333; }

  /* â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .cl-toast {
    position: fixed; bottom: 28px; right: 28px;
    z-index: 99999; background: var(--black); color: white;
    padding: 14px 22px; border-radius: 10px;
    font-size: 14px; font-weight: 600;
    box-shadow: 0 8px 32px rgba(0,0,0,0.24);
    transform: translateY(60px); opacity: 0;
    transition: all 0.32s cubic-bezier(0.4,0,0.2,1);
    pointer-events: none; max-width: 320px;
  }
  .cl-toast.show { transform: translateY(0); opacity: 1; }
  .cl-toast.success { background: #2a7a2a; }
  .cl-toast.error { background: #b42020; }
</style>

<div class="cl-container">

  <!-- Breadcrumb -->
  <nav class="cl-breadcrumb" aria-label="Breadcrumb">
    <a href="{% url 'home' %}">Home</a>
    <span>/</span>
    <a href="{% url 'catalog:contact_lenses_list' %}">Contact Lenses</a>
    <span>/</span>
    <span style="color: var(--black);">{{ product.name }}</span>
  </nav>

  <!-- Main Product Section -->
  <div class="cl-product-wrap">

    <!-- â”€â”€ GALLERY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="cl-gallery">
      <div class="cl-main-img">
        {% if product.image %}
        <img src="{{ product.image.url }}" alt="{{ product.name }}" id="mainImg" />
        {% endif %}
      </div>
      <div class="cl-thumbs" id="thumbStrip">
        {% if product.image %}
        <div class="cl-thumb active" onclick="switchImage(this, '{{ product.image.url }}')">
          <img src="{{ product.image.url }}" alt="{{ product.name }}" />
        </div>
        {% endif %}
        {% for image in images %}
        <div class="cl-thumb" onclick="switchImage(this, '{{ image.image.url }}')">
          <img src="{{ image.image.url }}" alt="{{ product.name }}" />
        </div>
        {% endfor %}
        {% if colors %}
        {% for color in colors %}
        <div class="cl-thumb" onclick="switchImage(this, '{{ color.image.url }}')" title="{{ color.name }}">
          <img src="{{ color.image.url }}" alt="{{ color.name }}" />
        </div>
        {% endfor %}
        {% endif %}
      </div>
    </div>

    <!-- â”€â”€ PRODUCT INFO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="cl-info">

      <!-- Badges -->
      <div class="cl-badges">
        {% if contact_lens.lens_type == 'color' %}
        <span class="cl-badge color-badge">Color Lens</span>
        {% else %}
        <span class="cl-badge clear-badge">Clear Lens</span>
        {% endif %}
        {% if contact_lens.replacement_schedule == 'daily' %}
        <span class="cl-badge daily-badge">Daily Disposable</span>
        {% elif contact_lens.replacement_schedule == 'monthly' %}
        <span class="cl-badge monthly-badge">Monthly</span>
        {% else %}
        <span class="cl-badge">{{ contact_lens.get_replacement_schedule_display }}</span>
        {% endif %}
        {% if product.is_featured %}<span class="cl-badge">Featured</span>{% endif %}
      </div>

      <!-- Title -->
      <div class="cl-title-row">
        <h1 class="cl-title">{{ product.name }}</h1>
        <button class="cl-wishlist-btn{% if product in request.user.wishlist.products.all %} active{% endif %}"
                id="wishlistBtn"
                data-product-id="{{ product.id }}"
                onclick="toggleWishlist(this)"
                title="Add to wishlist">
          {% if product in request.user.wishlist.products.all %}
          <svg width="18" height="18" viewBox="0 0 24 24" fill="red"><path d="M12 21s-6.7-4.4-10-9c-3.3-4.6.2-11 6-9 2 .6 4 2.4 4 2.4s2-1.8 4-2.4c5.8-2 9.3 4.4 6 9-3.3 4.6-10 9-10 9z"/></svg>
          {% else %}
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 21s-6.7-4.4-10-9c-3.3-4.6.2-11 6-9 2 .6 4 2.4 4 2.4s2-1.8 4-2.4c5.8-2 9.3 4.4 6 9-3.3 4.6-10 9-10 9z"/></svg>
          {% endif %}
        </button>
      </div>

      {% if product.brand %}
      <p class="cl-brand">Brand: <strong>{{ product.brand.name }}</strong></p>
      {% endif %}
      {% if product.sku %}
      <p class="cl-sku">SKU: {{ product.sku }}</p>
      {% endif %}

      <!-- Price -->
      <div class="cl-price-row">
        <span class="cl-price" id="displayPrice">QAR {{ product.base_price }}</span>
        {% if product.compare_at_price %}
        <span class="cl-price-old">QAR {{ product.compare_at_price }}</span>
        {% endif %}
      </div>
      <p class="cl-pack-note">Pack of <strong>{{ contact_lens.package_size }}</strong> lenses Â· {{ contact_lens.get_replacement_schedule_display }}</p>

      <!-- Short Description -->
      {% if product.short_description %}
      <p style="font-size:14px;color:#555;line-height:1.7;margin-bottom:20px;">{{ product.short_description }}</p>
      {% endif %}

      <!-- Lens Specs -->
      <div style="margin-bottom:24px;">
        <p class="cl-section-label">Lens Details</p>
        <table class="cl-specs-table">
          <tr>
            <td>Lens Type</td>
            <td>{{ contact_lens.get_lens_type_display|upper }}</td>
          </tr>
          <tr>
            <td>Replacement</td>
            <td>{{ contact_lens.get_replacement_schedule_display }}</td>
          </tr>
          <tr>
            <td>Diameter</td>
            <td>{{ contact_lens.diameter }} MM</td>
          </tr>
          <tr>
            <td>Base Curve</td>
            <td>{{ contact_lens.base_curve }}</td>
          </tr>
          <tr>
            <td>Water Content</td>
            <td>{{ contact_lens.water_content }}%</td>
          </tr>
          {% if contact_lens.intended_use %}
          <tr>
            <td>Intended Use</td>
            <td>{{ contact_lens.intended_use }}</td>
          </tr>
          {% endif %}
        </table>
      </div>

      <!-- Form -->
      <form id="productForm" method="POST" action="{% url 'cart:add_contact_lens_to_cart' %}" onsubmit="return false;">
        {% csrf_token %}
        <input type="hidden" name="product_id" value="{{ product.id }}">
        <input type="hidden" name="selected_color" id="hiddenColorId" value="">
        <input type="hidden" name="left_power" id="hiddenLeftPower" value="">
        <input type="hidden" name="right_power" id="hiddenRightPower" value="">
        <input type="hidden" name="is_plano" id="hiddenIsPlano" value="">

        <!-- Quantity -->
        <div style="margin-bottom:20px;">
          <p class="cl-section-label">Quantity</p>
          <div class="cl-qty-row">
            <button type="button" class="cl-qty-btn" onclick="changeQty(-1)">âˆ’</button>
            <input class="cl-qty-input" type="number" name="quantity" id="qtyInput" value="1" min="1" max="{{ product.stock_quantity|default:99 }}" readonly>
            <button type="button" class="cl-qty-btn" onclick="changeQty(1)">+</button>
          </div>
        </div>

        <!-- Confirmed badge -->
        <div class="cl-confirmed-badge" id="clConfirmedBadge">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          <span id="clConfirmedText">Selection confirmed</span>
          <button type="button" onclick="openPowerModal()" style="margin-left:auto;background:none;border:none;color:#2a6a20;font-size:12px;cursor:pointer;font-weight:600;">Change</button>
        </div>

        <!-- Actions -->
        <div class="cl-actions">
          <button type="button" class="cl-btn-select" onclick="openPowerModal()">
            {% if contact_lens.lens_type == 'color' %}ğŸ¨ Select Color & Power{% else %}ğŸ” Select Power{% endif %}
          </button>
          <button type="button" class="cl-btn-cart" id="addToCartBtn" onclick="addToCart()">
            Add to Cart
          </button>
          <button type="button" class="cl-btn-buy" onclick="buyNow()">Buy it now â†’</button>
        </div>
      </form>

      <!-- Shipping -->
      <div class="cl-shipping">
        <div class="cl-shipping-item">
          <div class="cl-shipping-icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="1" y="3" width="15" height="13" rx="1"/>
              <path d="M16 8h4l3 5v3h-7V8z"/>
              <circle cx="5.5" cy="18.5" r="2.5"/>
              <circle cx="18.5" cy="18.5" r="2.5"/>
            </svg>
          </div>
          <span>Estimated delivery: <strong>3â€“6 business days</strong> (Qatar/GCC)</span>
        </div>
        <div class="cl-shipping-item">
          <div class="cl-shipping-icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 4 23 10 17 10"/>
              <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
            </svg>
          </div>
          <span>Free returns within <strong>30 days</strong> of purchase</span>
        </div>
        <div class="cl-shipping-item">
          <div class="cl-shipping-icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
          </div>
          <span>Authentic products â€” <strong>100% genuine</strong></span>
        </div>
      </div>

    </div><!-- /cl-info -->
  </div><!-- /cl-product-wrap -->

  <!-- Description -->
  {% if product.description %}
  <div class="cl-desc-section">
    <h2 class="cl-section-title">About This Product</h2>
    <div class="cl-desc-body">{{ product.description|linebreaksbr }}</div>
  </div>
  {% endif %}

  <!-- Related Products -->
  {% if related_products %}
  <div class="cl-related-section">
    <h2 class="cl-section-title">You May Also Like</h2>
    <div class="cl-related-grid">
      {% for related in related_products %}
      <a href="{% url 'catalog:contact_lens_detail' related.slug %}" class="cl-product-card">
        <div class="cl-card-img">
          {% if related.image %}<img src="{{ related.image.url }}" alt="{{ related.name }}" loading="lazy">{% endif %}
        </div>
        <div class="cl-card-info">
          {% if related.brand %}<p class="cl-card-brand">{{ related.brand.name }}</p>{% endif %}
          <p class="cl-card-name">{{ related.name }}</p>
          <p class="cl-card-price">QAR {{ related.base_price }}</p>
        </div>
      </a>
      {% endfor %}
    </div>
  </div>
  {% endif %}

</div><!-- /cl-container -->


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     COLOR & POWER MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="power-modal-overlay" id="powerModalOverlay" onclick="handleOverlayClick(event)">
  <div class="power-modal-box" role="dialog" aria-modal="true">

    <div class="power-modal-header">
      <h2>{% if contact_lens.lens_type == 'color' %}Select Color & Power{% else %}Select Power{% endif %}</h2>
      <button class="power-modal-close" onclick="closePowerModal()" aria-label="Close">Ã—</button>
    </div>

    <div class="power-modal-body">

      {% if contact_lens.lens_type == 'color' and colors %}
      <!-- â”€â”€ Step 1: Color Selection â”€â”€ -->
      <p class="cl-section-label" style="margin-bottom:12px;">Step 1 â€” Choose Color</p>
      <div class="color-grid">
        {% for color in colors %}
        <div class="color-chip"
             data-color-id="{{ color.id }}"
             data-color-name="{{ color.name }}"
             data-power-enabled="{{ color.power_enabled|lower }}"
             onclick="selectColor(this)">
          <img class="color-chip-img" src="{{ color.image.url }}" alt="{{ color.name }}" loading="lazy">
          <div class="color-chip-name">{{ color.name }}</div>
          {% if color.power_enabled %}
          <span class="color-chip-tag tag-power">With Power</span>
          {% else %}
          <span class="color-chip-tag tag-plano">Plano Only</span>
          {% endif %}
        </div>
        {% endfor %}
      </div>

      <!-- Selected color confirmation -->
      <div class="cl-selected-info" id="selectedColorInfo">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
        <span>Color: <strong id="selectedColorName">â€”</strong></span>
      </div>

      <!-- â”€â”€ Step 2: Power (conditional) â”€â”€ -->
      <div id="powerSection" style="display:none;">
        <p class="cl-section-label" style="margin-bottom:12px;">Step 2 â€” Choose Power</p>
      {% else %}
      <!-- Clear lens: power only, no step label needed -->
      <div id="powerSection">
      {% endif %}

        <div class="power-section">
          <p class="power-section-title">Select Power (SPH) Per Eye</p>
          <div class="eye-grid">
            <div class="eye-box">
              <div class="eye-box-title">Left Eye (OS)</div>
              <label>Power (SPH)</label>
              <select id="leftPowerSelect">
                <option value="0.00">Plano (0.00)</option>
                {% for power in power_ranges %}
                <option value="{{ power }}">{{ power }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="eye-box">
              <div class="eye-box-title">Right Eye (OD)</div>
              <label>Power (SPH)</label>
              <select id="rightPowerSelect">
                <option value="0.00">Plano (0.00)</option>
                {% for power in power_ranges %}
                <option value="{{ power }}">{{ power }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <label class="same-power-row">
            <input type="checkbox" id="samePowerCheck" onchange="toggleSamePower()">
            Same power for both eyes
          </label>
        </div>

      </div><!-- /#powerSection -->

      <!-- â”€â”€ Notify section â”€â”€ -->
      <div class="notify-section">
        <p class="notify-title">Don't see your power?</p>
        <p class="notify-sub">Get notified when it becomes available:</p>
        <div class="notify-inputs">
          <input class="notify-input" type="text" placeholder="Required power (e.g. -5.50)" id="notifyPower">
          <input class="notify-input" type="email" placeholder="Your email address" id="notifyEmail">
          <button class="notify-btn" onclick="submitNotification()">Notify Me</button>
        </div>
      </div>

    </div><!-- /power-modal-body -->

    <div class="power-modal-footer">
      <button class="power-confirm-btn" onclick="confirmSelection()">Confirm Selection â†’</button>
    </div>

  </div>
</div><!-- /power-modal-overlay -->

<!-- Toast -->
<div class="cl-toast" id="clToast"></div>


<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const IS_COLOR_LENS  = "{{ contact_lens.lens_type }}" === 'color';
let selColorId       = null;
let selColorName     = '';
let selPowerEnabled  = false;
let selLeftPower     = '';
let selRightPower    = '';
let selectionDone    = false;

// â”€â”€ Gallery â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchImage(thumb, src) {
  document.querySelectorAll('.cl-thumb').forEach(t => t.classList.remove('active'));
  thumb.classList.add('active');
  const img = document.getElementById('mainImg');
  if (img) img.src = src;
}

// â”€â”€ Quantity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function changeQty(delta) {
  const input = document.getElementById('qtyInput');
  const max = parseInt(input.max) || 99;
  input.value = Math.min(Math.max(1, parseInt(input.value) + delta), max);
}

// â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPowerModal() {
  document.getElementById('powerModalOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closePowerModal() {
  document.getElementById('powerModalOverlay').classList.remove('open');
  document.body.style.overflow = '';
}
function handleOverlayClick(e) {
  if (e.target === document.getElementById('powerModalOverlay')) closePowerModal();
}

// â”€â”€ Color selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectColor(chip) {
  document.querySelectorAll('.color-chip').forEach(c => c.classList.remove('selected'));
  chip.classList.add('selected');

  selColorId      = chip.dataset.colorId;
  selColorName    = chip.dataset.colorName;
  selPowerEnabled = chip.dataset.powerEnabled === 'true';

  // Show info banner
  const info = document.getElementById('selectedColorInfo');
  if (info) {
    info.classList.add('show');
    document.getElementById('selectedColorName').textContent = selColorName;
  }

  // Show or hide power section
  const ps = document.getElementById('powerSection');
  if (ps) {
    ps.style.display = selPowerEnabled ? 'block' : 'none';
  }
}

// â”€â”€ Same power toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSamePower() {
  const checked = document.getElementById('samePowerCheck').checked;
  const right   = document.getElementById('rightPowerSelect');
  if (checked) {
    right.value    = document.getElementById('leftPowerSelect').value;
    right.disabled = true;
  } else {
    right.disabled = false;
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const leftSel = document.getElementById('leftPowerSelect');
  if (leftSel) {
    leftSel.addEventListener('change', () => {
      if (document.getElementById('samePowerCheck').checked) {
        document.getElementById('rightPowerSelect').value = leftSel.value;
      }
    });
  }
});

// â”€â”€ Confirm selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function confirmSelection() {
  if (IS_COLOR_LENS) {
    if (!selColorId) {
      showToast('Please select a color', 'error');
      return;
    }
    document.getElementById('hiddenColorId').value = selColorId;

    if (selPowerEnabled) {
      selLeftPower  = document.getElementById('leftPowerSelect').value;
      selRightPower = document.getElementById('rightPowerSelect').value;
      document.getElementById('hiddenLeftPower').value  = selLeftPower;
      document.getElementById('hiddenRightPower').value = selRightPower;
      document.getElementById('hiddenIsPlano').value    = 'false';
    } else {
      // Plano
      selLeftPower  = '0.00';
      selRightPower = '0.00';
      document.getElementById('hiddenLeftPower').value  = '0.00';
      document.getElementById('hiddenRightPower').value = '0.00';
      document.getElementById('hiddenIsPlano').value    = 'true';
    }
  } else {
    // Clear lens
    selLeftPower  = document.getElementById('leftPowerSelect').value;
    selRightPower = document.getElementById('rightPowerSelect').value;
    document.getElementById('hiddenLeftPower').value  = selLeftPower;
    document.getElementById('hiddenRightPower').value = selRightPower;
    document.getElementById('hiddenIsPlano').value    = (selLeftPower === '0.00' && selRightPower === '0.00') ? 'true' : 'false';
  }

  selectionDone = true;

  // Show confirmed badge
  const badge = document.getElementById('clConfirmedBadge');
  badge.classList.add('show');
  let text = '';
  if (IS_COLOR_LENS) {
    text = selColorName;
    if (selPowerEnabled) text += ' Â· L: ' + selLeftPower + ' / R: ' + selRightPower;
    else text += ' Â· Plano';
  } else {
    text = 'L: ' + selLeftPower + ' / R: ' + selRightPower;
  }
  document.getElementById('clConfirmedText').textContent = text;

  closePowerModal();
  showToast('Selection confirmed!', 'success');
}

// â”€â”€ Notify â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function submitNotification() {
  const power = document.getElementById('notifyPower').value.trim();
  const email = document.getElementById('notifyEmail').value.trim();
  if (!power || !email) { showToast('Please enter power and email', 'error'); return; }
  // TODO: wire to backend endpoint
  showToast("We'll notify you at " + email + " when " + power + " is available.", 'success');
  document.getElementById('notifyPower').value = '';
  document.getElementById('notifyEmail').value = '';
}

// â”€â”€ Add to Cart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addToCart() {
  if (!selectionDone) {
    showToast('Please select {% if contact_lens.lens_type == "color" %}color & power{% else %}power{% endif %} first', 'error');
    openPowerModal();
    return;
  }

  const btn = document.getElementById('addToCartBtn');
  btn.classList.add('loading');
  btn.textContent = 'Adding...';

  const form = document.getElementById('productForm');
  const formData = new FormData(form);
  formData.set('quantity', document.getElementById('qtyInput').value);
  const csrf = form.querySelector('[name=csrfmiddlewaretoken]').value;

  fetch("{% url 'cart:add_contact_lens_to_cart' %}", {
    method: 'POST',
    body: formData,
    headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrf }
  })
  .then(r => r.json())
  .then(data => {
    btn.classList.remove('loading');
    btn.textContent = 'Add to Cart';
    if (data.success) {
      showToast('Added to cart!', 'success');
      const cc = document.getElementById('cartCount');
      if (cc && data.cart_count) cc.textContent = data.cart_count;
    } else {
      showToast(data.message || 'Error adding to cart', 'error');
    }
  })
  .catch(() => {
    btn.classList.remove('loading');
    btn.textContent = 'Add to Cart';
    showToast('Something went wrong. Please try again.', 'error');
  });
}

// â”€â”€ Buy Now â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buyNow() {
  if (!selectionDone) {
    showToast('Please select {% if contact_lens.lens_type == "color" %}color & power{% else %}power{% endif %} first', 'error');
    openPowerModal();
    return;
  }
  const form = document.getElementById('productForm');
  form.action = "{% url 'orders:checkout' %}";
  form.method = 'POST';
  form.submit();
}

// â”€â”€ Wishlist â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleWishlist(btn) {
  const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
  fetch('/users/wishlist/toggle/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf, 'X-Requested-With': 'XMLHttpRequest' },
    body: JSON.stringify({ product_id: btn.dataset.productId })
  })
  .then(r => r.json())
  .then(data => {
    if (data.added) {
      btn.classList.add('active');
      btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="red"><path d="M12 21s-6.7-4.4-10-9c-3.3-4.6.2-11 6-9 2 .6 4 2.4 4 2.4s2-1.8 4-2.4c5.8-2 9.3 4.4 6 9-3.3 4.6-10 9-10 9z"/></svg>';
      showToast('Added to wishlist', 'success');
    } else {
      btn.classList.remove('active');
      btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 21s-6.7-4.4-10-9c-3.3-4.6.2-11 6-9 2 .6 4 2.4 4 2.4s2-1.8 4-2.4c5.8-2 9.3 4.4 6 9-3.3 4.6-10 9-10 9z"/></svg>';
      showToast('Removed from wishlist', '');
    }
  })
  .catch(() => showToast('Login required to use wishlist', 'error'));
}

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer;
function showToast(msg, type) {
  const t = document.getElementById('clToast');
  t.textContent = msg;
  t.className = 'cl-toast show' + (type ? ' ' + type : '');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3400);
}

// â”€â”€ Keyboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closePowerModal();
});
</script>

{% endblock %}