{% extends 'base.html' %}
{% load static %}
{% block title %}{{ product.name }} - Contact Lenses{% endblock %}

{% block content %}

<section class="shopify-section section">
  <div class="xo-section color-background-1">
    <xo-container class="xo-container--box">
      <xo-grid>

        <!-- LEFT: SAME GALLERY AS EYEGLASSES -->
        <xo-animate style="--xs: 12; --md: 7">
          <div class="xo-product-info-media-style3" style="position: sticky;">
            <xo-gallery>
              <xo-carousel>
                <xo-carousel-inner>
                  <xo-carousel-list>
                    {% for image in product.images.all %}
                      <xo-carousel-slide>
                        <img src="{{ image.image.url }}" alt="{{ product.name }}">
                      </xo-carousel-slide>
                    {% empty %}
                      <xo-carousel-slide>
                        <img src="{% static 'images/no-image.png' %}">
                      </xo-carousel-slide>
                    {% endfor %}
                  </xo-carousel-list>
                </xo-carousel-inner>
              </xo-carousel>
            </xo-gallery>
          </div>
        </xo-animate>

        <!-- RIGHT: PRODUCT INFO (SAME STRUCTURE AS EYEGLASSES) -->
        <xo-animate class="main-product__right" style="--xs: 12; --md: 5">
          <div class="xo-product-info-content" style="position: sticky; top: 9.3rem">

            <!-- TITLE -->
            <div class="xo-product-info-content__header">
              <h1 class="xo-product-info-content__title" style="--fz:2.4rem">
                {{ product.name }}
              </h1>
            </div>

            <!-- BRAND -->
            {% if product.brand %}
            <p style="margin: 10px 0; font-size: 14px; color: #666;">
              Brand: <strong>{{ product.brand.name }}</strong>
            </p>
            {% endif %}

            <!-- PRICE -->
            <div class="xo-product-info-content__price" style="padding: 20px 0;">
              <div class="xo-price xo-price--larger">
                <span class="xo-price__item xo-price__item--accent">
                  QAR {{ product.base_price }}
                </span>
              </div>
            </div>

            <p style="font-size:14px;color:#666;">Pack of {{ contact_lens.package_size }} lenses</p>

            <!-- COLOR SELECTION -->
            {% if contact_lens.lens_type == 'color' %}
            <div style="padding: 20px 0;">
              <h3 style="font-size: 16px;">Select Color</h3>

              <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:10px;">
                {% for color in colors %}
                  <div onclick="selectColor(this, {{ color.id }}, {{ color.power_enabled|lower }})"
                       style="border:1px solid #ddd;padding:8px;border-radius:8px;cursor:pointer;text-align:center;">
                    <img src="{{ color.image.url }}" style="width:100%;border-radius:6px;">
                    <small>{{ color.name }}</small>
                  </div>
                {% endfor %}
              </div>

              <p style="margin-top:10px;">Selected: <strong id="selectedColorName">-</strong></p>
            </div>
            {% endif %}

            <!-- POWER -->
            <div id="powerSection" style="display:none;padding-bottom:20px;">
              <h3 style="font-size:16px;">Select Power</h3>

              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div>
                  <label>Left Eye</label>
                  <select id="leftPower">
                    {% for p in power_ranges %}
                      <option>{{ p }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div>
                  <label>Right Eye</label>
                  <select id="rightPower">
                    {% for p in power_ranges %}
                      <option>{{ p }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>

              <label style="display:block;margin-top:10px;">
                <input type="checkbox" id="samePower" onchange="lockSamePower()"> Same for both eyes
              </label>
            </div>

            <!-- QUANTITY (SAME XO STYLE) -->
            <xo-cart-quantity class="xo-quantity-style2" style="--width: 13.5rem; --height: 5rem">
              <input class="xo-quantity-style2__number" type="number" id="quantity" value="1" min="1">
            </xo-cart-quantity>

            <div class="xo-space xo-space--vertical" style="--space: 2rem"></div>

            <!-- ADD TO CART -->
            <button type="button"
                    class="xo-btn xo-btn--light xo-btn--primary xo-btn--block"
                    onclick="addToCart()">
              <span class="xo-btn__content">
                <span class="xo-btn__text">Add to Cart</span>
              </span>
            </button>

          </div>
        </xo-animate>

      </xo-grid>
    </xo-container>
  </div>
</section>

<script>
let selectedColorId = null;
let selectedColorPowerEnabled = false;

function selectColor(el, id, powerEnabled) {
  selectedColorId = id;
  selectedColorPowerEnabled = powerEnabled;

  document.querySelectorAll('[onclick^="selectColor"]').forEach(e => e.style.border = '1px solid #ddd');
  el.style.border = '2px solid black';

  document.getElementById('selectedColorName').innerText = el.innerText.trim();
  document.getElementById('powerSection').style.display = powerEnabled ? 'block' : 'none';
}

function lockSamePower() {
  const right = document.getElementById('rightPower');
  right.disabled = document.getElementById('samePower').checked;
  if (right.disabled) {
    right.value = document.getElementById('leftPower').value;
  }
}

function addToCart() {
  {% if contact_lens.lens_type == 'color' %}
  if (!selectedColorId) {
    alert("Please select a color");
    return;
  }
  {% endif %}
  alert("Added to cart");
}
</script>

{% endblock %}
