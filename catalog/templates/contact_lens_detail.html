{% extends 'base.html' %}
{% load static %}
{% block title %}{{ product.name }} ‚Äì Al Ameen Optics{% endblock %}

{% block content %}
<style>
:root {
  --aa-ink:#0d0d0d;--aa-ink-soft:#555;--aa-gold:#b8976a;--aa-gold-lt:#d4b896;
  --aa-sand:#f7f3ed;--aa-muted:#8a8580;--aa-border:#e8e2d8;
  --aa-green:#2a7a2a;--aa-green-bg:#f0f7ee;
  --aa-orange:#c76a00;--aa-orange-bg:#fff8f0;
  --aa-radius:12px;--aa-shadow:0 4px 24px rgba(0,0,0,.08);
  --aa-ease:cubic-bezier(.4,0,.2,1);--aa-t:.26s;
}

/* ‚îÄ‚îÄ GALLERY (identical engine) ‚îÄ‚îÄ */
.gal{display:grid;grid-template-columns:88px 1fr;gap:12px;position:sticky;top:90px;align-self:start;}
@media(max-width:960px){.gal{position:static;}}
@media(max-width:540px){.gal{grid-template-columns:1fr;}}
.gal__rail{display:flex;flex-direction:column;gap:8px;max-height:520px;overflow-y:auto;overflow-x:hidden;scrollbar-width:thin;scrollbar-color:#d4b896 transparent;padding:2px;}
.gal__rail::-webkit-scrollbar{width:3px;}
.gal__rail::-webkit-scrollbar-thumb{background:#d4b896;border-radius:99px;}
@media(max-width:540px){.gal__rail{flex-direction:row;max-height:none;overflow-y:hidden;overflow-x:auto;order:2;}}
.gal__thumb{flex-shrink:0;width:84px;height:84px;border-radius:10px;overflow:hidden;border:2px solid var(--aa-border);background:var(--aa-sand);cursor:pointer;transition:border-color .2s,transform .2s;padding:0;}
@media(max-width:540px){.gal__thumb{width:68px;height:68px;}}
.gal__thumb img{width:100%;height:100%;object-fit:contain;padding:4px;display:block;}
.gal__thumb:hover{border-color:var(--aa-gold);transform:translateX(2px);}
@media(max-width:540px){.gal__thumb:hover{transform:translateY(-2px);}}
.gal__thumb.is-active{border-color:var(--aa-ink);box-shadow:0 0 0 1px var(--aa-ink);}
.gal__stage-wrap{position:relative;}
.gal__stage{position:relative;width:100%;aspect-ratio:1/1;border-radius:16px;overflow:hidden;background:var(--aa-sand);cursor:zoom-in;}
.gal__img{width:100%;height:100%;object-fit:contain;padding:24px;display:block;transition:opacity .18s ease;will-change:opacity;}
.gal__img.fading{opacity:0;}
.gal__placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--aa-gold);}
.gal__arr{position:absolute;top:50%;transform:translateY(-50%);width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,.9);border:1px solid rgba(0,0,0,.08);display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:10;box-shadow:0 2px 10px rgba(0,0,0,.12);opacity:0;pointer-events:none;transition:opacity .2s;color:#1a1a1a;}
.gal__stage:hover .gal__arr{opacity:1;pointer-events:auto;}
.gal__arr--prev{left:10px;}.gal__arr--next{right:10px;}
.gal__arr.hidden{display:none!important;}
.gal__counter{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);background:rgba(10,10,10,.45);backdrop-filter:blur(6px);color:#fff;font-size:11px;font-weight:700;letter-spacing:.1em;padding:4px 12px;border-radius:99px;pointer-events:none;}
.gal__counter.solo{display:none;}
.gal__fs{position:absolute;bottom:12px;right:12px;width:34px;height:34px;border-radius:8px;background:rgba(255,255,255,.88);border:1px solid rgba(0,0,0,.07);display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:10;opacity:0;pointer-events:none;transition:opacity .2s;}
.gal__stage:hover .gal__fs{opacity:1;pointer-events:auto;}
.gal__lb{display:none;position:fixed;inset:0;z-index:99999;background:rgba(6,6,6,.96);backdrop-filter:blur(16px);flex-direction:column;align-items:center;justify-content:center;gap:18px;}
.gal__lb.open{display:flex;}
.gal__lb-close{position:fixed;top:18px;right:22px;width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;}
.gal__lb-img{max-width:88vw;max-height:76vh;object-fit:contain;border-radius:12px;}
.gal__lb-nav{position:fixed;top:50%;transform:translateY(-50%);width:50px;height:50px;border-radius:50%;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.18);color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;}
.gal__lb-nav--prev{left:18px;}.gal__lb-nav--next{right:18px;}
.gal__lb-strip{display:flex;gap:8px;overflow-x:auto;max-width:90vw;scrollbar-width:thin;}
.gal__lb-dot{flex-shrink:0;width:58px;height:58px;border-radius:8px;overflow:hidden;border:2.5px solid rgba(255,255,255,.15);cursor:pointer;transition:border-color .2s;}
.gal__lb-dot img{width:100%;height:100%;object-fit:contain;padding:3px;}
.gal__lb-dot.active{border-color:#d4b896;}
.gal__lb-count{position:fixed;top:24px;left:50%;transform:translateX(-50%);color:rgba(255,255,255,.5);font-size:13px;font-weight:600;letter-spacing:.1em;}

/* ‚îÄ‚îÄ PAGE ‚îÄ‚îÄ */
.pd-page{max-width:1340px;margin:0 auto;padding:0 24px 100px;}
.pd-crumb{display:flex;align-items:center;gap:6px;flex-wrap:wrap;padding:16px 0 28px;font-size:12px;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:var(--aa-muted);}
.pd-crumb a{color:var(--aa-muted);text-decoration:none;}.pd-crumb a:hover{color:var(--aa-ink);}
.pd-crumb-sep{font-size:10px;color:#ccc;}
.pd-grid{display:grid;grid-template-columns:1fr 1fr;gap:60px;align-items:start;}
@media(max-width:960px){.pd-grid{grid-template-columns:1fr;gap:32px;}}

/* ‚îÄ‚îÄ INFO ‚îÄ‚îÄ */
.pi{display:flex;flex-direction:column;}
.pi__badges{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:14px;}
.pi__badge{font-size:10px;font-weight:800;letter-spacing:.1em;text-transform:uppercase;padding:4px 10px;border-radius:4px;}
.pi__badge--brand{background:var(--aa-sand);color:var(--aa-gold);}
.pi__badge--color{background:#f3eeff;color:#7c3aed;}
.pi__badge--clear{background:#e8f4ff;color:#1a56a8;}
.pi__badge--daily{background:var(--aa-green-bg);color:var(--aa-green);}
.pi__badge--monthly{background:var(--aa-orange-bg);color:var(--aa-orange);}
.pi__title{font-size:clamp(22px,2.6vw,32px);font-weight:800;line-height:1.15;color:var(--aa-ink);letter-spacing:-.03em;margin:0 0 10px;}
.pi__meta{display:flex;align-items:center;gap:14px;margin-bottom:6px;flex-wrap:wrap;}
.pi__brand{font-size:13px;color:var(--aa-muted);}.pi__brand strong{color:var(--aa-ink);}
.pi__sku{font-size:11px;color:#c5c0b8;letter-spacing:.06em;}
.pi__wish{margin-left:auto;flex-shrink:0;width:44px;height:44px;border-radius:50%;background:var(--aa-sand);border:2px solid var(--aa-border);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all var(--aa-t);}
.pi__wish:hover,.pi__wish.is-on{border-color:#e05f5f;background:#fff5f5;}
.pi__wish svg{width:18px;height:18px;}
.pi__price-box{display:flex;align-items:baseline;gap:12px;flex-wrap:wrap;padding:18px 22px;border-radius:var(--aa-radius);background:var(--aa-sand);border:1px solid rgba(184,151,106,.18);margin:20px 0 8px;}
.pi__price{font-size:34px;font-weight:900;color:var(--aa-ink);letter-spacing:-.04em;}
.pi__price-was{font-size:17px;color:var(--aa-muted);text-decoration:line-through;}
.pi__price-save{font-size:12px;font-weight:800;background:var(--aa-green);color:#fff;padding:3px 9px;border-radius:4px;}
.pi__pack-note{font-size:13px;color:var(--aa-muted);margin-bottom:22px;padding-left:2px;}
.pi__desc{font-size:14px;line-height:1.78;color:var(--aa-ink-soft);margin-bottom:22px;}
.pi__lbl{font-size:11px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--aa-muted);margin-bottom:10px;}
.pi__specs-table{width:100%;border-collapse:collapse;font-size:14px;margin-bottom:24px;}
.pi__specs-table tr{border-bottom:1px solid var(--aa-border);}
.pi__specs-table td{padding:10px 0;vertical-align:top;}
.pi__specs-table td:first-child{color:var(--aa-muted);width:44%;}
.pi__specs-table td:last-child{font-weight:700;color:var(--aa-ink);}
.pi__qty-wrap{margin-bottom:22px;}
.pi__qty{display:inline-flex;align-items:center;border:2px solid var(--aa-border);border-radius:var(--aa-radius);overflow:hidden;}
.pi__qty-btn{width:46px;height:46px;border:none;background:var(--aa-sand);font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--aa-ink);transition:background var(--aa-t);line-height:1;}
.pi__qty-btn:hover{background:var(--aa-border);}
.pi__qty-num{width:56px;height:46px;border:none;border-left:2px solid var(--aa-border);border-right:2px solid var(--aa-border);text-align:center;font-size:16px;font-weight:700;color:var(--aa-ink);background:#fff;}
.pi__qty-num:focus{outline:none;}
.pi__confirmed{display:none;align-items:center;gap:8px;background:var(--aa-green-bg);border:1px solid #3a8a2e;color:#2a6a20;border-radius:8px;padding:10px 14px;font-size:13px;font-weight:600;margin-bottom:14px;}
.pi__confirmed.is-show{display:flex;}
.pi__confirmed button{margin-left:auto;background:none;border:none;color:#2a6a20;font-size:12px;font-weight:700;cursor:pointer;text-decoration:underline;}
.pi__cta{display:flex;flex-direction:column;gap:12px;margin-bottom:26px;}
.pi__btn{width:100%;padding:17px 24px;border-radius:50px;font-size:14px;font-weight:800;letter-spacing:.06em;text-transform:uppercase;cursor:pointer;transition:all var(--aa-t);border:2px solid transparent;}
.pi__btn--select{background:#fff;border-color:var(--aa-gold);color:var(--aa-gold);}
.pi__btn--select:hover{background:var(--aa-gold);color:#fff;}
.pi__btn--cart{background:var(--aa-ink);border-color:var(--aa-ink);color:#fff;}
.pi__btn--cart:hover{background:#2a2a2a;}
.pi__btn--buy{background:var(--aa-gold);border-color:var(--aa-gold);color:#fff;}
.pi__btn--buy:hover{background:#a07050;border-color:#a07050;}
.pi__trust{background:var(--aa-sand);border-radius:var(--aa-radius);padding:16px 20px;display:flex;flex-direction:column;gap:12px;border:1px solid rgba(184,151,106,.18);margin-bottom:24px;}
.pi__trust-row{display:flex;align-items:center;gap:12px;font-size:13px;color:var(--aa-ink);}
.pi__trust-icon{width:34px;height:34px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 1px 6px rgba(0,0,0,.07);}
.pi__trust-icon svg{width:15px;height:15px;color:var(--aa-gold);}
.pd-section{padding:52px 0;border-top:1px solid var(--aa-border);}
.pd-section__h{font-size:22px;font-weight:800;color:var(--aa-ink);margin-bottom:18px;letter-spacing:-.02em;}
.pd-section__body{font-size:15px;line-height:1.85;color:var(--aa-ink-soft);}
.pd-rel-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:18px;margin-top:24px;}
@media(max-width:860px){.pd-rel-grid{grid-template-columns:repeat(2,1fr);}}
.pd-rel-card{text-decoration:none;color:inherit;display:block;border-radius:var(--aa-radius);overflow:hidden;border:1px solid var(--aa-border);background:#fff;transition:all var(--aa-t);}
.pd-rel-card:hover{transform:translateY(-4px);box-shadow:var(--aa-shadow);border-color:var(--aa-gold-lt);}
.pd-rel-card__img{aspect-ratio:1/1;background:var(--aa-sand);overflow:hidden;}
.pd-rel-card__img img{width:100%;height:100%;object-fit:contain;padding:10px;transition:transform .4s;display:block;}
.pd-rel-card:hover .pd-rel-card__img img{transform:scale(1.06);}
.pd-rel-card__info{padding:14px;}
.pd-rel-card__brand{font-size:10px;color:var(--aa-gold);font-weight:700;text-transform:uppercase;letter-spacing:.08em;}
.pd-rel-card__name{font-size:14px;font-weight:700;margin:4px 0;color:var(--aa-ink);line-height:1.3;}
.pd-rel-card__price{font-size:15px;font-weight:800;color:var(--aa-ink);}
.pd-toast{position:fixed;bottom:28px;right:28px;z-index:99999;padding:14px 22px;border-radius:var(--aa-radius);font-size:14px;font-weight:700;color:#fff;box-shadow:0 8px 32px rgba(0,0,0,.2);pointer-events:none;transform:translateY(70px);opacity:0;transition:all .32s var(--aa-ease);max-width:320px;background:var(--aa-ink);}
.pd-toast.is-show{transform:translateY(0);opacity:1;}
.pd-toast--ok{background:var(--aa-green)!important;}
.pd-toast--err{background:#c03020!important;}

/* ‚îÄ‚îÄ POWER / COLOR MODAL ‚îÄ‚îÄ */
.pm{display:none;position:fixed;inset:0;z-index:8888;background:rgba(13,13,13,.55);backdrop-filter:blur(5px);align-items:flex-start;justify-content:center;padding:24px 16px;overflow-y:auto;}
.pm.is-open{display:flex;}
.pm__box{background:#fff;width:100%;max-width:760px;border-radius:20px;overflow:hidden;box-shadow:0 24px 80px rgba(0,0,0,.2);animation:pmIn .3s var(--aa-ease);margin:auto;}
@keyframes pmIn{from{opacity:0;transform:translateY(22px) scale(.97)}to{opacity:1;transform:none}}
.pm__head{padding:22px 28px 18px;border-bottom:1px solid var(--aa-border);display:flex;align-items:center;justify-content:space-between;}
.pm__head h3{margin:0;font-size:18px;font-weight:800;}
.pm__close{background:none;border:none;font-size:26px;cursor:pointer;color:var(--aa-muted);padding:0;line-height:1;}
.pm__close:hover{color:var(--aa-ink);}
.pm__body{padding:22px 28px;max-height:72vh;overflow-y:auto;}
.pm__step-lbl{font-size:11px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--aa-muted);margin-bottom:12px;}
.color-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:12px;margin-bottom:24px;}
.color-chip{border:2px solid var(--aa-border);border-radius:var(--aa-radius);padding:10px 8px;cursor:pointer;transition:all var(--aa-t);text-align:center;}
.color-chip:hover{border-color:#aaa;box-shadow:var(--aa-shadow);}
.color-chip.is-on{border-color:var(--aa-ink);background:var(--aa-sand);}
.color-chip img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px;margin-bottom:7px;display:block;}
.color-chip__name{font-size:12px;font-weight:600;color:var(--aa-ink);}
.color-chip__tag{display:inline-block;font-size:10px;font-weight:700;padding:2px 6px;border-radius:3px;margin-top:4px;letter-spacing:.04em;text-transform:uppercase;}
.tag-plano{background:var(--aa-orange-bg);color:var(--aa-orange);}
.tag-power{background:var(--aa-green-bg);color:var(--aa-green);}
.cl-sel-info{display:none;align-items:center;gap:8px;background:#e8f4ff;border:1px solid #90c8f5;border-radius:8px;padding:10px 14px;font-size:13px;font-weight:600;color:#1a56a8;margin-bottom:20px;}
.cl-sel-info.is-show{display:flex;}
.pm__power-wrap{background:var(--aa-sand);border-radius:var(--aa-radius);padding:20px;margin-bottom:18px;}
.pm__power-lbl{font-size:12px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--aa-muted);margin-bottom:14px;}
.eye-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
@media(max-width:520px){.eye-grid{grid-template-columns:1fr;}}
.eye-box{background:#fff;border:2px solid var(--aa-border);border-radius:10px;padding:16px;}
.eye-box__title{font-size:14px;font-weight:700;color:var(--aa-ink);margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid var(--aa-ink);}
.eye-box label{display:block;font-size:11px;font-weight:600;color:var(--aa-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.06em;}
.eye-box select{width:100%;padding:10px 12px;border:2px solid var(--aa-border);border-radius:8px;font-size:14px;font-weight:600;color:var(--aa-ink);background:#fff;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%238a8580' stroke-width='1.6' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;transition:border-color var(--aa-t);}
.eye-box select:focus{border-color:var(--aa-gold);outline:none;}
.eye-box select:disabled{background-color:#f5f5f5;color:var(--aa-muted);cursor:not-allowed;}
.same-pow{display:flex;align-items:center;gap:10px;padding:10px 14px;background:#fff8e8;border:1px solid var(--aa-gold-lt);border-radius:8px;cursor:pointer;margin-top:12px;font-size:13px;font-weight:600;color:var(--aa-ink);}
.same-pow input{width:17px;height:17px;accent-color:var(--aa-ink);}
.notify-box{background:#f0f7ff;border:1px solid #c8e1ff;border-radius:var(--aa-radius);padding:16px 20px;margin-bottom:18px;}
.notify-box__title{font-size:13px;font-weight:700;color:var(--aa-ink);margin-bottom:3px;}
.notify-box__sub{font-size:12px;color:var(--aa-muted);margin-bottom:10px;}
.notify-row{display:flex;gap:8px;flex-wrap:wrap;}
.notify-inp{flex:1;min-width:130px;padding:9px 12px;border:2px solid var(--aa-border);border-radius:8px;font-size:13px;color:var(--aa-ink);transition:border-color var(--aa-t);}
.notify-inp:focus{border-color:var(--aa-gold);outline:none;}
.notify-btn{padding:9px 16px;background:#1a56a8;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;transition:background var(--aa-t);}
.notify-btn:hover{background:#154599;}
.pm__foot{padding:18px 28px 24px;border-top:1px solid var(--aa-border);background:#fff;position:sticky;bottom:0;}
.pm__confirm{width:100%;padding:15px;background:var(--aa-ink);color:#fff;border:none;border-radius:50px;font-size:15px;font-weight:800;cursor:pointer;transition:background var(--aa-t);letter-spacing:.04em;}
.pm__confirm:hover{background:#2a2a2a;}
</style>

<div class="pd-page">
  <nav class="pd-crumb">
    <a href="{% url 'home' %}">Home</a>
    <span class="pd-crumb-sep">‚Ä∫</span>
    <a href="{% url 'catalog:contact_lenses_list' %}">Contact Lenses</a>
    <span class="pd-crumb-sep">‚Ä∫</span>
    <span>{{ product.name }}</span>
  </nav>

  <div class="pd-grid">

    <!-- ‚ïê‚ïê GALLERY ‚ïê‚ïê -->
    <div>
      <div class="gal" id="galRoot">
        <div class="gal__rail" id="galRail">
          {% if primary_image %}
          <div class="gal__thumb is-active" data-src="{{ primary_image.image.url }}" tabindex="0">
            <img src="{{ primary_image.image.url }}" alt="{{ product.name }}" loading="eager">
          </div>
          {% endif %}
          {% for img in images %}
          <div class="gal__thumb" data-src="{{ img.image.url }}" tabindex="0">
            <img src="{{ img.image.url }}" alt="{{ product.name }}" loading="lazy">
          </div>
          {% endfor %}
          {% for color in colors %}
          <div class="gal__thumb" data-src="{{ color.image.url }}" tabindex="0" title="{{ color.name }}">
            <img src="{{ color.image.url }}" alt="{{ color.name }}" loading="lazy">
          </div>
          {% endfor %}
        </div>
        <div class="gal__stage-wrap">
          <div class="gal__stage" id="galStage" tabindex="0">
            {% if primary_image %}
            <img class="gal__img" id="galMain" src="{{ primary_image.image.url }}" alt="{{ product.name }}">
            {% else %}
            <div class="gal__placeholder">
              <svg width="80" height="80" viewBox="0 0 80 80" fill="none"><ellipse cx="25" cy="40" rx="18" ry="14" stroke="currentColor" stroke-width="3" fill="none"/><ellipse cx="55" cy="40" rx="18" ry="14" stroke="currentColor" stroke-width="3" fill="none"/><path d="M43 40H37" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg>
            </div>
            {% endif %}
            <button class="gal__arr gal__arr--prev hidden" id="galPrev" type="button" aria-label="Previous"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg></button>
            <button class="gal__arr gal__arr--next hidden" id="galNext" type="button" aria-label="Next"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="9 18 15 12 9 6"/></svg></button>
            <span class="gal__counter solo" id="galCounter">1 / 1</span>
            <button class="gal__fs" id="galFs" type="button" aria-label="Fullscreen"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></button>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê PRODUCT INFO ‚ïê‚ïê -->
    <div class="pi">
      <div style="display:flex;align-items:flex-start;gap:10px;margin-bottom:12px;">
        <div class="pi__badges">
          {% if product.brand %}<span class="pi__badge pi__badge--brand">{{ product.brand.name }}</span>{% endif %}
          {% if contact_lens.lens_type == 'color' %}<span class="pi__badge pi__badge--color">Color Lens</span>{% else %}<span class="pi__badge pi__badge--clear">Clear Lens</span>{% endif %}
          {% if contact_lens.replacement_schedule == 'daily' %}<span class="pi__badge pi__badge--daily">Daily</span>{% elif contact_lens.replacement_schedule == 'monthly' %}<span class="pi__badge pi__badge--monthly">Monthly</span>{% endif %}
        </div>
        <button class="pi__wish{% if product in request.user.wishlist.products.all %} is-on{% endif %}" id="piWishBtn" data-product-id="{{ product.id }}" aria-label="Wishlist">
          <svg viewBox="0 0 24 24" fill="{% if product in request.user.wishlist.products.all %}#e05f5f{% else %}none{% endif %}" stroke="{% if product in request.user.wishlist.products.all %}#e05f5f{% else %}currentColor{% endif %}" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
        </button>
      </div>

      <h1 class="pi__title">{{ product.name }}</h1>
      <div class="pi__meta">
        {% if product.brand %}<span class="pi__brand">Brand: <strong>{{ product.brand.name }}</strong></span>{% endif %}
        {% if product.sku %}<span class="pi__sku">SKU: {{ product.sku }}</span>{% endif %}
      </div>

      <div class="pi__price-box">
        <span class="pi__price">QAR {{ product.base_price }}</span>
        {% if product.compare_at_price %}
        <span class="pi__price-was">QAR {{ product.compare_at_price }}</span>
        <span class="pi__price-save">Save QAR {{ product.compare_at_price|floatformat:0 }}</span>
        {% endif %}
      </div>
      <p class="pi__pack-note">Pack of <strong>{{ contact_lens.package_size }}</strong> lenses ¬∑ {{ contact_lens.get_replacement_schedule_display }}</p>

      {% if product.short_description %}<p class="pi__desc">{{ product.short_description }}</p>{% endif %}

      <p class="pi__lbl">Lens Details</p>
      <table class="pi__specs-table">
        <tr><td>Lens Type</td><td>{{ contact_lens.get_lens_type_display }}</td></tr>
        <tr><td>Replacement</td><td>{{ contact_lens.get_replacement_schedule_display }}</td></tr>
        <tr><td>Diameter</td><td>{{ contact_lens.diameter }} MM</td></tr>
        <tr><td>Base Curve</td><td>{{ contact_lens.base_curve }}</td></tr>
        <tr><td>Water Content</td><td>{{ contact_lens.water_content }}%</td></tr>
        {% if contact_lens.intended_use %}<tr><td>Intended Use</td><td>{{ contact_lens.intended_use }}</td></tr>{% endif %}
      </table>

      <form id="pdForm" onsubmit="return false;">
        {% csrf_token %}
        <input type="hidden" name="product_id" value="{{ product.id }}">
        <input type="hidden" name="selected_color" id="hdColorId" value="">
        <input type="hidden" name="left_power" id="hdLeftPower" value="">
        <input type="hidden" name="right_power" id="hdRightPower" value="">
        <input type="hidden" name="is_plano" id="hdIsPlano" value="">

        <p class="pi__lbl">Quantity</p>
        <div class="pi__qty-wrap">
          <div class="pi__qty">
            <button type="button" class="pi__qty-btn" onclick="chQty(-1)">‚àí</button>
            <input class="pi__qty-num" type="number" id="qtyVal" name="quantity" value="1" min="1" max="{{ product.stock_quantity|default:99 }}" readonly>
            <button type="button" class="pi__qty-btn" onclick="chQty(1)">+</button>
          </div>
        </div>

        <div class="pi__confirmed" id="piConfirmed">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
          <span id="piConfirmedTxt">Selection confirmed</span>
          <button type="button" onclick="openPm()">Change</button>
        </div>

        <div class="pi__cta">
          <button type="button" class="pi__btn pi__btn--select" onclick="openPm()">
            {% if contact_lens.lens_type == 'color' %}üé® Select Color & Power{% else %}üîç Select Power{% endif %}
          </button>
          <button type="button" class="pi__btn pi__btn--cart" id="cartBtn" onclick="addCart()">
            <svg style="width:16px;height:16px;vertical-align:middle;margin-right:6px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg>Add to Cart
          </button>
          <button type="button" class="pi__btn pi__btn--buy" onclick="buyNow()">Buy it Now ‚Üí</button>
        </div>
      </form>

      <div class="pi__trust">
        <div class="pi__trust-row"><div class="pi__trust-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13" rx="1"/><path d="M16 8h4l3 5v3h-7V8z"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg></div><span>Delivery in <strong>3‚Äì6 business days</strong> ¬∑ Qatar / GCC</span></div>
        <div class="pi__trust-row"><div class="pi__trust-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></div><span>Free returns within <strong>30 days</strong></span></div>
        <div class="pi__trust-row"><div class="pi__trust-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M9 12l2 2 4-4"/></svg></div><span><strong>100% Authentic</strong> guaranteed</span></div>
      </div>
    </div>
  </div>

  {% if product.description %}
  <div class="pd-section"><h2 class="pd-section__h">About This Product</h2><div class="pd-section__body">{{ product.description|linebreaksbr }}</div></div>
  {% endif %}

  {% if related_products %}
  <div class="pd-section">
    <h2 class="pd-section__h">You May Also Like</h2>
    <div class="pd-rel-grid">
      {% for r in related_products %}
      <a href="{% url 'catalog:contact_lens_detail' r.slug %}" class="pd-rel-card">
        <div class="pd-rel-card__img">{% with r.images.first as rimg %}{% if rimg %}<img src="{{ rimg.image.url }}" alt="{{ r.name }}" loading="lazy">{% endif %}{% endwith %}</div>
        <div class="pd-rel-card__info">
          {% if r.brand %}<p class="pd-rel-card__brand">{{ r.brand.name }}</p>{% endif %}
          <p class="pd-rel-card__name">{{ r.name }}</p>
          <p class="pd-rel-card__price">QAR {{ r.base_price }}</p>
        </div>
      </a>
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>

<!-- ‚ïê‚ïê COLOR & POWER MODAL ‚ïê‚ïê -->
<div class="pm" id="pmOverlay" onclick="if(event.target===this)closePm()">
  <div class="pm__box">
    <div class="pm__head">
      <h3>{% if contact_lens.lens_type == 'color' %}Select Color & Power{% else %}Select Power{% endif %}</h3>
      <button class="pm__close" onclick="closePm()">√ó</button>
    </div>
    <div class="pm__body">
      {% if contact_lens.lens_type == 'color' and colors %}
      <p class="pm__step-lbl">Step 1 ‚Äî Choose Color</p>
      <div class="color-grid">
        {% for color in colors %}
        <div class="color-chip" data-color-id="{{ color.id }}" data-color-name="{{ color.name }}" data-power-enabled="{{ color.power_enabled|lower }}" onclick="selectColor(this)">
          <img src="{{ color.image.url }}" alt="{{ color.name }}" loading="lazy">
          <div class="color-chip__name">{{ color.name }}</div>
          {% if color.power_enabled %}<span class="color-chip__tag tag-power">With Power</span>{% else %}<span class="color-chip__tag tag-plano">Plano Only</span>{% endif %}
        </div>
        {% endfor %}
      </div>
      <div class="cl-sel-info" id="clSelInfo">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
        Color: <strong id="clSelName">‚Äî</strong>
      </div>
      <div id="pmPowerSection" style="display:none;">
        <p class="pm__step-lbl">Step 2 ‚Äî Choose Power</p>
      {% else %}
      <div id="pmPowerSection">
      {% endif %}
        <div class="pm__power-wrap">
          <p class="pm__power-lbl">Select Power (SPH) Per Eye</p>
          <div class="eye-grid">
            <div class="eye-box">
              <div class="eye-box__title">Left Eye (OS)</div>
              <label>Power (SPH)</label>
              <select id="leftPowerSel">
                <option value="0.00">Plano (0.00)</option>
                {% for power in power_ranges %}<option value="{{ power }}">{{ power }}</option>{% endfor %}
              </select>
            </div>
            <div class="eye-box">
              <div class="eye-box__title">Right Eye (OD)</div>
              <label>Power (SPH)</label>
              <select id="rightPowerSel">
                <option value="0.00">Plano (0.00)</option>
                {% for power in power_ranges %}<option value="{{ power }}">{{ power }}</option>{% endfor %}
              </select>
            </div>
          </div>
          <label class="same-pow"><input type="checkbox" id="samePowChk" onchange="toggleSamePow()"> Same power for both eyes</label>
        </div>
      </div>

      <div class="notify-box">
        <p class="notify-box__title">Don't see your power?</p>
        <p class="notify-box__sub">Get notified when it becomes available:</p>
        <div class="notify-row">
          <input class="notify-inp" type="text" placeholder="Required power (e.g. -5.50)" id="notifyPower">
          <input class="notify-inp" type="email" placeholder="Your email" id="notifyEmail">
          <button class="notify-btn" onclick="submitNotify()">Notify Me</button>
        </div>
      </div>
    </div>
    <div class="pm__foot">
      <button class="pm__confirm" onclick="confirmSel()">Confirm Selection ‚Üí</button>
    </div>
  </div>
</div>

<!-- LIGHTBOX -->
<div class="gal__lb" id="galLb">
  <button class="gal__lb-close" onclick="GAL.closeLb()" aria-label="Close"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
  <button class="gal__lb-nav gal__lb-nav--prev" onclick="GAL.lbNav(-1)" aria-label="Previous"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg></button>
  <img class="gal__lb-img" id="lbImg" src="" alt="">
  <button class="gal__lb-nav gal__lb-nav--next" onclick="GAL.lbNav(1)" aria-label="Next"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="9 18 15 12 9 6"/></svg></button>
  <div class="gal__lb-strip" id="lbStrip"></div>
  <span class="gal__lb-count" id="lbCount"></span>
</div>
<div class="pd-toast" id="pdToast"></div>

<script>
var GAL=(function(){
  var thumbEls,srcs,cur=0,total=0,mainImg,counter,lb,lbImg,lbStrip,lbCount;
  function init(){
    thumbEls=Array.from(document.querySelectorAll('#galRail .gal__thumb'));
    srcs=thumbEls.map(function(t){return t.dataset.src||'';});
    total=srcs.length;mainImg=document.getElementById('galMain');counter=document.getElementById('galCounter');
    lb=document.getElementById('galLb');lbImg=document.getElementById('lbImg');lbStrip=document.getElementById('lbStrip');lbCount=document.getElementById('lbCount');
    if(!mainImg||total===0)return;
    srcs.forEach(function(src,i){var d=document.createElement('div');d.className='gal__lb-dot'+(i===0?' active':'');var im=document.createElement('img');im.src=src;im.loading='lazy';d.appendChild(im);d.addEventListener('click',function(){lbGoTo(i);});lbStrip.appendChild(d);});
    if(total>1){document.getElementById('galPrev').classList.remove('hidden');document.getElementById('galNext').classList.remove('hidden');counter.classList.remove('solo');}
    updateCounter();
    thumbEls.forEach(function(t,i){t.addEventListener('click',function(){goTo(i);});t.addEventListener('keydown',function(e){if(e.key==='Enter'||e.key===' '){e.preventDefault();goTo(i);}});});
    document.getElementById('galPrev').addEventListener('click',function(e){e.stopPropagation();goTo(cur-1);});
    document.getElementById('galNext').addEventListener('click',function(e){e.stopPropagation();goTo(cur+1);});
    document.getElementById('galFs').addEventListener('click',function(e){e.stopPropagation();openLb();});
    document.getElementById('galStage').addEventListener('click',function(e){if(e.target.closest('#galPrev,#galNext,#galFs'))return;openLb();});
    document.getElementById('galStage').addEventListener('keydown',function(e){if(e.key==='ArrowLeft')goTo(cur-1);if(e.key==='ArrowRight')goTo(cur+1);if(e.key==='Enter')openLb();});
    var txS=0;
    document.getElementById('galStage').addEventListener('touchstart',function(e){txS=e.changedTouches[0].screenX;},{passive:true});
    document.getElementById('galStage').addEventListener('touchend',function(e){var dx=txS-e.changedTouches[0].screenX;if(Math.abs(dx)>50){dx>0?goTo(cur+1):goTo(cur-1);}},{passive:true});
    lb.addEventListener('click',function(e){if(e.target===lb)closeLb();});
  }
  function goTo(idx){if(idx<0)idx=total-1;if(idx>=total)idx=0;var newSrc=srcs[idx];if(!newSrc)return;mainImg.classList.add('fading');var tmp=new Image();tmp.onload=tmp.onerror=function(){mainImg.src=newSrc;mainImg.classList.remove('fading');};tmp.src=newSrc;thumbEls.forEach(function(t,i){t.classList.toggle('is-active',i===idx);});if(thumbEls[idx])thumbEls[idx].scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'});cur=idx;updateCounter();if(lb.classList.contains('open'))lbGoTo(idx);}
  function goToSrc(src){var idx=srcs.indexOf(src);if(idx!==-1){goTo(idx);return;}mainImg.classList.add('fading');setTimeout(function(){mainImg.src=src;mainImg.classList.remove('fading');},100);}
  function updateCounter(){if(counter)counter.textContent=(cur+1)+' / '+total;var dots=lbStrip?lbStrip.querySelectorAll('.gal__lb-dot'):[];Array.from(dots).forEach(function(d,i){d.classList.toggle('active',i===cur);});if(lbCount)lbCount.textContent=(cur+1)+' / '+total;}
  function openLb(){lbGoTo(cur);lb.classList.add('open');document.body.style.overflow='hidden';}
  function closeLb(){lb.classList.remove('open');document.body.style.overflow='';}
  function lbGoTo(idx){if(idx<0)idx=total-1;if(idx>=total)idx=0;lbImg.style.opacity='0';lbImg.style.transform='scale(.94)';lbImg.style.transition='opacity .22s,transform .22s';setTimeout(function(){lbImg.src=srcs[idx];lbImg.style.opacity='1';lbImg.style.transform='scale(1)';},110);cur=idx;updateCounter();var dots=lbStrip.querySelectorAll('.gal__lb-dot');Array.from(dots).forEach(function(d,i){d.classList.toggle('active',i===idx);});if(dots[idx])dots[idx].scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'});}
  document.addEventListener('keydown',function(e){if(!lb||!lb.classList.contains('open'))return;if(e.key==='ArrowLeft')lbGoTo(cur-1);if(e.key==='ArrowRight')lbGoTo(cur+1);if(e.key==='Escape')closeLb();});
  if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',init);else init();
  return{goTo:goTo,goToSrc:goToSrc,openLb:openLb,closeLb:closeLb,lbNav:function(d){lbGoTo(cur+d);}};
})();

var IS_COLOR='{{ contact_lens.lens_type }}'==='color';
var selColorId=null,selColorName='',selPowerEnabled=false,selDone=false;
function getCsrf(){var m=document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/);return m?decodeURIComponent(m[1]):'';}
var _tt;
function toast(msg,type){if(typeof window.showToast==='function'){window.showToast(msg,type==='ok'?'success':type==='err'?'error':'info');return;}var t=document.getElementById('pdToast');t.textContent=msg;t.className='pd-toast is-show'+(type?' pd-toast--'+type:'');clearTimeout(_tt);_tt=setTimeout(function(){t.classList.remove('is-show');},3400);}
function chQty(d){var i=document.getElementById('qtyVal');i.value=Math.min(Math.max(1,parseInt(i.value)+d),parseInt(i.max)||99);}
function openPm(){document.getElementById('pmOverlay').classList.add('is-open');document.body.style.overflow='hidden';}
function closePm(){document.getElementById('pmOverlay').classList.remove('is-open');document.body.style.overflow='';}
function selectColor(chip){
  document.querySelectorAll('.color-chip').forEach(function(c){c.classList.remove('is-on');});
  chip.classList.add('is-on');
  selColorId=chip.dataset.colorId;selColorName=chip.dataset.colorName;selPowerEnabled=chip.dataset.powerEnabled==='true';
  var info=document.getElementById('clSelInfo');if(info){info.classList.add('is-show');document.getElementById('clSelName').textContent=selColorName;}
  var ps=document.getElementById('pmPowerSection');if(ps)ps.style.display=selPowerEnabled?'block':'none';
  GAL.goToSrc(chip.querySelector('img').src);
}
function toggleSamePow(){var chk=document.getElementById('samePowChk');var r=document.getElementById('rightPowerSel');if(chk.checked){r.value=document.getElementById('leftPowerSel').value;r.disabled=true;}else{r.disabled=false;}}
document.addEventListener('DOMContentLoaded',function(){
  var ls=document.getElementById('leftPowerSel');
  if(ls)ls.addEventListener('change',function(){if(document.getElementById('samePowChk').checked)document.getElementById('rightPowerSel').value=ls.value;});
});
function confirmSel(){
  if(IS_COLOR&&!selColorId){toast('Please select a color','err');return;}
  if(IS_COLOR)document.getElementById('hdColorId').value=selColorId;
  var lp,rp;
  if(!IS_COLOR||selPowerEnabled){lp=document.getElementById('leftPowerSel').value;rp=document.getElementById('rightPowerSel').value;}
  else{lp='0.00';rp='0.00';}
  document.getElementById('hdLeftPower').value=lp;
  document.getElementById('hdRightPower').value=rp;
  document.getElementById('hdIsPlano').value=(lp==='0.00'&&rp==='0.00')?'true':'false';
  selDone=true;
  var ok=document.getElementById('piConfirmed');ok.classList.add('is-show');
  var txt=IS_COLOR?selColorName+(selPowerEnabled?' ¬∑ L:'+lp+' R:'+rp:' ¬∑ Plano'):'L:'+lp+' / R:'+rp;
  document.getElementById('piConfirmedTxt').textContent=txt;
  closePm();toast('Selection confirmed!','ok');
}
function submitNotify(){var p=document.getElementById('notifyPower').value.trim();var e=document.getElementById('notifyEmail').value.trim();if(!p||!e){toast('Please enter power and email','err');return;}toast('We\'ll notify you at '+e,'ok');document.getElementById('notifyPower').value='';document.getElementById('notifyEmail').value='';}
function addCart(){
  if(!selDone){toast('Please select {% if contact_lens.lens_type == "color" %}color & power{% else %}power{% endif %} first','err');openPm();return;}
  var btn=document.getElementById('cartBtn');var orig=btn.innerHTML;btn.textContent='Adding‚Ä¶';btn.disabled=true;
  var form=document.getElementById('pdForm');var fd=new FormData(form);fd.set('quantity',document.getElementById('qtyVal').value);
  fetch("{% url 'cart:add_contact_lens_to_cart' %}",{method:'POST',body:fd,headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':getCsrf()}})
  .then(function(r){return r.json();})
  .then(function(d){btn.innerHTML=orig;btn.disabled=false;if(d.success){toast('üõí Added to cart!','ok');if(typeof window.updateCartBadge==='function')window.updateCartBadge(d.cart_count||0);}else toast(d.message||'Error','err');})
  .catch(function(){btn.innerHTML=orig;btn.disabled=false;toast('Network error','err');});
}
function buyNow(){
  if(!selDone){toast('Please select {% if contact_lens.lens_type == "color" %}color & power{% else %}power{% endif %} first','err');openPm();return;}
  var form=document.getElementById('pdForm');form.action="{% url 'orders:checkout' %}";form.method='POST';form.submit();
}
document.getElementById('piWishBtn').addEventListener('click',function(){
  var btn=this;var pid=btn.dataset.productId;var csrf=getCsrf();
  fetch("{% url 'wishlist:toggle' 0 %}".replace('/0/','/'+pid+'/'),{method:'POST',credentials:'same-origin',headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':csrf,'Content-Type':'application/x-www-form-urlencoded'},body:'csrfmiddlewaretoken='+encodeURIComponent(csrf)})
  .then(function(r){return r.json();})
  .then(function(d){var svg=btn.querySelector('svg');if(d.added){btn.classList.add('is-on');svg.setAttribute('fill','#e05f5f');svg.setAttribute('stroke','#e05f5f');toast('‚ù§Ô∏è Added to wishlist!','ok');}else{btn.classList.remove('is-on');svg.setAttribute('fill','none');svg.setAttribute('stroke','currentColor');toast('Removed from wishlist','');}if(typeof window.updateWishlistCount==='function'&&d.wishlist_count!==undefined)window.updateWishlistCount(d.wishlist_count);}).catch(function(){toast('Please log in to use wishlist','');});
});
document.addEventListener('keydown',function(e){if(e.key==='Escape'){closePm();GAL.closeLb();}});
</script>
{% endblock %}