{% extends 'base.html' %}
{% load static %}
{% block title %}{{ product.name }} - Accessories{% endblock %}

{% block content %}

<style>
  /* ─── DESIGN TOKENS ─────────────────────────────── */
  :root {
    --black: #0a0a0a;
    --white: #fafafa;
    --gold: #b8976a;
    --gold-light: #d4b896;
    --sand: #f5f0e8;
    --muted: #888;
    --border: #e5e0d8;
    --radius: 10px;
    --shadow: 0 4px 24px rgba(0,0,0,0.08);
    --transition: all 0.28s cubic-bezier(0.4,0,0.2,1);
  }

  /* ─── BREADCRUMB ─────────────────────────────────── */
  .sg-breadcrumb {
    padding: 14px 0;
    font-size: 13px;
    color: var(--muted);
    letter-spacing: 0.02em;
  }
  .sg-breadcrumb a { color: var(--muted); text-decoration: none; }
  .sg-breadcrumb a:hover { color: var(--black); }
  .sg-breadcrumb span { margin: 0 6px; }

  /* ─── PRODUCT LAYOUT ─────────────────────────────── */
  .sg-product-wrap {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 48px;
    align-items: start;
    padding: 0 0 60px;
  }
  @media (max-width: 900px) {
    .sg-product-wrap { grid-template-columns: 1fr; gap: 28px; }
  }

  /* ─── GALLERY ─────────────────────────────────────── */
  .sg-gallery { position: sticky; top: 100px; }
  .sg-main-img {
    width: 100%;
    aspect-ratio: 1/1;
    border-radius: 16px;
    overflow: hidden;
    background: var(--sand);
    position: relative;
    margin-bottom: 14px;
    cursor: zoom-in;
  }
  .sg-main-img img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    transition: transform 0.4s ease;
    display: block;
  }
  .sg-main-img:hover img { transform: scale(1.04); }

  .sg-thumbs {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  .sg-thumb {
    width: 72px;
    height: 72px;
    border-radius: 8px;
    overflow: hidden;
    background: var(--sand);
    border: 2px solid transparent;
    cursor: pointer;
    transition: var(--transition);
    flex-shrink: 0;
  }
  .sg-thumb img { width: 100%; height: 100%; object-fit: contain; display: block; }
  .sg-thumb.active, .sg-thumb:hover { border-color: var(--gold); }

  /* ─── PRODUCT INFO ───────────────────────────────── */
  .sg-badges {
    display: flex;
    gap: 8px;
    margin-bottom: 14px;
    flex-wrap: wrap;
  }
  .sg-badge {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 4px 10px;
    border-radius: 4px;
    background: var(--sand);
    color: var(--gold);
  }
  .sg-badge.new { background: #f0f7ee; color: #3a8a2e; }

  .sg-title-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 6px;
  }
  .sg-title {
    font-size: clamp(22px, 2.4vw, 30px);
    font-weight: 700;
    line-height: 1.2;
    color: var(--black);
    letter-spacing: -0.02em;
    margin: 0;
  }

  .sg-wishlist-btn {
    background: none;
    border: 2px solid var(--border);
    border-radius: 50%;
    width: 44px;
    height: 44px;
    flex-shrink: 0;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
  }
  .sg-wishlist-btn:hover { border-color: #e05f5f; background: #fff0f0; }
  .sg-wishlist-btn.active { border-color: #e05f5f; background: #fff0f0; }

  .sg-brand { font-size: 13px; color: var(--muted); margin-bottom: 4px; }
  .sg-brand strong { color: var(--black); }
  .sg-sku { font-size: 12px; color: #bbb; margin-bottom: 20px; }

  .sg-price-row {
    display: flex;
    align-items: baseline;
    gap: 12px;
    margin-bottom: 24px;
    padding: 16px 20px;
    background: var(--sand);
    border-radius: var(--radius);
  }
  .sg-price {
    font-size: 28px;
    font-weight: 800;
    color: var(--black);
    letter-spacing: -0.03em;
  }
  .sg-price-old {
    font-size: 16px;
    color: var(--muted);
    text-decoration: line-through;
  }
  .sg-discount-badge {
    font-size: 12px;
    font-weight: 700;
    background: #2a7a2a;
    color: #fff;
    padding: 3px 8px;
    border-radius: 4px;
  }

  /* ─── SECTION LABEL ──────────────────────────────── */
  .sg-section-label {
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 10px;
  }

  /* ─── COLOR VARIANTS ─────────────────────────────── */
  .sg-colors {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 24px;
  }
  .sg-color-swatch {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    cursor: pointer;
  }
  .sg-color-dot {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 3px solid transparent;
    box-shadow: 0 0 0 1px var(--border);
    transition: var(--transition);
    position: relative;
  }
  .sg-color-swatch.active .sg-color-dot,
  .sg-color-swatch:hover .sg-color-dot {
    box-shadow: 0 0 0 2px var(--gold);
    transform: scale(1.1);
  }
  .sg-color-name { font-size: 11px; color: var(--muted); }

  /* ─── SIZE SELECT ────────────────────────────────── */
  .sg-size-select {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    font-size: 15px;
    background: white;
    color: var(--black);
    cursor: pointer;
    transition: var(--transition);
    margin-bottom: 24px;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23888' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
  }
  .sg-size-select:focus { border-color: var(--gold); outline: none; }

  /* ─── QUANTITY ───────────────────────────────────── */
  .sg-qty-row {
    display: flex;
    align-items: center;
    gap: 0;
    width: fit-content;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    margin-bottom: 20px;
  }
  .sg-qty-btn {
    width: 44px;
    height: 44px;
    border: none;
    background: var(--sand);
    cursor: pointer;
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
    color: var(--black);
  }
  .sg-qty-btn:hover { background: var(--border); }
  .sg-qty-input {
    width: 52px;
    height: 44px;
    border: none;
    border-left: 2px solid var(--border);
    border-right: 2px solid var(--border);
    text-align: center;
    font-size: 16px;
    font-weight: 600;
    color: var(--black);
    background: white;
  }
  .sg-qty-input:focus { outline: none; }

  /* ─── ACTION BUTTONS ─────────────────────────────── */
  .sg-actions { display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px; }

  .sg-btn-cart {
    padding: 16px 24px;
    background: var(--black);
    border: 2px solid var(--black);
    border-radius: var(--radius);
    font-size: 15px;
    font-weight: 700;
    color: white;
    cursor: pointer;
    transition: var(--transition);
    letter-spacing: 0.04em;
    text-transform: uppercase;
    position: relative;
    overflow: hidden;
  }
  .sg-btn-cart:hover { background: #333; border-color: #333; }
  .sg-btn-cart.loading { pointer-events: none; opacity: 0.7; }

  .sg-btn-buy {
    padding: 16px 24px;
    background: var(--gold);
    border: 2px solid var(--gold);
    border-radius: var(--radius);
    font-size: 15px;
    font-weight: 700;
    color: white;
    cursor: pointer;
    transition: var(--transition);
    letter-spacing: 0.04em;
    text-transform: uppercase;
    width: 100%;
  }
  .sg-btn-buy:hover { background: #a37d55; border-color: #a37d55; }

  /* ─── SHIPPING INFO ───────────────────────────────── */
  .sg-shipping {
    background: var(--sand);
    border-radius: var(--radius);
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 24px;
  }
  .sg-shipping-item {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 13px;
    color: var(--black);
  }
  .sg-shipping-icon {
    width: 32px;
    height: 32px;
    background: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  /* ─── SPECS TABLE ────────────────────────────────── */
  .sg-specs { margin-top: 8px; }
  .sg-specs-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }
  .sg-specs-table tr { border-bottom: 1px solid var(--border); }
  .sg-specs-table td { padding: 10px 0; vertical-align: top; }
  .sg-specs-table td:first-child { font-weight: 600; color: var(--black); width: 44%; }
  .sg-specs-table td:last-child { color: var(--muted); }

  /* ─── DESCRIPTION SECTION ────────────────────────── */
  .sg-desc-section {
    padding: 40px 0;
    border-top: 1px solid var(--border);
  }
  .sg-section-title {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 16px;
    color: var(--black);
  }
  .sg-desc-body { font-size: 15px; line-height: 1.8; color: #555; }

  /* ─── RELATED PRODUCTS ───────────────────────────── */
  .sg-related-section { padding: 40px 0; border-top: 1px solid var(--border); }
  .sg-related-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    margin-top: 24px;
  }
  @media (max-width: 900px) { .sg-related-grid { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 500px) { .sg-related-grid { grid-template-columns: 1fr 1fr; gap: 12px; } }

  .sg-product-card {
    text-decoration: none;
    color: inherit;
    display: block;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--border);
    transition: var(--transition);
    background: white;
  }
  .sg-product-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow);
    border-color: var(--gold-light);
  }
  .sg-card-img { aspect-ratio: 1/1; background: var(--sand); overflow: hidden; }
  .sg-card-img img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    transition: transform 0.4s ease;
    display: block;
  }
  .sg-product-card:hover .sg-card-img img { transform: scale(1.06); }
  .sg-card-info { padding: 14px; }
  .sg-card-brand { font-size: 11px; color: var(--gold); font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; }
  .sg-card-name { font-size: 14px; font-weight: 600; margin: 4px 0; color: var(--black); }
  .sg-card-price { font-size: 15px; font-weight: 700; color: var(--black); }

  /* ─── TOAST ──────────────────────────────────────── */
  .sg-toast {
    position: fixed;
    bottom: 28px;
    right: 28px;
    z-index: 99999;
    background: var(--black);
    color: white;
    padding: 14px 22px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 8px 32px rgba(0,0,0,0.24);
    transform: translateY(60px);
    opacity: 0;
    transition: all 0.32s cubic-bezier(0.4,0,0.2,1);
    pointer-events: none;
  }
  .sg-toast.show { transform: translateY(0); opacity: 1; }
  .sg-toast.success { background: #2a7a2a; }
  .sg-toast.error { background: #b42020; }

  /* ─── CONTAINER ──────────────────────────────────── */
  .sg-container {
    max-width: 1280px;
    margin: 0 auto;
    padding: 0 24px;
  }
</style>

<div class="sg-container">
  <!-- Breadcrumb -->
  <nav class="sg-breadcrumb" aria-label="Breadcrumb">
    <a href="{% url 'home' %}">Home</a>
    <span>/</span>
    <a href="{% url 'catalog:accessories_list' %}">Accessories</a>
    <span>/</span>
    <span style="color: var(--black);">{{ product.name }}</span>
  </nav>

  <!-- Main Product Section -->
  <div class="sg-product-wrap">

    <!-- ── GALLERY ── -->
    <div class="sg-gallery">
      <div class="sg-main-img" id="mainImgWrap">
        {% if product.image %}
        <img src="{{ product.image.url }}" alt="{{ product.name }}" id="mainImg" />
        {% endif %}
      </div>
      <div class="sg-thumbs" id="thumbStrip">
        {% if product.image %}
        <div class="sg-thumb active" onclick="switchImage(this, '{{ product.image.url }}')">
          <img src="{{ product.image.url }}" alt="{{ product.name }}" />
        </div>
        {% endif %}
        {% for image in images %}
        <div class="sg-thumb" onclick="switchImage(this, '{{ image.image.url }}')">
          <img src="{{ image.image.url }}" alt="{{ product.name }}" />
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- ── PRODUCT INFO ── -->
    <div class="sg-info">

      <!-- Badges -->
      <div class="sg-badges">
        {% if product.is_featured %}<span class="sg-badge">Featured</span>{% endif %}
        {% if product.compare_at_price %}<span class="sg-badge new">Sale</span>{% endif %}
        {% if product.category %}<span class="sg-badge">{{ product.category.name }}</span>{% endif %}
      </div>

      <!-- Title -->
      <div class="sg-title-row">
        <h1 class="sg-title">{{ product.name }}</h1>
        <button class="sg-wishlist-btn{% if product in request.user.wishlist.products.all %} active{% endif %}"
                id="wishlistBtn"
                data-product-id="{{ product.id }}"
                onclick="toggleWishlist(this)"
                title="Add to wishlist">
          {% if product in request.user.wishlist.products.all %}
          <svg width="18" height="18" viewBox="0 0 24 24" fill="red"><path d="M12 21s-6.7-4.4-10-9c-3.3-4.6.2-11 6-9 2 .6 4 2.4 4 2.4s2-1.8 4-2.4c5.8-2 9.3 4.4 6 9-3.3 4.6-10 9-10 9z"/></svg>
          {% else %}
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 21s-6.7-4.4-10-9c-3.3-4.6.2-11 6-9 2 .6 4 2.4 4 2.4s2-1.8 4-2.4c5.8-2 9.3 4.4 6 9-3.3 4.6-10 9-10 9z"/></svg>
          {% endif %}
        </button>
      </div>

      <!-- Brand -->
      {% if product.brand %}
      <p class="sg-brand">Brand: <strong>{{ product.brand.name }}</strong></p>
      {% endif %}

      <!-- SKU -->
      {% if product.sku %}
      <p class="sg-sku">SKU: {{ product.sku }}</p>
      {% endif %}

      <!-- Price -->
      <div class="sg-price-row">
        <span class="sg-price">QAR {{ product.base_price }}</span>
        {% if product.compare_at_price %}
        <span class="sg-price-old">QAR {{ product.compare_at_price }}</span>
        <span class="sg-discount-badge">SAVE QAR {{ product.compare_at_price|floatformat:0 }}</span>
        {% endif %}
      </div>

      <!-- Short Description -->
      {% if product.short_description %}
      <p style="font-size:14px;color:#555;line-height:1.7;margin-bottom:20px;">{{ product.short_description }}</p>
      {% endif %}

      <!-- Form -->
      <form id="productForm" method="POST" action="{% url 'cart:add_to_cart' %}" onsubmit="return false;">
        {% csrf_token %}
        <input type="hidden" name="product_id" value="{{ product.id }}">
        <input type="hidden" name="selected_variant_id" id="selectedVariantId" value="">

        <!-- Color Variants -->
        {% if variants %}
        <div style="margin-bottom:24px;">
          <p class="sg-section-label">Color / Variant</p>
          <div class="sg-colors">
            {% for variant in variants %}
            <div class="sg-color-swatch{% if forloop.first %} active{% endif %}"
                 onclick="selectVariant(this, '{{ variant.id }}', '{{ variant.color_name }}')"
                 title="{{ variant.color_name }}"
                 data-variant-id="{{ variant.id }}">
              {% if variant.color_code %}
              <div class="sg-color-dot" style="background:{{ variant.color_code }};"></div>
              {% else %}
              <div class="sg-color-dot" style="background:linear-gradient(135deg,#ccc,#aaa);"></div>
              {% endif %}
              <span class="sg-color-name">{{ variant.color_name }}</span>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Size (if applicable) -->
        {% with first_size=variants.0.size %}
        {% if first_size %}
        <div style="margin-bottom:4px;">
          <p class="sg-section-label">Size</p>
          <select class="sg-size-select" name="selected_size" id="sizeSelect">
            <option value="">Choose Size</option>
            {% for variant in variants %}
            {% if variant.size %}
            <option value="{{ variant.size }}">{{ variant.size }}</option>
            {% endif %}
            {% endfor %}
          </select>
        </div>
        {% endif %}
        {% endwith %}

        <!-- Quantity -->
        <div style="margin-bottom:20px;">
          <p class="sg-section-label">Quantity</p>
          <div class="sg-qty-row">
            <button type="button" class="sg-qty-btn" onclick="changeQty(-1)">−</button>
            <input class="sg-qty-input" type="number" name="quantity" id="qtyInput" value="1" min="1" max="{{ product.stock_quantity|default:99 }}" readonly>
            <button type="button" class="sg-qty-btn" onclick="changeQty(1)">+</button>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="sg-actions">
          <button type="button" class="sg-btn-cart" id="addToCartBtn" onclick="addToCart()">
            Add to Cart
          </button>
          <button type="submit" class="sg-btn-buy" onclick="buyNow()">Buy it now →</button>
        </div>
      </form>

      <!-- Shipping Info -->
      <div class="sg-shipping">
        <div class="sg-shipping-item">
          <div class="sg-shipping-icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="1" y="3" width="15" height="13" rx="1"/>
              <path d="M16 8h4l3 5v3h-7V8z"/>
              <circle cx="5.5" cy="18.5" r="2.5"/>
              <circle cx="18.5" cy="18.5" r="2.5"/>
            </svg>
          </div>
          <span>Estimated delivery: <strong>3–6 business days</strong> (Qatar/GCC)</span>
        </div>
        <div class="sg-shipping-item">
          <div class="sg-shipping-icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 4 23 10 17 10"/>
              <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
            </svg>
          </div>
          <span>Free returns within <strong>45 days</strong> of purchase</span>
        </div>
        <div class="sg-shipping-item">
          <div class="sg-shipping-icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
          </div>
          <span>Authentic products — <strong>100% genuine</strong></span>
        </div>
      </div>

      <!-- Specifications -->
      {% if specifications %}
      <div class="sg-specs">
        <p class="sg-section-label">Specifications</p>
        <table class="sg-specs-table">
          {% for spec in specifications %}
          <tr>
            <td>{{ spec.spec_key }}</td>
            <td>{{ spec.spec_value }}</td>
          </tr>
          {% endfor %}
        </table>
      </div>
      {% endif %}

    </div><!-- /sg-info -->
  </div><!-- /sg-product-wrap -->

  <!-- About This Product -->
  {% if product.description %}
  <div class="sg-desc-section">
    <h2 class="sg-section-title">About This Product</h2>
    <div class="sg-desc-body">{{ product.description|linebreaksbr }}</div>
  </div>
  {% endif %}

  <!-- Related Products -->
  {% if related_products %}
  <div class="sg-related-section">
    <h2 class="sg-section-title">You May Also Like</h2>
    <div class="sg-related-grid">
      {% for related in related_products %}
      <a href="{% url 'catalog:product_detail' related.slug %}" class="sg-product-card">
        <div class="sg-card-img">
          {% if related.image %}<img src="{{ related.image.url }}" alt="{{ related.name }}" loading="lazy">{% endif %}
        </div>
        <div class="sg-card-info">
          {% if related.brand %}<p class="sg-card-brand">{{ related.brand.name }}</p>{% endif %}
          <p class="sg-card-name">{{ related.name }}</p>
          <p class="sg-card-price">QAR {{ related.base_price }}</p>
        </div>
      </a>
      {% endfor %}
    </div>
  </div>
  {% endif %}

</div><!-- /sg-container -->

<!-- Toast -->
<div class="sg-toast" id="sgToast"></div>

<script>
// ── Variant selection ──────────────────────────────────────
let selectedVariantId = '';

function selectVariant(el, id, name) {
  document.querySelectorAll('.sg-color-swatch').forEach(s => s.classList.remove('active'));
  el.classList.add('active');
  selectedVariantId = id;
  document.getElementById('selectedVariantId').value = id;
}

// ── Gallery ────────────────────────────────────────────────
function switchImage(thumb, src) {
  document.querySelectorAll('.sg-thumb').forEach(t => t.classList.remove('active'));
  thumb.classList.add('active');
  const mainImg = document.getElementById('mainImg');
  if (mainImg) mainImg.src = src;
}

// ── Quantity ───────────────────────────────────────────────
function changeQty(delta) {
  const input = document.getElementById('qtyInput');
  const max = parseInt(input.max) || 99;
  const current = parseInt(input.value) || 1;
  const next = Math.min(Math.max(1, current + delta), max);
  input.value = next;
}

// ── Add to Cart ────────────────────────────────────────────
function addToCart() {
  const btn = document.getElementById('addToCartBtn');
  btn.classList.add('loading');
  btn.textContent = 'Adding...';

  const form = document.getElementById('productForm');
  const formData = new FormData(form);
  formData.set('quantity', document.getElementById('qtyInput').value);

  const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

  fetch("{% url 'cart:add_to_cart' %}", {
    method: 'POST',
    body: formData,
    headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken }
  })
  .then(r => r.json())
  .then(data => {
    btn.classList.remove('loading');
    btn.textContent = 'Add to Cart';
    if (data.success) {
      showToast('Added to cart!', 'success');
      const cartCount = document.getElementById('cartCount');
      if (cartCount && data.cart_count) cartCount.textContent = data.cart_count;
    } else {
      showToast(data.message || 'Error adding to cart', 'error');
    }
  })
  .catch(() => {
    btn.classList.remove('loading');
    btn.textContent = 'Add to Cart';
    showToast('Something went wrong. Please try again.', 'error');
  });
}

// ── Buy Now ────────────────────────────────────────────────
function buyNow() {
  const form = document.getElementById('productForm');
  form.action = "{% url 'orders:checkout' %}";
  form.method = 'POST';
  form.submit();
}

// ── Wishlist ───────────────────────────────────────────────
function toggleWishlist(btn) {
  const productId = btn.dataset.productId;
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  fetch('/users/wishlist/toggle/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken,
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: JSON.stringify({ product_id: productId })
  })
  .then(r => r.json())
  .then(data => {
    if (data.added) {
      btn.classList.add('active');
      btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="red"><path d="M12 21s-6.7-4.4-10-9c-3.3-4.6.2-11 6-9 2 .6 4 2.4 4 2.4s2-1.8 4-2.4c5.8-2 9.3 4.4 6 9-3.3 4.6-10 9-10 9z"/></svg>';
      showToast('Added to wishlist', 'success');
    } else {
      btn.classList.remove('active');
      btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 21s-6.7-4.4-10-9c-3.3-4.6.2-11 6-9 2 .6 4 2.4 4 2.4s2-1.8 4-2.4c5.8-2 9.3 4.4 6 9-3.3 4.6-10 9-10 9z"/></svg>';
      showToast('Removed from wishlist', '');
    }
  })
  .catch(() => showToast('Login required to use wishlist', 'error'));
}

// ── Toast ──────────────────────────────────────────────────
let toastTimer;
function showToast(message, type) {
  const toast = document.getElementById('sgToast');
  toast.textContent = message;
  toast.className = 'sg-toast show' + (type ? ' ' + type : '');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { toast.classList.remove('show'); }, 3200);
}

// ── Keyboard: close on Escape ──────────────────────────────
document.addEventListener('keydown', e => { if (e.key === 'Escape') {} });

// ── Init ───────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', () => {
  const firstSwatch = document.querySelector('.sg-color-swatch');
  if (firstSwatch) {
    selectedVariantId = firstSwatch.dataset.variantId || '';
    document.getElementById('selectedVariantId').value = selectedVariantId;
  }
});
</script>

{% endblock %}