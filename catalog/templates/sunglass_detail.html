{% extends 'base.html' %}
{% load static %}
{% block title %}{{ product.name }} ‚Äì Al Ameen Optics{% endblock %}

{% block extra_styles %}
{% load static %}
<style>
  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AA PRODUCT GALLERY ‚Äî Universal, Amazon/Flipkart grade
   Include this in base.html or per product detail page
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚îÄ‚îÄ Gallery Layout ‚îÄ‚îÄ */
.aa-gal {
  display: grid;
  grid-template-columns: 86px 1fr;
  gap: 14px;
  position: sticky;
  top: 88px;
  align-self: start;
}
@media (max-width: 900px) { .aa-gal { position: static; } }
@media (max-width: 540px) {
  .aa-gal {
    grid-template-columns: 1fr;
    grid-template-rows: 1fr auto;
  }
}

/* ‚îÄ‚îÄ Rail ‚îÄ‚îÄ */
.aa-gal__rail {
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: 520px;
  overflow-y: auto;
  overflow-x: hidden;
  scrollbar-width: thin;
  scrollbar-color: #d4b896 transparent;
  padding: 2px;
}
.aa-gal__rail::-webkit-scrollbar { width: 3px; }
.aa-gal__rail::-webkit-scrollbar-thumb { background: #d4b896; border-radius: 99px; }
@media (max-width: 540px) {
  .aa-gal__rail {
    order: 2;
    flex-direction: row;
    max-height: none;
    max-width: 100%;
    overflow-y: hidden;
    overflow-x: auto;
    scrollbar-width: thin;
  }
}

/* ‚îÄ‚îÄ Thumb ‚îÄ‚îÄ */
.aa-gal__thumb {
  flex-shrink: 0;
  width: 82px;
  height: 82px;
  border-radius: 10px;
  overflow: hidden;
  border: 2px solid #e8e2d8;
  background: #f7f3ed;
  cursor: pointer;
  position: relative;
  transition: border-color 0.22s, box-shadow 0.22s, transform 0.22s;
  outline: none;
  padding: 0;
}
@media (max-width: 540px) { .aa-gal__thumb { width: 70px; height: 70px; } }
.aa-gal__thumb img {
  width: 100%; height: 100%;
  object-fit: contain;
  padding: 5px;
  transition: transform 0.3s ease;
  display: block;
  pointer-events: none;
}
.aa-gal__thumb:hover {
  border-color: #b8976a;
  box-shadow: 0 0 0 1px #b8976a;
  transform: translateX(3px);
}
@media (max-width: 540px) { .aa-gal__thumb:hover { transform: translateY(-2px); } }
.aa-gal__thumb:hover img { transform: scale(1.06); }
.aa-gal__thumb.is-active {
  border-color: #0d0d0d;
  box-shadow: 0 0 0 1px #0d0d0d;
}
.aa-gal__thumb.is-active::after {
  content: '';
  position: absolute;
  inset: 0;
  background: rgba(13,13,13,0.04);
  border-radius: 8px;
  pointer-events: none;
}
.aa-gal__thumb-label {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  background: rgba(13,13,13,0.72);
  color: #fff;
  font-size: 9px;
  font-weight: 700;
  text-align: center;
  padding: 3px 4px;
  letter-spacing: 0.03em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  opacity: 0;
  transition: opacity 0.2s;
}
.aa-gal__thumb:hover .aa-gal__thumb-label,
.aa-gal__thumb.is-active .aa-gal__thumb-label { opacity: 1; }

/* ‚îÄ‚îÄ Stage wrap ‚îÄ‚îÄ */
.aa-gal__stage-wrap {
  position: relative;
  display: flex;
  align-items: flex-start;
}

/* ‚îÄ‚îÄ Stage ‚îÄ‚îÄ */
.aa-gal__stage {
  position: relative;
  width: 100%;
  aspect-ratio: 1 / 1;
  border-radius: 16px;
  overflow: hidden;
  background: #f7f3ed;
  background-image:
    radial-gradient(ellipse at 20% 20%, rgba(255,255,255,0.7) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 80%, rgba(184,151,106,0.07) 0%, transparent 50%);
  cursor: crosshair;
  outline: none;
  user-select: none;
  -webkit-user-select: none;
}

/* ‚îÄ‚îÄ Image frame & main image ‚îÄ‚îÄ */
.aa-gal__img-frame {
  width: 100%; height: 100%;
  position: relative;
  overflow: hidden;
}
.aa-gal__main {
  width: 100%; height: 100%;
  object-fit: contain;
  padding: 28px;
  display: block;
  transition: opacity 0.18s ease, transform 0.18s ease;
  will-change: transform;
  pointer-events: none;
  -webkit-user-drag: none;
}
.aa-gal__main.is-loading {
  opacity: 0;
  transform: scale(0.97);
}

/* ‚îÄ‚îÄ Placeholder ‚îÄ‚îÄ */
.aa-gal__placeholder {
  width: 100%; height: 100%;
  display: flex; align-items: center; justify-content: center;
}
.aa-gal__placeholder svg { width: 40%; height: 40%; opacity: 0.4; }

/* ‚îÄ‚îÄ Zoom lens ‚îÄ‚îÄ */
.aa-gal__zoom-lens {
  position: absolute;
  border: 2px solid rgba(184,151,106,0.6);
  background: rgba(255,255,255,0.25);
  backdrop-filter: blur(1px);
  border-radius: 4px;
  display: none;
  pointer-events: none;
  z-index: 10;
}
.aa-gal__stage.is-zooming .aa-gal__zoom-lens { display: block; }

/* ‚îÄ‚îÄ Zoom pane ‚îÄ‚îÄ */
.aa-gal__zoom-pane {
  position: absolute;
  left: calc(100% + 16px);
  top: 0;
  width: 440px;
  height: 440px;
  border-radius: 14px;
  overflow: hidden;
  background: #f7f3ed;
  border: 1px solid #e8e2d8;
  box-shadow: 0 8px 40px rgba(0,0,0,0.14);
  display: none;
  z-index: 100;
  pointer-events: none;
}
.aa-gal__zoom-pane img {
  position: absolute;
  display: block;
  pointer-events: none;
  -webkit-user-drag: none;
}
.aa-gal__stage.is-zooming ~ .aa-gal__zoom-pane,
.aa-gal__stage-wrap:hover .aa-gal__zoom-pane { display: block; }
/* Hide pane on small screens */
@media (max-width: 1280px) {
  .aa-gal__zoom-pane { display: none !important; }
  .aa-gal__stage { cursor: zoom-in; }
  .aa-gal__stage.is-tap-zoomed { cursor: zoom-out; }
}

/* ‚îÄ‚îÄ Tap zoom (mobile fallback) ‚îÄ‚îÄ */
.aa-gal__stage.is-tap-zoomed .aa-gal__main {
  padding: 0;
  object-fit: cover;
  transition: none;
}

/* ‚îÄ‚îÄ Arrows ‚îÄ‚îÄ */
.aa-gal__arrow {
  position: absolute;
  top: 50%; transform: translateY(-50%);
  width: 40px; height: 40px; border-radius: 50%;
  background: rgba(255,255,255,0.92);
  backdrop-filter: blur(6px);
  border: 1px solid rgba(0,0,0,0.08);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; z-index: 20;
  box-shadow: 0 2px 12px rgba(0,0,0,0.12);
  transition: all 0.2s ease;
  opacity: 0; pointer-events: none;
  color: #1a1a1a;
}
.aa-gal__stage:hover .aa-gal__arrow,
.aa-gal__stage:focus-within .aa-gal__arrow { opacity: 1; pointer-events: auto; }
.aa-gal__arrow:hover { background: #fff; box-shadow: 0 4px 20px rgba(0,0,0,0.18); }
.aa-gal__arrow--prev { left: 12px; }
.aa-gal__arrow--prev:hover { transform: translateY(-50%) translateX(-2px); }
.aa-gal__arrow--next { right: 12px; }
.aa-gal__arrow--next:hover { transform: translateY(-50%) translateX(2px); }
.aa-gal__arrow.is-hidden { display: none !important; }

/* ‚îÄ‚îÄ Counter ‚îÄ‚îÄ */
.aa-gal__counter {
  position: absolute; bottom: 14px; left: 50%;
  transform: translateX(-50%);
  background: rgba(10,10,10,0.45);
  backdrop-filter: blur(6px);
  color: #fff; font-size: 11px; font-weight: 700;
  letter-spacing: 0.1em; padding: 4px 12px;
  border-radius: 99px; pointer-events: none;
  transition: opacity 0.2s;
  white-space: nowrap;
}
.aa-gal__counter.is-single { display: none; }

/* ‚îÄ‚îÄ Fullscreen button ‚îÄ‚îÄ */
.aa-gal__fullscreen {
  position: absolute; bottom: 14px; right: 14px;
  width: 36px; height: 36px; border-radius: 8px;
  background: rgba(255,255,255,0.88);
  backdrop-filter: blur(6px);
  border: 1px solid rgba(0,0,0,0.07);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; z-index: 20;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  opacity: 0; pointer-events: none;
  transition: all 0.2s;
  color: #333;
}
.aa-gal__stage:hover .aa-gal__fullscreen { opacity: 1; pointer-events: auto; }
.aa-gal__fullscreen:hover { background: #fff; transform: scale(1.08); }

/* ‚îÄ‚îÄ Zoom hint ‚îÄ‚îÄ */
.aa-gal__zoom-hint {
  position: absolute; bottom: 14px; left: 14px;
  display: flex; align-items: center; gap: 5px;
  background: rgba(255,255,255,0.88);
  backdrop-filter: blur(6px);
  border: 1px solid rgba(0,0,0,0.07);
  color: #555; font-size: 11px; font-weight: 600;
  padding: 5px 10px; border-radius: 6px;
  box-shadow: 0 1px 6px rgba(0,0,0,0.08);
  opacity: 0; pointer-events: none;
  transition: opacity 0.3s 0.8s;
}
.aa-gal__stage:hover .aa-gal__zoom-hint { opacity: 1; }
@media (max-width: 1280px) { .aa-gal__zoom-hint { display: none; } }

/* ‚îÄ‚îÄ Lightbox ‚îÄ‚îÄ */
.aa-gal__lb {
  display: none;
  position: fixed; inset: 0; z-index: 99999;
  background: rgba(6,6,6,0.96);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  flex-direction: column;
  align-items: center; justify-content: center;
  gap: 20px;
}
.aa-gal__lb.is-open { display: flex; }
.aa-gal__lb-close {
  position: fixed; top: 20px; right: 24px;
  width: 46px; height: 46px; border-radius: 50%;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  color: #fff; display: flex; align-items: center; justify-content: center;
  cursor: pointer; transition: background 0.2s; z-index: 2;
}
.aa-gal__lb-close:hover { background: rgba(255,255,255,0.2); }
.aa-gal__lb-main {
  display: flex; flex-direction: column; align-items: center; gap: 18px;
  max-width: 90vw;
}
.aa-gal__lb-img {
  max-width: 88vw; max-height: 75vh;
  object-fit: contain; border-radius: 12px;
  animation: aaLbIn 0.28s ease;
}
@keyframes aaLbIn { from { opacity:0; transform:scale(0.94); } to { opacity:1; transform:scale(1); } }
.aa-gal__lb-nav {
  position: fixed; top: 50%; transform: translateY(-50%);
  width: 52px; height: 52px; border-radius: 50%;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.18);
  color: #fff; display: flex; align-items: center; justify-content: center;
  cursor: pointer; transition: background 0.2s, transform 0.2s; z-index: 2;
}
.aa-gal__lb-nav:hover { background: rgba(255,255,255,0.22); }
.aa-gal__lb-nav--prev { left: 20px; }
.aa-gal__lb-nav--prev:hover { transform: translateY(-50%) translateX(-2px); }
.aa-gal__lb-nav--next { right: 20px; }
.aa-gal__lb-nav--next:hover { transform: translateY(-50%) translateX(2px); }
.aa-gal__lb-strip {
  display: flex; gap: 10px; overflow-x: auto; max-width: 90vw;
  padding: 4px 2px;
  scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.3) transparent;
}
.aa-gal__lb-dot {
  flex-shrink: 0; width: 62px; height: 62px;
  border-radius: 8px; overflow: hidden;
  border: 2.5px solid rgba(255,255,255,0.15);
  cursor: pointer;
  transition: border-color 0.2s, transform 0.2s;
}
.aa-gal__lb-dot img { width:100%; height:100%; object-fit:contain; padding:3px; }
.aa-gal__lb-dot.is-active { border-color: #d4b896; transform: scale(1.1); }
.aa-gal__lb-count {
  position: fixed; top: 26px; left: 50%; transform: translateX(-50%);
  color: rgba(255,255,255,0.5); font-size: 13px; font-weight: 600;
  letter-spacing: 0.1em; pointer-events: none;
}
</style>
<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DESIGN TOKENS ‚Äî Matches home page palette
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
:root {
  --aa-ink:      #0d0d0d;
  --aa-ink-soft: #555;
  --aa-gold:     #b8976a;
  --aa-gold-lt:  #d4b896;
  --aa-sand:     #f7f3ed;
  --aa-muted:    #8a8580;
  --aa-border:   #e8e2d8;
  --aa-green:    #2a7a2a;
  --aa-green-bg: #f0f7ee;
  --aa-radius:   12px;
  --aa-shadow:   0 4px 24px rgba(0,0,0,.08);
  --aa-ease:     cubic-bezier(.4,0,.2,1);
  --aa-t:        .26s;
}

/* ‚îÄ‚îÄ‚îÄ PAGE WRAP ‚îÄ‚îÄ‚îÄ */
.pd-page { max-width: 1340px; margin: 0 auto; padding: 0 24px 100px; }

/* ‚îÄ‚îÄ‚îÄ BREADCRUMB ‚îÄ‚îÄ‚îÄ */
.pd-crumb {
  display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
  padding: 16px 0 28px; font-size: 12px; font-weight: 600;
  letter-spacing: .06em; text-transform: uppercase; color: var(--aa-muted);
}
.pd-crumb a { color: var(--aa-muted); text-decoration: none; transition: color var(--aa-t); }
.pd-crumb a:hover { color: var(--aa-ink); }
.pd-crumb-sep { font-size: 10px; color: #ccc; }
.pd-crumb span:last-child { color: var(--aa-ink); }

/* ‚îÄ‚îÄ‚îÄ GRID ‚îÄ‚îÄ‚îÄ */
.pd-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 60px;
  align-items: start;
}
@media (max-width: 960px) { .pd-grid { grid-template-columns: 1fr; gap: 32px; } }

/* ‚îÄ‚îÄ‚îÄ PRODUCT INFO ‚îÄ‚îÄ‚îÄ */
.pi { display: flex; flex-direction: column; }

.pi__badges { display: flex; gap: 7px; flex-wrap: wrap; margin-bottom: 14px; }
.pi__badge {
  font-size: 10px; font-weight: 800; letter-spacing: .1em; text-transform: uppercase;
  padding: 4px 10px; border-radius: 4px;
}
.pi__badge--brand  { background: var(--aa-sand); color: var(--aa-gold); }
.pi__badge--sale   { background: var(--aa-green-bg); color: var(--aa-green); }
.pi__badge--gender { background: #f0f0ff; color: #5558a8; }

.pi__title {
  font-size: clamp(22px, 2.6vw, 32px);
  font-weight: 800; line-height: 1.15;
  color: var(--aa-ink); letter-spacing: -.03em;
  margin: 0 0 10px;
}
.pi__meta { display: flex; align-items: center; gap: 14px; margin-bottom: 6px; flex-wrap: wrap; }
.pi__brand { font-size: 13px; color: var(--aa-muted); }
.pi__brand strong { color: var(--aa-ink); }
.pi__sku { font-size: 11px; color: #c5c0b8; letter-spacing: .06em; }

.pi__wish {
  margin-left: auto; flex-shrink: 0;
  width: 44px; height: 44px; border-radius: 50%;
  background: var(--aa-sand); border: 2px solid var(--aa-border);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; transition: all var(--aa-t);
}
.pi__wish:hover, .pi__wish.is-on { border-color: #e05f5f; background: #fff5f5; }
.pi__wish svg { width: 18px; height: 18px; transition: fill var(--aa-t), stroke var(--aa-t); }

/* ‚îÄ‚îÄ‚îÄ PRICE ‚îÄ‚îÄ‚îÄ */
.pi__price-box {
  display: flex; align-items: baseline; gap: 12px; flex-wrap: wrap;
  padding: 18px 22px; border-radius: var(--aa-radius);
  background: var(--aa-sand); border: 1px solid rgba(184,151,106,.18);
  margin: 20px 0 22px;
}
.pi__price { font-size: 34px; font-weight: 900; color: var(--aa-ink); letter-spacing: -.04em; }
.pi__price-was { font-size: 17px; color: var(--aa-muted); text-decoration: line-through; }
.pi__price-save {
  font-size: 12px; font-weight: 800; background: var(--aa-green); color: #fff;
  padding: 3px 9px; border-radius: 4px; letter-spacing: .04em;
}

.pi__desc { font-size: 14px; line-height: 1.78; color: var(--aa-ink-soft); margin-bottom: 22px; }

/* ‚îÄ‚îÄ‚îÄ LABEL ‚îÄ‚îÄ‚îÄ */
.pi__lbl {
  font-size: 11px; font-weight: 700; letter-spacing: .12em; text-transform: uppercase;
  color: var(--aa-muted); margin-bottom: 10px;
}

/* ‚îÄ‚îÄ‚îÄ SWATCHES ‚îÄ‚îÄ‚îÄ */
.pi__swatches { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 24px; }
.pi__swatch {
  display: flex; flex-direction: column; align-items: center; gap: 5px;
  cursor: pointer; outline: none;
}
.pi__swatch-dot {
  width: 36px; height: 36px; border-radius: 50%;
  border: 3px solid transparent;
  box-shadow: 0 0 0 1.5px var(--aa-border);
  transition: all var(--aa-t);
}
.pi__swatch:hover .pi__swatch-dot,
.pi__swatch.is-on .pi__swatch-dot {
  box-shadow: 0 0 0 2.5px var(--aa-gold);
  transform: scale(1.1);
}
.pi__swatch-name { font-size: 10px; color: var(--aa-muted); font-weight: 500; }

/* ‚îÄ‚îÄ‚îÄ SELECT ‚îÄ‚îÄ‚îÄ */
.pi__select {
  width: 100%; padding: 13px 16px; margin-bottom: 22px;
  border: 2px solid var(--aa-border); border-radius: var(--aa-radius);
  font-size: 14px; font-weight: 600; color: var(--aa-ink);
  background: #fff; cursor: pointer; appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%238a8580' stroke-width='1.6' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 16px center;
  transition: border-color var(--aa-t);
}
.pi__select:focus { border-color: var(--aa-gold); outline: none; }

/* ‚îÄ‚îÄ‚îÄ POWER TOGGLE ‚îÄ‚îÄ‚îÄ */
.pi__power-wrap { margin-bottom: 22px; }
.pi__power-toggle {
  display: flex; background: var(--aa-sand); border-radius: var(--aa-radius);
  padding: 4px; border: 1px solid rgba(184,151,106,.2); gap: 4px;
}
.pi__power-btn {
  flex: 1; padding: 12px 8px; border: none; background: transparent;
  border-radius: 8px; font-size: 13px; font-weight: 600;
  cursor: pointer; color: var(--aa-muted); transition: all var(--aa-t);
}
.pi__power-btn.is-on { background: var(--aa-ink); color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,.18); }

/* ‚îÄ‚îÄ‚îÄ LENS OK ‚îÄ‚îÄ‚îÄ */
.pi__lens-ok {
  display: none; align-items: center; gap: 8px;
  background: var(--aa-green-bg); border: 1px solid #3a8a2e;
  color: #2a6a20; border-radius: 8px;
  padding: 10px 14px; font-size: 13px; font-weight: 600; margin-bottom: 14px;
}
.pi__lens-ok.is-show { display: flex; }
.pi__lens-ok button {
  margin-left: auto; background: none; border: none;
  color: #2a6a20; font-size: 12px; font-weight: 700; cursor: pointer;
  text-decoration: underline; text-underline-offset: 2px;
}

/* ‚îÄ‚îÄ‚îÄ QUANTITY ‚îÄ‚îÄ‚îÄ */
.pi__qty-wrap { margin-bottom: 22px; }
.pi__qty {
  display: inline-flex; align-items: center;
  border: 2px solid var(--aa-border); border-radius: var(--aa-radius); overflow: hidden;
}
.pi__qty-btn {
  width: 46px; height: 46px; border: none; background: var(--aa-sand);
  font-size: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center;
  color: var(--aa-ink); transition: background var(--aa-t); line-height: 1;
}
.pi__qty-btn:hover { background: var(--aa-border); }
.pi__qty-num {
  width: 56px; height: 46px; border: none;
  border-left: 2px solid var(--aa-border); border-right: 2px solid var(--aa-border);
  text-align: center; font-size: 16px; font-weight: 700; color: var(--aa-ink);
  background: #fff;
}
.pi__qty-num:focus { outline: none; }

/* ‚îÄ‚îÄ‚îÄ CTA BUTTONS ‚îÄ‚îÄ‚îÄ */
.pi__cta { display: flex; flex-direction: column; gap: 12px; margin-bottom: 26px; }
.pi__btn {
  width: 100%; padding: 17px 24px; border-radius: 50px;
  font-size: 14px; font-weight: 800; letter-spacing: .06em; text-transform: uppercase;
  cursor: pointer; transition: all var(--aa-t); border: 2px solid transparent;
  position: relative; overflow: hidden;
}
.pi__btn--lens {
  background: #fff; border-color: var(--aa-gold); color: var(--aa-gold);
  display: none;
}
.pi__btn--lens.is-show { display: block; }
.pi__btn--lens:hover { background: var(--aa-gold); color: #fff; }
.pi__btn--cart {
  background: var(--aa-ink); border-color: var(--aa-ink); color: #fff;
}
.pi__btn--cart:hover { background: #2a2a2a; }
.pi__btn--cart:active { transform: scale(.98); }
.pi__btn--buy {
  background: var(--aa-gold); border-color: var(--aa-gold); color: #fff;
}
.pi__btn--buy:hover { background: #a07050; border-color: #a07050; }
.pi__btn--buy:active { transform: scale(.98); }

/* ‚îÄ‚îÄ‚îÄ TRUST BAR ‚îÄ‚îÄ‚îÄ */
.pi__trust {
  background: var(--aa-sand); border-radius: var(--aa-radius);
  padding: 16px 20px; display: flex; flex-direction: column; gap: 12px;
  border: 1px solid rgba(184,151,106,.18); margin-bottom: 24px;
}
.pi__trust-row { display: flex; align-items: center; gap: 12px; font-size: 13px; color: var(--aa-ink); }
.pi__trust-icon {
  width: 34px; height: 34px; border-radius: 50%; background: #fff;
  display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  box-shadow: 0 1px 6px rgba(0,0,0,.07);
}
.pi__trust-icon svg { width: 15px; height: 15px; color: var(--aa-gold); }

/* ‚îÄ‚îÄ‚îÄ SPECS ‚îÄ‚îÄ‚îÄ */
.pi__specs-table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 8px; }
.pi__specs-table tr { border-bottom: 1px solid var(--aa-border); }
.pi__specs-table td { padding: 10px 0; vertical-align: top; }
.pi__specs-table td:first-child { font-weight: 600; color: var(--aa-ink); width: 44%; }
.pi__specs-table td:last-child { color: var(--aa-muted); }

/* ‚îÄ‚îÄ‚îÄ BELOW FOLD ‚îÄ‚îÄ‚îÄ */
.pd-section { padding: 52px 0; border-top: 1px solid var(--aa-border); }
.pd-section__h { font-size: 22px; font-weight: 800; color: var(--aa-ink); margin-bottom: 18px; letter-spacing: -.02em; }
.pd-section__body { font-size: 15px; line-height: 1.85; color: var(--aa-ink-soft); }

/* ‚îÄ‚îÄ‚îÄ RELATED GRID ‚îÄ‚îÄ‚îÄ */
.pd-rel-grid {
  display: grid; grid-template-columns: repeat(4,1fr); gap: 18px; margin-top: 24px;
}
@media (max-width:860px) { .pd-rel-grid { grid-template-columns: repeat(2,1fr); } }
.pd-rel-card {
  text-decoration: none; color: inherit; display: block;
  border-radius: var(--aa-radius); overflow: hidden;
  border: 1px solid var(--aa-border); background: #fff;
  transition: all var(--aa-t);
}
.pd-rel-card:hover { transform: translateY(-4px); box-shadow: var(--aa-shadow); border-color: var(--aa-gold-lt); }
.pd-rel-card__img { aspect-ratio: 1/1; background: var(--aa-sand); overflow: hidden; }
.pd-rel-card__img img { width:100%; height:100%; object-fit:contain; padding:10px; transition: transform .4s; display:block; }
.pd-rel-card:hover .pd-rel-card__img img { transform: scale(1.06); }
.pd-rel-card__info { padding: 14px; }
.pd-rel-card__brand { font-size: 10px; color: var(--aa-gold); font-weight: 700; text-transform: uppercase; letter-spacing: .08em; }
.pd-rel-card__name { font-size: 14px; font-weight: 700; margin: 4px 0; color: var(--aa-ink); line-height: 1.3; }
.pd-rel-card__price { font-size: 15px; font-weight: 800; color: var(--aa-ink); }

/* ‚îÄ‚îÄ‚îÄ LENS MODAL ‚îÄ‚îÄ‚îÄ */
.lm { display: none; position: fixed; inset: 0; z-index: 8888;
  background: rgba(13,13,13,.55); backdrop-filter: blur(5px);
  align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
.lm.is-open { display: flex; }
.lm__box {
  background: #fff; width: 100%; max-width: 640px;
  border-radius: 20px; overflow: hidden;
  box-shadow: 0 24px 80px rgba(0,0,0,.2);
  animation: lmIn .3s var(--aa-ease); margin: auto;
}
@keyframes lmIn { from { opacity:0; transform:translateY(22px) scale(.97); } to { opacity:1; transform:none; } }
.lm__head {
  padding: 22px 28px 18px; border-bottom: 1px solid var(--aa-border);
  display: flex; align-items: center; justify-content: space-between;
}
.lm__head h3 { margin: 0; font-size: 18px; font-weight: 800; }
.lm__close { background: none; border: none; font-size: 26px; cursor: pointer; color: var(--aa-muted); padding: 0; line-height: 1; }
.lm__close:hover { color: var(--aa-ink); }
.lm__body { padding: 22px 28px; max-height: 68vh; overflow-y: auto; }
.lm__step { font-size: 11px; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--aa-muted); margin-bottom: 12px; }
.lm__colors { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 26px; }
.lm__color-chip {
  display: flex; flex-direction: column; align-items: center; gap: 6px;
  padding: 10px 14px; border: 2px solid var(--aa-border); border-radius: var(--aa-radius);
  cursor: pointer; transition: all var(--aa-t); min-width: 72px; text-align: center;
}
.lm__color-chip:hover, .lm__color-chip.is-on { border-color: var(--aa-ink); background: var(--aa-sand); }
.lm__color-dot { width: 30px; height: 30px; border-radius: 50%; border: 2px solid rgba(0,0,0,.07); }
.lm__color-name { font-size: 12px; font-weight: 600; color: var(--aa-ink); }
.lm__opt {
  border: 2px solid var(--aa-border); border-radius: var(--aa-radius);
  padding: 16px 20px; margin-bottom: 10px; cursor: pointer;
  display: flex; align-items: center; justify-content: space-between; gap: 14px;
  transition: all var(--aa-t);
}
.lm__opt:hover { border-color: #aaa; box-shadow: var(--aa-shadow); }
.lm__opt.is-on { border-color: var(--aa-ink); background: var(--aa-sand); }
.lm__opt-left { display: flex; align-items: center; gap: 12px; }
.lm__radio {
  width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--aa-border);
  flex-shrink: 0; display: flex; align-items: center; justify-content: center;
  transition: all var(--aa-t);
}
.lm__opt.is-on .lm__radio { border-color: var(--aa-ink); background: var(--aa-ink); }
.lm__radio::after { content:''; width:8px; height:8px; border-radius:50%; background:#fff; display:none; }
.lm__opt.is-on .lm__radio::after { display:block; }
.lm__opt-name { font-size: 14px; font-weight: 700; }
.lm__opt-desc { font-size: 12px; color: var(--aa-muted); margin-top: 2px; }
.lm__opt-price { font-size: 17px; font-weight: 800; white-space: nowrap; }
.lm__rx { background: var(--aa-sand); border-radius: var(--aa-radius); padding: 18px; margin: 18px 0 0; }
.lm__rx-table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; }
.lm__rx-table th { background: var(--aa-ink); color: #fff; padding: 9px 12px; font-size: 13px; font-weight: 600; text-align: left; }
.lm__rx-table td { padding: 9px 12px; border-bottom: 1px solid var(--aa-border); }
.lm__rx-table tr:last-child td { border-bottom: none; }
.lm__rx-table td:first-child { font-weight: 600; font-size: 13px; white-space: nowrap; }
.lm__rx-input {
  width: 100%; padding: 7px 10px; border: 1.5px solid var(--aa-border); border-radius: 6px;
  font-size: 13px; min-width: 65px; transition: border-color var(--aa-t);
}
.lm__rx-input:focus { border-color: var(--aa-gold); outline: none; }
.lm__foot {
  padding: 18px 28px 24px; border-top: 1px solid var(--aa-border);
  background: #fff; position: sticky; bottom: 0;
}
.lm__total { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.lm__total-lbl { font-size: 14px; font-weight: 600; }
.lm__total-val { font-size: 24px; font-weight: 900; letter-spacing: -.03em; }
.lm__confirm {
  width: 100%; padding: 15px; background: var(--aa-ink); color: #fff;
  border: none; border-radius: 50px; font-size: 15px; font-weight: 800;
  cursor: pointer; transition: background var(--aa-t); letter-spacing: .04em;
}
.lm__confirm:hover { background: #2a2a2a; }

/* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
.pd-toast {
  position: fixed; bottom: 28px; right: 28px; z-index: 99999;
  padding: 14px 22px; border-radius: var(--aa-radius);
  font-size: 14px; font-weight: 700; color: #fff;
  box-shadow: 0 8px 32px rgba(0,0,0,.2); pointer-events: none;
  transform: translateY(70px); opacity: 0;
  transition: all .32s var(--aa-ease); max-width: 320px;
  background: var(--aa-ink);
}
.pd-toast.is-show { transform: translateY(0); opacity: 1; }
.pd-toast--ok  { background: var(--aa-green) !important; }
.pd-toast--err { background: #c03020 !important; }
</style>
{% endblock %}

{% block content %}
<div class="pd-page">

  <!-- Breadcrumb -->
  <nav class="pd-crumb">
    <a href="{% url 'home' %}">Home</a>
    <span class="pd-crumb-sep">‚Ä∫</span>
    <a href="{% url 'catalog:sunglasses_list' %}">Sunglasses</a>
    <span class="pd-crumb-sep">‚Ä∫</span>
    <span>{{ product.name }}</span>
  </nav>

  <!-- Main Grid -->
  <div class="pd-grid">

    <!-- ‚ïê‚ïê GALLERY ‚ïê‚ïê -->
    <div>
      {% include 'partials/_product_gallery.html' with main_image=product.image images=images variants=variants product=product %}
    </div>

    <!-- ‚ïê‚ïê PRODUCT INFO ‚ïê‚ïê -->
    <div class="pi">

      <!-- Badges + wishlist -->
      <div style="display:flex;align-items:flex-start;gap:10px;margin-bottom:12px;">
        <div class="pi__badges">
          {% if product.brand %}<span class="pi__badge pi__badge--brand">{{ product.brand.name }}</span>{% endif %}
          {% if product.compare_at_price %}<span class="pi__badge pi__badge--sale">Sale</span>{% endif %}
          {% if product.gender != 'unisex' %}<span class="pi__badge pi__badge--gender">{{ product.gender|capfirst }}</span>{% endif %}
        </div>
        <button class="pi__wish{% if product in request.user.wishlist.products.all %} is-on{% endif %}"
                id="piWishBtn" data-product-id="{{ product.id }}" aria-label="Wishlist">
          <svg viewBox="0 0 24 24"
               fill="{% if product in request.user.wishlist.products.all %}#e05f5f{% else %}none{% endif %}"
               stroke="{% if product in request.user.wishlist.products.all %}#e05f5f{% else %}currentColor{% endif %}"
               stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
        </button>
      </div>

      <h1 class="pi__title">{{ product.name }}</h1>
      <div class="pi__meta">
        {% if product.brand %}<span class="pi__brand">Brand: <strong>{{ product.brand.name }}</strong></span>{% endif %}
        {% if product.sku %}<span class="pi__sku">SKU: {{ product.sku }}</span>{% endif %}
      </div>

      <!-- Price -->
      <div class="pi__price-box">
        <span class="pi__price" id="dispPrice">QAR {{ product.base_price }}</span>
        {% if product.compare_at_price %}
        <span class="pi__price-was">QAR {{ product.compare_at_price }}</span>
        <span class="pi__price-save">Save QAR {{ product.compare_at_price|floatformat:0 }}</span>
        {% endif %}
      </div>

      {% if product.short_description %}
      <p class="pi__desc">{{ product.short_description }}</p>
      {% endif %}

      <form id="pdForm" onsubmit="return false;">
        {% csrf_token %}
        <input type="hidden" name="product_id" value="{{ product.id }}">
        <input type="hidden" name="selected_variant_id" id="hdVariant" value="">
        <input type="hidden" name="power_type" id="hdPower" value="without">
        <input type="hidden" name="selected_lens_color" id="hdLensColor" value="">
        <input type="hidden" name="selected_lens_option" id="hdLensOpt" value="">
        <input type="hidden" name="total_lens_price" id="hdLensPrice" value="0">

        <!-- Frame Color -->
        {% if variants %}
        <p class="pi__lbl">Frame Color</p>
        <div class="pi__swatches">
          {% for v in variants %}
          <div class="pi__swatch{% if forloop.first %} is-on{% endif %}"
               data-variant="{{ v.id }}"
               data-img="{% if v.images.exists %}{{ v.images.first.image.url }}{% endif %}"
               onclick="pickVariant(this)" tabindex="0" role="button" aria-label="{{ v.color_name }}">
            <div class="pi__swatch-dot" style="background:{% if v.color_code %}{{ v.color_code }}{% else %}linear-gradient(135deg,#ccc,#999){% endif %};"></div>
            <span class="pi__swatch-name">{{ v.color_name }}</span>
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Size -->
        {% if variants.0.size %}
        <p class="pi__lbl">Frame Size</p>
        <select class="pi__select" name="selected_size">
          <option value="">Select size</option>
          {% for v in variants %}{% if v.size %}<option value="{{ v.size }}">{{ v.size }}</option>{% endif %}{% endfor %}
        </select>
        {% endif %}

        <!-- Prescription -->
        <div class="pi__power-wrap">
          <p class="pi__lbl">Prescription Lenses</p>
          <div class="pi__power-toggle">
            <button type="button" class="pi__power-btn is-on" onclick="setPower('without',this)">Without Power</button>
            <button type="button" class="pi__power-btn" onclick="setPower('with',this)">+ Add Prescription</button>
          </div>
        </div>

        <button type="button" class="pi__btn pi__btn--lens" id="lensBtn" onclick="openLm()">üîç Select Prescription Lenses</button>

        <div class="pi__lens-ok" id="lensOk">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
          <span id="lensOkTxt">Lens selected</span>
          <button type="button" onclick="openLm()">Change</button>
        </div>

        <!-- Qty -->
        <p class="pi__lbl">Quantity</p>
        <div class="pi__qty-wrap">
          <div class="pi__qty">
            <button type="button" class="pi__qty-btn" onclick="chQty(-1)">‚àí</button>
            <input class="pi__qty-num" type="number" id="qtyVal" name="quantity" value="1" min="1" max="{{ product.stock_quantity|default:99 }}" readonly>
            <button type="button" class="pi__qty-btn" onclick="chQty(1)">+</button>
          </div>
        </div>

        <!-- CTAs -->
        <div class="pi__cta">
          <button type="button" class="pi__btn pi__btn--cart" id="cartBtn" onclick="addCart()">
            <svg style="width:16px;height:16px;vertical-align:middle;margin-right:6px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg>Add to Cart
          </button>
          <button type="button" class="pi__btn pi__btn--buy" onclick="buyNow()">Buy it Now ‚Üí</button>
        </div>
      </form>

      <!-- Trust bar -->
      <div class="pi__trust">
        <div class="pi__trust-row">
          <div class="pi__trust-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13" rx="1"/><path d="M16 8h4l3 5v3h-7V8z"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg></div>
          <span>Delivery in <strong>3‚Äì6 business days</strong> ¬∑ Qatar / GCC</span>
        </div>
        <div class="pi__trust-row">
          <div class="pi__trust-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></div>
          <span>Free returns within <strong>45 days</strong> of purchase</span>
        </div>
        <div class="pi__trust-row">
          <div class="pi__trust-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M9 12l2 2 4-4"/></svg></div>
          <span><strong>100% Authentic</strong> ‚Äî genuine products guaranteed</span>
        </div>
      </div>

      <!-- Specs -->
      {% if specifications %}
      <p class="pi__lbl">Specifications</p>
      <table class="pi__specs-table">
        {% for s in specifications %}
        <tr><td>{{ s.spec_key }}</td><td>{{ s.spec_value }}</td></tr>
        {% endfor %}
      </table>
      {% endif %}

    </div><!-- /pi -->
  </div><!-- /pd-grid -->

  <!-- Description -->
  {% if product.description %}
  <div class="pd-section">
    <h2 class="pd-section__h">About This Product</h2>
    <div class="pd-section__body">{{ product.description|linebreaksbr }}</div>
  </div>
  {% endif %}

  <!-- Related -->
  {% if related_products %}
  <div class="pd-section">
    <h2 class="pd-section__h">You May Also Like</h2>
    <div class="pd-rel-grid">
      {% for r in related_products %}
      <a href="{% url 'catalog:sunglass_detail' r.slug %}" class="pd-rel-card">
        <div class="pd-rel-card__img">{% if r.image %}<img src="{{ r.image.url }}" alt="{{ r.name }}" loading="lazy">{% endif %}</div>
        <div class="pd-rel-card__info">
          {% if r.brand %}<p class="pd-rel-card__brand">{{ r.brand.name }}</p>{% endif %}
          <p class="pd-rel-card__name">{{ r.name }}</p>
          <p class="pd-rel-card__price">QAR {{ r.base_price }}</p>
        </div>
      </a>
      {% endfor %}
    </div>
  </div>
  {% endif %}

</div><!-- /pd-page -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LENS MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="lm" id="lmOverlay" onclick="if(event.target===this)closeLm()">
  <div class="lm__box">
    <div class="lm__head">
      <h3>Choose Prescription Lenses</h3>
      <button class="lm__close" onclick="closeLm()">√ó</button>
    </div>
    <div class="lm__body">
      <p class="lm__step">Step 1 ‚Äî Lens Tint</p>
      <div class="lm__colors">
        <div class="lm__color-chip" onclick="pickLensColor(this,'grey')"><div class="lm__color-dot" style="background:#808080;"></div><span class="lm__color-name">Grey</span></div>
        <div class="lm__color-chip" onclick="pickLensColor(this,'brown')"><div class="lm__color-dot" style="background:#8B4513;"></div><span class="lm__color-name">Brown</span></div>
        <div class="lm__color-chip" onclick="pickLensColor(this,'green')"><div class="lm__color-dot" style="background:#228B22;"></div><span class="lm__color-name">Green</span></div>
        <div class="lm__color-chip" onclick="pickLensColor(this,'blue')"><div class="lm__color-dot" style="background:#1a5fa8;"></div><span class="lm__color-name">Blue</span></div>
        <div class="lm__color-chip" onclick="pickLensColor(this,'clear')"><div class="lm__color-dot" style="background:linear-gradient(135deg,#e8f4ff,#c5d9f0);border:1.5px solid #b0c8e0;"></div><span class="lm__color-name">Clear</span></div>
      </div>
      <p class="lm__step">Step 2 ‚Äî Lens Type</p>
      <div class="lm__opt" onclick="pickLensOpt(this,'regular_156',250)">
        <div class="lm__opt-left"><div class="lm__radio"></div><div><div class="lm__opt-name">Regular 1.56</div><div class="lm__opt-desc">Anti-reflection ¬∑ Mild prescriptions</div></div></div>
        <div class="lm__opt-price">250 QAR</div>
      </div>
      <div class="lm__opt" onclick="pickLensOpt(this,'essilor_crizal',350)">
        <div class="lm__opt-left"><div class="lm__radio"></div><div><div class="lm__opt-name">Essilor Crizal Easy Pro 1.5</div><div class="lm__opt-desc">UV ¬∑ Scratch & dust resistant ¬∑ Superior clarity</div></div></div>
        <div class="lm__opt-price">350 QAR</div>
      </div>
      <p class="lm__step" style="margin-top:22px;">Step 3 ‚Äî Prescription (Rx)</p>
      <div class="lm__rx">
        <table class="lm__rx-table">
          <thead><tr><th>Eye</th><th>SPH</th><th>CYL</th><th>AXIS</th></tr></thead>
          <tbody>
            <tr><td><strong>Right (OD)</strong></td><td><input class="lm__rx-input" type="number" step="0.25" placeholder="-1.50" id="mRSph"></td><td><input class="lm__rx-input" type="number" step="0.25" placeholder="-0.50" id="mRCyl"></td><td><input class="lm__rx-input" type="number" min="0" max="180" placeholder="0‚Äì180" id="mRAxis"></td></tr>
            <tr><td><strong>Left (OS)</strong></td><td><input class="lm__rx-input" type="number" step="0.25" placeholder="-2.00" id="mLSph"></td><td><input class="lm__rx-input" type="number" step="0.25" placeholder="-0.75" id="mLCyl"></td><td><input class="lm__rx-input" type="number" min="0" max="180" placeholder="0‚Äì180" id="mLAxis"></td></tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="lm__foot">
      <div class="lm__total"><span class="lm__total-lbl">Lens Price:</span><span class="lm__total-val" id="lmTotal">‚Äî QAR</span></div>
      <button class="lm__confirm" onclick="confirmLens()">Confirm Lens Selection ‚Üí</button>
    </div>
  </div>
</div>

<div class="pd-toast" id="pdToast"></div>

<script>
const BASE_PRICE = parseFloat('{{ product.base_price|default:0 }}');
let lensColor='', lensOpt='', lensPrice=0, lensConfirmed=false;
let powerType='without';

/* CSRF */
function getCsrf(){var m=document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/);return m?decodeURIComponent(m[1]):'';};

/* Toast */
var _tt;
function toast(msg,type){
  var t=document.getElementById('pdToast');
  t.textContent=msg; t.className='pd-toast is-show'+(type?' pd-toast--'+type:'');
  clearTimeout(_tt); _tt=setTimeout(function(){t.classList.remove('is-show');},3400);
}

/* Variant */
function pickVariant(el){
  document.querySelectorAll('.pi__swatch').forEach(function(s){s.classList.remove('is-on');});
  el.classList.add('is-on');
  document.getElementById('hdVariant').value = el.dataset.variant||'';
  var img = el.dataset.img;
  if(img && window.__aaGal) window.__aaGal.goToSrc(img);
}

/* Power */
function setPower(type, btn){
  powerType=type;
  document.querySelectorAll('.pi__power-btn').forEach(function(b){b.classList.remove('is-on');});
  btn.classList.add('is-on');
  document.getElementById('hdPower').value=type;
  var lb=document.getElementById('lensBtn');
  if(type==='with'){lb.classList.add('is-show');}
  else{lb.classList.remove('is-show');lensColor='';lensOpt='';lensPrice=0;lensConfirmed=false;document.getElementById('lensOk').classList.remove('is-show');document.getElementById('hdLensPrice').value='0';updateDispPrice();}
}

/* Lens modal */
function openLm(){document.getElementById('lmOverlay').classList.add('is-open');document.body.style.overflow='hidden';}
function closeLm(){document.getElementById('lmOverlay').classList.remove('is-open');document.body.style.overflow='';}
function pickLensColor(chip,c){document.querySelectorAll('.lm__color-chip').forEach(function(x){x.classList.remove('is-on');});chip.classList.add('is-on');lensColor=c;}
function pickLensOpt(card,val,price){document.querySelectorAll('.lm__opt').forEach(function(x){x.classList.remove('is-on');});card.classList.add('is-on');lensOpt=val;lensPrice=price;document.getElementById('lmTotal').textContent=price+' QAR';}
function confirmLens(){
  if(!lensColor){toast('Please select a lens tint color','err');return;}
  if(!lensOpt){toast('Please select a lens type','err');return;}
  document.getElementById('hdLensColor').value=lensColor;
  document.getElementById('hdLensOpt').value=lensOpt;
  document.getElementById('hdLensPrice').value=lensPrice;
  lensConfirmed=true; updateDispPrice();
  var ok=document.getElementById('lensOk');
  ok.classList.add('is-show');
  document.getElementById('lensOkTxt').textContent=(lensOpt==='essilor_crizal'?'Essilor Crizal Easy Pro':'Regular 1.56')+' ¬∑ '+lensColor.charAt(0).toUpperCase()+lensColor.slice(1)+' ¬∑ '+lensPrice+' QAR';
  closeLm(); toast('Lens confirmed! +'+lensPrice+' QAR','ok');
}
function updateDispPrice(){
  document.getElementById('dispPrice').textContent='QAR '+(BASE_PRICE+(lensConfirmed?lensPrice:0)).toFixed(2);
}

/* Qty */
function chQty(d){var i=document.getElementById('qtyVal');i.value=Math.min(Math.max(1,parseInt(i.value)+d),parseInt(i.max)||99);}

/* Add to cart */
function addCart(){
  if(powerType==='with'&&!lensConfirmed){toast('Please select prescription lenses first','err');openLm();return;}
  var btn=document.getElementById('cartBtn');
  var orig=btn.innerHTML; btn.textContent='Adding‚Ä¶'; btn.disabled=true;
  var form=document.getElementById('pdForm');
  var fd=new FormData();
  fd.append('csrfmiddlewaretoken',getCsrf());
  fd.append('product_id','{{ product.id }}');
  fd.append('quantity',document.getElementById('qtyVal').value);
  fd.append('selected_variant_id',document.getElementById('hdVariant').value);
  fd.append('power_type',document.getElementById('hdPower').value);
  fd.append('selected_lens_color',document.getElementById('hdLensColor').value);
  fd.append('selected_lens_option',document.getElementById('hdLensOpt').value);
  fd.append('total_lens_price',document.getElementById('hdLensPrice').value);
  fetch("{% url 'cart:add_to_cart' %}",{method:'POST',body:fd,headers:{'X-Requested-With':'XMLHttpRequest'}})
  .then(function(r){return r.json();})
  .then(function(data){
    btn.innerHTML=orig; btn.disabled=false;
    if(data.success){
      toast('üõí Added to cart!','ok');
      var cc=document.getElementById('cartCount')||document.querySelector('[data-cart-count]');
      if(cc&&data.cart_count) cc.textContent=data.cart_count;
    } else { toast(data.message||'Could not add to cart.','err'); }
  })
  .catch(function(){btn.innerHTML=orig;btn.disabled=false;toast('Network error.','err');});
}

/* Buy now */
function buyNow(){
  if(powerType==='with'&&!lensConfirmed){toast('Please select prescription lenses first','err');openLm();return;}
  var fd=new FormData();
  fd.append('csrfmiddlewaretoken',getCsrf());
  fd.append('product_id','{{ product.id }}');
  fd.append('quantity',document.getElementById('qtyVal').value);
  fd.append('selected_variant_id',document.getElementById('hdVariant').value||'');
  fd.append('power_type',document.getElementById('hdPower').value);
  fd.append('selected_lens_color',document.getElementById('hdLensColor').value);
  fd.append('selected_lens_option',document.getElementById('hdLensOpt').value);
  fd.append('total_lens_price',document.getElementById('hdLensPrice').value);
  fetch("{% url 'cart:add_to_cart' %}",{method:'POST',body:fd,headers:{'X-Requested-With':'XMLHttpRequest'}})
  .then(function(r){return r.json();})
  .then(function(d){if(d.success){window.location.href="{% url 'orders:checkout' %}";}else{toast(d.message||'Could not process.','err');}})
  .catch(function(){toast('Network error.','err');});
}

/* Wishlist */
document.getElementById('piWishBtn').addEventListener('click',function(){
  var btn=this;
  var pid=btn.dataset.productId;
  var csrf=getCsrf();
  fetch("{% url 'wishlist:toggle' 0 %}".replace('/0/','/'+pid+'/'),{
    method:'POST',credentials:'same-origin',
    headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':csrf,'Content-Type':'application/x-www-form-urlencoded'},
    body:'csrfmiddlewaretoken='+encodeURIComponent(csrf)
  })
  .then(function(r){return r.json();})
  .then(function(data){
    var svg=btn.querySelector('svg');
    if(data.added){
      btn.classList.add('is-on');
      svg.setAttribute('fill','#e05f5f');svg.setAttribute('stroke','#e05f5f');
      toast('‚ù§Ô∏è Added to wishlist!','ok');
    } else {
      btn.classList.remove('is-on');
      svg.setAttribute('fill','none');svg.setAttribute('stroke','currentColor');
      toast('üíî Removed from wishlist.','');
    }
    var wc=document.querySelector('.wishlist-count,[data-wishlist-count]');
    if(wc&&data.wishlist_count) wc.textContent=data.wishlist_count;
  })
  .catch(function(){toast('Please log in to use wishlist.','');});
});

document.addEventListener('keydown',function(e){if(e.key==='Escape')closeLm();});

/* Init first variant */
document.addEventListener('DOMContentLoaded',function(){
  var first=document.querySelector('.pi__swatch');
  if(first){document.getElementById('hdVariant').value=first.dataset.variant||'';}
});
</script>

<script>
  /**
 * AA Product Gallery ‚Äî Universal, Amazon/Flipkart grade
 * Self-initializing. Works with any .aa-gal container.
 * Exposes window.__aaGal for external control.
 */
(function () {
  'use strict';

  function AaGallery() {
    var gal = document.getElementById('aaGal');
    if (!gal) return;

    var rail       = document.getElementById('aaGalRail');
    var stage      = document.getElementById('aaGalStage');
    var mainImg    = document.getElementById('aaGalMain');
    var zoomLens   = document.getElementById('aaZoomLens');
    var zoomPane   = document.getElementById('aaZoomPane');
    var zoomImg    = document.getElementById('aaZoomImg');
    var counter    = document.getElementById('aaGalCounter');
    var prevBtn    = document.getElementById('aaGalPrev');
    var nextBtn    = document.getElementById('aaGalNext');
    var fullBtn    = document.getElementById('aaGalFullscreen');
    var lb         = document.getElementById('aaGalLb');
    var lbImg      = document.getElementById('aaLbImg');
    var lbStrip    = document.getElementById('aaLbStrip');
    var lbCount    = document.getElementById('aaLbCount');

    if (!stage || !mainImg) return;

    var thumbs  = Array.from(rail.querySelectorAll('.aa-gal__thumb'));
    var srcs    = thumbs.map(function(t) { return t.dataset.src || ''; });
    var total   = srcs.length;
    var cur     = 0;
    var isMobile = window.innerWidth <= 1280;
    var tapZoomed = false;

    // ‚îÄ‚îÄ Build lightbox strip ‚îÄ‚îÄ
    srcs.forEach(function(src, i) {
      var dot = document.createElement('div');
      dot.className = 'aa-gal__lb-dot' + (i === 0 ? ' is-active' : '');
      var im = document.createElement('img');
      im.src = src; im.loading = 'lazy';
      dot.appendChild(im);
      dot.addEventListener('click', function() { lbGoTo(i); });
      lbStrip.appendChild(dot);
    });

    // ‚îÄ‚îÄ Arrow / counter visibility ‚îÄ‚îÄ
    if (total <= 1) {
      prevBtn && prevBtn.classList.add('is-hidden');
      nextBtn && nextBtn.classList.add('is-hidden');
      counter && counter.classList.add('is-single');
    }
    updateCounter();

    // ‚îÄ‚îÄ Go to index ‚îÄ‚îÄ
    function goTo(idx, force) {
      if (!force && idx === cur) return;
      if (idx < 0) idx = total - 1;
      if (idx >= total) idx = 0;

      var newSrc = srcs[idx];
      if (!newSrc) return;

      mainImg.classList.add('is-loading');

      var tmp = new Image();
      tmp.onload = function() {
        mainImg.src = newSrc;
        zoomImg.src = newSrc;
        mainImg.classList.remove('is-loading');
      };
      tmp.onerror = function() {
        mainImg.src = newSrc;
        zoomImg.src = newSrc;
        mainImg.classList.remove('is-loading');
      };
      tmp.src = newSrc;

      // Update thumbs
      thumbs.forEach(function(t, i) {
        t.classList.toggle('is-active', i === idx);
        t.setAttribute('aria-selected', i === idx ? 'true' : 'false');
        t.tabIndex = i === idx ? 0 : -1;
      });
      // Scroll active thumb into view
      if (thumbs[idx]) {
        thumbs[idx].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      }

      cur = idx;
      updateCounter();

      // If lightbox open, sync it
      if (lb.classList.contains('is-open')) {
        lbGoTo(idx);
      }
    }

    function updateCounter() {
      if (counter) counter.textContent = (cur + 1) + ' / ' + total;
      var lbDots = Array.from(lbStrip.querySelectorAll('.aa-gal__lb-dot'));
      lbDots.forEach(function(d, i) { d.classList.toggle('is-active', i === cur); });
      if (lbCount) lbCount.textContent = (cur + 1) + ' / ' + total;
    }

    // ‚îÄ‚îÄ Thumbnail clicks ‚îÄ‚îÄ
    thumbs.forEach(function(t, i) {
      t.addEventListener('click', function() { goTo(i, true); });
      t.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); goTo(i, true); }
        if (e.key === 'ArrowDown' || e.key === 'ArrowRight') { e.preventDefault(); if (thumbs[i+1]) thumbs[i+1].focus(); }
        if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') { e.preventDefault(); if (thumbs[i-1]) thumbs[i-1].focus(); }
      });
    });

    // ‚îÄ‚îÄ Arrow buttons ‚îÄ‚îÄ
    prevBtn && prevBtn.addEventListener('click', function(e) { e.stopPropagation(); goTo(cur - 1); });
    nextBtn && nextBtn.addEventListener('click', function(e) { e.stopPropagation(); goTo(cur + 1); });

    // ‚îÄ‚îÄ Stage keyboard ‚îÄ‚îÄ
    stage.addEventListener('keydown', function(e) {
      if (e.key === 'ArrowLeft')  { e.preventDefault(); goTo(cur - 1); }
      if (e.key === 'ArrowRight') { e.preventDefault(); goTo(cur + 1); }
      if (e.key === 'Enter' || e.key === 'f') { openLb(); }
      if (e.key === 'Escape') { stage.classList.remove('is-zooming'); }
    });

    // ‚îÄ‚îÄ Fullscreen ‚îÄ‚îÄ
    fullBtn && fullBtn.addEventListener('click', function(e) { e.stopPropagation(); openLb(); });

    // ‚îÄ‚îÄ Zoom (desktop) ‚îÄ‚îÄ
    var ZOOM_FACTOR = 2.8;
    var lensW = 120, lensH = 120;

    function setupZoom() {
      if (!mainImg) return;
      // Set pane dimensions based on stage size
      var sr = stage.getBoundingClientRect();
      zoomPane && (zoomPane.style.width = (sr.width * 0.85) + 'px');
      zoomPane && (zoomPane.style.height = (sr.height * 0.85) + 'px');
      if (zoomImg && mainImg.src) zoomImg.src = mainImg.src;
    }

    stage.addEventListener('mouseenter', function() {
      isMobile = window.innerWidth <= 1280;
      if (isMobile) return;
      if (!srcs[cur]) return;
      zoomImg.src = srcs[cur];
      stage.classList.add('is-zooming');
      setupZoom();
    });

    stage.addEventListener('mouseleave', function() {
      stage.classList.remove('is-zooming');
    });

    stage.addEventListener('mousemove', function(e) {
      isMobile = window.innerWidth <= 1280;
      if (isMobile || !stage.classList.contains('is-zooming')) return;

      var sr = stage.getBoundingClientRect();
      var mx = e.clientX - sr.left;
      var my = e.clientY - sr.top;

      // Clamp
      var lx = Math.max(lensW/2, Math.min(mx, sr.width - lensW/2));
      var ly = Math.max(lensH/2, Math.min(my, sr.height - lensH/2));

      // Position lens
      zoomLens.style.left   = (lx - lensW/2) + 'px';
      zoomLens.style.top    = (ly - lensH/2) + 'px';
      zoomLens.style.width  = lensW + 'px';
      zoomLens.style.height = lensH + 'px';

      // Position zoom image inside pane
      var paneW = zoomPane.offsetWidth;
      var paneH = zoomPane.offsetHeight;

      // Natural image size estimate
      var imgNatW = mainImg.naturalWidth || sr.width * ZOOM_FACTOR;
      var imgNatH = mainImg.naturalHeight || sr.height * ZOOM_FACTOR;
      var scaleW  = paneW / (sr.width / imgNatW);
      var scaleH  = paneH / (sr.height / imgNatH);

      var ratio = Math.min(scaleW, scaleH);
      var rW = imgNatW * (paneW / (lensW * (imgNatW / sr.width)));
      var rH = imgNatH * (paneH / (lensH * (imgNatH / sr.height)));

      // Simpler: scale image to fill pane √ó ZOOM_FACTOR
      var scaledW = sr.width * ZOOM_FACTOR;
      var scaledH = sr.height * ZOOM_FACTOR;

      var bgX = -((lx / sr.width) * scaledW - paneW / 2);
      var bgY = -((ly / sr.height) * scaledH - paneH / 2);

      // Clamp bg offset
      bgX = Math.min(0, Math.max(bgX, -(scaledW - paneW)));
      bgY = Math.min(0, Math.max(bgY, -(scaledH - paneH)));

      zoomImg.style.width    = scaledW + 'px';
      zoomImg.style.height   = scaledH + 'px';
      zoomImg.style.left     = bgX + 'px';
      zoomImg.style.top      = bgY + 'px';
    });

    // ‚îÄ‚îÄ Tap zoom (mobile ‚Äî pinch-style tap) ‚îÄ‚îÄ
    stage.addEventListener('click', function(e) {
      if (e.target.closest('.aa-gal__arrow, .aa-gal__fullscreen')) return;
      isMobile = window.innerWidth <= 1280;
      if (!isMobile) return;

      if (!tapZoomed) {
        // Open lightbox on mobile tap
        openLb();
      }
    });

    // ‚îÄ‚îÄ Touch swipe ‚îÄ‚îÄ
    var txStart = 0, tyStart = 0;
    stage.addEventListener('touchstart', function(e) {
      txStart = e.changedTouches[0].screenX;
      tyStart = e.changedTouches[0].screenY;
    }, { passive: true });
    stage.addEventListener('touchend', function(e) {
      var dx = txStart - e.changedTouches[0].screenX;
      var dy = tyStart - e.changedTouches[0].screenY;
      if (Math.abs(dx) > 50 && Math.abs(dy) < 60) {
        dx > 0 ? goTo(cur + 1) : goTo(cur - 1);
      }
    }, { passive: true });

    // ‚îÄ‚îÄ Lightbox ‚îÄ‚îÄ
    function openLb() {
      lbGoTo(cur);
      lb.classList.add('is-open');
      document.body.style.overflow = 'hidden';
    }
    function closeLb() {
      lb.classList.remove('is-open');
      document.body.style.overflow = '';
    }
    function lbGoTo(idx) {
      if (idx < 0) idx = total - 1;
      if (idx >= total) idx = 0;
      lbImg.style.cssText = 'opacity:0;transform:scale(0.94);transition:opacity .22s,transform .22s;';
      var src = srcs[idx];
      setTimeout(function() {
        lbImg.src = src;
        lbImg.style.cssText = 'opacity:1;transform:scale(1);transition:opacity .22s,transform .22s;';
      }, 120);
      cur = idx;
      updateCounter();
      var dots = lbStrip.querySelectorAll('.aa-gal__lb-dot');
      dots.forEach(function(d, i) {
        d.classList.toggle('is-active', i === idx);
      });
      if (dots[idx]) dots[idx].scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
    }

    lb.addEventListener('click', function(e) {
      if (e.target === lb) closeLb();
    });

    document.addEventListener('keydown', function(e) {
      if (!lb.classList.contains('is-open')) return;
      if (e.key === 'ArrowLeft')  lbGoTo(cur - 1);
      if (e.key === 'ArrowRight') lbGoTo(cur + 1);
      if (e.key === 'Escape') closeLb();
    });

    // ‚îÄ‚îÄ Public API ‚îÄ‚îÄ
    window.__aaGal = {
      goTo: goTo,
      goToSrc: function(src) {
        var idx = srcs.indexOf(src);
        if (idx !== -1) { goTo(idx, true); return; }
        // src not in list ‚Äî inject it temporarily
        mainImg.classList.add('is-loading');
        setTimeout(function() {
          mainImg.src = src;
          zoomImg && (zoomImg.src = src);
          mainImg.classList.remove('is-loading');
        }, 100);
      },
      next: function() { goTo(cur + 1); },
      prev: function() { goTo(cur - 1); },
      openLb: openLb,
      closeLb: closeLb,
      lbNav: function(d) { lbGoTo(cur + d); }
    };

    // ‚îÄ‚îÄ Init zoom image ‚îÄ‚îÄ
    zoomImg && mainImg && (zoomImg.src = mainImg.src);

    window.addEventListener('resize', function() {
      isMobile = window.innerWidth <= 1280;
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', AaGallery);
  } else {
    AaGallery();
  }
})();
</script>
{% endblock %}