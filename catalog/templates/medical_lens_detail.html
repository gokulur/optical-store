{% extends 'base.html' %}
{% load static %}
{% block title %}{{ lens_option.name }} - Medical Lenses{% endblock %}
{% load custom_filters %}

{% block content %}

<style>
  /* ─── DESIGN TOKENS ─────────────────────────────── */
  :root {
    --black: #0a0a0a;
    --white: #fafafa;
    --gold: #b8976a;
    --gold-light: #d4b896;
    --sand: #f5f0e8;
    --muted: #888;
    --border: #e5e0d8;
    --radius: 10px;
    --shadow: 0 4px 24px rgba(0,0,0,0.08);
    --transition: all 0.28s cubic-bezier(0.4,0,0.2,1);
  }

  /* ─── BREADCRUMB ─────────────────────────────────── */
  .eg-breadcrumb { padding: 14px 0; font-size: 13px; color: var(--muted); letter-spacing: 0.02em; }
  .eg-breadcrumb a { color: var(--muted); text-decoration: none; }
  .eg-breadcrumb a:hover { color: var(--black); }
  .eg-breadcrumb span { margin: 0 6px; }

  /* ─── LAYOUT ─────────────────────────────────────── */
  .eg-product-wrap {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 48px;
    align-items: start;
    padding: 0 0 60px;
  }
  @media (max-width: 900px) { .eg-product-wrap { grid-template-columns: 1fr; gap: 28px; } }

  /* ─── GALLERY ─────────────────────────────────────── */
  .eg-gallery { position: sticky; top: 100px; }
  .eg-main-img {
    width: 100%; aspect-ratio: 1/1; border-radius: 16px; overflow: hidden;
    background: var(--sand); margin-bottom: 14px; cursor: zoom-in;
    display: flex; align-items: center; justify-content: center;
  }
  .eg-main-img img { width: 100%; height: 100%; object-fit: contain; transition: transform 0.4s ease; display: block; }
  .eg-main-img:hover img { transform: scale(1.04); }
  .ml-no-image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; color: var(--gold); }
  .ml-no-image-placeholder p { font-size: 13px; color: var(--muted); }

  .eg-thumbs { display: flex; gap: 10px; flex-wrap: wrap; }
  .eg-thumb { width: 72px; height: 72px; border-radius: 8px; overflow: hidden; background: var(--sand); border: 2px solid transparent; cursor: pointer; transition: var(--transition); flex-shrink: 0; }
  .eg-thumb img { width: 100%; height: 100%; object-fit: contain; display: block; }
  .eg-thumb.active, .eg-thumb:hover { border-color: var(--gold); }

  /* ─── PRODUCT INFO ───────────────────────────────── */
  .eg-badges { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; }
  .eg-badge { font-size: 11px; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; padding: 4px 10px; border-radius: 4px; background: var(--sand); color: var(--gold); }

  .eg-title-row { display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; margin-bottom: 6px; }
  .eg-title { font-size: clamp(22px, 2.4vw, 30px); font-weight: 700; line-height: 1.2; color: var(--black); letter-spacing: -0.02em; margin: 0; }

  .eg-brand { font-size: 13px; color: var(--muted); margin-bottom: 4px; }
  .eg-brand strong { color: var(--black); }
  .eg-sku { font-size: 12px; color: #bbb; margin-bottom: 20px; }

  .eg-price-row { display: flex; align-items: baseline; gap: 12px; margin-bottom: 24px; padding: 16px 20px; background: var(--sand); border-radius: var(--radius); }
  .eg-price { font-size: 28px; font-weight: 800; color: var(--black); letter-spacing: -0.03em; }
  .eg-price-old { font-size: 16px; color: var(--muted); text-decoration: line-through; }

  .eg-section-label { font-size: 12px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-bottom: 10px; }

  /* ─── MEDICAL LENS SPECIFIC ──────────────────────── */
  .ml-specs-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 24px;
  }
  .ml-spec-card {
    background: var(--sand);
    border-radius: 10px;
    padding: 14px 16px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .ml-spec-label { font-size: 11px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); }
  .ml-spec-value { font-size: 15px; font-weight: 700; color: var(--black); }

  /* ─── COATING CHIPS ──────────────────────────────── */
  .ml-coatings { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 24px; }
  .ml-coating-chip {
    display: flex; align-items: center; gap: 6px;
    padding: 6px 12px; border-radius: 20px;
    border: 1px solid var(--border);
    background: white; font-size: 12px; font-weight: 600;
    color: var(--black);
  }
  .ml-coating-chip svg { color: var(--gold); }

  /* ─── POWER RANGE ────────────────────────────────── */
  .ml-power-range {
    background: var(--sand); border-radius: var(--radius);
    padding: 14px 18px; margin-bottom: 24px;
    display: flex; align-items: center; justify-content: space-between;
    flex-wrap: wrap; gap: 8px;
  }
  .ml-power-label { font-size: 12px; color: var(--muted); font-weight: 600; }
  .ml-power-value { font-size: 14px; font-weight: 700; color: var(--black); }

  /* ─── QUANTITY ───────────────────────────────────── */
  .eg-qty-row { display: flex; align-items: center; width: fit-content; border: 2px solid var(--border); border-radius: var(--radius); overflow: hidden; margin-bottom: 20px; }
  .eg-qty-btn { width: 44px; height: 44px; border: none; background: var(--sand); cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: var(--transition); color: var(--black); }
  .eg-qty-btn:hover { background: var(--border); }
  .eg-qty-input { width: 52px; height: 44px; border: none; border-left: 2px solid var(--border); border-right: 2px solid var(--border); text-align: center; font-size: 16px; font-weight: 600; color: var(--black); background: white; }
  .eg-qty-input:focus { outline: none; }

  /* ─── ACTION BUTTONS ─────────────────────────────── */
  .eg-actions { display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px; }
  .eg-btn-cart { padding: 16px 24px; background: var(--black); border: 2px solid var(--black); border-radius: var(--radius); font-size: 15px; font-weight: 700; color: white; cursor: pointer; transition: var(--transition); letter-spacing: 0.04em; text-transform: uppercase; }
  .eg-btn-cart:hover { background: #333; border-color: #333; }
  .eg-btn-cart.loading { pointer-events: none; opacity: 0.7; }
  .eg-btn-buy { padding: 16px 24px; background: var(--gold); border: 2px solid var(--gold); border-radius: var(--radius); font-size: 15px; font-weight: 700; color: white; cursor: pointer; transition: var(--transition); letter-spacing: 0.04em; text-transform: uppercase; width: 100%; }
  .eg-btn-buy:hover { background: #a37d55; border-color: #a37d55; }

  /* ─── PRESCRIPTION SECTION ───────────────────────── */
  .ml-rx-section { background: var(--sand); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
  .ml-rx-title { font-size: 14px; font-weight: 700; color: var(--black); margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
  .ml-rx-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
  .ml-rx-table th { background: var(--black); color: white; padding: 10px 12px; font-size: 13px; font-weight: 600; text-align: left; }
  .ml-rx-table td { padding: 10px 12px; border-bottom: 1px solid var(--border); }
  .ml-rx-table tr:last-child td { border-bottom: none; }
  .ml-rx-table td:first-child { font-weight: 600; font-size: 13px; white-space: nowrap; }
  .ml-rx-input { width: 100%; padding: 7px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; transition: var(--transition); min-width: 70px; }
  .ml-rx-input:focus { border-color: var(--gold); outline: none; }

  /* ─── COMPATIBLE FRAMES ──────────────────────────── */
  .ml-compatible-note {
    background: #f0f7ee; border: 1px solid #3a8a2e; color: #2a6a20;
    border-radius: 8px; padding: 12px 16px; font-size: 13px; font-weight: 600;
    margin-bottom: 16px; display: flex; align-items: flex-start; gap: 8px;
  }

  /* ─── SHIPPING ───────────────────────────────────── */
  .eg-shipping { background: var(--sand); border-radius: var(--radius); padding: 16px 20px; display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px; }
  .eg-shipping-item { display: flex; align-items: center; gap: 12px; font-size: 13px; color: var(--black); }
  .eg-shipping-icon { width: 32px; height: 32px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

  /* ─── SPECS TABLE ────────────────────────────────── */
  .eg-specs-table { width: 100%; border-collapse: collapse; font-size: 14px; }
  .eg-specs-table tr { border-bottom: 1px solid var(--border); }
  .eg-specs-table td { padding: 10px 0; vertical-align: top; }
  .eg-specs-table td:first-child { font-weight: 600; color: var(--black); width: 44%; }
  .eg-specs-table td:last-child { color: var(--muted); }

  /* ─── DESCRIPTION ────────────────────────────────── */
  .eg-desc-section { padding: 40px 0; border-top: 1px solid var(--border); }
  .eg-section-title { font-size: 20px; font-weight: 700; margin-bottom: 16px; color: var(--black); }
  .eg-desc-body { font-size: 15px; line-height: 1.8; color: #555; }

  /* ─── RELATED ────────────────────────────────────── */
  .eg-related-section { padding: 40px 0; border-top: 1px solid var(--border); }
  .eg-related-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 24px; }
  @media (max-width: 900px) { .eg-related-grid { grid-template-columns: repeat(2, 1fr); } }
  .eg-product-card { text-decoration: none; color: inherit; display: block; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); transition: var(--transition); background: white; }
  .eg-product-card:hover { transform: translateY(-4px); box-shadow: var(--shadow); border-color: var(--gold-light); }
  .eg-card-img { aspect-ratio: 1/1; background: var(--sand); overflow: hidden; display: flex; align-items: center; justify-content: center; }
  .eg-card-img img { width: 100%; height: 100%; object-fit: contain; transition: transform 0.4s ease; display: block; }
  .eg-product-card:hover .eg-card-img img { transform: scale(1.06); }
  .eg-card-info { padding: 14px; }
  .eg-card-brand { font-size: 11px; color: var(--gold); font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; }
  .eg-card-name { font-size: 14px; font-weight: 600; margin: 4px 0; color: var(--black); }
  .eg-card-price { font-size: 15px; font-weight: 700; color: var(--black); }
  .eg-card-index { font-size: 12px; color: var(--muted); }

  /* ─── CONTAINER ──────────────────────────────────── */
  .eg-container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }

  /* ─── TOAST ──────────────────────────────────────── */
  .eg-toast { position: fixed; bottom: 28px; right: 28px; z-index: 99999; background: var(--black); color: white; padding: 14px 22px; border-radius: 10px; font-size: 14px; font-weight: 600; box-shadow: 0 8px 32px rgba(0,0,0,0.24); transform: translateY(60px); opacity: 0; transition: all 0.32s cubic-bezier(0.4,0,0.2,1); pointer-events: none; max-width: 320px; }
  .eg-toast.show { transform: translateY(0); opacity: 1; }
  .eg-toast.success { background: #2a7a2a; }
  .eg-toast.error { background: #b42020; }
</style>

<div class="eg-container">

  <!-- Breadcrumb -->
  <nav class="eg-breadcrumb" aria-label="Breadcrumb">
    <a href="{% url 'home' %}">Home</a>
    <span>/</span>
    <a href="{% url 'catalog:medical_lenses_list' %}">Medical Lenses</a>
    <span>/</span>
    <span style="color: var(--black);">{{ lens_option.name }}</span>
  </nav>

  <!-- Main Section -->
  <div class="eg-product-wrap">

    <!-- GALLERY -->
    <div class="eg-gallery">
      <div class="eg-main-img">
        {% if lens_option.image %}
        <img src="{{ lens_option.image.url }}" alt="{{ lens_option.name }}" id="mainImg" />
        {% else %}
        <div class="ml-no-image-placeholder">
          <svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
            <ellipse cx="25" cy="40" rx="18" ry="14" stroke="#b8976a" stroke-width="3" fill="none"/>
            <ellipse cx="55" cy="40" rx="18" ry="14" stroke="#b8976a" stroke-width="3" fill="none"/>
            <path d="M43 40 H37" stroke="#b8976a" stroke-width="3" stroke-linecap="round"/>
            <path d="M7 40 H7" stroke="#b8976a" stroke-width="3" stroke-linecap="round"/>
            <path d="M73 40 H73" stroke="#b8976a" stroke-width="3" stroke-linecap="round"/>
          </svg>
          <p>Medical Lens</p>
        </div>
        {% endif %}
      </div>
      {% if lens_option.image %}
      <div class="eg-thumbs" id="thumbStrip">
        <div class="eg-thumb active" onclick="switchImage(this, '{{ lens_option.image.url }}')">
          <img src="{{ lens_option.image.url }}" alt="{{ lens_option.name }}" />
        </div>
        {% for img in lens_option.images.all %}
        <div class="eg-thumb" onclick="switchImage(this, '{{ img.image.url }}')">
          <img src="{{ img.image.url }}" alt="{{ lens_option.name }}" />
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <!-- PRODUCT INFO -->
    <div class="eg-info">

      <!-- Badges -->
      <div class="eg-badges">
        {% if lens_option.lens_brand %}
        <span class="eg-badge">{{ lens_option.lens_brand.name }}</span>
        {% endif %}
        {% if lens_option.lens_type %}
        <span class="eg-badge" style="background:#e8f0f5;color:#3a6a9a;">{{ lens_option.lens_type.name }}</span>
        {% endif %}
        {% if lens_option.is_featured %}
        <span class="eg-badge" style="background:#f0f7ee;color:#3a8a2e;">Featured</span>
        {% endif %}
      </div>

      <!-- Title -->
      <div class="eg-title-row">
        <h1 class="eg-title">{{ lens_option.name }}</h1>
      </div>

      {% if lens_option.lens_brand %}
      <p class="eg-brand">Brand: <strong>{{ lens_option.lens_brand.name }}</strong></p>
      {% endif %}
      {% if lens_option.sku %}
      <p class="eg-sku">SKU: {{ lens_option.sku }}</p>
      {% endif %}

      <!-- Price -->
      <div class="eg-price-row">
        <span class="eg-price">QAR {{ lens_option.base_price }}</span>
        {% if lens_option.compare_at_price %}
        <span class="eg-price-old">QAR {{ lens_option.compare_at_price }}</span>
        {% endif %}
      </div>

      <!-- Key Specs Grid -->
      <div class="ml-specs-grid">
        {% if lens_option.index %}
        <div class="ml-spec-card">
          <span class="ml-spec-label">Lens Index</span>
          <span class="ml-spec-value">{{ lens_option.index }}</span>
        </div>
        {% endif %}
        {% if lens_option.lens_type %}
        <div class="ml-spec-card">
          <span class="ml-spec-label">Lens Type</span>
          <span class="ml-spec-value">{{ lens_option.lens_type.name }}</span>
        </div>
        {% endif %}
        {% if lens_option.min_power and lens_option.max_power %}
        <div class="ml-spec-card">
          <span class="ml-spec-label">Power Range (SPH)</span>
          <span class="ml-spec-value">{{ lens_option.min_power }} to {{ lens_option.max_power }}</span>
        </div>
        {% endif %}
        {% if lens_option.max_cyl %}
        <div class="ml-spec-card">
          <span class="ml-spec-label">Max CYL</span>
          <span class="ml-spec-value">{{ lens_option.max_cyl }}</span>
        </div>
        {% endif %}
      </div>

      <!-- Coatings / Features -->
      {% if lens_option.coatings.all %}
      <p class="eg-section-label">Coatings & Features</p>
      <div class="ml-coatings">
        {% for coating in lens_option.coatings.all %}
        <div class="ml-coating-chip">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
          {{ coating.name }}
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- Compatible Note -->
      {% if lens_option.compatible_frames_note %}
      <div class="ml-compatible-note">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        <span>{{ lens_option.compatible_frames_note }}</span>
      </div>
      {% else %}
      <div class="ml-compatible-note">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        <span>Compatible with all frames sold in our store — fitting included</span>
      </div>
      {% endif %}

      <!-- Form -->
      <form id="productForm" method="POST" action="{% url 'cart:add_medical_lens_to_cart' %}" onsubmit="return false;">
        {% csrf_token %}
        <input type="hidden" name="lens_option_id" value="{{ lens_option.id }}">
        <!-- Prescription -->
        <input type="hidden" name="right_sph"  id="h_rSph">
        <input type="hidden" name="right_cyl"  id="h_rCyl">
        <input type="hidden" name="right_axis" id="h_rAxis">
        <input type="hidden" name="right_add"  id="h_rAdd">
        <input type="hidden" name="left_sph"   id="h_lSph">
        <input type="hidden" name="left_cyl"   id="h_lCyl">
        <input type="hidden" name="left_axis"  id="h_lAxis">
        <input type="hidden" name="left_add"   id="h_lAdd">

        <!-- Prescription Entry -->
        <div class="ml-rx-section">
          <p class="ml-rx-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="2" width="6" height="4" rx="1"/><path d="M9 2H7a2 2 0 00-2 2v16a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2h-2"/><line x1="9" y1="12" x2="15" y2="12"/><line x1="9" y1="16" x2="13" y2="16"/></svg>
            Enter Your Prescription (Optional — can be added later)
          </p>
          <div style="overflow-x:auto;">
            <table class="ml-rx-table">
              <thead>
                <tr><th>Eye</th><th>SPH</th><th>CYL</th><th>AXIS</th><th>ADD</th></tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>Right (OD)</strong></td>
                  <td><input class="ml-rx-input" type="number" step="0.25" placeholder="-1.50" id="m_rSph" oninput="syncRx()"></td>
                  <td><input class="ml-rx-input" type="number" step="0.25" placeholder="-0.50" id="m_rCyl" oninput="syncRx()"></td>
                  <td><input class="ml-rx-input" type="number" min="0" max="180" placeholder="0–180" id="m_rAxis" oninput="syncRx()"></td>
                  <td><input class="ml-rx-input" type="number" step="0.25" placeholder="+1.00" id="m_rAdd" oninput="syncRx()"></td>
                </tr>
                <tr>
                  <td><strong>Left (OS)</strong></td>
                  <td><input class="ml-rx-input" type="number" step="0.25" placeholder="-2.00" id="m_lSph" oninput="syncRx()"></td>
                  <td><input class="ml-rx-input" type="number" step="0.25" placeholder="-0.75" id="m_lCyl" oninput="syncRx()"></td>
                  <td><input class="ml-rx-input" type="number" min="0" max="180" placeholder="0–180" id="m_lAxis" oninput="syncRx()"></td>
                  <td><input class="ml-rx-input" type="number" step="0.25" placeholder="+1.00" id="m_lAdd" oninput="syncRx()"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Quantity -->
        <div style="margin-bottom:20px;">
          <p class="eg-section-label">Quantity</p>
          <div class="eg-qty-row">
            <button type="button" class="eg-qty-btn" onclick="changeQty(-1)">−</button>
            <input class="eg-qty-input" type="number" name="quantity" id="qtyInput" value="1" min="1" max="99" readonly>
            <button type="button" class="eg-qty-btn" onclick="changeQty(1)">+</button>
          </div>
        </div>

        <!-- Actions -->
        <div class="eg-actions">
          <button type="button" class="eg-btn-cart" id="addToCartBtn" onclick="addToCart()">
            Add to Cart
          </button>
          <button type="button" class="eg-btn-buy" onclick="buyNow()">Buy it now →</button>
        </div>
      </form>

      <!-- Shipping -->
      <div class="eg-shipping">
        <div class="eg-shipping-item">
          <div class="eg-shipping-icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13" rx="1"/><path d="M16 8h4l3 5v3h-7V8z"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
          </div>
          <span>Estimated delivery: <strong>5–10 business days</strong> (lens processing included)</span>
        </div>
        <div class="eg-shipping-item">
          <div class="eg-shipping-icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
          </div>
          <span>Free returns within <strong>45 days</strong> of purchase</span>
        </div>
        <div class="eg-shipping-item">
          <div class="eg-shipping-icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          </div>
          <span>Authentic products — <strong>100% genuine</strong></span>
        </div>
      </div>

      <!-- Additional Specs -->
      {% if lens_option.specifications.all %}
      <div style="margin-top:8px;">
        <p class="eg-section-label">Full Specifications</p>
        <table class="eg-specs-table">
          {% for spec in lens_option.specifications.all %}
          <tr>
            <td>{{ spec.spec_key }}</td>
            <td>{{ spec.spec_value }}</td>
          </tr>
          {% endfor %}
        </table>
      </div>
      {% endif %}

    </div><!-- /eg-info -->
  </div><!-- /eg-product-wrap -->

  <!-- Description -->
  {% if lens_option.description %}
  <div class="eg-desc-section">
    <h2 class="eg-section-title">About This Lens</h2>
    <div class="eg-desc-body">{{ lens_option.description|linebreaksbr }}</div>
  </div>
  {% endif %}

  <!-- Related Medical Lenses -->
  {% if related_lens_options %}
  <div class="eg-related-section">
    <h2 class="eg-section-title">You May Also Like</h2>
    <div class="eg-related-grid">
      {% for related in related_lens_options %}
      <a href="{% url 'catalog:medical_lens_detail' related.id %}" class="eg-product-card">
        <div class="eg-card-img">
          {% if related.image %}
          <img src="{{ related.image.url }}" alt="{{ related.name }}" loading="lazy">
          {% else %}
          <svg width="48" height="48" viewBox="0 0 80 80" fill="none"><ellipse cx="25" cy="40" rx="18" ry="14" stroke="#b8976a" stroke-width="3" fill="none"/><ellipse cx="55" cy="40" rx="18" ry="14" stroke="#b8976a" stroke-width="3" fill="none"/><path d="M43 40 H37" stroke="#b8976a" stroke-width="3" stroke-linecap="round"/></svg>
          {% endif %}
        </div>
        <div class="eg-card-info">
          {% if related.lens_brand %}<p class="eg-card-brand">{{ related.lens_brand.name }}</p>{% endif %}
          <p class="eg-card-name">{{ related.name }}</p>
          {% if related.index %}<p class="eg-card-index">Index {{ related.index }}</p>{% endif %}
          <p class="eg-card-price">QAR {{ related.base_price }}</p>
        </div>
      </a>
      {% endfor %}
    </div>
  </div>
  {% endif %}

</div><!-- /eg-container -->

<!-- Toast -->
<div class="eg-toast" id="egToast"></div>

<script>
function switchImage(thumb, src) {
  document.querySelectorAll('.eg-thumb').forEach(t => t.classList.remove('active'));
  thumb.classList.add('active');
  const img = document.getElementById('mainImg');
  if (img) img.src = src;
}

function changeQty(delta) {
  const input = document.getElementById('qtyInput');
  input.value = Math.min(Math.max(1, parseInt(input.value) + delta), 99);
}

function syncRx() {
  document.getElementById('h_rSph').value  = document.getElementById('m_rSph').value  || '';
  document.getElementById('h_rCyl').value  = document.getElementById('m_rCyl').value  || '';
  document.getElementById('h_rAxis').value = document.getElementById('m_rAxis').value || '';
  document.getElementById('h_rAdd').value  = document.getElementById('m_rAdd').value  || '';
  document.getElementById('h_lSph').value  = document.getElementById('m_lSph').value  || '';
  document.getElementById('h_lCyl').value  = document.getElementById('m_lCyl').value  || '';
  document.getElementById('h_lAxis').value = document.getElementById('m_lAxis').value || '';
  document.getElementById('h_lAdd').value  = document.getElementById('m_lAdd').value  || '';
}

function addToCart() {
  syncRx();
  const btn = document.getElementById('addToCartBtn');
  btn.classList.add('loading');
  btn.textContent = 'Adding...';
  const form = document.getElementById('productForm');
  const formData = new FormData(form);
  formData.set('quantity', document.getElementById('qtyInput').value);
  const csrf = form.querySelector('[name=csrfmiddlewaretoken]').value;

  fetch("{% url 'cart:add_medical_lens_to_cart' %}", {
    method: 'POST',
    body: formData,
    headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrf }
  })
  .then(r => r.json())
  .then(data => {
    btn.classList.remove('loading');
    btn.textContent = 'Add to Cart';
    if (data.success) {
      showToast('Added to cart!', 'success');
      const cc = document.getElementById('cartCount');
      if (cc && data.cart_count) cc.textContent = data.cart_count;
    } else {
      showToast(data.message || 'Error adding to cart', 'error');
    }
  })
  .catch(() => {
    btn.classList.remove('loading');
    btn.textContent = 'Add to Cart';
    showToast('Something went wrong. Please try again.', 'error');
  });
}

function buyNow() {
  syncRx();
  const form = document.getElementById('productForm');
  form.action = "{% url 'orders:checkout' %}";
  form.method = 'POST';
  form.submit();
}

let toastTimer;
function showToast(msg, type) {
  const t = document.getElementById('egToast');
  t.textContent = msg;
  t.className = 'eg-toast show' + (type ? ' ' + type : '');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3400);
}
</script>

{% endblock %}