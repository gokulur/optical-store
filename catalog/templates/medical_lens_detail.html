{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %}{{ lens_option.lens_brand.name }} {{ lens_option.lens_type.name }} â€“ Al Ameen Optics{% endblock %}

{% block content %}
<style>
:root {
  --aa-ink:#0d0d0d;--aa-ink-soft:#555;--aa-gold:#b8976a;--aa-gold-lt:#d4b896;
  --aa-sand:#f7f3ed;--aa-muted:#8a8580;--aa-border:#e8e2d8;
  --aa-green:#2a7a2a;--aa-green-bg:#f0f7ee;
  --aa-radius:12px;--aa-shadow:0 4px 24px rgba(0,0,0,.08);
  --aa-ease:cubic-bezier(.4,0,.2,1);--aa-t:.26s;
}

/* â”€â”€ GALLERY (full engine) â”€â”€ */
.gal{display:grid;grid-template-columns:88px 1fr;gap:12px;position:sticky;top:90px;align-self:start;}
@media(max-width:960px){.gal{position:static;}}
@media(max-width:540px){.gal{grid-template-columns:1fr;}}
.gal__rail{display:flex;flex-direction:column;gap:8px;max-height:520px;overflow-y:auto;overflow-x:hidden;scrollbar-width:thin;scrollbar-color:#d4b896 transparent;padding:2px;}
.gal__rail::-webkit-scrollbar{width:3px;}.gal__rail::-webkit-scrollbar-thumb{background:#d4b896;border-radius:99px;}
@media(max-width:540px){.gal__rail{flex-direction:row;max-height:none;overflow-y:hidden;overflow-x:auto;order:2;}}
.gal__thumb{flex-shrink:0;width:84px;height:84px;border-radius:10px;overflow:hidden;border:2px solid var(--aa-border);background:var(--aa-sand);cursor:pointer;transition:border-color .2s,transform .2s;padding:0;}
@media(max-width:540px){.gal__thumb{width:68px;height:68px;}}
.gal__thumb img{width:100%;height:100%;object-fit:contain;padding:4px;display:block;}
.gal__thumb:hover{border-color:var(--aa-gold);transform:translateX(2px);}
@media(max-width:540px){.gal__thumb:hover{transform:translateY(-2px);}}
.gal__thumb.is-active{border-color:var(--aa-ink);box-shadow:0 0 0 1px var(--aa-ink);}
.gal__stage-wrap{position:relative;}
.gal__stage{position:relative;width:100%;aspect-ratio:1/1;border-radius:16px;overflow:hidden;background:var(--aa-sand);cursor:zoom-in;}
.gal__img{width:100%;height:100%;object-fit:contain;padding:24px;display:block;transition:opacity .18s ease;will-change:opacity;}
.gal__img.fading{opacity:0;}
.gal__placeholder{width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;color:var(--aa-gold);}
.gal__placeholder p{font-size:13px;color:var(--aa-muted);}
.gal__arr{position:absolute;top:50%;transform:translateY(-50%);width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,.9);border:1px solid rgba(0,0,0,.08);display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:10;box-shadow:0 2px 10px rgba(0,0,0,.12);opacity:0;pointer-events:none;transition:opacity .2s;color:#1a1a1a;}
.gal__stage:hover .gal__arr{opacity:1;pointer-events:auto;}
.gal__arr--prev{left:10px;}.gal__arr--next{right:10px;}
.gal__arr.hidden{display:none!important;}
.gal__counter{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);background:rgba(10,10,10,.45);backdrop-filter:blur(6px);color:#fff;font-size:11px;font-weight:700;letter-spacing:.1em;padding:4px 12px;border-radius:99px;pointer-events:none;}
.gal__counter.solo{display:none;}
.gal__fs{position:absolute;bottom:12px;right:12px;width:34px;height:34px;border-radius:8px;background:rgba(255,255,255,.88);border:1px solid rgba(0,0,0,.07);display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:10;opacity:0;pointer-events:none;transition:opacity .2s;}
.gal__stage:hover .gal__fs{opacity:1;pointer-events:auto;}
.gal__lb{display:none;position:fixed;inset:0;z-index:99999;background:rgba(6,6,6,.96);backdrop-filter:blur(16px);flex-direction:column;align-items:center;justify-content:center;gap:18px;}
.gal__lb.open{display:flex;}
.gal__lb-close{position:fixed;top:18px;right:22px;width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;}
.gal__lb-img{max-width:88vw;max-height:76vh;object-fit:contain;border-radius:12px;}
.gal__lb-nav{position:fixed;top:50%;transform:translateY(-50%);width:50px;height:50px;border-radius:50%;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.18);color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;}
.gal__lb-nav--prev{left:18px;}.gal__lb-nav--next{right:18px;}
.gal__lb-strip{display:flex;gap:8px;overflow-x:auto;max-width:90vw;scrollbar-width:thin;}
.gal__lb-dot{flex-shrink:0;width:58px;height:58px;border-radius:8px;overflow:hidden;border:2.5px solid rgba(255,255,255,.15);cursor:pointer;transition:border-color .2s;}
.gal__lb-dot img{width:100%;height:100%;object-fit:contain;padding:3px;}
.gal__lb-dot.active{border-color:#d4b896;}
.gal__lb-count{position:fixed;top:24px;left:50%;transform:translateX(-50%);color:rgba(255,255,255,.5);font-size:13px;font-weight:600;letter-spacing:.1em;}

/* â”€â”€ PAGE â”€â”€ */
.pd-page{max-width:1340px;margin:0 auto;padding:0 24px 100px;}
.pd-crumb{display:flex;align-items:center;gap:6px;flex-wrap:wrap;padding:16px 0 28px;font-size:12px;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:var(--aa-muted);}
.pd-crumb a{color:var(--aa-muted);text-decoration:none;}.pd-crumb a:hover{color:var(--aa-ink);}
.pd-crumb-sep{font-size:10px;color:#ccc;}
.pd-grid{display:grid;grid-template-columns:1fr 1fr;gap:60px;align-items:start;}
@media(max-width:960px){.pd-grid{grid-template-columns:1fr;gap:32px;}}

/* â”€â”€ INFO â”€â”€ */
.pi{display:flex;flex-direction:column;}
.pi__badges{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:14px;}
.pi__badge{font-size:10px;font-weight:800;letter-spacing:.1em;text-transform:uppercase;padding:4px 10px;border-radius:4px;}
.pi__badge--brand{background:var(--aa-sand);color:var(--aa-gold);}
.pi__badge--type{background:#e8f0f5;color:#3a6a9a;}
.pi__title{font-size:clamp(22px,2.6vw,32px);font-weight:800;line-height:1.15;color:var(--aa-ink);letter-spacing:-.03em;margin:0 0 10px;}
.pi__meta{display:flex;align-items:center;gap:14px;margin-bottom:6px;flex-wrap:wrap;}
.pi__brand{font-size:13px;color:var(--aa-muted);}.pi__brand strong{color:var(--aa-ink);}
.pi__price-box{display:flex;align-items:baseline;gap:12px;flex-wrap:wrap;padding:18px 22px;border-radius:var(--aa-radius);background:var(--aa-sand);border:1px solid rgba(184,151,106,.18);margin:20px 0 22px;}
.pi__price{font-size:34px;font-weight:900;color:var(--aa-ink);letter-spacing:-.04em;}
.pi__price-was{font-size:17px;color:var(--aa-muted);text-decoration:line-through;}
.pi__lbl{font-size:11px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--aa-muted);margin-bottom:10px;}
.pi__specs-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px;}
.pi__spec-card{background:var(--aa-sand);border-radius:10px;padding:14px 16px;display:flex;flex-direction:column;gap:4px;}
.pi__spec-card__lbl{font-size:11px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--aa-muted);}
.pi__spec-card__val{font-size:15px;font-weight:700;color:var(--aa-ink);}
.pi__coatings{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:24px;}
.pi__coating-chip{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:20px;border:1px solid var(--aa-border);background:#fff;font-size:12px;font-weight:600;color:var(--aa-ink);}
.pi__coating-chip svg{color:var(--aa-gold);}
.pi__compat-note{display:flex;align-items:flex-start;gap:8px;background:var(--aa-green-bg);border:1px solid #3a8a2e;color:#2a6a20;border-radius:8px;padding:12px 16px;font-size:13px;font-weight:600;margin-bottom:22px;}
.pi__qty-wrap{margin-bottom:22px;}
.pi__qty{display:inline-flex;align-items:center;border:2px solid var(--aa-border);border-radius:var(--aa-radius);overflow:hidden;}
.pi__qty-btn{width:46px;height:46px;border:none;background:var(--aa-sand);font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--aa-ink);transition:background var(--aa-t);line-height:1;}
.pi__qty-btn:hover{background:var(--aa-border);}
.pi__qty-num{width:56px;height:46px;border:none;border-left:2px solid var(--aa-border);border-right:2px solid var(--aa-border);text-align:center;font-size:16px;font-weight:700;color:var(--aa-ink);background:#fff;}
.pi__qty-num:focus{outline:none;}
/* Rx table */
.pi__rx{background:var(--aa-sand);border-radius:var(--aa-radius);padding:18px;margin-bottom:22px;}
.pi__rx-title{font-size:14px;font-weight:700;color:var(--aa-ink);margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.pi__rx-tbl{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden;}
.pi__rx-tbl th{background:var(--aa-ink);color:#fff;padding:9px 12px;font-size:13px;font-weight:600;text-align:left;}
.pi__rx-tbl td{padding:9px 12px;border-bottom:1px solid var(--aa-border);}
.pi__rx-tbl tr:last-child td{border-bottom:none;}
.pi__rx-tbl td:first-child{font-weight:600;font-size:13px;white-space:nowrap;}
.pi__rx-inp{width:100%;padding:7px 10px;border:1.5px solid var(--aa-border);border-radius:6px;font-size:13px;min-width:60px;transition:border-color var(--aa-t);}
.pi__rx-inp:focus{border-color:var(--aa-gold);outline:none;}
.pi__cta{display:flex;flex-direction:column;gap:12px;margin-bottom:26px;}
.pi__btn{width:100%;padding:17px 24px;border-radius:50px;font-size:14px;font-weight:800;letter-spacing:.06em;text-transform:uppercase;cursor:pointer;transition:all var(--aa-t);border:2px solid transparent;}
.pi__btn--cart{background:var(--aa-ink);border-color:var(--aa-ink);color:#fff;}
.pi__btn--cart:hover{background:#2a2a2a;}
.pi__btn--buy{background:var(--aa-gold);border-color:var(--aa-gold);color:#fff;}
.pi__btn--buy:hover{background:#a07050;border-color:#a07050;}
.pi__trust{background:var(--aa-sand);border-radius:var(--aa-radius);padding:16px 20px;display:flex;flex-direction:column;gap:12px;border:1px solid rgba(184,151,106,.18);margin-bottom:24px;}
.pi__trust-row{display:flex;align-items:center;gap:12px;font-size:13px;color:var(--aa-ink);}
.pi__trust-icon{width:34px;height:34px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 1px 6px rgba(0,0,0,.07);}
.pi__trust-icon svg{width:15px;height:15px;color:var(--aa-gold);}
.pd-section{padding:52px 0;border-top:1px solid var(--aa-border);}
.pd-section__h{font-size:22px;font-weight:800;color:var(--aa-ink);margin-bottom:18px;letter-spacing:-.02em;}
.pd-section__body{font-size:15px;line-height:1.85;color:var(--aa-ink-soft);}
.pd-rel-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:18px;margin-top:24px;}
@media(max-width:860px){.pd-rel-grid{grid-template-columns:repeat(2,1fr);}}
.pd-rel-card{text-decoration:none;color:inherit;display:block;border-radius:var(--aa-radius);overflow:hidden;border:1px solid var(--aa-border);background:#fff;transition:all var(--aa-t);}
.pd-rel-card:hover{transform:translateY(-4px);box-shadow:var(--aa-shadow);border-color:var(--aa-gold-lt);}
.pd-rel-card__img{aspect-ratio:1/1;background:var(--aa-sand);overflow:hidden;display:flex;align-items:center;justify-content:center;}
.pd-rel-card__img img{width:100%;height:100%;object-fit:contain;padding:10px;transition:transform .4s;display:block;}
.pd-rel-card:hover .pd-rel-card__img img{transform:scale(1.06);}
.pd-rel-card__info{padding:14px;}
.pd-rel-card__brand{font-size:10px;color:var(--aa-gold);font-weight:700;text-transform:uppercase;letter-spacing:.08em;}
.pd-rel-card__name{font-size:14px;font-weight:700;margin:4px 0;color:var(--aa-ink);line-height:1.3;}
.pd-rel-card__idx{font-size:12px;color:var(--aa-muted);}
.pd-rel-card__price{font-size:15px;font-weight:800;color:var(--aa-ink);}
.pd-toast{position:fixed;bottom:28px;right:28px;z-index:99999;padding:14px 22px;border-radius:var(--aa-radius);font-size:14px;font-weight:700;color:#fff;box-shadow:0 8px 32px rgba(0,0,0,.2);pointer-events:none;transform:translateY(70px);opacity:0;transition:all .32s var(--aa-ease);max-width:320px;background:var(--aa-ink);}
.pd-toast.is-show{transform:translateY(0);opacity:1;}
.pd-toast--ok{background:var(--aa-green)!important;}
.pd-toast--err{background:#c03020!important;}
</style>

<div class="pd-page">
  <nav class="pd-crumb">
    <a href="{% url 'home' %}">Home</a>
    <span class="pd-crumb-sep">â€º</span>
    <a href="{% url 'catalog:medical_lenses_list' %}">Medical Lenses</a>
    <span class="pd-crumb-sep">â€º</span>
    <span>{{ lens_option.lens_brand.name }} {{ lens_option.lens_type.name }}</span>
  </nav>

  <div class="pd-grid">

    <!-- â•â• GALLERY â•â• -->
    <div>
      <div class="gal" id="galRoot">
        <div class="gal__rail" id="galRail">
          {% if lens_option.image %}
          <div class="gal__thumb is-active" data-src="{{ lens_option.image.url }}" tabindex="0">
            <img src="{{ lens_option.image.url }}" alt="{{ lens_option.lens_brand.name }}" loading="eager">
          </div>
          {% for img in lens_option.images.all %}
          <div class="gal__thumb" data-src="{{ img.image.url }}" tabindex="0">
            <img src="{{ img.image.url }}" alt="{{ lens_option.lens_brand.name }}" loading="lazy">
          </div>
          {% endfor %}
          {% endif %}
        </div>
        <div class="gal__stage-wrap">
          <div class="gal__stage" id="galStage" tabindex="0">
            {% if lens_option.image %}
            <img class="gal__img" id="galMain" src="{{ lens_option.image.url }}" alt="{{ lens_option.lens_brand.name }}">
            {% else %}
            <div class="gal__placeholder">
              <svg width="80" height="80" viewBox="0 0 80 80" fill="none"><ellipse cx="25" cy="40" rx="18" ry="14" stroke="currentColor" stroke-width="3" fill="none"/><ellipse cx="55" cy="40" rx="18" ry="14" stroke="currentColor" stroke-width="3" fill="none"/><path d="M43 40H37" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg>
              <p>Medical Lens</p>
            </div>
            {% endif %}
            <button class="gal__arr gal__arr--prev hidden" id="galPrev" type="button" aria-label="Previous"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg></button>
            <button class="gal__arr gal__arr--next hidden" id="galNext" type="button" aria-label="Next"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="9 18 15 12 9 6"/></svg></button>
            <span class="gal__counter solo" id="galCounter">1 / 1</span>
            <button class="gal__fs" id="galFs" type="button" aria-label="Fullscreen"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></button>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â• PRODUCT INFO â•â• -->
    <div class="pi">
      <div class="pi__badges">
        {% if lens_option.lens_brand %}<span class="pi__badge pi__badge--brand">{{ lens_option.lens_brand.name }}</span>{% endif %}
        {% if lens_option.lens_type %}<span class="pi__badge pi__badge--type">{{ lens_option.lens_type.name }}</span>{% endif %}
      </div>

      <h1 class="pi__title">{{ lens_option.lens_brand.name }} {{ lens_option.lens_type.name }}{% if lens_option.index %} â€“ Index {{ lens_option.index }}{% endif %}</h1>
      <div class="pi__meta">
        {% if lens_option.lens_brand %}<span class="pi__brand">Brand: <strong>{{ lens_option.lens_brand.name }}</strong></span>{% endif %}
      </div>

      <div class="pi__price-box">
        <span class="pi__price">QAR {{ lens_option.base_price }}</span>
        {% if lens_option.compare_at_price %}<span class="pi__price-was">QAR {{ lens_option.compare_at_price }}</span>{% endif %}
      </div>

      <!-- Key Specs Grid -->
      <div class="pi__specs-grid">
        {% if lens_option.index %}
        <div class="pi__spec-card"><span class="pi__spec-card__lbl">Lens Index</span><span class="pi__spec-card__val">{{ lens_option.index }}</span></div>
        {% endif %}
        {% if lens_option.lens_type %}
        <div class="pi__spec-card"><span class="pi__spec-card__lbl">Lens Type</span><span class="pi__spec-card__val">{{ lens_option.lens_type.name }}</span></div>
        {% endif %}
        {% if lens_option.min_power and lens_option.max_power %}
        <div class="pi__spec-card"><span class="pi__spec-card__lbl">Power Range (SPH)</span><span class="pi__spec-card__val">{{ lens_option.min_power }} to {{ lens_option.max_power }}</span></div>
        {% endif %}
        {% if lens_option.max_cyl %}
        <div class="pi__spec-card"><span class="pi__spec-card__lbl">Max CYL</span><span class="pi__spec-card__val">{{ lens_option.max_cyl }}</span></div>
        {% endif %}
      </div>

      {% if lens_option.coatings.all %}
      <p class="pi__lbl">Coatings & Features</p>
      <div class="pi__coatings">
        {% for coating in lens_option.coatings.all %}
        <div class="pi__coating-chip">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
          {{ coating.name }}
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <div class="pi__compat-note">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        <span>Compatible with all frames sold in our store â€” fitting included</span>
      </div>

      <form id="pdForm" onsubmit="return false;">
        {% csrf_token %}
        <input type="hidden" name="lens_option_id" value="{{ lens_option.id }}">
        <input type="hidden" name="right_sph" id="h_rSph">
        <input type="hidden" name="right_cyl" id="h_rCyl">
        <input type="hidden" name="right_axis" id="h_rAxis">
        <input type="hidden" name="right_add" id="h_rAdd">
        <input type="hidden" name="left_sph" id="h_lSph">
        <input type="hidden" name="left_cyl" id="h_lCyl">
        <input type="hidden" name="left_axis" id="h_lAxis">
        <input type="hidden" name="left_add" id="h_lAdd">

        <!-- Rx Entry -->
        <div class="pi__rx">
          <p class="pi__rx-title">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="2" width="6" height="4" rx="1"/><path d="M9 2H7a2 2 0 00-2 2v16a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2h-2"/><line x1="9" y1="12" x2="15" y2="12"/></svg>
            Prescription â€” Optional (can be added later)
          </p>
          <div style="overflow-x:auto;">
            <table class="pi__rx-tbl">
              <thead><tr><th>Eye</th><th>SPH</th><th>CYL</th><th>AXIS</th><th>ADD</th></tr></thead>
              <tbody>
                <tr><td><strong>Right (OD)</strong></td><td><input class="pi__rx-inp" type="number" step="0.25" placeholder="-1.50" id="m_rSph" oninput="syncRx()"></td><td><input class="pi__rx-inp" type="number" step="0.25" placeholder="-0.50" id="m_rCyl" oninput="syncRx()"></td><td><input class="pi__rx-inp" type="number" min="0" max="180" placeholder="0â€“180" id="m_rAxis" oninput="syncRx()"></td><td><input class="pi__rx-inp" type="number" step="0.25" placeholder="+1.00" id="m_rAdd" oninput="syncRx()"></td></tr>
                <tr><td><strong>Left (OS)</strong></td><td><input class="pi__rx-inp" type="number" step="0.25" placeholder="-2.00" id="m_lSph" oninput="syncRx()"></td><td><input class="pi__rx-inp" type="number" step="0.25" placeholder="-0.75" id="m_lCyl" oninput="syncRx()"></td><td><input class="pi__rx-inp" type="number" min="0" max="180" placeholder="0â€“180" id="m_lAxis" oninput="syncRx()"></td><td><input class="pi__rx-inp" type="number" step="0.25" placeholder="+1.00" id="m_lAdd" oninput="syncRx()"></td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <p class="pi__lbl">Quantity</p>
        <div class="pi__qty-wrap">
          <div class="pi__qty">
            <button type="button" class="pi__qty-btn" onclick="chQty(-1)">âˆ’</button>
            <input class="pi__qty-num" type="number" id="qtyVal" name="quantity" value="1" min="1" max="99" readonly>
            <button type="button" class="pi__qty-btn" onclick="chQty(1)">+</button>
          </div>
        </div>

        <div class="pi__cta">
          <button type="button" class="pi__btn pi__btn--cart" id="cartBtn" onclick="addCart()">
            <svg style="width:16px;height:16px;vertical-align:middle;margin-right:6px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg>Add to Cart
          </button>
          <button type="button" class="pi__btn pi__btn--buy" onclick="buyNow()">Buy it Now â†’</button>
        </div>
      </form>

      <div class="pi__trust">
        <div class="pi__trust-row"><div class="pi__trust-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13" rx="1"/><path d="M16 8h4l3 5v3h-7V8z"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg></div><span>Delivery <strong>5â€“10 business days</strong> (lens processing included)</span></div>
        <div class="pi__trust-row"><div class="pi__trust-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></div><span>Free returns within <strong>45 days</strong></span></div>
        <div class="pi__trust-row"><div class="pi__trust-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M9 12l2 2 4-4"/></svg></div><span><strong>100% Authentic</strong> guaranteed</span></div>
      </div>
    </div>
  </div>

  {% if lens_option.description %}
  <div class="pd-section"><h2 class="pd-section__h">About This Lens</h2><div class="pd-section__body">{{ lens_option.description|linebreaksbr }}</div></div>
  {% endif %}

  {% if related_lens_options %}
  <div class="pd-section">
    <h2 class="pd-section__h">You May Also Like</h2>
    <div class="pd-rel-grid">
      {% for r in related_lens_options %}
      <a href="{% url 'catalog:medical_lens_detail' r.id %}" class="pd-rel-card">
        <div class="pd-rel-card__img">
          {% if r.image %}<img src="{{ r.image.url }}" alt="{{ r.lens_brand.name }}" loading="lazy">
          {% else %}<svg width="48" height="48" viewBox="0 0 80 80" fill="none"><ellipse cx="25" cy="40" rx="18" ry="14" stroke="#b8976a" stroke-width="3" fill="none"/><ellipse cx="55" cy="40" rx="18" ry="14" stroke="#b8976a" stroke-width="3" fill="none"/><path d="M43 40H37" stroke="#b8976a" stroke-width="3" stroke-linecap="round"/></svg>{% endif %}
        </div>
        <div class="pd-rel-card__info">
          {% if r.lens_brand %}<p class="pd-rel-card__brand">{{ r.lens_brand.name }}</p>{% endif %}
          <p class="pd-rel-card__name">{{ r.lens_type.name }}</p>
          {% if r.index %}<p class="pd-rel-card__idx">Index {{ r.index }}</p>{% endif %}
          <p class="pd-rel-card__price">QAR {{ r.base_price }}</p>
        </div>
      </a>
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>

<!-- LIGHTBOX -->
<div class="gal__lb" id="galLb">
  <button class="gal__lb-close" onclick="GAL.closeLb()" aria-label="Close"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
  <button class="gal__lb-nav gal__lb-nav--prev" onclick="GAL.lbNav(-1)" aria-label="Previous"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg></button>
  <img class="gal__lb-img" id="lbImg" src="" alt="">
  <button class="gal__lb-nav gal__lb-nav--next" onclick="GAL.lbNav(1)" aria-label="Next"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="9 18 15 12 9 6"/></svg></button>
  <div class="gal__lb-strip" id="lbStrip"></div>
  <span class="gal__lb-count" id="lbCount"></span>
</div>
<div class="pd-toast" id="pdToast"></div>

<script>
var GAL=(function(){
  var thumbEls,srcs,cur=0,total=0,mainImg,counter,lb,lbImg,lbStrip,lbCount;
  function init(){
    thumbEls=Array.from(document.querySelectorAll('#galRail .gal__thumb'));
    srcs=thumbEls.map(function(t){return t.dataset.src||'';});
    total=srcs.length;mainImg=document.getElementById('galMain');counter=document.getElementById('galCounter');
    lb=document.getElementById('galLb');lbImg=document.getElementById('lbImg');lbStrip=document.getElementById('lbStrip');lbCount=document.getElementById('lbCount');
    if(!mainImg||total===0)return;
    srcs.forEach(function(src,i){var d=document.createElement('div');d.className='gal__lb-dot'+(i===0?' active':'');var im=document.createElement('img');im.src=src;im.loading='lazy';d.appendChild(im);d.addEventListener('click',function(){lbGoTo(i);});lbStrip.appendChild(d);});
    if(total>1){document.getElementById('galPrev').classList.remove('hidden');document.getElementById('galNext').classList.remove('hidden');counter.classList.remove('solo');}
    updateCounter();
    thumbEls.forEach(function(t,i){t.addEventListener('click',function(){goTo(i);});t.addEventListener('keydown',function(e){if(e.key==='Enter'||e.key===' '){e.preventDefault();goTo(i);}});});
    document.getElementById('galPrev').addEventListener('click',function(e){e.stopPropagation();goTo(cur-1);});
    document.getElementById('galNext').addEventListener('click',function(e){e.stopPropagation();goTo(cur+1);});
    document.getElementById('galFs').addEventListener('click',function(e){e.stopPropagation();openLb();});
    document.getElementById('galStage').addEventListener('click',function(e){if(e.target.closest('#galPrev,#galNext,#galFs'))return;openLb();});
    document.getElementById('galStage').addEventListener('keydown',function(e){if(e.key==='ArrowLeft')goTo(cur-1);if(e.key==='ArrowRight')goTo(cur+1);if(e.key==='Enter')openLb();});
    var txS=0;
    document.getElementById('galStage').addEventListener('touchstart',function(e){txS=e.changedTouches[0].screenX;},{passive:true});
    document.getElementById('galStage').addEventListener('touchend',function(e){var dx=txS-e.changedTouches[0].screenX;if(Math.abs(dx)>50){dx>0?goTo(cur+1):goTo(cur-1);}},{passive:true});
    lb.addEventListener('click',function(e){if(e.target===lb)closeLb();});
  }
  function goTo(idx){if(idx<0)idx=total-1;if(idx>=total)idx=0;var newSrc=srcs[idx];if(!newSrc)return;mainImg.classList.add('fading');var tmp=new Image();tmp.onload=tmp.onerror=function(){mainImg.src=newSrc;mainImg.classList.remove('fading');};tmp.src=newSrc;thumbEls.forEach(function(t,i){t.classList.toggle('is-active',i===idx);});if(thumbEls[idx])thumbEls[idx].scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'});cur=idx;updateCounter();if(lb.classList.contains('open'))lbGoTo(idx);}
  function updateCounter(){if(counter)counter.textContent=(cur+1)+' / '+total;var dots=lbStrip?lbStrip.querySelectorAll('.gal__lb-dot'):[];Array.from(dots).forEach(function(d,i){d.classList.toggle('active',i===cur);});if(lbCount)lbCount.textContent=(cur+1)+' / '+total;}
  function openLb(){lbGoTo(cur);lb.classList.add('open');document.body.style.overflow='hidden';}
  function closeLb(){lb.classList.remove('open');document.body.style.overflow='';}
  function lbGoTo(idx){if(idx<0)idx=total-1;if(idx>=total)idx=0;lbImg.style.opacity='0';lbImg.style.transform='scale(.94)';lbImg.style.transition='opacity .22s,transform .22s';setTimeout(function(){lbImg.src=srcs[idx];lbImg.style.opacity='1';lbImg.style.transform='scale(1)';},110);cur=idx;updateCounter();var dots=lbStrip.querySelectorAll('.gal__lb-dot');Array.from(dots).forEach(function(d,i){d.classList.toggle('active',i===idx);});if(dots[idx])dots[idx].scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'});}
  document.addEventListener('keydown',function(e){if(!lb||!lb.classList.contains('open'))return;if(e.key==='ArrowLeft')lbGoTo(cur-1);if(e.key==='ArrowRight')lbGoTo(cur+1);if(e.key==='Escape')closeLb();});
  if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',init);else init();
  return{goTo:goTo,openLb:openLb,closeLb:closeLb,lbNav:function(d){lbGoTo(cur+d);}};
})();

function getCsrf(){var m=document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/);return m?decodeURIComponent(m[1]):'';}
var _tt;
function toast(msg,type){if(typeof window.showToast==='function'){window.showToast(msg,type==='ok'?'success':type==='err'?'error':'info');return;}var t=document.getElementById('pdToast');t.textContent=msg;t.className='pd-toast is-show'+(type?' pd-toast--'+type:'');clearTimeout(_tt);_tt=setTimeout(function(){t.classList.remove('is-show');},3400);}
function chQty(d){var i=document.getElementById('qtyVal');i.value=Math.min(Math.max(1,parseInt(i.value)+d),99);}
function syncRx(){
  ['rSph','rCyl','rAxis','rAdd','lSph','lCyl','lAxis','lAdd'].forEach(function(k){
    document.getElementById('h_'+k).value=document.getElementById('m_'+k).value||'';
  });
}
function buildFd(){
  syncRx();
  var fd=new FormData();
  fd.append('csrfmiddlewaretoken',getCsrf());fd.append('lens_option_id','{{ lens_option.id }}');
  fd.append('quantity',document.getElementById('qtyVal').value);
  ['rSph','rCyl','rAxis','rAdd','lSph','lCyl','lAxis','lAdd'].forEach(function(k){fd.append(k.replace('r','right_').replace('l','left_'),document.getElementById('h_'+k).value);});
  return fd;
}
function addCart(){
  var btn=document.getElementById('cartBtn');var orig=btn.innerHTML;btn.textContent='Addingâ€¦';btn.disabled=true;
  fetch("{% url 'cart:add_medical_lens_to_cart' %}",{method:'POST',body:buildFd(),headers:{'X-Requested-With':'XMLHttpRequest'}})
  .then(function(r){return r.json();})
  .then(function(d){btn.innerHTML=orig;btn.disabled=false;if(d.success){toast('ðŸ›’ Added to cart!','ok');if(typeof window.updateCartBadge==='function')window.updateCartBadge(d.cart_count||0);}else toast(d.message||'Error','err');})
  .catch(function(){btn.innerHTML=orig;btn.disabled=false;toast('Network error','err');});
}
function buyNow(){
  var form=document.getElementById('pdForm');
  syncRx();form.action="{% url 'orders:checkout' %}";form.method='POST';form.submit();
}
document.addEventListener('keydown',function(e){if(e.key==='Escape')GAL.closeLb();});
</script>
{% endblock %}