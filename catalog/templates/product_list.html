{% extends 'base.html' %}
{% load static %}
{% block title %}Accessories - Optical Store{% endblock %}

{% block content %}
<main class="content-for-layout focus-none" id="xo-main-content" role="main" tabindex="-1">

  <!-- Collection Title Banner -->
  <div class="shopify-section" id="shopify-section-collection-title">
    <section class="xo-section color-inverse"
             style="--bg-color:#f3f3f3;--margin:0;--pt:110;--pb:110;--pt-mobile:50px;--pb-mobile:50px;">
      <div class="collection-title">
        <h2 class="collection-title__title">Accessories</h2>
        <nav aria-label="breadcrumb" class="breadcrumb" role="navigation" style="--display-mobile:block">
          <ol class="breadcrumb__list" style="--justify:center">
            <li class="breadcrumb__item">
              <a class="breadcrumb__link" href="{% url 'home' %}">Home</a>
              <span class="breadcrumb__separator">
                <svg height="8" viewBox="0 0 320 512" xmlns="http://www.w3.org/2000/svg">
                  <path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"/>
                </svg>
              </span>
            </li>
            <li class="breadcrumb__item breadcrumb__item--current" style="--display:block">
              <a aria-current="page" class="breadcrumb__link breadcrumb--current" href="#" style="--display:block">Accessories</a>
            </li>
          </ol>
        </nav>
      </div>
    </section>
  </div>

  <!-- Main Collection Products Section -->
  <section class="shopify-section section-collection-products" id="shopify-section-main-collection">
    <div class="xo-section color-background-1" style="--margin:0;--pt:50;--pb:50;z-index:99">
      <xo-filters xo-money-format="QAR 1.00" xo-section-id="main-collection">
        <xo-container class="xo-container--box">

          <!-- Refine bar -->
          <xo-filters-refine class="xo-filters-refine">
            <xo-filters-clear xo-clear-all="" id="clear-all-btn" style="cursor:pointer;">Clear all</xo-filters-clear>
            <xo-filters-refine-clear-icon aria-label="Close">
              <svg aria-hidden="true" fill="none" focusable="false" viewBox="0 0 12 13" width="20" xmlns="http://www.w3.org/2000/svg">
                <path d="M8.48627 9.32917L2.82849 3.67098" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M2.88539 9.38504L8.42932 3.61524" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </xo-filters-refine-clear-icon>
          </xo-filters-refine>

          <xo-grid>
            <!-- ── SIDEBAR FILTERS ── -->
            <div aria-labelledby="verticalTitle"
                 class="main-collection-style1__sidebar"
                 style="--xs:12;--sm:12;--md:4;--lg:3;overflow:hidden">

              <!-- Category Filter -->
              <div class="collection-sidebar__header">
                <h2 class="collection-sidebar__title" id="verticalTitle">CATEGORY</h2>
              </div>
              <div class="collection-sidebar__menu">
                {% for cat in categories %}
                <label class="field-checkbox-text" style="width:100%;cursor:pointer;display:block;">
                  <input class="field-checkbox-text__input category-filter-checkbox"
                         name="category" type="checkbox" value="{{ cat.slug }}"
                         {% if cat.slug in selected_categories %}checked{% endif %} />
                  <div class="field-checkbox-text__item" style="width:100%;display:flex;align-items:center;">
                    <span class="collection-sidebar__icon">
                      <svg height="11" viewBox="0 0 320 512" xmlns="http://www.w3.org/2000/svg">
                        <path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="rgba(var(--color-foreground))"/>
                      </svg>
                    </span>
                    <span class="field-checkbox-text__content">{{ cat.name }}</span>
                  </div>
                </label>
                {% empty %}
                <!-- No categories defined; show an "All" fallback -->
                <label class="field-checkbox-text" style="width:100%;cursor:pointer;display:block;">
                  <input class="field-checkbox-text__input category-filter-checkbox" name="category" type="checkbox" value="all" checked />
                  <div class="field-checkbox-text__item" style="width:100%;display:flex;align-items:center;">
                    <span class="collection-sidebar__icon">
                      <svg height="11" viewBox="0 0 320 512"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="rgba(var(--color-foreground))"/></svg>
                    </span>
                    <span class="field-checkbox-text__content">All</span>
                  </div>
                </label>
                {% endfor %}
              </div>

              <!-- Brands Filter -->
              <div class="fieldset-block__header">
                <h2 class="fieldset-block__title">BRANDS</h2>
              </div>
              <div class="fieldset-block__content fieldset-block__content--column">
                {% for brand in brands %}
                <xo-filters-field>
                  <label class="field-checkbox-text">
                    <input class="field-checkbox-text__input brand-filter-checkbox"
                           name="brand" type="checkbox" value="{{ brand.slug }}"
                           {% if brand.slug in selected_brands %}checked{% endif %} />
                    <div class="field-checkbox-text__item" style="width:100%;display:flex;align-items:center;">
                      <span class="field-checkbox-text__icon">
                        <svg height="12" viewBox="0 0 320 512"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="rgba(var(--color-foreground))"/></svg>
                      </span>
                      <span class="field-checkbox-text__content">{{ brand.name }}</span>
                    </div>
                  </label>
                </xo-filters-field>
                {% endfor %}
              </div>

              <!-- Price Filter -->
              <div class="fieldset-block__header">
                <h2 class="fieldset-block__title">PRICE</h2>
              </div>
              <div class="fieldset-block__content">
                <xo-filters-field style="width:100%;padding:0 0.1rem">
                  <div class="xo-field-price">
                    <div class="price-range-wrapper">
                      <div class="price-slider-container">
                        <input type="range" class="price-slider price-slider--min"
                               min="{{ price_range.min_price|default:0 }}"
                               max="{{ price_range.max_price|default:2000 }}"
                               value="{{ price_range.min_price|default:0 }}" step="5">
                        <input type="range" class="price-slider price-slider--max"
                               min="{{ price_range.min_price|default:0 }}"
                               max="{{ price_range.max_price|default:2000 }}"
                               value="{{ price_range.max_price|default:2000 }}" step="5">
                        <div class="price-slider-track"></div>
                        <div class="price-slider-fill"></div>
                      </div>
                    </div>
                    <div class="xo-field-price__input-group">
                      <div class="xo-field-price__label">Price:</div>
                      <span class="price-display price-display--min">QAR <span id="price-min-display">{{ price_range.min_price|default:0 }}</span></span>
                      <span>-</span>
                      <span class="price-display price-display--max">QAR <span id="price-max-display">{{ price_range.max_price|default:2000 }}</span></span>
                    </div>
                  </div>
                </xo-filters-field>
              </div>

              <!-- Sort -->
              <div class="fieldset-block__header">
                <h2 class="fieldset-block__title">SORT BY</h2>
              </div>
              <div class="fieldset-block__content fieldset-block__content--column" style="padding:0 10px 16px;">
                <xo-popover-trigger class="xo-field-select-custom-filter__trigger" xo-name="filter-select-sort-side">
                  <span class="xo-field-select-custom-filter__name" style="font-size:13px;">
                    {% if current_sort == 'base_price' %}Price: Low to High
                    {% elif current_sort == '-base_price' %}Price: High to Low
                    {% elif current_sort == 'name' %}Name: A-Z
                    {% else %}Newest{% endif %}
                  </span>
                  <svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 22" width="18"><polyline points="6 9 12 15 18 9"/></svg>
                </xo-popover-trigger>
                <xo-popover class="xo-field-select-custom-filter__popover xo-scrollbar" xo-name="filter-select-sort-side" xo-placement="bottom-right">
                  <xo-filters-field><label class="xo-field-select-custom-filter__check"><input {% if not current_sort or current_sort == '-created_at' %}checked{% endif %} class="xo-field-select-custom-filter__input sort-radio" name="sort_by" type="radio" value="-created_at"/><span class="xo-field-select-custom-filter__label">Newest</span></label></xo-filters-field>
                  <xo-filters-field><label class="xo-field-select-custom-filter__check"><input {% if current_sort == 'base_price' %}checked{% endif %} class="xo-field-select-custom-filter__input sort-radio" name="sort_by" type="radio" value="base_price"/><span class="xo-field-select-custom-filter__label">Price: Low to High</span></label></xo-filters-field>
                  <xo-filters-field><label class="xo-field-select-custom-filter__check"><input {% if current_sort == '-base_price' %}checked{% endif %} class="xo-field-select-custom-filter__input sort-radio" name="sort_by" type="radio" value="-base_price"/><span class="xo-field-select-custom-filter__label">Price: High to Low</span></label></xo-filters-field>
                  <xo-filters-field><label class="xo-field-select-custom-filter__check"><input {% if current_sort == 'name' %}checked{% endif %} class="xo-field-select-custom-filter__input sort-radio" name="sort_by" type="radio" value="name"/><span class="xo-field-select-custom-filter__label">Name: A-Z</span></label></xo-filters-field>
                </xo-popover>
              </div>
            </div>
            <!-- /SIDEBAR -->

            <!-- ── PRODUCTS AREA ── -->
            <div style="--xs:12;--sm:12;--md:8;--lg:9;--order-md:0">

              <!-- Toolbar -->
              <div class="main-collection-style1__header">
                <xo-modal-trigger class="main-collection-mobile__trigger" xo-name="collection-modal-mobile">
                  <svg style="enable-background:new 0 0 320.42 225;" viewBox="0 0 320.42 225" width="18">
                    <path d="M303.92,33H16.5C7.39,33,0,25.61,0,16.5v0C0,7.39,7.39,0,16.5,0h287.42c9.11,0,16.5,7.39,16.5,16.5v0 C320.42,25.61,313.04,33,303.92,33z" fill="currentColor"/>
                    <path d="M256.55,129H63.87c-9.11,0-16.5-7.39-16.5-16.5v0c0-9.11,7.39-16.5,16.5-16.5h192.68c9.11,0,16.5,7.39,16.5,16.5v0 C273.05,121.61,265.66,129,256.55,129z" fill="currentColor"/>
                    <path d="M208.05,225h-95.67c-9.11,0-16.5-7.39-16.5-16.5v0c0-9.11,7.39-16.5,16.5-16.5h95.67c9.11,0,16.5,7.39,16.5,16.5v0 C224.55,217.61,217.16,225,208.05,225z" fill="currentColor"/>
                  </svg>
                  <div class="main-collection-mobile__trigger-text">Filter</div>
                </xo-modal-trigger>

                <div class="xo-facets">
                  <div class="xo-facets__item">
                    <div class="xo-field-select-custom-filter">
                      <xo-popover-trigger class="xo-field-select-custom-filter__trigger" xo-name="filter-select-sort-top">
                        <xo-filters-sort-by-selected class="xo-field-select-custom-filter__name">
                          {% if current_sort == 'base_price' %}Price: Low to High
                          {% elif current_sort == '-base_price' %}Price: High to Low
                          {% elif current_sort == 'name' %}Name: A-Z
                          {% else %}Newest{% endif %}
                        </xo-filters-sort-by-selected>
                        <svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 22" width="20"><polyline points="6 9 12 15 18 9"/></svg>
                      </xo-popover-trigger>
                      <xo-popover class="xo-field-select-custom-filter__popover xo-scrollbar" xo-name="filter-select-sort-top" xo-placement="bottom-right">
                        <xo-filters-field><label class="xo-field-select-custom-filter__check"><input {% if not current_sort or current_sort == '-created_at' %}checked{% endif %} class="xo-field-select-custom-filter__input sort-radio" name="sort_by" type="radio" value="-created_at"/><span class="xo-field-select-custom-filter__label">Newest</span></label></xo-filters-field>
                        <xo-filters-field><label class="xo-field-select-custom-filter__check"><input {% if current_sort == 'base_price' %}checked{% endif %} class="xo-field-select-custom-filter__input sort-radio" name="sort_by" type="radio" value="base_price"/><span class="xo-field-select-custom-filter__label">Price: Low to High</span></label></xo-filters-field>
                        <xo-filters-field><label class="xo-field-select-custom-filter__check"><input {% if current_sort == '-base_price' %}checked{% endif %} class="xo-field-select-custom-filter__input sort-radio" name="sort_by" type="radio" value="-base_price"/><span class="xo-field-select-custom-filter__label">Price: High to Low</span></label></xo-filters-field>
                        <xo-filters-field><label class="xo-field-select-custom-filter__check"><input {% if current_sort == 'name' %}checked{% endif %} class="xo-field-select-custom-filter__input sort-radio" name="sort_by" type="radio" value="name"/><span class="xo-field-select-custom-filter__label">Name: A-Z</span></label></xo-filters-field>
                      </xo-popover>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Loading indicator -->
              <div id="loading-indicator" style="display:none;text-align:center;padding:40px;">
                <div style="display:inline-block;width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #000;border-radius:50%;animation:spin 1s linear infinite;"></div>
              </div>

              <!-- Products Grid -->
              <xo-filters-content id="products-container">
                <div>
                  <xo-grid class="filters-content__grid" style="--xs:2;--sm:2;--md:2;--lg:3">
                    {% for product in products %}
                    <xo-product xo-product-id="{{ product.id }}" xo-section-id="main-collection">
                      <xo-animate class="xo-product-card xo-product-card--style9 color-background-1" xo-cascade="">
                        <div class="xo-product-card__header xo-product-card__header--style9">
                          <a href="{% url 'catalog:product_detail' product.slug %}">
                            <xo-product-media xo-type="auto">
                              <div class="xo-product-image">
                                <div class="xo-image" style="--xo-ratio-percent:1/1;">
                                  {% with first_image=product.images.first %}
                                  {% if first_image %}
                                  <img alt="{{ product.name }}" src="{{ first_image.image.url }}" width="1000" height="1000" loading="lazy"/>
                                  {% elif product.image %}
                                  <img alt="{{ product.name }}" src="{{ product.image.url }}" width="1000" height="1000" loading="lazy"/>
                                  {% else %}
                                  <img alt="No Image" src="{% static 'images/no-image.jpg' %}" width="1000" height="1000" loading="lazy"/>
                                  {% endif %}
                                  {% endwith %}
                                </div>
                              </div>
                            </xo-product-media>
                          </a>

                          {% if product.is_featured %}
                          <div class="xo-product-card__badge">
                            <div class="xo-badge-sale">Featured</div>
                          </div>
                          {% elif product.compare_at_price %}
                          <div class="xo-product-card__badge">
                            <div class="xo-badge-sale">Sale</div>
                          </div>
                          {% endif %}
                        </div>

                        <div class="xo-product-card__information">
                          {% if product.brand %}
                          <div style="font-size:12px;color:#999;text-transform:uppercase;margin-bottom:5px;">{{ product.brand.name }}</div>
                          {% endif %}

                          <h2 class="xo-product-card__title">
                            <a href="{% url 'catalog:product_detail' product.slug %}">{{ product.name }}</a>
                          </h2>

                          {% if product.category %}
                          <div style="font-size:12px;color:#666;margin:5px 0;">{{ product.category.name }}</div>
                          {% endif %}

                          <div class="xo-product-card__price">
                            <div class="xo-price">
                              <div class="xo-price__container">
                                <div class="xo-price__sale">
                                  <span class="xo-price__item xo-price__item--accent">QAR {{ product.base_price }}</span>
                                  {% if product.compare_at_price %}
                                  <span class="xo-price__item xo-price__item--regular" style="text-decoration:line-through;margin-left:8px;color:#999;">QAR {{ product.compare_at_price }}</span>
                                  {% endif %}
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </xo-animate>
                    </xo-product>
                    {% empty %}
                    <div style="grid-column:1/-1;text-align:center;padding:3rem;">
                      <h3>No accessories found</h3>
                      <p>Try adjusting your filters</p>
                    </div>
                    {% endfor %}
                  </xo-grid>

                  <!-- Pagination -->
                  {% if page_obj.has_other_pages %}
                  <xo-filters-paginate>
                    <nav aria-label="Pagination" class="xo-pagination">
                      <ul class="xo-pagination__list" role="list">
                        {% if page_obj.has_previous %}
                        <li>
                          <a aria-label="Previous page" class="xo-pagination__page xo-pagination__page--prev pagination-link"
                             href="#" data-page="{{ page_obj.previous_page_number }}">
                            <svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="20"><polyline points="15 18 9 12 15 6"/></svg>
                          </a>
                        </li>
                        {% endif %}
                        {% for page in page_obj.paginator.page_range %}
                        {% if page == page_obj.number %}
                        <li><span aria-current="page" class="xo-pagination__page xo-pagination__page--current">{{ page }}</span></li>
                        {% else %}
                        <li><a class="xo-pagination__page pagination-link" href="#" data-page="{{ page }}">{{ page }}</a></li>
                        {% endif %}
                        {% endfor %}
                        {% if page_obj.has_next %}
                        <li>
                          <a aria-label="Next page" class="xo-pagination__page xo-pagination__page--next pagination-link"
                             href="#" data-page="{{ page_obj.next_page_number }}">
                            <svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="20"><polyline points="9 18 15 12 9 6"/></svg>
                          </a>
                        </li>
                        {% endif %}
                      </ul>
                    </nav>
                  </xo-filters-paginate>
                  {% endif %}

                </div>
              </xo-filters-content>
            </div>
            <!-- /PRODUCTS AREA -->
          </xo-grid>
        </xo-container>
      </xo-filters>
    </div>
  </section>
</main>

<style>
@keyframes spin { to { transform: rotate(360deg); } }

.price-range-wrapper { width:100%; padding:20px 0; }
.price-slider-container { position:relative; width:100%; height:6px; margin-bottom:20px; }
.price-slider-track { position:absolute; width:100%; height:6px; background:#e0e0e0; border-radius:3px; top:0; left:0; }
.price-slider-fill { position:absolute; height:6px; background:linear-gradient(90deg,#000,#333); border-radius:3px; top:0; }
.price-slider {
  position:absolute; width:100%; height:6px; top:0; left:0; margin:0; padding:0;
  pointer-events:none; -webkit-appearance:none; appearance:none; background:transparent; z-index:5;
}
.price-slider::-webkit-slider-thumb {
  -webkit-appearance:none; width:20px; height:20px; border-radius:50%;
  background:#000; border:3px solid #fff; box-shadow:0 2px 8px rgba(0,0,0,.3);
  cursor:pointer; pointer-events:all; transition:all .2s;
}
.price-slider::-webkit-slider-thumb:hover { width:24px; height:24px; }
.price-slider::-moz-range-thumb {
  width:20px; height:20px; border-radius:50%; background:#000;
  border:3px solid #fff; box-shadow:0 2px 8px rgba(0,0,0,.3); cursor:pointer; pointer-events:all;
}
.xo-field-price__input-group { display:flex; align-items:center; justify-content:center; gap:8px; flex-wrap:wrap; padding:10px 0; }
.xo-field-price__label { font-weight:600; color:#333; }
.price-display { font-weight:600; color:#000; font-size:14px; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {

  // Category filter
  document.querySelectorAll('.category-filter-checkbox').forEach(cb => {
    cb.addEventListener('change', applyFilters);
  });

  // Brand filter
  document.querySelectorAll('.brand-filter-checkbox').forEach(cb => {
    cb.addEventListener('change', applyFilters);
  });

  // Price sliders
  const minSlider  = document.querySelector('.price-slider--min');
  const maxSlider  = document.querySelector('.price-slider--max');
  const minDisplay = document.getElementById('price-min-display');
  const maxDisplay = document.getElementById('price-max-display');
  const fill       = document.querySelector('.price-slider-fill');
  let debounceTimer;

  function updateSliders() {
    let minVal = parseInt(minSlider.value);
    let maxVal = parseInt(maxSlider.value);
    if (minVal > maxVal - 5) { minVal = maxVal - 5; minSlider.value = minVal; }
    const minPct = ((minVal - minSlider.min) / (minSlider.max - minSlider.min)) * 100;
    const maxPct = ((maxVal - maxSlider.min) / (maxSlider.max - maxSlider.min)) * 100;
    fill.style.left  = minPct + '%';
    fill.style.right = (100 - maxPct) + '%';
    minDisplay.textContent = minVal;
    maxDisplay.textContent = maxVal;
  }

  if (minSlider && maxSlider) {
    minSlider.addEventListener('input', updateSliders);
    maxSlider.addEventListener('input', updateSliders);
    minSlider.addEventListener('change', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(applyFilters, 500); });
    maxSlider.addEventListener('change', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(applyFilters, 500); });
    updateSliders();
  }

  // Sort radios
  document.querySelectorAll('.sort-radio').forEach(r => r.addEventListener('change', applyFilters));

  // Apply filters
  function applyFilters() {
    const params = new URLSearchParams();

    document.querySelectorAll('.category-filter-checkbox:checked').forEach(cb => {
      if (cb.value !== 'all') params.append('category', cb.value);
    });
    document.querySelectorAll('.brand-filter-checkbox:checked').forEach(cb => {
      params.append('brand', cb.value);
    });
    if (minSlider && maxSlider) {
      params.set('min_price', minSlider.value);
      params.set('max_price', maxSlider.value);
    }
    const sortVal = document.querySelector('.sort-radio:checked');
    if (sortVal) params.set('sort', sortVal.value);
    params.set('ajax', '1');

    const loading  = document.getElementById('loading-indicator');
    const products = document.getElementById('products-container');
    if (loading)  loading.style.display  = 'block';
    if (products) products.style.opacity = '0.5';

    fetch(`${window.location.pathname}?${params.toString()}`, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.text())
    .then(html => {
      const doc = new DOMParser().parseFromString(html, 'text/html');
      const newGrid = doc.querySelector('#products-container');
      if (newGrid && products) products.innerHTML = newGrid.innerHTML;
      params.delete('ajax');
      window.history.pushState({}, '', `${window.location.pathname}?${params.toString()}`);
    })
    .catch(console.error)
    .finally(() => {
      if (loading)  loading.style.display  = 'none';
      if (products) products.style.opacity = '1';
    });
  }

  // Pagination (AJAX)
  document.addEventListener('click', function (e) {
    const link = e.target.matches('.pagination-link') ? e.target : e.target.closest('.pagination-link');
    if (!link) return;
    e.preventDefault();
    const page = link.dataset.page;
    if (!page) return;
    const params = new URLSearchParams(window.location.search);
    params.set('page', page);
    params.set('ajax', '1');
    const loading  = document.getElementById('loading-indicator');
    const products = document.getElementById('products-container');
    if (loading)  loading.style.display  = 'block';
    if (products) products.style.opacity = '0.5';
    fetch(`${window.location.pathname}?${params.toString()}`, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.text())
    .then(html => {
      const doc    = new DOMParser().parseFromString(html, 'text/html');
      const newGrid = doc.querySelector('#products-container');
      if (newGrid && products) products.innerHTML = newGrid.innerHTML;
      params.delete('ajax');
      window.history.pushState({}, '', `${window.location.pathname}?${params.toString()}`);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    })
    .catch(console.error)
    .finally(() => {
      if (loading)  loading.style.display  = 'none';
      if (products) products.style.opacity = '1';
    });
  });

  // Clear all
  document.getElementById('clear-all-btn')?.addEventListener('click', () => {
    window.location.href = window.location.pathname;
  });
});
</script>
{% endblock %}