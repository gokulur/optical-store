{% extends 'base.html' %}
{% load static %}
{% block title %}Medical Lenses - Optical Store{% endblock %}

{% block content %}
<main class="content-for-layout focus-none" id="xo-main-content" role="main" tabindex="-1">
    
    <!-- Collection Title Section -->
    <div class="shopify-section" id="shopify-section-collection-title">
        <section class="xo-section color-inverse" style="--bg-color: #f3f3f3; --margin: 0; --pt: 110; --pb: 110; --pt-mobile: 50px; --pb-mobile: 50px;">
            <xo-animate class="xo-section-bg" style="--img-desktop: url({% static 'images/medical-lenses-banner.jpg' %}); --img-mobile: url({% static 'images/medical-lenses-banner.jpg' %});" xo-disabled="" xo-duration="1000">
                <xo-parallax class="xo-section-bg-image__item" xo-lerp-ease="0.4">
                    <xo-parallax-scroll class="xo-section-bg-image__url xo-background-lazyload" xo-keyframes="{'0%': { backgroundPositionY: '200px' },'100%': { backgroundPositionY: '-200px' },}"></xo-parallax-scroll>
                </xo-parallax>
            </xo-animate>
            
            <div class="collection-title">
                <xo-animate xo-cascade="">
                    <h2 class="collection-title__title">Medical Lenses</h2>
                </xo-animate>
                <xo-animate xo-cascade="">
                    <nav aria-label="breadcrumb" class="breadcrumb" role="navigation" style="--display-mobile:block">
                        <ol class="breadcrumb__list" style="--justify:center">
                            <li class="breadcrumb__item">
                                <a class="breadcrumb__link" href="{% url 'home' %}">Home</a>
                                <span class="breadcrumb__separator">
                                    <svg height="8" viewbox="0 0 320 512" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg>
                                </span>
                            </li>
                            <li class="breadcrumb__item breadcrumb__item--current" style="--display:block">
                                <a aria-current="page" class="breadcrumb__link breadcrumb--current" href="#" style="--display:block">Medical Lenses</a>
                            </li>
                        </ol>
                    </nav>
                </xo-animate>
            </div>
        </section>
    </div>

    <!-- Main Section -->
    <section class="shopify-section section-collection-products" id="shopify-section-main-collection">
        <div class="xo-section color-background-1" style="--margin: 0; --pt: 50; --pb: 50; z-index: 99">
            <xo-filters-top></xo-filters-top>
            <xo-filters xo-money-format="QAR 1.00" xo-section-id="main-collection">
                <xo-container class="xo-container--box">

                    <!-- Filters Refine Bar -->
                    <xo-filters-refine class="xo-filters-refine">
                        <xo-filters-clear xo-clear-all="" id="clear-all-btn" style="cursor: pointer;">Clear all</xo-filters-clear>
                        <xo-filters-refine-clear-icon aria-label="Close">
                            <svg aria-hidden="true" fill="none" focusable="false" viewbox="0 0 12 13" width="20" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8.48627 9.32917L2.82849 3.67098" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                                <path d="M2.88539 9.38504L8.42932 3.61524" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                            </svg>
                        </xo-filters-refine-clear-icon>
                    </xo-filters-refine>

                    <xo-grid>
                        <!-- SIDEBAR -->
                        <div aria-labelledby="verticalTitle" class="main-collection-style1__sidebar" style="--xs: 12; --sm: 12; --md: 4; --lg: 3; overflow:hidden">

                            <!-- Lens Brand Filter -->
                            <div class="collection-sidebar__header">
                                <h2 class="collection-sidebar__title" id="verticalTitle">LENS BRAND</h2>
                            </div>
                            <div class="fieldset-block__content fieldset-block__content--column">
                                {% for lens_brand in lens_brands %}
                                <xo-filters-field>
                                    <label class="field-checkbox-text" style="width: 100%; cursor: pointer; display: block;">
                                        <input class="field-checkbox-text__input lens-brand-filter-checkbox" name="lens_brand" type="checkbox" value="{{ lens_brand.slug }}" {% if lens_brand.slug in selected_lens_brands %}checked{% endif %} />
                                        <div class="field-checkbox-text__item" style="width: 100%; display: flex; align-items: center;">
                                            <span class="field-checkbox-text__icon">
                                                <svg height="11" viewbox="0 0 320 512" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="rgba(var(--color-foreground))"></path></svg>
                                            </span>
                                            <span class="field-checkbox-text__content">{{ lens_brand.name }}</span>
                                        </div>
                                    </label>
                                </xo-filters-field>
                                {% endfor %}
                            </div>

                            <!-- Lens Type Filter -->
                            <div class="fieldset-block__header">
                                <h2 class="fieldset-block__title">LENS TYPE</h2>
                            </div>
                            <div class="fieldset-block__content fieldset-block__content--column">
                                {% for lens_type in lens_types %}
                                <xo-filters-field>
                                    <label class="field-checkbox-text" style="width: 100%; cursor: pointer; display: block;">
                                        <input class="field-checkbox-text__input lens-type-filter-checkbox" name="lens_type" type="checkbox" value="{{ lens_type.slug }}" {% if lens_type.slug in selected_lens_types %}checked{% endif %} />
                                        <div class="field-checkbox-text__item" style="width: 100%; display: flex; align-items: center;">
                                            <span class="field-checkbox-text__icon">
                                                <svg height="11" viewbox="0 0 320 512" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="rgba(var(--color-foreground))"></path></svg>
                                            </span>
                                            <span class="field-checkbox-text__content">{{ lens_type.name }}</span>
                                        </div>
                                    </label>
                                </xo-filters-field>
                                {% endfor %}
                            </div>

                            <!-- Lens Index Filter -->
                            <div class="fieldset-block__header">
                                <h2 class="fieldset-block__title">LENS INDEX</h2>
                            </div>
                            <div class="fieldset-block__content fieldset-block__content--column">
                                {% for index_val in index_options %}
                                <xo-filters-field>
                                    <label class="field-checkbox-text" style="width: 100%; cursor: pointer; display: block;">
                                        <input class="field-checkbox-text__input index-filter-checkbox" name="index" type="checkbox" value="{{ index_val }}" {% if index_val|stringformat:"s" in selected_indexes %}checked{% endif %} />
                                        <div class="field-checkbox-text__item" style="width: 100%; display: flex; align-items: center;">
                                            <span class="field-checkbox-text__icon">
                                                <svg height="11" viewbox="0 0 320 512" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="rgba(var(--color-foreground))"></path></svg>
                                            </span>
                                            <span class="field-checkbox-text__content">Index {{ index_val }}</span>
                                        </div>
                                    </label>
                                </xo-filters-field>
                                {% endfor %}
                            </div>

                            <!-- Coating Filter -->
                            <div class="fieldset-block__header">
                                <h2 class="fieldset-block__title">COATING</h2>
                            </div>
                            <div class="fieldset-block__content fieldset-block__content--column">
                                <xo-filters-field>
                                    <label class="field-checkbox-text" style="width: 100%; cursor: pointer; display: block;">
                                        <input class="field-checkbox-text__input coating-filter-checkbox" name="coating" type="checkbox" value="anti_reflection" {% if 'anti_reflection' in selected_coatings %}checked{% endif %} />
                                        <div class="field-checkbox-text__item" style="width: 100%; display: flex; align-items: center;">
                                            <span class="field-checkbox-text__icon"><svg height="11" viewbox="0 0 320 512" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="rgba(var(--color-foreground))"></path></svg></span>
                                            <span class="field-checkbox-text__content">Anti-Reflection</span>
                                        </div>
                                    </label>
                                </xo-filters-field>
                                <xo-filters-field>
                                    <label class="field-checkbox-text" style="width: 100%; cursor: pointer; display: block;">
                                        <input class="field-checkbox-text__input coating-filter-checkbox" name="coating" type="checkbox" value="blue_light" {% if 'blue_light' in selected_coatings %}checked{% endif %} />
                                        <div class="field-checkbox-text__item" style="width: 100%; display: flex; align-items: center;">
                                            <span class="field-checkbox-text__icon"><svg height="11" viewbox="0 0 320 512" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="rgba(var(--color-foreground))"></path></svg></span>
                                            <span class="field-checkbox-text__content">Blue Light Filter</span>
                                        </div>
                                    </label>
                                </xo-filters-field>
                                <xo-filters-field>
                                    <label class="field-checkbox-text" style="width: 100%; cursor: pointer; display: block;">
                                        <input class="field-checkbox-text__input coating-filter-checkbox" name="coating" type="checkbox" value="photochromic" {% if 'photochromic' in selected_coatings %}checked{% endif %} />
                                        <div class="field-checkbox-text__item" style="width: 100%; display: flex; align-items: center;">
                                            <span class="field-checkbox-text__icon"><svg height="11" viewbox="0 0 320 512" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="rgba(var(--color-foreground))"></path></svg></span>
                                            <span class="field-checkbox-text__content">Photochromic (Transitions)</span>
                                        </div>
                                    </label>
                                </xo-filters-field>
                                <xo-filters-field>
                                    <label class="field-checkbox-text" style="width: 100%; cursor: pointer; display: block;">
                                        <input class="field-checkbox-text__input coating-filter-checkbox" name="coating" type="checkbox" value="uv_protection" {% if 'uv_protection' in selected_coatings %}checked{% endif %} />
                                        <div class="field-checkbox-text__item" style="width: 100%; display: flex; align-items: center;">
                                            <span class="field-checkbox-text__icon"><svg height="11" viewbox="0 0 320 512" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="rgba(var(--color-foreground))"></path></svg></span>
                                            <span class="field-checkbox-text__content">UV Protection</span>
                                        </div>
                                    </label>
                                </xo-filters-field>
                            </div>

                            <!-- Price Filter -->
                            <div class="fieldset-block__header">
                                <h2 class="fieldset-block__title">PRICE</h2>
                            </div>
                            <div class="fieldset-block__content">
                                <xo-filters-field style="width:100%; padding: 0 0.1rem">
                                    <div class="xo-field-price">
                                        <div class="price-range-wrapper">
                                            <div class="price-slider-container">
                                                <input type="range" class="price-slider price-slider--min" min="{{ price_range.min_price|default:0 }}" max="{{ price_range.max_price|default:3000 }}" value="{{ price_range.min_price|default:0 }}" step="10">
                                                <input type="range" class="price-slider price-slider--max" min="{{ price_range.min_price|default:0 }}" max="{{ price_range.max_price|default:3000 }}" value="{{ price_range.max_price|default:3000 }}" step="10">
                                                <div class="price-slider-track"></div>
                                                <div class="price-slider-fill"></div>
                                            </div>
                                        </div>
                                        <div class="xo-field-price__input-group">
                                            <div class="xo-field-price__label">Price:</div>
                                            <span class="price-display price-display--min">QAR <span id="price-min-display">0</span></span>
                                            <span>-</span>
                                            <span class="price-display price-display--max">QAR <span id="price-max-display">3000</span></span>
                                        </div>
                                    </div>
                                </xo-filters-field>
                            </div>
                        </div>

                        <!-- PRODUCTS AREA -->
                        <div style="--xs: 12; --sm: 12; --md: 8; --lg: 9; --order-md: 0">

                            <!-- Toolbar -->
                            <div class="main-collection-style1__header">
                                <xo-modal-trigger class="main-collection-mobile__trigger" xo-name="collection-modal-mobile">
                                    <svg style="enable-background:new 0 0 320.42 225;" viewbox="0 0 320.42 225" width="18">
                                        <path d="M303.92,33H16.5C7.39,33,0,25.61,0,16.5v0C0,7.39,7.39,0,16.5,0h287.42c9.11,0,16.5,7.39,16.5,16.5v0C320.42,25.61,313.04,33,303.92,33z" fill="currentColor"></path>
                                        <path d="M256.55,129H63.87c-9.11,0-16.5-7.39-16.5-16.5v0c0-9.11,7.39-16.5,16.5-16.5h192.68c9.11,0,16.5,7.39,16.5,16.5v0C273.05,121.61,265.66,129,256.55,129z" fill="currentColor"></path>
                                        <path d="M208.05,225h-95.67c-9.11,0-16.5-7.39-16.5-16.5v0c0-9.11,7.39-16.5,16.5-16.5h95.67c9.11,0,16.5,7.39,16.5,16.5v0C224.55,217.61,217.16,225,208.05,225z" fill="currentColor"></path>
                                    </svg>
                                    <div class="main-collection-mobile__trigger-text">Filter</div>
                                </xo-modal-trigger>

                                <!-- Sort -->
                                <div class="xo-facets">
                                    <div class="xo-facets__item">
                                        <div class="xo-field-select-custom-filter">
                                            <xo-popover-trigger class="xo-field-select-custom-filter__trigger" xo-name="filter-select-sort">
                                                <xo-filters-sort-by-selected class="xo-field-select-custom-filter__name">
                                                    {% if request.GET.sort == 'base_price' %}Price: Low to High
                                                    {% elif request.GET.sort == '-base_price' %}Price: High to Low
                                                    {% elif request.GET.sort == 'name' %}Name: A-Z
                                                    {% elif request.GET.sort == '-name' %}Name: Z-A
                                                    {% else %}Newest{% endif %}
                                                </xo-filters-sort-by-selected>
                                                <svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 22" width="20"><polyline points="6 9 12 15 18 9"></polyline></svg>
                                            </xo-popover-trigger>
                                            <xo-popover class="xo-field-select-custom-filter__popover xo-scrollbar" xo-name="filter-select-sort" xo-placement="bottom-right">
                                                <xo-filters-field><label class="xo-field-select-custom-filter__check"><input {% if not request.GET.sort or request.GET.sort == '-created_at' %}checked{% endif %} class="xo-field-select-custom-filter__input sort-radio" name="sort_by" type="radio" value="-created_at" /><span class="xo-field-select-custom-filter__label">Newest</span></label></xo-filters-field>
                                                <xo-filters-field><label class="xo-field-select-custom-filter__check"><input {% if request.GET.sort == 'base_price' %}checked{% endif %} class="xo-field-select-custom-filter__input sort-radio" name="sort_by" type="radio" value="base_price" /><span class="xo-field-select-custom-filter__label">Price: Low to High</span></label></xo-filters-field>
                                                <xo-filters-field><label class="xo-field-select-custom-filter__check"><input {% if request.GET.sort == '-base_price' %}checked{% endif %} class="xo-field-select-custom-filter__input sort-radio" name="sort_by" type="radio" value="-base_price" /><span class="xo-field-select-custom-filter__label">Price: High to Low</span></label></xo-filters-field>
                                                <xo-filters-field><label class="xo-field-select-custom-filter__check"><input {% if request.GET.sort == 'name' %}checked{% endif %} class="xo-field-select-custom-filter__input sort-radio" name="sort_by" type="radio" value="name" /><span class="xo-field-select-custom-filter__label">Name: A-Z</span></label></xo-filters-field>
                                                <xo-filters-field><label class="xo-field-select-custom-filter__check"><input {% if request.GET.sort == '-name' %}checked{% endif %} class="xo-field-select-custom-filter__input sort-radio" name="sort_by" type="radio" value="-name" /><span class="xo-field-select-custom-filter__label">Name: Z-A</span></label></xo-filters-field>
                                            </xo-popover>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Loading -->
                            <div id="loading-indicator" style="display: none; text-align: center; padding: 40px;">
                                <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #000; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            </div>

                            <!-- Products Grid -->
                            <xo-filters-content id="products-container">
                                <div>
                                    <xo-grid class="filters-content__grid" style="--xs: 2; --sm: 2; --md: 2; --lg: 3">
                                        {% for lens_option in lens_options %}
                                        <xo-product xo-product-id="{{ lens_option.id }}" xo-section-id="main-collection">
                                            <xo-animate class="xo-product-card xo-product-card--style9 color-background-1" xo-cascade="">
                                                <div class="xo-product-card__header xo-product-card__header--style9">
                                                    <a href="{% url 'catalog:medical_lens_detail' lens_option.id %}">
                                                        <xo-product-media xo-type="auto">
                                                            <div class="xo-product-image">
                                                                <div class="xo-image" style="--xo-ratio-percent: 1/1;">
                                                                    {% if lens_option.image %}
                                                                    <img alt="{{ lens_option.name }}" src="{{ lens_option.image.url }}" width="1000" height="1000" loading="lazy" />
                                                                    {% else %}
                                                                    <div class="ml-placeholder-img">
                                                                        <svg width="60" height="60" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                                            <ellipse cx="25" cy="40" rx="18" ry="14" stroke="#b8976a" stroke-width="3" fill="none"/>
                                                                            <ellipse cx="55" cy="40" rx="18" ry="14" stroke="#b8976a" stroke-width="3" fill="none"/>
                                                                            <path d="M43 40 H37" stroke="#b8976a" stroke-width="3" stroke-linecap="round"/>
                                                                            <path d="M7 40 H7" stroke="#b8976a" stroke-width="3" stroke-linecap="round"/>
                                                                            <path d="M73 40 H73" stroke="#b8976a" stroke-width="3" stroke-linecap="round"/>
                                                                        </svg>
                                                                    </div>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </xo-product-media>
                                                    </a>

                                                    <!-- Badges -->
                                                    <div class="xo-product-card__badge" style="display:flex;flex-direction:column;gap:4px;">
                                                        {% if lens_option.lens_brand %}
                                                        <div class="xo-badge-ml-brand">{{ lens_option.lens_brand.name }}</div>
                                                        {% endif %}
                                                        {% if lens_option.is_featured %}
                                                        <div class="xo-badge-sale">Featured</div>
                                                        {% endif %}
                                                    </div>
                                                </div>

                                                <div class="xo-product-card__information">
                                                    {% if lens_option.lens_type %}
                                                    <div class="ml-card-type">{{ lens_option.lens_type.name }}</div>
                                                    {% endif %}
                                                    <h2 class="xo-product-card__title">
                                                        <a href="{% url 'catalog:medical_lens_detail' lens_option.id %}">{{ lens_option.name }}</a>
                                                    </h2>
                                                    {% if lens_option.index %}
                                                    <div class="ml-card-index">Index {{ lens_option.index }}</div>
                                                    {% endif %}
                                                    {% if lens_option.coating_display %}
                                                    <div class="ml-card-coating">{{ lens_option.coating_display }}</div>
                                                    {% endif %}
                                                    <div class="xo-product-card__price">
                                                        <div class="xo-price">
                                                            <div class="xo-price__container">
                                                                <div class="xo-price__sale">
                                                                    <span class="xo-price__item xo-price__item--accent">QAR {{ lens_option.base_price }}</span>
                                                                    {% if lens_option.compare_at_price %}
                                                                    <span class="xo-price__item xo-price__item--regular" style="text-decoration: line-through; margin-left: 8px; color: #999;">QAR {{ lens_option.compare_at_price }}</span>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </xo-animate>
                                        </xo-product>
                                        {% empty %}
                                        <div style="grid-column: 1/-1; text-align: center; padding: 3rem;">
                                            <h3>No medical lenses found</h3>
                                            <p>Try adjusting your filters</p>
                                        </div>
                                        {% endfor %}
                                    </xo-grid>

                                    <!-- Pagination -->
                                    {% if page_obj.has_other_pages %}
                                    <xo-filters-paginate>
                                        <nav aria-label="Pagination" class="xo-pagination">
                                            <ul class="xo-pagination__list" role="list">
                                                {% if page_obj.has_previous %}
                                                <li><a aria-label="Previous page" class="xo-pagination__page xo-pagination__page--prev pagination-link" href="#" data-page="{{ page_obj.previous_page_number }}"><svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="20"><polyline points="15 18 9 12 15 6"></polyline></svg></a></li>
                                                {% endif %}
                                                {% for page in page_obj.paginator.page_range %}
                                                {% if page == page_obj.number %}
                                                <li><span aria-current="page" class="xo-pagination__page xo-pagination__page--current">{{ page }}</span></li>
                                                {% else %}
                                                <li><a class="xo-pagination__page pagination-link" href="#" data-page="{{ page }}">{{ page }}</a></li>
                                                {% endif %}
                                                {% endfor %}
                                                {% if page_obj.has_next %}
                                                <li><a aria-label="Next page" class="xo-pagination__page xo-pagination__page--next pagination-link" href="#" data-page="{{ page_obj.next_page_number }}"><svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="20"><polyline points="9 18 15 12 9 6"></polyline></svg></a></li>
                                                {% endif %}
                                            </ul>
                                        </nav>
                                    </xo-filters-paginate>
                                    {% endif %}
                                </div>
                            </xo-filters-content>
                        </div>
                    </xo-grid>
                </xo-container>
            </xo-filters>
        </div>
    </section>
</main>

<style>
@keyframes spin { to { transform: rotate(360deg); } }

/* Medical Lens card extras */
.ml-placeholder-img {
    width: 100%;
    aspect-ratio: 1/1;
    background: #f5f0e8;
    display: flex;
    align-items: center;
    justify-content: center;
}
.ml-card-type {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #b8976a;
    margin-bottom: 4px;
}
.ml-card-index {
    font-size: 12px;
    color: #666;
    margin: 3px 0;
}
.ml-card-coating {
    font-size: 11px;
    color: #999;
    margin-bottom: 6px;
}
.xo-badge-ml-brand {
    display: inline-block;
    background: rgba(184,151,106,0.9);
    color: white;
    font-size: 10px;
    font-weight: 700;
    padding: 3px 8px;
    border-radius: 4px;
    letter-spacing: 0.04em;
}

/* Price Range Styling */
.price-range-wrapper { width: 100%; padding: 20px 0; }
.price-slider-container { position: relative; width: 100%; height: 6px; margin-bottom: 20px; }
.price-slider-track { position: absolute; width: 100%; height: 6px; background: #e0e0e0; border-radius: 3px; top: 0; left: 0; }
.price-slider-fill { position: absolute; height: 6px; background: linear-gradient(90deg, #000, #333); border-radius: 3px; top: 0; }
.price-slider { position: absolute; width: 100%; height: 6px; top: 0; left: 0; margin: 0; padding: 0; pointer-events: none; -webkit-appearance: none; appearance: none; background: transparent; z-index: 5; }
.price-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #000; border: 3px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.3); cursor: pointer; pointer-events: all; transition: all 0.2s; }
.price-slider::-webkit-slider-thumb:hover { width: 24px; height: 24px; }
.price-slider::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; background: #000; border: 3px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.3); cursor: pointer; pointer-events: all; }
.xo-field-price__input-group { display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap; padding: 10px 0; }
.xo-field-price__label { font-weight: 600; color: #333; }
.price-display { font-weight: 600; color: #000; font-size: 14px; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterCheckboxes = document.querySelectorAll('.lens-brand-filter-checkbox, .lens-type-filter-checkbox, .index-filter-checkbox, .coating-filter-checkbox');
    filterCheckboxes.forEach(cb => cb.addEventListener('change', applyFilters));

    // Price Sliders
    const minSlider = document.querySelector('.price-slider--min');
    const maxSlider = document.querySelector('.price-slider--max');
    const minDisplay = document.getElementById('price-min-display');
    const maxDisplay = document.getElementById('price-max-display');
    const fill = document.querySelector('.price-slider-fill');
    let debounceTimer;

    function updateSliders() {
        let minVal = parseInt(minSlider.value);
        let maxVal = parseInt(maxSlider.value);
        if (minVal > maxVal - 10) { minVal = maxVal - 10; minSlider.value = minVal; }
        const minPct = ((minVal - minSlider.min) / (minSlider.max - minSlider.min)) * 100;
        const maxPct = ((maxVal - maxSlider.min) / (maxSlider.max - maxSlider.min)) * 100;
        fill.style.left = minPct + '%';
        fill.style.right = (100 - maxPct) + '%';
        minDisplay.textContent = minVal;
        maxDisplay.textContent = maxVal;
    }

    if (minSlider && maxSlider) {
        minSlider.addEventListener('input', updateSliders);
        maxSlider.addEventListener('input', updateSliders);
        minSlider.addEventListener('change', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(applyFilters, 500); });
        maxSlider.addEventListener('change', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(applyFilters, 500); });
        updateSliders();
    }

    function applyFilters() {
        const params = new URLSearchParams();

        document.querySelectorAll('.lens-brand-filter-checkbox:checked').forEach(cb => params.append('lens_brand', cb.value));
        document.querySelectorAll('.lens-type-filter-checkbox:checked').forEach(cb => params.append('lens_type', cb.value));
        document.querySelectorAll('.index-filter-checkbox:checked').forEach(cb => params.append('index', cb.value));
        document.querySelectorAll('.coating-filter-checkbox:checked').forEach(cb => params.append('coating', cb.value));

        if (minSlider && maxSlider) {
            params.set('min_price', minSlider.value);
            params.set('max_price', maxSlider.value);
        }

        const sortValue = document.querySelector('.sort-radio:checked');
        if (sortValue) params.set('sort', sortValue.value);
        params.set('ajax', '1');

        const loadingIndicator = document.getElementById('loading-indicator');
        const productsContainer = document.getElementById('products-container');
        if (loadingIndicator) loadingIndicator.style.display = 'block';
        if (productsContainer) productsContainer.style.opacity = '0.5';

        fetch(`${window.location.pathname}?${params.toString()}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(r => r.text())
        .then(html => {
            const doc = new DOMParser().parseFromString(html, 'text/html');
            const newContainer = doc.querySelector('#products-container');
            if (newContainer && productsContainer) productsContainer.innerHTML = newContainer.innerHTML;
            params.delete('ajax');
            window.history.pushState({}, '', `${window.location.pathname}?${params.toString()}`);
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            if (productsContainer) productsContainer.style.opacity = '1';
        })
        .catch(() => {
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            if (productsContainer) productsContainer.style.opacity = '1';
        });
    }

    document.querySelectorAll('.sort-radio').forEach(r => r.addEventListener('change', applyFilters));

    document.addEventListener('click', function(e) {
        const link = e.target.matches('.pagination-link') ? e.target : e.target.closest('.pagination-link');
        if (!link) return;
        e.preventDefault();
        const page = link.dataset.page;
        if (!page) return;
        const params = new URLSearchParams(window.location.search);
        params.set('page', page); params.set('ajax', '1');
        const loadingIndicator = document.getElementById('loading-indicator');
        const productsContainer = document.getElementById('products-container');
        if (loadingIndicator) loadingIndicator.style.display = 'block';
        if (productsContainer) productsContainer.style.opacity = '0.5';
        fetch(`${window.location.pathname}?${params.toString()}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(r => r.text())
        .then(html => {
            const doc = new DOMParser().parseFromString(html, 'text/html');
            const newContainer = doc.querySelector('#products-container');
            if (newContainer && productsContainer) productsContainer.innerHTML = newContainer.innerHTML;
            params.delete('ajax');
            window.history.pushState({}, '', `${window.location.pathname}?${params.toString()}`);
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            if (productsContainer) productsContainer.style.opacity = '1';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        })
        .catch(() => {
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            if (productsContainer) productsContainer.style.opacity = '1';
        });
    });

    const clearAllBtn = document.getElementById('clear-all-btn');
    if (clearAllBtn) clearAllBtn.addEventListener('click', () => { window.location.href = window.location.pathname; });
});
</script>

{% endblock %}