{% extends 'base.html' %}
{% block title %}Set New Password — Al Ameen Optics{% endblock %}

{% block extra_styles %}
<style>
:root {
  --auth-accent:#1a6fa8;--auth-accent-dark:#155f90;--auth-gold:#c8a96e;
  --auth-border:#c5d8e8;--auth-muted:#6b8299;--auth-dark:#1a2a3a;
  --auth-error:#e03030;--auth-success:#2a8a3a;
  --font-display:'Playfair Display',serif;--font-body:'Jost',sans-serif;
}
.auth-page { min-height:calc(100vh - 160px);display:grid;grid-template-columns:1fr 1fr;background:#0d1a27; }
.auth-visual { position:relative;overflow:hidden;display:flex;flex-direction:column;justify-content:flex-end;padding:60px 56px; }
.auth-visual__bg {
  position:absolute;inset:0;
  background:linear-gradient(160deg,rgba(200,169,110,.18) 0%,rgba(13,26,39,.9) 65%),
    url('https://images.unsplash.com/photo-1607023558931-e3f573f2e993?w=900&h=1200&fit=crop') center/cover no-repeat;
  animation:panZoom 14s ease-in-out infinite alternate;
}
@keyframes panZoom { from{transform:scale(1.04);}to{transform:scale(1.1) translateY(-14px);} }
.auth-visual__overlay { position:absolute;inset:0;background:linear-gradient(to top,rgba(13,26,39,.93) 0%,rgba(13,26,39,.25) 55%,transparent 100%); }
.auth-visual__content { position:relative;z-index:2; }
.auth-visual__eyebrow { display:inline-flex;align-items:center;gap:10px;margin-bottom:20px; }
.auth-visual__eyebrow-line { display:block;width:32px;height:1.5px;background:var(--auth-gold); }
.auth-visual__eyebrow-text { font-size:.72rem;font-weight:600;letter-spacing:.22em;text-transform:uppercase;color:var(--auth-gold);font-family:var(--font-body); }
.auth-visual__title { font-family:var(--font-display);font-size:clamp(2.4rem,3.5vw,4rem);font-weight:400;color:#fff;line-height:1.15;margin:0 0 16px; }
.auth-visual__title em { color:var(--auth-gold);font-style:italic; }
.auth-visual__sub { font-size:.93rem;font-weight:300;color:rgba(255,255,255,.65);line-height:1.65;margin:0 0 36px;max-width:320px;font-family:var(--font-body); }
.auth-visual__tips { display:flex;flex-direction:column;gap:10px; }
.auth-visual__tip { display:flex;align-items:center;gap:10px;font-size:.83rem;color:rgba(255,255,255,.75);font-family:var(--font-body); }
.auth-visual__tip svg { width:14px;height:14px;stroke:var(--auth-gold);fill:none;stroke-width:2.5;flex-shrink:0; }

.auth-form-panel { display:flex;align-items:center;justify-content:center;background:#f4f8fb;padding:60px 40px; }
.auth-form-card { width:100%;max-width:440px; }
.auth-form-card__logo { display:flex;align-items:center;gap:12px;margin-bottom:36px; }
.auth-form-card__logo-icon { width:44px;height:44px;background:var(--auth-accent);border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0; }
.auth-form-card__logo-icon svg { width:22px;height:22px;fill:none;stroke:#fff;stroke-width:2; }
.auth-form-card__logo-text h2 { font-family:var(--font-display);font-size:1.4rem;font-weight:600;color:var(--auth-dark);margin:0;line-height:1.2; }
.auth-form-card__logo-text span { font-size:.72rem;letter-spacing:.15em;text-transform:uppercase;color:var(--auth-muted);font-family:var(--font-body); }

/* Progress steps — step 3 active */
.auth-steps { display:flex;align-items:center;gap:0;margin-bottom:32px; }
.auth-step { flex:1;display:flex;flex-direction:column;align-items:center;gap:6px;position:relative; }
.auth-step::after { content:'';position:absolute;top:16px;left:55%;width:90%;height:1.5px;background:#dde8f0; }
.auth-step:last-child::after { display:none; }
.auth-step.done::after { background:var(--auth-accent); }
.auth-step__dot { width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.78rem;font-weight:700;font-family:var(--font-body);position:relative;z-index:1;border:2px solid #dde8f0;background:#fff;color:#aaa; }
.auth-step.active .auth-step__dot { background:var(--auth-dark);border-color:var(--auth-dark);color:#fff; }
.auth-step.done .auth-step__dot { background:var(--auth-accent);border-color:var(--auth-accent);color:#fff; }
.auth-step__label { font-size:.68rem;letter-spacing:.06em;text-transform:uppercase;color:#bbb;font-family:var(--font-body); }
.auth-step.active .auth-step__label { color:var(--auth-dark);font-weight:700; }
.auth-step.done .auth-step__label { color:var(--auth-accent); }

.auth-step-header { text-align:center;margin-bottom:32px; }
.auth-step-icon { width:72px;height:72px;margin:0 auto 20px;background:linear-gradient(135deg,rgba(26,111,168,.1),rgba(26,111,168,.05));border:2px solid rgba(26,111,168,.18);border-radius:20px;display:flex;align-items:center;justify-content:center; }
.auth-step-icon svg { width:32px;height:32px;stroke:var(--auth-accent);fill:none;stroke-width:1.8; }
.auth-step-header h1 { font-family:var(--font-display);font-size:2rem;font-weight:500;color:var(--auth-dark);margin:0 0 8px; }
.auth-step-header p { font-size:.88rem;color:var(--auth-muted);margin:0;font-family:var(--font-body); }

.auth-field { margin-bottom:20px; }
.auth-field label { display:block;font-size:.76rem;font-weight:700;text-transform:uppercase;letter-spacing:.09em;color:var(--auth-dark);margin-bottom:8px;font-family:var(--font-body); }
.auth-field__input-wrap { position:relative; }
.auth-field__input-wrap > svg { position:absolute;left:14px;top:50%;transform:translateY(-50%);width:16px;height:16px;stroke:var(--auth-muted);fill:none;stroke-width:2;pointer-events:none;z-index:1; }
.auth-field input { width:100%;padding:13px 46px 13px 44px;border:1.5px solid var(--auth-border);border-radius:10px;font-size:.92rem;color:var(--auth-dark);background:#fff;outline:none;transition:border-color .25s,box-shadow .25s;font-family:var(--font-body);box-sizing:border-box; }
.auth-field input:focus { border-color:var(--auth-accent);box-shadow:0 0 0 3px rgba(26,111,168,.1); }
.auth-field input.is-error { border-color:var(--auth-error); }
.auth-field input.is-ok { border-color:var(--auth-success); }
.auth-field__msg { font-size:.75rem;margin-top:5px;font-family:var(--font-body);display:block;min-height:16px; }
.auth-field__msg.err { color:var(--auth-error); }
.auth-field__msg.ok { color:var(--auth-success); }
.auth-field__eye { position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--auth-muted);display:flex;align-items:center;padding:4px;transition:color .2s; }
.auth-field__eye:hover { color:var(--auth-accent); }
.auth-field__eye svg { width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2; }

/* Strength bar */
.auth-strength-bar { height:3px;border-radius:2px;margin-top:6px;background:#e0e8f0;overflow:hidden; }
.auth-strength-bar__fill { height:100%;border-radius:2px;width:0%;transition:width .4s,background .4s; }

/* Requirements checklist */
.auth-pwd-reqs { display:grid;grid-template-columns:1fr 1fr;gap:6px 16px;margin:10px 0 20px; }
.auth-pwd-req { display:flex;align-items:center;gap:6px;font-size:.76rem;color:#aaa;font-family:var(--font-body);transition:color .25s; }
.auth-pwd-req svg { width:13px;height:13px;stroke:currentColor;fill:none;stroke-width:2.5;flex-shrink:0; }
.auth-pwd-req.met { color:var(--auth-success); }

.auth-submit { width:100%;height:52px;background:var(--auth-dark);color:#fff;border:none;border-radius:10px;font-size:.88rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;cursor:pointer;transition:all .3s;font-family:var(--font-body);display:flex;align-items:center;justify-content:center;gap:10px;position:relative;overflow:hidden; }
.auth-submit::before { content:'';position:absolute;inset:0;background:var(--auth-accent);transform:translateX(-101%);transition:transform .4s cubic-bezier(.76,0,.24,1); }
.auth-submit:hover::before { transform:translateX(0); }
.auth-submit span,.auth-submit svg { position:relative;z-index:1; }
.auth-submit svg { width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2.5;transition:transform .3s; }
.auth-submit:hover svg { transform:translateX(4px); }

.auth-messages { margin-bottom:16px; }
.auth-alert { display:flex;align-items:flex-start;gap:10px;padding:11px 14px;border-radius:8px;font-size:.84rem;font-family:var(--font-body);margin-bottom:8px; }
.auth-alert--error { background:#fff0f0;border:1px solid #ffd0d0;color:#8a1c1c; }
.auth-alert--success { background:#f0fdf4;border:1px solid #bbf0cc;color:#166534; }
.auth-alert svg { width:15px;height:15px;flex-shrink:0;stroke:currentColor;fill:none;stroke-width:2; }
.auth-alt { text-align:center;font-size:.88rem;color:var(--auth-muted);font-family:var(--font-body);margin-top:24px; }
.auth-alt a { color:var(--auth-accent);font-weight:700;text-decoration:none; }
.auth-alt a:hover { text-decoration:underline; }

@media (max-width:900px) { .auth-page{grid-template-columns:1fr;}.auth-visual{display:none;} }
@media (max-width:480px) { .auth-form-panel{padding:28px 16px;}.auth-pwd-reqs{grid-template-columns:1fr;} }
</style>
{% endblock %}

{% block content %}
<div class="auth-page">
  <div class="auth-visual">
    <div class="auth-visual__bg"></div>
    <div class="auth-visual__overlay"></div>
    <div class="auth-visual__content">
      <div class="auth-visual__eyebrow">
        <span class="auth-visual__eyebrow-line"></span>
        <span class="auth-visual__eyebrow-text">Account Security</span>
      </div>
      <h2 class="auth-visual__title">Almost<br><em>There.</em></h2>
      <p class="auth-visual__sub">
        Create a strong new password to secure your Al Ameen Optics account. A good password uses a mix of letters, numbers, and symbols.
      </p>
      <div class="auth-visual__tips">
        <div class="auth-visual__tip"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>At least 8 characters long</div>
        <div class="auth-visual__tip"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Mix of uppercase and lowercase letters</div>
        <div class="auth-visual__tip"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Include a number and a symbol</div>
        <div class="auth-visual__tip"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Never reuse a password from another site</div>
      </div>
    </div>
  </div>

  <div class="auth-form-panel">
    <div class="auth-form-card">
      <div class="auth-form-card__logo">
        <div class="auth-form-card__logo-icon">
          <svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        </div>
        <div class="auth-form-card__logo-text">
          <h2>Al Ameen Optics</h2>
          <span>Your Vision Matters More</span>
        </div>
      </div>

      <!-- Progress steps (step 3 active, 1+2 done) -->
      <div class="auth-steps">
        <div class="auth-step done">
          <div class="auth-step__dot"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>
          <span class="auth-step__label">Email</span>
        </div>
        <div class="auth-step done">
          <div class="auth-step__dot"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>
          <span class="auth-step__label">Link sent</span>
        </div>
        <div class="auth-step active">
          <div class="auth-step__dot">3</div>
          <span class="auth-step__label">New password</span>
        </div>
      </div>

      <div class="auth-step-header">
        <div class="auth-step-icon">
          <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        </div>
        <h1>Set new password</h1>
        <p>Create a strong password for your account</p>
      </div>

      {% if messages %}
      <div class="auth-messages">
        {% for message in messages %}
        <div class="auth-alert auth-alert--{{ message.tags }}">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          {{ message }}
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <form method="POST" id="resetForm">
        {% csrf_token %}

        <div class="auth-field">
          <label for="new_password">New Password</label>
          <div class="auth-field__input-wrap">
            <input type="password" name="new_password" id="new_password" placeholder="Create a strong password" required autocomplete="new-password">
            <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            <button type="button" class="auth-field__eye" onclick="togglePwd('new_password',this)" aria-label="Toggle password">
              <svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
          </div>
          <div class="auth-strength-bar"><div class="auth-strength-bar__fill" id="strength-fill"></div></div>
        </div>

        <!-- Requirements -->
        <div class="auth-pwd-reqs">
          <div class="auth-pwd-req" id="req-len"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg>8+ characters</div>
          <div class="auth-pwd-req" id="req-upper"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg>Uppercase letter</div>
          <div class="auth-pwd-req" id="req-lower"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg>Lowercase letter</div>
          <div class="auth-pwd-req" id="req-num"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg>Number</div>
        </div>

        <div class="auth-field">
          <label for="confirm_password">Confirm Password</label>
          <div class="auth-field__input-wrap">
            <input type="password" name="confirm_password" id="confirm_password" placeholder="Repeat your new password" required autocomplete="new-password">
            <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            <button type="button" class="auth-field__eye" onclick="togglePwd('confirm_password',this)" aria-label="Toggle password">
              <svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
          </div>
          <span class="auth-field__msg" id="confirm-msg"></span>
        </div>

        <button type="submit" class="auth-submit">
          <span>Update Password</span>
          <svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        </button>
      </form>

      <div class="auth-alt">
        <a href="{% url 'users:login' %}">← Back to Sign In</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function togglePwd(id, btn) {
  var i = document.getElementById(id);
  var show = i.type === 'password';
  i.type = show ? 'text' : 'password';
  btn.querySelector('svg').innerHTML = show
    ? '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>'
    : '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
}

var pwd = document.getElementById('new_password');
var conf = document.getElementById('confirm_password');

function setReq(id, met) {
  var el = document.getElementById(id);
  el.classList.toggle('met', met);
  el.querySelector('svg').innerHTML = met
    ? '<polyline points="20 6 9 17 4 12"/>'
    : '<circle cx="12" cy="12" r="10"/>';
}

pwd.addEventListener('input', function() {
  var v = this.value;
  var score = 0;
  var len = v.length >= 8; if (len) score++;
  var upper = /[A-Z]/.test(v); if (upper) score++;
  var lower = /[a-z]/.test(v); if (lower) score++;
  var num = /[0-9]/.test(v); if (num) score++;
  if (/[^A-Za-z0-9]/.test(v)) score++;

  setReq('req-len', len); setReq('req-upper', upper);
  setReq('req-lower', lower); setReq('req-num', num);

  var fill = document.getElementById('strength-fill');
  var cols = ['#e03030','#f0ad00','#f0ad00','#2a8a3a','#2a8a3a'];
  fill.style.width = (score * 20) + '%';
  fill.style.background = score > 0 ? cols[score-1] : '#e0e8f0';
});

conf.addEventListener('input', function() {
  var ok = this.value === pwd.value && this.value.length > 0;
  var msgEl = document.getElementById('confirm-msg');
  msgEl.textContent = ok ? 'Passwords match ✓' : (this.value.length ? 'Passwords do not match' : '');
  msgEl.className = 'auth-field__msg ' + (ok ? 'ok' : 'err');
  this.className = ok ? 'is-ok' : (this.value.length ? 'is-error' : '');
});

document.getElementById('resetForm').addEventListener('submit', function(e) {
  if (pwd.value !== conf.value || pwd.value.length < 8) e.preventDefault();
});
</script>
{% endblock %}