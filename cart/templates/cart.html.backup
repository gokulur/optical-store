{% extends 'base.html' %}
{% load static %}
{% block title %}Shopping Cart ‚Äî Optical Store{% endblock %}

{% block content %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet">

<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DESIGN TOKENS ‚Äî Premium Optical
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
:root {
  --obsidian: #0d0d0f;
  --charcoal: #1a1a1f;
  --graphite: #2e2e36;
  --gold: #b8976a;
  --gold-light: #d4b896;
  --gold-pale: #f5ede0;
  --sand: #f7f3ed;
  --ivory: #faf8f5;
  --white: #ffffff;
  --muted: #8a8a95;
  --border: #e8e4dc;
  --border-dark: #d4cfc5;
  --success: #2a6b2e;
  --success-bg: #edf7ee;
  --success-border: #b2d9b5;
  --warning: #b05a00;
  --warning-bg: #fff5e6;
  --warning-border: #f5c887;
  --info: #1a4fa0;
  --info-bg: #eaf1fc;
  --info-border: #9dbff0;
  --danger: #b02020;
  --danger-bg: #fceaea;
  --danger-border: #f0b0b0;
  --purple: #5e3a8a;
  --purple-bg: #f3edfb;
  --radius-sm: 6px;
  --radius: 12px;
  --radius-lg: 18px;
  --radius-xl: 24px;
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
  --shadow: 0 4px 24px rgba(0,0,0,0.09);
  --shadow-lg: 0 12px 48px rgba(0,0,0,0.14);
  --transition: all 0.25s cubic-bezier(0.4,0,0.2,1);
  --font-display: 'Cormorant Garamond', serif;
  --font-body: 'DM Sans', sans-serif;
}

*, *::before, *::after { box-sizing: border-box; }
body { font-family: var(--font-body); }

.cp {
  max-width: 1340px;
  margin: 0 auto;
  padding: 0 28px 100px;
}

/* ‚îÄ‚îÄ PAGE HEADER ‚îÄ‚îÄ */
.cp-header {
  padding: 48px 0 32px;
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
  margin-bottom: 48px;
  gap: 20px;
  flex-wrap: wrap;
}
.cp-header-left h1 {
  font-family: var(--font-display);
  font-size: clamp(32px, 4vw, 52px);
  font-weight: 600;
  letter-spacing: -0.01em;
  margin: 0 0 6px;
  color: var(--obsidian);
  line-height: 1.1;
}
.cp-header-left p { font-size: 13px; color: var(--muted); margin: 0; font-weight: 400; }

.cp-breadcrumb { font-size: 12px; color: var(--muted); display: flex; align-items: center; gap: 8px; }
.cp-breadcrumb a { color: var(--muted); text-decoration: none; }
.cp-breadcrumb a:hover { color: var(--gold); }
.cp-breadcrumb-sep { opacity: 0.4; }

/* ‚îÄ‚îÄ CHECKOUT STEPS ‚îÄ‚îÄ */
.checkout-steps {
  display: flex;
  align-items: center;
  background: var(--sand);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 14px 24px;
  margin-bottom: 36px;
}
.cstep { display: flex; align-items: center; gap: 9px; font-size: 12px; font-weight: 500; color: var(--muted); flex: 1; }
.cstep.active { color: var(--obsidian); }
.cstep.active .cstep-num { background: var(--obsidian); color: var(--white); }
.cstep-num { width: 24px; height: 24px; border-radius: 50%; background: var(--border); color: var(--muted); font-size: 11px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.cstep-line { flex: 1; height: 1px; background: var(--border); margin: 0 12px; }
@media (max-width: 640px) { .cstep-label { display: none; } .cstep-line { margin: 0 8px; } }

/* ‚îÄ‚îÄ ALERTS ‚îÄ‚îÄ */
.cp-alert { padding: 14px 18px; border-radius: var(--radius); margin-bottom: 16px; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 10px; }
.cp-alert--success { background: var(--success-bg); color: var(--success); border: 1px solid var(--success-border); }
.cp-alert--error   { background: var(--danger-bg);  color: var(--danger);  border: 1px solid var(--danger-border); }
.cp-alert--info    { background: var(--info-bg);    color: var(--info);    border: 1px solid var(--info-border); }

/* ‚îÄ‚îÄ LAYOUT GRID ‚îÄ‚îÄ */
.cp-grid { display: grid; grid-template-columns: 1fr 390px; gap: 36px; align-items: start; }
@media (max-width: 1000px) { .cp-grid { grid-template-columns: 1fr; gap: 28px; } }

/* ‚îÄ‚îÄ LEFT PANEL ‚îÄ‚îÄ */
.cp-left-head { display: flex; align-items: center; justify-content: space-between; padding-bottom: 18px; border-bottom: 2px solid var(--obsidian); margin-bottom: 0; }
.cp-col-labels { display: grid; grid-template-columns: 1fr 150px 130px 110px; gap: 16px; font-size: 10px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); }
@media (max-width: 750px) { .cp-col-labels { display: none; } }

/* ‚îÄ‚îÄ CART ITEM CARD ‚îÄ‚îÄ */
.ci-card { background: var(--white); border: 1px solid var(--border); border-radius: var(--radius-lg); margin-top: 16px; overflow: hidden; transition: var(--transition), opacity 0.35s ease, transform 0.35s ease; box-shadow: var(--shadow-sm); }
.ci-card:hover { border-color: var(--gold); box-shadow: var(--shadow); }
.ci-card.removing { opacity: 0; transform: translateX(60px); pointer-events: none; }

.ci-type-banner { padding: 8px 20px; font-size: 10px; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; display: flex; align-items: center; gap: 8px; }
.ci-type-banner--eyeglasses  { background: #f0f7ee; color: var(--success); border-bottom: 1px solid var(--success-border); }
.ci-type-banner--sunglasses  { background: var(--purple-bg); color: var(--purple); border-bottom: 1px solid #d4c0f0; }
.ci-type-banner--contact     { background: var(--info-bg); color: var(--info); border-bottom: 1px solid var(--info-border); }
.ci-type-banner--accessories { background: var(--sand); color: #555; border-bottom: 1px solid var(--border); }
.ci-type-banner--reading     { background: #fff9f0; color: #a05a00; border-bottom: 1px solid #f5d9a8; }

.ci-main { display: grid; grid-template-columns: 1fr 150px 130px 110px; gap: 16px; align-items: center; padding: 20px 20px 0; }
@media (max-width: 750px) { .ci-main { grid-template-columns: 1fr; gap: 14px; } }

.ci-product { display: flex; gap: 16px; align-items: flex-start; }
.ci-img-wrap { width: 96px; height: 96px; border-radius: var(--radius); overflow: hidden; background: var(--sand); border: 1px solid var(--border); flex-shrink: 0; position: relative; }
.ci-img-wrap img { width: 100%; height: 100%; object-fit: contain; display: block; transition: transform 0.4s ease; }
.ci-img-wrap:hover img { transform: scale(1.07); }
.ci-meta { flex: 1; min-width: 0; }
.ci-name { font-size: 14px; font-weight: 600; color: var(--obsidian); text-decoration: none; line-height: 1.35; display: block; margin-bottom: 2px; transition: color 0.2s; }
.ci-name:hover { color: var(--gold); }
.ci-brand { font-size: 11px; color: var(--muted); margin-bottom: 8px; font-weight: 400; }
.ci-unit-price { font-size: 12px; color: var(--muted); margin-bottom: 8px; }

.ci-badges { display: flex; flex-wrap: wrap; gap: 5px; }
.cbadge { display: inline-flex; align-items: center; gap: 4px; font-size: 10px; padding: 3px 9px; border-radius: 20px; white-space: nowrap; font-weight: 600; letter-spacing: 0.02em; }
.cbadge-frame    { background: var(--sand); color: #444; border: 1px solid var(--border-dark); }
.cbadge-lens     { background: var(--success-bg); color: var(--success); border: 1px solid var(--success-border); }
.cbadge-addon    { background: #fff5e6; color: #a05000; border: 1px solid #f5c887; }
.cbadge-sunglass { background: var(--purple-bg); color: var(--purple); border: 1px solid #d4c0f0; }
.cbadge-contact  { background: var(--info-bg); color: var(--info); border: 1px solid var(--info-border); }
.cbadge-color    { background: #fce8f0; color: #8b1a4a; border: 1px solid #f0b0cc; }
.cbadge-reading  { background: #e8f5e9; color: #1b5e20; border: 1px solid #81c784; }

.qty-control { display: inline-flex; align-items: center; border: 1.5px solid var(--border); border-radius: var(--radius); overflow: hidden; background: var(--white); transition: var(--transition); }
.qty-control:focus-within { border-color: var(--gold); }
.qty-control.loading { opacity: 0.4; pointer-events: none; }

.qty-btn { width: 36px; height: 36px; border: none; background: var(--sand); cursor: pointer; font-size: 17px; color: var(--obsidian); display: flex; align-items: center; justify-content: center; transition: var(--transition); user-select: none; flex-shrink: 0; line-height: 1; font-weight: 300; }
.qty-btn:hover:not([disabled]) { background: var(--gold-pale); color: var(--gold); }
.qty-btn[disabled], .qty-btn.at-limit { opacity: 0.3; cursor: not-allowed; }
.qty-input { width: 44px; height: 36px; border: none; border-left: 1px solid var(--border); border-right: 1px solid var(--border); text-align: center; font-size: 14px; font-weight: 700; color: var(--obsidian); background: var(--white); pointer-events: none; font-family: var(--font-body); }

.ci-total { font-size: 16px; font-weight: 700; color: var(--obsidian); font-family: var(--font-display); letter-spacing: 0.01em; transition: color 0.35s; text-align: right; }
.ci-total.flash { color: var(--success); }

.price-col { text-align: center; font-size: 13px; color: var(--muted); font-weight: 500; }
.price-col .lens-sub { font-size: 10px; color: #bbb; margin-top: 3px; }

@media (max-width: 750px) {
  .ci-total { text-align: left; }
  .qty-cell, .price-cell, .total-cell { display: flex; justify-content: space-between; align-items: center; }
  .qty-cell::before  { content: 'Qty:';   font-size: 11px; color: var(--muted); font-weight: 600; }
  .price-cell::before { content: 'Unit:'; font-size: 11px; color: var(--muted); font-weight: 600; }
  .total-cell::before { content: 'Total:'; font-size: 11px; color: var(--muted); font-weight: 600; }
}

/* ‚îÄ‚îÄ CONFIG SECTION ‚îÄ‚îÄ */
.ci-config { padding: 0 20px 16px; }
.ci-config-inner { background: var(--sand); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; margin-top: 14px; }
.ci-config-tabs { display: flex; border-bottom: 1px solid var(--border); }
.ci-config-tab { flex: 1; padding: 10px 14px; font-size: 11px; font-weight: 600; text-align: center; cursor: default; color: var(--muted); border-right: 1px solid var(--border); }
.ci-config-tab:last-child { border-right: none; }
.ci-config-tab.active { background: white; color: var(--obsidian); }
.ci-config-tab.filled { color: var(--success); }
.ci-config-body { padding: 14px 16px; }

.rx-grid { display: grid; grid-template-columns: auto 1fr 1fr 1fr 1fr; gap: 6px 10px; font-size: 11px; align-items: center; }
.rx-head { font-weight: 700; color: var(--muted); font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; }
.rx-eye  { font-weight: 700; color: var(--obsidian); font-size: 11px; }
.rx-val  { background: white; border: 1px solid var(--border); border-radius: 4px; padding: 4px 8px; font-size: 11px; color: #333; text-align: center; }

.sg-lens-display { display: flex; flex-wrap: wrap; gap: 8px; }
.sg-lens-chip { background: white; border: 1px solid var(--border); border-radius: 8px; padding: 8px 14px; font-size: 11px; }
.sg-lens-chip strong { display: block; font-size: 12px; color: var(--obsidian); margin-bottom: 2px; }
.sg-lens-chip span   { color: var(--muted); }

.cl-power-display { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.cl-power-box { background: white; border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; text-align: center; }
.cl-power-box .cl-eye  { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 4px; }
.cl-power-box .cl-pwr  { font-size: 18px; font-weight: 700; color: var(--obsidian); font-family: var(--font-display); }
.cl-power-box .cl-unit { font-size: 10px; color: var(--muted); }

.addon-list { display: flex; flex-direction: column; gap: 6px; }
.addon-item { display: flex; align-items: center; justify-content: space-between; background: white; border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; font-size: 12px; }
.addon-item-name  { color: var(--obsidian); font-weight: 500; display: flex; align-items: center; gap: 6px; }
.addon-item-price { color: var(--gold); font-weight: 700; }

.stock-warn { display: none; font-size: 11px; color: var(--danger); font-weight: 600; margin-top: 6px; }
.stock-warn.visible { display: block; }

.ci-note { background: var(--warning-bg); border: 1px solid var(--warning-border); border-radius: 6px; padding: 7px 11px; font-size: 11px; color: #7a3e00; font-style: italic; margin-top: 8px; }

/* ‚îÄ‚îÄ CARD FOOTER ‚îÄ‚îÄ */
.ci-footer { display: flex; align-items: center; justify-content: space-between; padding: 12px 20px 16px; border-top: 1px solid var(--border); margin-top: 14px; }
.ci-remove-btn { background: none; border: none; font-size: 12px; color: var(--muted); cursor: pointer; padding: 5px 0; display: inline-flex; align-items: center; gap: 5px; font-family: var(--font-body); font-weight: 500; transition: var(--transition); text-decoration: underline; text-underline-offset: 2px; }
.ci-remove-btn:hover { color: var(--danger); }
.ci-remove-btn:disabled { opacity: 0.4; cursor: wait; }
.ci-edit-lens { background: none; border: 1px solid var(--border); border-radius: 6px; font-size: 11px; color: var(--obsidian); cursor: pointer; padding: 5px 12px; font-family: var(--font-body); font-weight: 600; transition: var(--transition); display: flex; align-items: center; gap: 5px; text-decoration: none; }
.ci-edit-lens:hover { border-color: var(--gold); color: var(--gold); }

/* ‚îÄ‚îÄ CONTINUE / TRUST ‚îÄ‚îÄ */
.cp-continue { margin-top: 20px; display: flex; align-items: center; gap: 14px; flex-wrap: wrap; }
.cp-continue-btn { display: inline-flex; align-items: center; gap: 6px; padding: 11px 22px; background: transparent; color: var(--obsidian); border: 1.5px solid var(--border); border-radius: var(--radius); font-size: 13px; font-weight: 600; text-decoration: none; transition: var(--transition); font-family: var(--font-body); }
.cp-continue-btn:hover { border-color: var(--obsidian); color: var(--obsidian); }

.trust-strip { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; margin-top: 32px; }
@media (max-width: 640px) { .trust-strip { grid-template-columns: repeat(2, 1fr); } }
.tt { background: var(--white); padding: 18px 16px; text-align: center; transition: background 0.2s; }
.tt:hover { background: var(--sand); }
.tt-icon  { font-size: 20px; margin-bottom: 6px; }
.tt-title { font-size: 12px; font-weight: 700; color: var(--obsidian); margin-bottom: 2px; }
.tt-desc  { font-size: 10px; color: var(--muted); }

/* ‚îÄ‚îÄ ORDER SUMMARY SIDEBAR ‚îÄ‚îÄ */
.order-panel { position: sticky; top: 88px; background: var(--white); border: 1px solid var(--border); border-radius: var(--radius-xl); overflow: hidden; box-shadow: var(--shadow); }
.op-head { background: var(--obsidian); color: var(--white); padding: 18px 24px; }
.op-head h2 { font-family: var(--font-display); font-size: 18px; font-weight: 600; margin: 0 0 2px; letter-spacing: 0.01em; }
.op-head p  { font-size: 11px; opacity: 0.5; margin: 0; }
.op-body { padding: 22px 24px; }

.fs-bar { background: var(--sand); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px 16px; margin-bottom: 22px; }
.fs-text { font-size: 12px; font-weight: 600; color: var(--obsidian); margin-bottom: 9px; display: flex; align-items: center; gap: 6px; }
.fs-text.qualified { color: var(--success); }
.fs-track { height: 5px; background: var(--border); border-radius: 3px; overflow: hidden; }
.fs-fill  { height: 100%; background: linear-gradient(90deg, var(--gold), #7cb342); border-radius: 3px; transition: width 0.6s cubic-bezier(0.4,0,0.2,1); }

.promo-wrap { display: flex; gap: 8px; margin-bottom: 20px; }
.promo-input { flex: 1; height: 40px; padding: 0 14px; border: 1.5px solid var(--border); border-radius: var(--radius); font-size: 12px; font-family: var(--font-body); color: var(--obsidian); background: var(--white); transition: border-color 0.2s; outline: none; }
.promo-input:focus { border-color: var(--gold); }
.promo-input::placeholder { color: var(--muted); }
.promo-btn { height: 40px; padding: 0 16px; background: var(--obsidian); color: var(--white); border: none; border-radius: var(--radius); font-size: 12px; font-weight: 700; cursor: pointer; font-family: var(--font-body); letter-spacing: 0.04em; transition: var(--transition); white-space: nowrap; }
.promo-btn:hover { background: var(--graphite); }

.op-divider { height: 1px; background: var(--border); margin: 16px 0; }

.sr { display: flex; justify-content: space-between; align-items: center; margin-bottom: 11px; font-size: 13px; color: #555; font-weight: 400; }
.sr-label { display: flex; align-items: center; gap: 6px; }
.sr--total { margin-top: 14px; padding-top: 14px; border-top: 2px solid var(--obsidian); font-size: 19px; font-weight: 700; color: var(--obsidian); font-family: var(--font-display); }
.sr-free { color: var(--success); font-weight: 700; font-size: 12px; }
.sr-note { font-size: 10px; color: var(--muted); margin: 8px 0 20px; text-align: center; }

.btn-checkout { width: 100%; padding: 16px; background: var(--obsidian); color: var(--white); border: 2px solid var(--obsidian); border-radius: var(--radius); font-size: 14px; font-weight: 700; letter-spacing: 0.07em; text-transform: uppercase; cursor: pointer; transition: var(--transition); text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 12px; font-family: var(--font-body); position: relative; overflow: hidden; }
.btn-checkout::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, transparent 30%, rgba(184,151,106,0.15) 100%); pointer-events: none; }
.btn-checkout:hover { background: var(--charcoal); border-color: var(--charcoal); color: var(--white); transform: translateY(-1px); box-shadow: 0 6px 20px rgba(0,0,0,0.22); }
.btn-checkout.disabled { opacity: 0.4; cursor: not-allowed; pointer-events: none; transform: none; }

.btn-shop-more { width: 100%; padding: 12px; background: transparent; color: var(--obsidian); border: 1.5px solid var(--border); border-radius: var(--radius); font-size: 13px; font-weight: 600; cursor: pointer; transition: var(--transition); text-decoration: none; display: block; text-align: center; font-family: var(--font-body); }
.btn-shop-more:hover { border-color: var(--obsidian); color: var(--obsidian); }

.pay-icons { display: flex; align-items: center; justify-content: center; gap: 6px; margin-top: 14px; flex-wrap: wrap; }
.pay-icon  { background: var(--sand); border: 1px solid var(--border); border-radius: 5px; padding: 3px 8px; font-size: 10px; font-weight: 700; color: var(--muted); letter-spacing: 0.05em; }

.op-benefits { margin-top: 20px; padding-top: 18px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 9px; }
.ben-row  { display: flex; align-items: center; gap: 10px; font-size: 12px; color: #555; }
.ben-icon { width: 26px; height: 26px; background: var(--sand); border: 1px solid var(--border); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; flex-shrink: 0; }

/* ‚îÄ‚îÄ EMPTY CART ‚îÄ‚îÄ */
.empty-cart { grid-column: 1 / -1; text-align: center; padding: 80px 40px; background: var(--white); border: 1px solid var(--border); border-radius: var(--radius-xl); }
.empty-icon { font-size: 64px; opacity: 0.35; margin-bottom: 20px; }
.empty-cart h2 { font-family: var(--font-display); font-size: 34px; font-weight: 600; color: var(--obsidian); margin-bottom: 10px; }
.empty-cart p  { font-size: 15px; color: var(--muted); margin-bottom: 32px; }
.empty-cats { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; }
.btn-cat { display: inline-flex; align-items: center; gap: 8px; padding: 13px 26px; border-radius: var(--radius); font-size: 13px; font-weight: 600; text-decoration: none; transition: var(--transition); border: 1.5px solid transparent; }
.btn-cat--dark { background: var(--obsidian); color: white; }
.btn-cat--gold { background: var(--gold); color: white; }
.btn-cat--blue { background: #1a4fa0; color: white; }
.btn-cat:hover { opacity: 0.85; transform: translateY(-1px); }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.cp-toast { position: fixed; bottom: 28px; right: 28px; z-index: 99999; background: var(--obsidian); color: var(--white); padding: 14px 20px; border-radius: var(--radius); font-size: 13px; font-weight: 600; box-shadow: 0 8px 32px rgba(0,0,0,0.25); transform: translateY(70px); opacity: 0; transition: all 0.32s cubic-bezier(0.4,0,0.2,1); pointer-events: none; max-width: 300px; display: flex; align-items: center; gap: 8px; font-family: var(--font-body); }
.cp-toast.show  { transform: translateY(0); opacity: 1; }
.cp-toast.t-ok  { background: var(--success); }
.cp-toast.t-err { background: var(--danger); }
.cp-toast.t-warn { background: var(--warning); }

.sec-sep { display: flex; align-items: center; gap: 12px; margin: 26px 0 8px; }
.sec-sep-label { font-size: 10px; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: var(--muted); white-space: nowrap; }
.sec-sep-line  { flex: 1; height: 1px; background: var(--border); }

@media (max-width: 480px) {
  .cp { padding: 0 16px 80px; }
  .cp-header { padding: 28px 0 20px; }
  .checkout-steps { padding: 12px 16px; }
  .op-body { padding: 18px 18px; }
}
</style>

<div class="cp">

  <!-- HEADER -->
  <div class="cp-header">
    <div class="cp-header-left">
      <div class="cp-breadcrumb" style="margin-bottom:10px;">
        <a href="{% url 'home' %}">Home</a>
        <span class="cp-breadcrumb-sep">‚Ä∫</span>
        <span>Cart</span>
      </div>
      <h1>Your Cart</h1>
      {% if cart_items %}
      <p id="cart-head-label">
        {{ item_count }} item{{ item_count|pluralize }} ¬∑ Review your selection below
      </p>
      {% endif %}
    </div>
  </div>

  <!-- CHECKOUT STEPS -->
  <div class="checkout-steps">
    <div class="cstep active"><div class="cstep-num">1</div><span class="cstep-label">Cart</span></div>
    <div class="cstep-line"></div>
    <div class="cstep"><div class="cstep-num">2</div><span class="cstep-label">Delivery</span></div>
    <div class="cstep-line"></div>
    <div class="cstep"><div class="cstep-num">3</div><span class="cstep-label">Payment</span></div>
    <div class="cstep-line"></div>
    <div class="cstep"><div class="cstep-num">4</div><span class="cstep-label">Confirm</span></div>
  </div>

  <!-- ALERTS -->
  {% if messages %}
  {% for message in messages %}
  <div class="cp-alert cp-alert--{{ message.tags }}">
    {% if message.tags == 'success' %}‚úì{% elif message.tags == 'error' %}‚úï{% else %}‚Ñπ{% endif %}
    {{ message }}
  </div>
  {% endfor %}
  {% endif %}

  {% if cart_items %}
  <div class="cp-grid">

    <!-- LEFT: CART ITEMS -->
    <div>
      <div class="cp-left-head">
        <div class="cp-col-labels">
          <div>Product</div>
          <div style="text-align:center;">Quantity</div>
          <div style="text-align:center;">Unit Price</div>
          <div style="text-align:right;">Total</div>
        </div>
      </div>

      <div id="cart-rows">
        {% for item in cart_items %}
        {% with stock=item.product.stock_quantity|default:9999 %}

        <div class="ci-card"
             id="cart-row-{{ item.id }}"
             data-item-id="{{ item.id }}"
             data-stock="{{ stock }}">

          <!-- TYPE BANNER -->
          <div class="ci-type-banner
            {% if item.product.product_type == 'eyeglasses' %}ci-type-banner--eyeglasses
            {% elif item.product.product_type == 'sunglasses' %}ci-type-banner--sunglasses
            {% elif item.product.product_type == 'contact_lenses' %}ci-type-banner--contact
            {% elif item.product.product_type == 'reading_glasses' %}ci-type-banner--reading
            {% else %}ci-type-banner--accessories{% endif %}">
            {% if item.product.product_type == 'eyeglasses' %}
              üëì Eyeglasses &nbsp;¬∑&nbsp; Prescription Frame
            {% elif item.product.product_type == 'sunglasses' %}
              üï∂Ô∏è Sunglasses
            {% elif item.product.product_type == 'contact_lenses' %}
              üíß Contact Lenses
            {% elif item.product.product_type == 'reading_glasses' %}
              üîç Reading Glasses
            {% elif item.product.product_type == 'accessories' %}
              üß¥ Accessory
            {% else %}
              {{ item.product.product_type|title }}
            {% endif %}
            {% if item.lens_option %}
              &nbsp;¬∑&nbsp; {{ item.lens_option.lens_brand.name }}
              {% if item.lens_option.lens_type %} {{ item.lens_option.lens_type.name }}{% endif %}
            {% endif %}
          </div>

          <!-- MAIN ROW -->
          <div class="ci-main">

            <!-- Product Info -->
            <div class="ci-product">
              <a href="{% url 'product_detail' item.product.slug %}" class="ci-img-wrap">
                {% if item.product.images.first %}
                  <img src="{{ item.product.images.first.image.url }}" alt="{{ item.product.name }}" loading="lazy">
                {% elif item.product.image %}
                  <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" loading="lazy">
                {% else %}
                  <img src="{% static 'img/no-image.jpg' %}" alt="No image">
                {% endif %}
              </a>

              <div class="ci-meta">
                <a href="{% url 'product_detail' item.product.slug %}" class="ci-name">{{ item.product.name }}</a>
                {% if item.product.brand %}
                <div class="ci-brand">{{ item.product.brand.name }}</div>
                {% endif %}
                <div class="ci-unit-price">QAR {{ item.unit_price }} per unit</div>

                <div class="ci-badges">
                  {% if item.variant %}
                    {% if item.variant.color_name %}
                    <span class="cbadge cbadge-frame">
                      {% if item.variant.color_code %}
                        <span style="display:inline-block;width:9px;height:9px;border-radius:50%;background:{{ item.variant.color_code }};border:1px solid rgba(0,0,0,0.15);flex-shrink:0;"></span>
                      {% endif %}
                      {{ item.variant.color_name }}
                    </span>
                    {% endif %}
                    {% if item.variant.size %}<span class="cbadge cbadge-frame">{{ item.variant.size }}</span>{% endif %}
                  {% endif %}
                  {% if item.lens_price and item.lens_price > 0 %}
                  <span class="cbadge cbadge-addon">+QAR {{ item.lens_price }} lens</span>
                  {% endif %}
                  {% if item.sunglass_lens_option %}
                  <span class="cbadge cbadge-sunglass">üï∂ {{ item.sunglass_lens_option }}{% if item.lens_color %} ¬∑ {{ item.lens_color }}{% endif %}</span>
                  {% endif %}
                  {% if item.lens_addons.all %}
                    {% for ao in item.lens_addons.all %}
                    <span class="cbadge cbadge-addon">‚ú¶ {{ ao.addon.name }}</span>
                    {% endfor %}
                  {% endif %}
                  {% if item.contact_lens_left_power or item.contact_lens_right_power %}
                  <span class="cbadge cbadge-contact">L: {{ item.contact_lens_left_power|default:"Plano" }}</span>
                  <span class="cbadge cbadge-contact">R: {{ item.contact_lens_right_power|default:"Plano" }}</span>
                  {% endif %}
                  {% if item.prescription_data.color_name %}
                  <span class="cbadge cbadge-color">üé® {{ item.prescription_data.color_name }}</span>
                  {% endif %}
                </div>

                <div class="stock-warn" id="stock-warn-{{ item.id }}">‚ö† Max stock reached</div>
              </div>
            </div>

            <!-- Quantity -->
            <div class="qty-cell" style="display:flex;justify-content:center;">
              <div class="qty-control" id="qty-ctrl-{{ item.id }}">
                <button class="qty-btn decrease-qty" type="button" data-item-id="{{ item.id }}"
                        {% if item.quantity <= 1 %}disabled{% endif %} aria-label="Decrease">‚àí</button>
                <input class="qty-input qty-val-{{ item.id }}" type="text" value="{{ item.quantity }}" readonly aria-label="Quantity">
                <button class="qty-btn increase-qty" type="button" data-item-id="{{ item.id }}"
                        {% if item.quantity >= stock %}disabled{% endif %} aria-label="Increase">+</button>
              </div>
            </div>

            <!-- Unit price column -->
            <div class="price-col price-cell">
              <div>QAR {{ item.unit_price }}</div>
              {% if item.lens_price and item.lens_price > 0 %}
              <div class="lens-sub">+QAR {{ item.lens_price }} lens</div>
              {% endif %}
            </div>

            <!-- Item total -->
            <div class="total-cell" style="display:flex;justify-content:flex-end;align-items:center;">
              <div class="ci-total item-total-{{ item.id }}">QAR {{ item.item_total }}</div>
            </div>
          </div><!-- /ci-main -->

          <!-- EXPANDED CONFIG -->
          {% if item.prescription_data or item.lens_addons.all or item.special_instructions or item.contact_lens_left_power or item.contact_lens_right_power or item.sunglass_lens_option %}
          <div class="ci-config">
            <div class="ci-config-inner">
              <div class="ci-config-tabs">
                {% if item.prescription_data %}<div class="ci-config-tab active filled">üìã Prescription</div>{% endif %}
                {% if item.lens_option %}<div class="ci-config-tab filled">üîç Lens Details</div>{% endif %}
                {% if item.sunglass_lens_option %}<div class="ci-config-tab filled">üï∂ Sunglass Lens</div>{% endif %}
                {% if item.contact_lens_left_power or item.contact_lens_right_power %}<div class="ci-config-tab filled">üíß Power</div>{% endif %}
                {% if item.lens_addons.all %}<div class="ci-config-tab filled">‚ú¶ Add-ons</div>{% endif %}
              </div>
              <div class="ci-config-body">
                {% if item.prescription_data %}
                  {% if item.prescription_data.right_sph or item.prescription_data.right_eye %}
                  <div style="margin-bottom:10px;">
                    <div class="rx-grid">
                      <div class="rx-head"></div>
                      <div class="rx-head">SPH</div><div class="rx-head">CYL</div><div class="rx-head">AXIS</div><div class="rx-head">ADD</div>
                      {% if item.prescription_data.right_sph %}
                      <div class="rx-eye">OD (R)</div>
                      <div class="rx-val">{{ item.prescription_data.right_sph|default:"‚Äî" }}</div>
                      <div class="rx-val">{{ item.prescription_data.right_cyl|default:"‚Äî" }}</div>
                      <div class="rx-val">{{ item.prescription_data.right_axis|default:"‚Äî" }}</div>
                      <div class="rx-val">{{ item.prescription_data.right_add|default:"‚Äî" }}</div>
                      {% endif %}
                      {% if item.prescription_data.left_sph %}
                      <div class="rx-eye">OS (L)</div>
                      <div class="rx-val">{{ item.prescription_data.left_sph|default:"‚Äî" }}</div>
                      <div class="rx-val">{{ item.prescription_data.left_cyl|default:"‚Äî" }}</div>
                      <div class="rx-val">{{ item.prescription_data.left_axis|default:"‚Äî" }}</div>
                      <div class="rx-val">{{ item.prescription_data.left_add|default:"‚Äî" }}</div>
                      {% endif %}
                      {% if item.prescription_data.right_eye %}
                      <div class="rx-eye">OD (R)</div>
                      <div class="rx-val">{{ item.prescription_data.right_eye.sph|default:"‚Äî" }}</div>
                      <div class="rx-val">{{ item.prescription_data.right_eye.cyl|default:"‚Äî" }}</div>
                      <div class="rx-val">{{ item.prescription_data.right_eye.axis|default:"‚Äî" }}</div>
                      <div class="rx-val">{{ item.prescription_data.right_eye.add|default:"‚Äî" }}</div>
                      {% endif %}
                      {% if item.prescription_data.left_eye %}
                      <div class="rx-eye">OS (L)</div>
                      <div class="rx-val">{{ item.prescription_data.left_eye.sph|default:"‚Äî" }}</div>
                      <div class="rx-val">{{ item.prescription_data.left_eye.cyl|default:"‚Äî" }}</div>
                      <div class="rx-val">{{ item.prescription_data.left_eye.axis|default:"‚Äî" }}</div>
                      <div class="rx-val">{{ item.prescription_data.left_eye.add|default:"‚Äî" }}</div>
                      {% endif %}
                    </div>
                  </div>
                  {% endif %}
                {% endif %}
                {% if item.prescription_data.color_name and not item.prescription_data.right_sph %}
                <div style="display:flex;align-items:center;gap:8px;font-size:12px;">
                  <span style="color:var(--muted);">Color:</span>
                  <span class="cbadge cbadge-color">üé® {{ item.prescription_data.color_name }}</span>
                </div>
                {% endif %}
                {% if item.contact_lens_left_power or item.contact_lens_right_power %}
                <div class="cl-power-display" style="{% if item.prescription_data %}margin-top:12px;{% endif %}">
                  <div class="cl-power-box">
                    <div class="cl-eye">Left Eye (OS)</div>
                    <div class="cl-pwr">{{ item.contact_lens_left_power|default:"Plano" }}</div>
                    <div class="cl-unit">diopters</div>
                  </div>
                  <div class="cl-power-box">
                    <div class="cl-eye">Right Eye (OD)</div>
                    <div class="cl-pwr">{{ item.contact_lens_right_power|default:"Plano" }}</div>
                    <div class="cl-unit">diopters</div>
                  </div>
                </div>
                {% endif %}
                {% if item.sunglass_lens_option %}
                <div class="sg-lens-display">
                  <div class="sg-lens-chip"><strong>Lens Type</strong><span>{{ item.sunglass_lens_option }}</span></div>
                  {% if item.lens_color %}<div class="sg-lens-chip"><strong>Lens Color</strong><span>{{ item.lens_color }}</span></div>{% endif %}
                  {% if item.lens_price and item.lens_price > 0 %}<div class="sg-lens-chip"><strong>Lens Price</strong><span>QAR {{ item.lens_price }}</span></div>{% endif %}
                </div>
                {% endif %}
                {% if item.lens_option %}
                <div class="sg-lens-display">
                  <div class="sg-lens-chip"><strong>Brand</strong><span>{{ item.lens_option.lens_brand.name }}</span></div>
                  {% if item.lens_option.lens_type %}<div class="sg-lens-chip"><strong>Type</strong><span>{{ item.lens_option.lens_type.name }}</span></div>{% endif %}
                  <div class="sg-lens-chip"><strong>Index</strong><span>{{ item.lens_option.index }}</span></div>
                  <div class="sg-lens-chip"><strong>Lens Price</strong><span>QAR {{ item.lens_price }}</span></div>
                </div>
                {% endif %}
                {% if item.lens_addons.all %}
                <div class="addon-list" style="margin-top:10px;">
                  {% for ao in item.lens_addons.all %}
                  <div class="addon-item">
                    <div class="addon-item-name">‚ú¶ {{ ao.addon.name }}</div>
                    <div class="addon-item-price">+QAR {{ ao.price }}</div>
                  </div>
                  {% endfor %}
                </div>
                {% endif %}
                {% if item.special_instructions %}
                <div class="ci-note" style="margin-top:10px;">üìù {{ item.special_instructions }}</div>
                {% endif %}
              </div>
            </div>
          </div>
          {% elif item.special_instructions %}
          <div class="ci-config">
            <div class="ci-note">üìù {{ item.special_instructions }}</div>
          </div>
          {% endif %}

          <!-- CARD FOOTER -->
          <div class="ci-footer">
            <button class="ci-remove-btn" data-item-id="{{ item.id }}" aria-label="Remove {{ item.product.name }}">
              ‚úï Remove
            </button>
            {% if item.product.product_type == 'eyeglasses' %}
            <a href="{% url 'catalog:eyeglass_detail' item.product.slug %}" class="ci-edit-lens">‚úè Edit Lens Configuration</a>
            {% elif item.product.product_type == 'sunglasses' %}
            <a href="{% url 'catalog:sunglass_detail' item.product.slug %}" class="ci-edit-lens">‚úè Edit Lens Configuration</a>
            {% elif item.product.product_type == 'contact_lenses' %}
            <a href="{% url 'catalog:contact_lens_detail' item.product.slug %}" class="ci-edit-lens">‚úè Edit Power / Color</a>
            {% elif item.product.product_type == 'reading_glasses' %}
            <a href="{% url 'catalog:product_detail' item.product.slug %}" class="ci-edit-lens">‚úè Edit Reading Power</a>
            {% endif %}
          </div>

        </div><!-- /ci-card -->
        {% endwith %}
        {% endfor %}
      </div><!-- /cart-rows -->

      <div class="cp-continue">
        <a href="{% url 'home' %}" class="cp-continue-btn">‚Üê Continue Shopping</a>
      </div>

      <div class="trust-strip">
        <div class="tt"><div class="tt-icon">üöö</div><div class="tt-title">Free Delivery</div><div class="tt-desc">Orders over QAR 200</div></div>
        <div class="tt"><div class="tt-icon">üîÑ</div><div class="tt-title">Easy Returns</div><div class="tt-desc">14-day policy</div></div>
        <div class="tt"><div class="tt-icon">üîí</div><div class="tt-title">Secure Checkout</div><div class="tt-desc">End-to-end encrypted</div></div>
        <div class="tt"><div class="tt-icon">üëÅ</div><div class="tt-title">Free Eye Test</div><div class="tt-desc">At any of our stores</div></div>
      </div>
    </div><!-- /LEFT -->

    <!-- RIGHT: ORDER SUMMARY -->
    <div class="order-panel">
      <div class="op-head">
        <h2>Order Summary</h2>
        <p id="cart-head-label-side">{{ item_count }} item{{ item_count|pluralize }} in your cart</p>
      </div>

      <div class="op-body">

        <!-- Free shipping bar -->
        <div class="fs-bar">
          <div class="fs-text {% if shipping == 0 %}qualified{% endif %}" id="fs-text">
            {% if shipping == 0 %}
            ‚úì Free shipping unlocked!
            {% else %}
            üöö Add QAR <span id="fs-remain">{{ free_shipping_remaining }}</span> for free shipping
            {% endif %}
          </div>
          <div class="fs-track">
            <div class="fs-fill" id="fs-fill"
                 style="width:{% if shipping == 0 %}100{% else %}{{ shipping_progress|floatformat:0 }}{% endif %}%;"></div>
          </div>
        </div>

        <!-- Promo code -->
        <div class="promo-wrap">
          <input type="text" class="promo-input" placeholder="Enter promo code" id="promo-input">
          <button class="promo-btn" onclick="applyPromo()">Apply</button>
        </div>

        <!-- Subtotal -->
        <div class="sr">
          <span class="sr-label">Subtotal (<span id="sum-count">{{ item_count }}</span> items)</span>
          <span id="sum-subtotal"><strong>QAR {{ subtotal }}</strong></span>
        </div>

        <!-- Shipping -->
        <div class="sr" id="sum-shipping-row" style="{% if shipping == 0 %}display:none;{% endif %}">
          <span>Shipping</span>
          <span id="sum-shipping">QAR {{ shipping }}</span>
        </div>

        <!-- Free badge -->
        <div id="sum-free-badge"
             style="display:{% if shipping == 0 %}flex{% else %}none{% endif %};
                    align-items:center;gap:6px;font-size:12px;
                    color:var(--success);margin-bottom:10px;font-weight:600;">
          ‚úì FREE Shipping
        </div>

        <!-- Tax -->
        <div class="sr" style="font-size:11px;color:var(--muted);">
          <span>VAT / Tax</span>
          <span>Calculated at checkout</span>
        </div>

        <div class="op-divider"></div>

        <!-- Grand Total -->
        <div class="sr sr--total">
          <span>Total</span>
          <span id="sum-total">QAR {{ total }}</span>
        </div>

        <p class="sr-note">Inclusive of taxes where applicable</p>

        <!-- CTA -->
        <a href="{% url 'orders:checkout' %}" id="btn-checkout"
           class="btn-checkout {% if total == 0 %}disabled{% endif %}">
          <span>Proceed to Checkout</span>
          <span>‚Üí</span>
        </a>

        <a href="{% url 'home' %}" class="btn-shop-more">Continue Shopping</a>

        <div class="pay-icons">
          <div class="pay-icon">VISA</div>
          <div class="pay-icon">MC</div>
          <div class="pay-icon">AMEX</div>
          <div class="pay-icon">MADA</div>
          <div class="pay-icon">CASH</div>
        </div>

        <div class="op-benefits">
          <div class="ben-row"><div class="ben-icon">üîí</div><span>SSL encrypted checkout</span></div>
          <div class="ben-row"><div class="ben-icon">üè∑</div><span>1-year warranty on all frames</span></div>
          <div class="ben-row"><div class="ben-icon">üëÅ</div><span>Free eye test at our stores</span></div>
          <div class="ben-row"><div class="ben-icon">üìû</div><span>24/7 customer support</span></div>
        </div>

      </div>
    </div><!-- /RIGHT -->

  </div><!-- /cp-grid -->

  {% else %}
  <!-- EMPTY CART -->
  <div class="cp-grid">
    <div class="empty-cart">
      <div class="empty-icon">üõí</div>
      <h2>Your cart is empty</h2>
      <p>You haven't added anything yet ‚Äî explore our collections below</p>
      <div class="empty-cats">
        <a href="{% url 'catalog:eyeglasses_list' %}" class="btn-cat btn-cat--dark">üëì Eyeglasses</a>
        <a href="{% url 'catalog:sunglasses_list' %}" class="btn-cat btn-cat--gold">üï∂ Sunglasses</a>
        <a href="{% url 'catalog:contact_lenses_list' %}" class="btn-cat btn-cat--blue">üíß Contact Lenses</a>
      </div>
    </div>
  </div>
  {% endif %}

</div><!-- /cp -->

<!-- TOAST -->
<div class="cp-toast" id="cpToast"></div>

<script>
(function () {
"use strict";

const FREE_SHIP_THRESHOLD = 200;

/* ‚îÄ‚îÄ CSRF ‚îÄ‚îÄ */
function csrf() {
  const m = document.cookie.match(/csrftoken=([^;]+)/);
  return m ? decodeURIComponent(m[1]) : "";
}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
let _tt;
function toast(msg, type) {
  const el = document.getElementById("cpToast");
  if (!el) return;
  el.textContent = msg;
  el.className = "cp-toast show" +
    (type === "ok" ? " t-ok" : type === "err" ? " t-err" : type === "warn" ? " t-warn" : "");
  clearTimeout(_tt);
  _tt = setTimeout(() => el.classList.remove("show"), 3800);
}

/* ‚îÄ‚îÄ PROMO ‚îÄ‚îÄ */
function applyPromo() {
  const val = (document.getElementById("promo-input") || {}).value || "";
  if (!val.trim()) { toast("Enter a promo code first.", "warn"); return; }
  toast("Promo codes coming soon!", "warn");
}
window.applyPromo = applyPromo;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   UPDATE HEADER BADGE ‚Äî syncs the bag icon
   in the site header on every cart change.
   Works with both #aa-cart-count (base.html)
   and any other badge selector used.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function syncHeaderBadge(count) {
  const n = parseInt(count) || 0;

  // Primary badge from base.html
  const primary = document.getElementById("aa-cart-count");
  if (primary) {
    primary.textContent = n;
    primary.style.transform = "scale(1.4)";
    setTimeout(() => { primary.style.transform = "scale(1)"; }, 300);
  }

  // Any other badge elements sites might use
  document.querySelectorAll(
    "#cart-count, #cart-items-count, .cart-badge, " +
    ".header-v24__cart-count, [data-cart-count]"
  ).forEach(el => {
    el.textContent = n;
    el.style.transform = "scale(1.35)";
    setTimeout(() => { el.style.transform = ""; }, 300);
  });

  // window.updateCartBadge is exposed by base.html as well
  if (typeof window.updateCartBadge === "function") {
    window.updateCartBadge(n);
  }
}

/* ‚îÄ‚îÄ FREE-SHIP BAR ‚îÄ‚îÄ */
function updateFsBar(sub) {
  const textEl = document.getElementById("fs-text");
  const fillEl = document.getElementById("fs-fill");
  if (!textEl) return;
  if (sub >= FREE_SHIP_THRESHOLD) {
    textEl.className = "fs-text qualified";
    textEl.innerHTML = "‚úì Free shipping unlocked!";
    if (fillEl) fillEl.style.width = "100%";
  } else {
    const rem = (FREE_SHIP_THRESHOLD - sub).toFixed(2);
    const pct = Math.min(100, Math.round(sub / FREE_SHIP_THRESHOLD * 100));
    textEl.className = "fs-text";
    textEl.innerHTML = 'üöö Add QAR <span id="fs-remain">' + rem + '</span> for free shipping';
    if (fillEl) fillEl.style.width = pct + "%";
  }
}

/* ‚îÄ‚îÄ UPDATE ALL SUMMARY UI ‚îÄ‚îÄ */
function updateSummary(data) {
  const sub   = parseFloat(data.subtotal)   || 0;
  const ship  = parseFloat(data.shipping)   || 0;
  const tot   = parseFloat(data.cart_total) || 0;
  const cnt   = parseInt(data.cart_count)   || 0;

  // Subtotal
  const subEl = document.getElementById("sum-subtotal");
  if (subEl) subEl.innerHTML = "<strong>QAR " + sub.toFixed(2) + "</strong>";

  // Shipping row / free badge
  const shipRow   = document.getElementById("sum-shipping-row");
  const shipEl    = document.getElementById("sum-shipping");
  const freeBadge = document.getElementById("sum-free-badge");
  if (shipRow)   shipRow.style.display   = ship > 0 ? "flex" : "none";
  if (freeBadge) freeBadge.style.display = ship === 0 ? "flex" : "none";
  if (shipEl)    shipEl.textContent      = "QAR " + ship.toFixed(2);

  // Grand total
  const totEl = document.getElementById("sum-total");
  if (totEl) totEl.textContent = "QAR " + tot.toFixed(2);

  // Item counts in summary + header text
  const cntEl = document.getElementById("sum-count");
  if (cntEl) cntEl.textContent = cnt;

  const headEl = document.getElementById("cart-head-label");
  if (headEl) headEl.textContent = cnt + " item" + (cnt !== 1 ? "s" : "") + " ¬∑ Review your selection below";

  const sideEl = document.getElementById("cart-head-label-side");
  if (sideEl) sideEl.textContent = cnt + " item" + (cnt !== 1 ? "s" : "") + " in your cart";

  // Checkout button
  const btn = document.getElementById("btn-checkout");
  if (btn) { tot <= 0 ? btn.classList.add("disabled") : btn.classList.remove("disabled"); }

  // Free-ship progress bar
  updateFsBar(sub);

  // ‚òÖ Always sync the header bag badge
  syncHeaderBadge(cnt);
}

/* ‚îÄ‚îÄ APPLY ITEM UPDATE ‚îÄ‚îÄ */
function applyItemUpdate(itemId, data) {
  const qty   = parseInt(data.quantity);
  const stock = getStock(itemId);

  document.querySelectorAll(".qty-val-" + itemId).forEach(el => { el.value = qty; });

  const totEl = document.querySelector(".item-total-" + itemId);
  if (totEl) {
    totEl.textContent = "QAR " + parseFloat(data.item_total).toFixed(2);
    totEl.classList.add("flash");
    setTimeout(() => totEl.classList.remove("flash"), 550);
  }

  syncBtns(itemId, qty, stock);

  const warn = document.getElementById("stock-warn-" + itemId);
  if (warn) { qty >= stock ? warn.classList.add("visible") : warn.classList.remove("visible"); }

  updateSummary(data);   // ‚Üê summary + header badge
}

function getStock(id) {
  const row = document.getElementById("cart-row-" + id);
  return row ? (parseInt(row.dataset.stock) || 9999) : 9999;
}

function syncBtns(id, qty, stock) {
  const dec = document.querySelector(`.decrease-qty[data-item-id="${id}"]`);
  const inc = document.querySelector(`.increase-qty[data-item-id="${id}"]`);
  if (dec) { qty <= 1 ? (dec.setAttribute("disabled",""), dec.classList.add("at-limit")) : (dec.removeAttribute("disabled"), dec.classList.remove("at-limit")); }
  if (inc) { qty >= stock ? (inc.setAttribute("disabled",""), inc.classList.add("at-limit")) : (inc.removeAttribute("disabled"), inc.classList.remove("at-limit")); }
}

/* ‚îÄ‚îÄ REMOVE ROW ‚îÄ‚îÄ */
function removeRow(itemId, data) {
  const row = document.getElementById("cart-row-" + itemId);
  if (row) {
    row.classList.add("removing");
    setTimeout(() => {
      row.remove();
      updateSummary(data);   // ‚Üê updates badge after removal
      if (parseInt(data.cart_count) === 0) setTimeout(() => location.reload(), 400);
    }, 370);
  } else {
    updateSummary(data);
    if (parseInt(data.cart_count) === 0) location.reload();
  }
}

/* ‚îÄ‚îÄ FETCH HELPER ‚îÄ‚îÄ */
function cartFetch(url, method, onOk, onFail, onFinal) {
  fetch(url, {
    method,
    headers: { "X-Requested-With": "XMLHttpRequest", "X-CSRFToken": csrf() }
  })
  .then(r => r.json())
  .then(d => { d.success ? onOk(d) : onFail(d); })
  .catch(() => toast("Network error. Try again.", "err"))
  .finally(onFinal || (() => {}));
}

/* ‚îÄ‚îÄ EVENT DELEGATION ‚îÄ‚îÄ */
document.addEventListener("click", function (e) {

  // INCREASE
  const inc = e.target.closest(".increase-qty");
  if (inc && !inc.hasAttribute("disabled")) {
    e.preventDefault();
    const id    = inc.dataset.itemId;
    const stock = getStock(id);
    const cur   = parseInt(document.querySelector(".qty-val-" + id)?.value || 1);
    if (cur >= stock) {
      toast("Max stock reached (" + stock + " available)", "warn");
      inc.setAttribute("disabled",""); inc.classList.add("at-limit");
      const w = document.getElementById("stock-warn-" + id);
      if (w) w.classList.add("visible");
      return;
    }
    const ctrl = document.getElementById("qty-ctrl-" + id);
    if (ctrl) ctrl.classList.add("loading");
    cartFetch(
      "/cart/update/" + id + "/increase/", "GET",
      d  => applyItemUpdate(id, d),
      d  => {
        if (d.limit_reached) { toast("Only " + d.quantity + " in stock", "warn"); syncBtns(id, d.quantity, stock); }
        else toast(d.message || "Could not update", "err");
      },
      () => { if (ctrl) ctrl.classList.remove("loading"); }
    );
    return;
  }

  // DECREASE
  const dec = e.target.closest(".decrease-qty");
  if (dec && !dec.hasAttribute("disabled")) {
    e.preventDefault();
    const id  = dec.dataset.itemId;
    const cur = parseInt(document.querySelector(".qty-val-" + id)?.value || 1);
    if (cur <= 1) { toast("Minimum is 1. Use Remove to delete.", "warn"); dec.setAttribute("disabled",""); return; }
    const ctrl = document.getElementById("qty-ctrl-" + id);
    if (ctrl) ctrl.classList.add("loading");
    cartFetch(
      "/cart/update/" + id + "/decrease/", "GET",
      d  => applyItemUpdate(id, d),
      d  => toast(d.message || "Could not update", "err"),
      () => { if (ctrl) ctrl.classList.remove("loading"); }
    );
    return;
  }

  // REMOVE
  const rm = e.target.closest(".ci-remove-btn");
  if (rm) {
    e.preventDefault();
    if (!confirm("Remove this item from your cart?")) return;
    const id = rm.dataset.itemId;
    rm.disabled = true;
    rm.textContent = "Removing‚Ä¶";
    cartFetch(
      "/cart/remove/" + id + "/", "POST",
      d  => { toast(d.message || "Item removed", "ok"); removeRow(id, d); },
      d  => { toast(d.message || "Could not remove", "err"); rm.disabled = false; rm.innerHTML = "‚úï Remove"; }
    );
    return;
  }
});

/* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll(".ci-card").forEach(function (card) {
    const id    = card.dataset.itemId;
    const stock = parseInt(card.dataset.stock) || 9999;
    const qtyEl = card.querySelector(".qty-input");
    if (!qtyEl || !id) return;
    const qty = parseInt(qtyEl.value) || 1;
    syncBtns(id, qty, stock);
    if (qty >= stock) {
      const w = document.getElementById("stock-warn-" + id);
      if (w) w.classList.add("visible");
    }
  });
});

})();
</script>
{% endblock %}