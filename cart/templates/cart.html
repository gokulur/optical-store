{% extends 'base.html' %}
{% load static %}
{% block title %}Shopping Cart{% endblock %}

{% block content %}
<style>
    .disabled {
        opacity: 0.5;
        pointer-events: none;
    }
    
    /* Lens Info Styling */
    .lens-info {
        background: #f9f9f9;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        font-size: 13px;
    }
    
    .lens-info p {
        margin: 5px 0;
        color: #666;
    }
    
    .lens-info strong {
        color: #000;
    }
    
    .lens-info ul {
        margin: 5px 0 0 20px;
        padding: 0;
    }
    
    .lens-info li {
        margin: 3px 0;
    }
    
    /* Prescription Info */
    .prescription-info {
        background: #fff3cd;
        border: 1px solid #ffc107;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        font-size: 13px;
    }
    
    .prescription-details {
        margin-top: 5px;
    }
    
    .eye-prescription {
        margin: 5px 0;
        color: #666;
    }
    
    /* Contact Lens Power */
    .contact-lens-power {
        background: #e3f2fd;
        border: 1px solid #2196f3;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        font-size: 13px;
    }
    
    .contact-lens-power p {
        margin: 3px 0;
        color: #666;
    }
    
    /* Special Instructions */
    .special-instructions {
        background: #f3e5f5;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        font-size: 13px;
        font-style: italic;
        color: #666;
    }
    
    /* Empty Cart */
    .empty-cart-message {
        text-align: center;
        padding: 60px 20px;
    }
    
    .empty-cart-icon {
        font-size: 80px;
        margin-bottom: 20px;
    }
    
    .empty-cart-message h2 {
        font-size: 24px;
        margin-bottom: 10px;
    }
    
    .empty-cart-message p {
        color: #666;
        margin-bottom: 30px;
    }
</style>

<main id="xo-main-content" class="content-for-layout focus-none" role="main" tabindex="-1">
    <!-- Page Heading -->
    <div id="shopify-section-template--cart-heading" class="shopify-section">
        <section class="xo-section color-background-1" style="--margin: 0;--pt: 50;--pb: 0;">
            <xo-animate class="xo-section-bg" xo-disabled="" xo-duration="1000"
                style="animation: auto ease 0s 1 normal none running none; opacity: 1;" xo-visible="">
                <xo-parallax xo-lerp-ease="0.4" class="xo-section-bg-image__item">
                    <xo-parallax-scroll
                        xo-keyframes="{ '0%': { backgroundPositionY: '200px' }, '100%': { backgroundPositionY: '-200px' }, }"
                        class="xo-section-bg-image__url xo-background-lazyload" xo-fit-content=""
                        style="backface-visibility: hidden; background-size: cover; background-position: 50% -123.761px; background-attachment: fixed;"></xo-parallax-scroll>
                </xo-parallax>
            </xo-animate>

            <xo-container>
                <xo-animate xo-cascade="" xo-type="fade-up"
                    style="opacity: 1; --xo-order: 0; --xo-strength: 1; --xo-constant: 75; --xo-duration: 500; --xo-easing: cubic-bezier(0, 0, 0.3, 1); animation: auto ease 0s 1 normal none running none;"
                    xo-visible="">
                    <div class="xo-page-heading xo-page-heading--center">
                        <h1 class="xo-page-heading__title">Your Shopping Cart</h1>
                        <div class="xo-page-heading__description">
                            {% if cart_items %}
                            <p>{{ cart_items|length }} item(s) in your cart</p>
                            {% endif %}
                        </div>
                    </div>
                </xo-animate>
            </xo-container>
        </section>
    </div>

    <!-- Messages -->
    {% if messages %}
    <div class="xo-section color-background-1" style="--margin: 0;--pt: 20;--pb: 0;">
        <xo-container>
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }}" style="padding: 15px; margin-bottom: 15px; border-radius: 5px; background: {% if message.tags == 'success' %}#d4edda{% elif message.tags == 'error' %}#f8d7da{% else %}#d1ecf1{% endif %};">
                {{ message }}
            </div>
            {% endfor %}
        </xo-container>
    </div>
    {% endif %}

    <!-- Cart Items Section -->
    <div id="shopify-section-template--cart-items" class="shopify-section">
        <div class="xo-section color-background-1" style="--margin: 0;--pt: 20;--pb: 50;">
            <xo-cart id="template--cart-items" class="xo-main-cart color-background-1">
                <xo-container class="xo-cart">
                    <xo-animate xo-cascade="" xo-type="fade-up"
                        style="opacity: 1; --xo-order: 1; --xo-strength: 1; --xo-constant: 75; --xo-duration: 500; --xo-easing: cubic-bezier(0, 0, 0.3, 1); animation: auto ease 0s 1 normal none running none;"
                        xo-visible="">
                        
                        {% if cart_items %}
                        <xo-cart-will-change xo-unique-id="cart-table-template">
                            <xo-grid>
                                <div style="--xs: 12; --sm: 12; --md: 12; --lg: 8;" class="xo-cart__left">
                                    <div class="xo-cart-table">
                                        <form action=" " method="post" id="cart">
                                            {% csrf_token %}
                                            <table role="table" class="xo-table">
                                                <thead role="rowgroup">
                                                    <tr role="row" class="xo-table__head-row">
                                                        <th role="columnheader">Product</th>
                                                        <th role="columnheader">Quantity</th>
                                                        <th role="columnheader">Total</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for item in cart_items %}
                                                    <tr role="row" class="xo-table__body-row"
                                                        data-item-id="{{ item.id }}" id="cart-row-{{ item.id }}">
                                                        <td role="cell" data-th="Product">
                                                            <xo-product xo-section-id="template--cart-items"
                                                                xo-product-id="{{ item.product.id }}"
                                                                xo-line="{{ forloop.counter }}">
                                                                <div class="xo-cart-item">
                                                                    <a href="{% url 'product_detail' item.product.slug %}" class="xo-cart-item__image">
                                                                        {% if item.product.image %}
                                                                        <div class="xo-image" style="--xo-ratio-percent: 1/1;">
                                                                            <img src="{{ item.product.image.url }}"
                                                                                alt="{{ item.product.name }}"
                                                                                width="860" height="860" loading="lazy"
                                                                                is="xo-lazyload" sizes="100vw"
                                                                                fetchpriority="auto"
                                                                                xo-loaded="">
                                                                        </div>
                                                                        {% else %}
                                                                        <div class="xo-image">
                                                                            <img src="{% static 'images/no-image.png' %}"
                                                                                alt="No Image">
                                                                        </div>
                                                                        {% endif %}
                                                                    </a>

                                                                    <div class="xo-cart-item__content">
                                                                        <a href="{% url 'product_detail' item.product.slug %}" class="xo-cart-item__title">
                                                                            {{ item.product.name }}
                                                                        </a>
                                                                        
                                                                        <div class="xo-cart-item__price">
                                                                            <div class="xo-cart-item__original-price">
                                                                                QAR {{ item.unit_price }}
                                                                            </div>
                                                                        </div>

                                                                        <!-- Mobile Quantity Controls -->
                                                                        <xo-product xo-section-id="template--cart-items"
                                                                            xo-product-id="{{ item.product.id }}">
                                                                            <div class="xo-cart-item__quantity">
                                                                                <div class="xo-cart-table__quantity">
                                                                                    <xo-cart-quantity class="xo-quantity-style2"
                                                                                        style="--width: 10rem; --height: 4rem"
                                                                                        data-item-id="{{ item.id }}">
                                                                                        <a href="?action=decrease"
                                                                                            class="xo-quantity-style2__button decrease-qty"
                                                                                            data-item-id="{{ item.id }}"
                                                                                            data-url="?action=decrease">â€“</a>

                                                                                        <input type="text" value="{{ item.quantity }}" readonly
                                                                                            class="xo-quantity-style2__number item-quantity-{{ item.id }}">

                                                                                        <a href="?action=increase"
                                                                                            class="xo-quantity-style2__button increase-qty"
                                                                                            data-item-id="{{ item.id }}"
                                                                                            data-url="?action=increase">+</a>
                                                                                    </xo-cart-quantity>
                                                                                </div>
                                                                            </div>
                                                                        </xo-product>

                                                                        <!-- Product Details -->
                                                                        <div class="xo-cart-item__options">
                                                                            {% if item.product.brand %}
                                                                            <div class="xo-cart-item__option">
                                                                                <span>Brand:</span>
                                                                                <span>{{ item.product.brand.name }}</span>
                                                                            </div>
                                                                            {% endif %}
                                                                            
                                                                            {% if item.variant %}
                                                                            <div class="xo-cart-item__option">
                                                                                <span>Color:</span>
                                                                                <span>{{ item.variant.color_name }}</span>
                                                                            </div>
                                                                            {% if item.variant.size %}
                                                                            <div class="xo-cart-item__option">
                                                                                <span>Size:</span>
                                                                                <span>{{ item.variant.size }}</span>
                                                                            </div>
                                                                            {% endif %}
                                                                            {% endif %}
                                                                        </div>

                                                                        <!-- Lens Information -->
                                                                        {% if item.lens_option %}
                                                                        <div class="lens-info">
                                                                            <p><strong>Lens:</strong> {{ item.lens_option.lens_brand.name }} {{ item.lens_option.lens_type.name }}</p>
                                                                            <p>Index: {{ item.lens_option.index }} | Price: QAR {{ item.lens_price }}</p>
                                                                            
                                                                            {% if item.lens_addons.all %}
                                                                            <p><strong>Add-ons:</strong></p>
                                                                            <ul>
                                                                                {% for addon_item in item.lens_addons.all %}
                                                                                <li>{{ addon_item.addon.name }} - QAR {{ addon_item.price }}</li>
                                                                                {% endfor %}
                                                                            </ul>
                                                                            {% endif %}
                                                                        </div>
                                                                        {% endif %}

                                                                        {% if item.sunglass_lens_option %}
                                                                        <div class="lens-info">
                                                                            <p><strong>Sunglass Lens:</strong> {{ item.sunglass_lens_option }}</p>
                                                                            <p>Color: {{ item.lens_color|default:"Standard" }} | Price: QAR {{ item.lens_price }}</p>
                                                                        </div>
                                                                        {% endif %}

                                                                        <!-- Prescription Info -->
                                                                        {% if item.prescription_data %}
                                                                        <div class="prescription-info">
                                                                            <p><strong>Prescription:</strong></p>
                                                                            <div class="prescription-details">
                                                                                <div class="eye-prescription">
                                                                                    <strong>Right Eye:</strong>
                                                                                    SPH: {{ item.prescription_data.right_sph|default:"-" }},
                                                                                    CYL: {{ item.prescription_data.right_cyl|default:"-" }},
                                                                                    AXIS: {{ item.prescription_data.right_axis|default:"-" }}
                                                                                    {% if item.prescription_data.right_add %}
                                                                                    , ADD: {{ item.prescription_data.right_add }}
                                                                                    {% endif %}
                                                                                </div>
                                                                                <div class="eye-prescription">
                                                                                    <strong>Left Eye:</strong>
                                                                                    SPH: {{ item.prescription_data.left_sph|default:"-" }},
                                                                                    CYL: {{ item.prescription_data.left_cyl|default:"-" }},
                                                                                    AXIS: {{ item.prescription_data.left_axis|default:"-" }}
                                                                                    {% if item.prescription_data.left_add %}
                                                                                    , ADD: {{ item.prescription_data.left_add }}
                                                                                    {% endif %}
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        {% endif %}

                                                                        <!-- Contact Lens Power -->
                                                                        {% if item.contact_lens_left_power or item.contact_lens_right_power %}
                                                                        <div class="contact-lens-power">
                                                                            <p><strong>Power:</strong></p>
                                                                            <p>Left: {{ item.contact_lens_left_power|default:"Plano" }}</p>
                                                                            <p>Right: {{ item.contact_lens_right_power|default:"Plano" }}</p>
                                                                        </div>
                                                                        {% endif %}

                                                                        {% if item.special_instructions %}
                                                                        <div class="special-instructions">
                                                                            <p><strong>Note:</strong> {{ item.special_instructions }}</p>
                                                                        </div>
                                                                        {% endif %}

                                                                        <!-- Remove Button -->
                                                                        <xo-cart-remove>
                                                                            <button class="xo-btn xo-btn--dark xo-btn--link xo-btn--slide-up remove-item-btn"
                                                                                style="cursor: pointer;"
                                                                                data-item-id="{{ item.id }}"
                                                                                data-url=""
                                                                                aria-label="Remove {{ item.product.name }}">
                                                                                <span class="xo-btn__content">
                                                                                    <span class="xo-btn__text" data-text="Delete">Delete</span>
                                                                                </span>
                                                                                <span class="xo-btn__loading">
                                                                                    <div class="xo-loader-3"
                                                                                        style="--size: 8; --color: currentColor; --duration: 1000;">
                                                                                        <div></div>
                                                                                    </div>
                                                                                </span>
                                                                            </button>
                                                                        </xo-cart-remove>

                                                                        <xo-cart-change-fallback>
                                                                            <div class="xo-loader-2"
                                                                                style="--size: 26; --color: currentColor; --duration: 1000; --stroke-width: 2;">
                                                                                <div></div>
                                                                            </div>
                                                                        </xo-cart-change-fallback>
                                                                    </div>
                                                                </div>
                                                            </xo-product>
                                                        </td>

                                                        <!-- Desktop Quantity -->
                                                        <td role="cell" data-th="Quantity">
                                                            <xo-product xo-section-id="template--cart-items"
                                                                xo-product-id="{{ item.product.id }}"
                                                                xo-line="{{ forloop.counter }}">
                                                                <div class="xo-cart-table__quantity">
                                                                    <xo-cart-quantity class="xo-quantity-style2"
                                                                        style="--width: 10rem; --height: 4rem"
                                                                        data-item-id="{{ item.id }}">
                                                                        <a href="?action=decrease"
                                                                            class="xo-quantity-style2__button decrease-qty"
                                                                            data-item-id="{{ item.id }}"
                                                                            data-url="?action=decrease">â€“</a>

                                                                        <input type="text" value="{{ item.quantity }}" readonly
                                                                            class="xo-quantity-style2__number item-quantity-{{ item.id }}">

                                                                        <a href="?action=increase"
                                                                            class="xo-quantity-style2__button increase-qty"
                                                                            data-item-id="{{ item.id }}"
                                                                            data-url="?action=increase">+</a>
                                                                    </xo-cart-quantity>
                                                                </div>
                                                            </xo-product>
                                                        </td>

                                                        <!-- Total -->
                                                        <td role="cell" data-th="Total">
                                                            <div class="xo-cart-table__price item-total-{{ item.id }}">
                                                                QAR {{ item.item_total }}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </form>
                                    </div>

                                    <!-- Continue Shopping -->
                                    <xo-cart-will-change xo-unique-id="continue-shopping">
                                        <div class="xo-space xo-space--vertical" style="--space: 1rem"></div>
                                        <a href="{% url 'home' %}">
                                            <button class="xo-btn xo-btn--dark xo-btn--link xo-btn--slide-up" style="">
                                                <span class="xo-btn__content">
                                                    <span class="xo-btn__text" data-text="Continue shopping">
                                                        Continue shopping
                                                    </span>
                                                </span>
                                                <span class="xo-btn__loading">
                                                    <div class="xo-loader-3"
                                                        style="--size: 8; --color: currentColor; --duration: 1000;">
                                                        <div></div>
                                                    </div>
                                                </span>
                                            </button>
                                        </a>
                                    </xo-cart-will-change>
                                </div>

                                <!-- Cart Summary Sidebar -->
                                <div style="--md: 12; --lg: 4" class="xo-cart__right">
                                    <!-- Free Shipping Progress -->
                                    <xo-cart-free-shipping-custom
                                        xo-free-shipping-notice="Congrats! You are eligible for FREE Shipping"
                                        xo-free-shipping-progress="Buy {{ money }} more to enjoy FREE shipping">
                                        <div class="xo-cart-free-shipping">
                                            <div class="xo-cart-free-shipping__position">
                                                {% if shipping == 0 %}
                                                <div class="xo-cart-free-shipping__text" style="color: #4caf50; font-weight: bold;">
                                                    âœ“ You qualify for FREE shipping!
                                                </div>
                                                {% else %}
                                                <div class="xo-cart-free-shipping__text">
                                                    Add QAR {{ free_shipping_remaining }} more for FREE shipping
                                                </div>
                                                <div class="xo-cart-free-shipping__progress" style="--progress: {{ shipping_progress }}%;">
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </xo-cart-free-shipping-custom>

                                    <div class="xo-space xo-space--vertical" style="--space: 2rem"></div>

                                    <!-- Cart Totals -->
                                    <xo-cart-will-change class="xo-cart-totals">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                            <span>Subtotal:</span>
                                            <span>QAR {{ subtotal }}</span>
                                        </div>
                                        {% if shipping > 0 %}
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                            <span>Shipping:</span>
                                            <span>QAR {{ shipping }}</span>
                                        </div>
                                        {% endif %}
                                        {% if tax > 0 %}
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                            <span>Tax:</span>
                                            <span>QAR {{ tax }}</span>
                                        </div>
                                        {% endif %}
                                        <div class="xo-space xo-space--vertical" style="--space: 1rem"></div>
                                        <div style="display: flex; justify-content: space-between; font-size: 20px; font-weight: bold;">
                                            <div class="xo-cart-totals__subtotal">Total</div>
                                            <div class="xo-cart-table__price" id="cart-total">
                                                QAR {{ total }}
                                            </div>
                                        </div>
                                    </xo-cart-will-change>

                                    <xo-cart-will-change xo-unique-id="xo-cart-tax-note" class="xo-cart-tax-note">
                                        <div class="xo-space xo-space--vertical" style="--space: 1rem"></div>
                                        Taxes and <a href=" ">shipping</a> calculated at checkout
                                    </xo-cart-will-change>

                                    <xo-cart-will-change xo-unique-id="xo-space-2">
                                        <div class="xo-space xo-space--vertical" style="--space: 1rem"></div>
                                    </xo-cart-will-change>

                                    <!-- Checkout Button -->
                                    <xo-cart-will-change xo-unique-id="xo-actions" class="xo-actions">
                                        <a href=" ">
                                            <button class="xo-btn xo-btn--dark xo-btn--secondary xo-btn--md xo-btn--slide-up xo-btn--block
                                                {% if total == 0 %}disabled{% endif %}"
                                                {% if total == 0 %}disabled{% endif %}>
                                                <span class="xo-btn__content">
                                                    <span class="xo-btn__text" data-text="Check Out">
                                                        Check Out
                                                    </span>
                                                </span>
                                                <span class="xo-btn__loading">
                                                    <div class="xo-loader-3"
                                                        style="--size: 8; --color: currentColor; --duration: 1000;">
                                                        <div></div>
                                                    </div>
                                                </span>
                                            </button>
                                        </a>
                                    </xo-cart-will-change>

                                    <div class="xo-space xo-space--vertical" style="--space: 2rem"></div>

                                    <!-- Shopping Benefits -->
                                    <div style="background: #f9f9f9; padding: 20px; border-radius: 8px;">
                                        <h3 style="font-size: 16px; margin-bottom: 15px;">Shopping Benefits</h3>
                                        <ul style="list-style: none; padding: 0; margin: 0;">
                                            <li style="margin: 10px 0; font-size: 14px;">âœ“ Free shipping on orders over 200 QAR</li>
                                            <li style="margin: 10px 0; font-size: 14px;">âœ“ 14-day return policy</li>
                                            <li style="margin: 10px 0; font-size: 14px;">âœ“ Secure payment processing</li>
                                            <li style="margin: 10px 0; font-size: 14px;">âœ“ Free eye test at stores</li>
                                            <li style="margin: 10px 0; font-size: 14px;">âœ“ 1-year warranty on frames</li>
                                        </ul>
                                    </div>
                                </div>
                            </xo-grid>
                        </xo-cart-will-change>
                        
                        {% else %}
                        <!-- Empty Cart -->
                        <div class="empty-cart-message">
                            <div class="empty-cart-icon">ðŸ›’</div>
                            <h2>Your cart is empty</h2>
                            <p>Looks like you haven't added anything to your cart yet.</p>
                            <a href="{% url 'home' %}">
                                <button class="xo-btn xo-btn--dark xo-btn--primary xo-btn--md">
                                    <span class="xo-btn__content">
                                        <span class="xo-btn__text">Start Shopping</span>
                                    </span>
                                </button>
                            </a>
                        </div>
                        {% endif %}
                    </xo-animate>
                </xo-container>
            </xo-cart>
        </div>
    </div>

    <!-- Trust Badges -->
    {% if cart_items %}
    <section class="xo-section color-background-1" style="--margin: 0;--pt: 30;--pb: 30;">
        <xo-container>
            <xo-grid style="--gap: 20px;">
                <xo-animate style="--xs: 6; --md: 3">
                    <div style="text-align: center; padding: 20px;">
                        <h3 style="font-size: 20px; margin-bottom: 10px;">ðŸšš Free Shipping</h3>
                        <p style="color: #666;">On orders over 200 QAR</p>
                    </div>
                </xo-animate>
                <xo-animate style="--xs: 6; --md: 3">
                    <div style="text-align: center; padding: 20px;">
                        <h3 style="font-size: 20px; margin-bottom: 10px;">ðŸ”„ Easy Returns</h3>
                        <p style="color: #666;">14-day return policy</p>
                    </div>
                </xo-animate>
                <xo-animate style="--xs: 6; --md: 3">
                    <div style="text-align: center; padding: 20px;">
                        <h3 style="font-size: 20px; margin-bottom: 10px;">ðŸ”’ Secure Payment</h3>
                        <p style="color: #666;">Your data is protected</p>
                    </div>
                </xo-animate>
                <xo-animate style="--xs: 6; --md: 3">
                    <div style="text-align: center; padding: 20px;">
                        <h3 style="font-size: 20px; margin-bottom: 10px;">ðŸ’¬ 24/7 Support</h3>
                        <p style="color: #666;">We're here to help</p>
                    </div>
                </xo-animate>
            </xo-grid>
        </xo-container>
    </section>
    {% endif %}
</main>

<script>
document.addEventListener("click", function (e) {
    // Increase / Decrease Quantity
    const qtyBtn = e.target.closest(".increase-qty, .decrease-qty");
    if (qtyBtn) {
        e.preventDefault();
        e.stopImmediatePropagation();

        let itemID = qtyBtn.dataset.itemId;
        let url = qtyBtn.dataset.url;

        fetch(url, {
            method: "GET",
            headers: { 
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": "{{ csrf_token }}"
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                if (data.deleted) {
                    document.getElementById("cart-row-" + itemID).remove();
                    
                    // Reload if cart is empty
                    if (data.cart_count === 0) {
                        location.reload();
                    }
                } else {
                    // Update Quantity
                    document.querySelectorAll(".item-quantity-" + itemID)
                        .forEach(el => el.value = data.quantity);

                    // Update item total
                    document.querySelector(".item-total-" + itemID).innerHTML = "QAR " + data.item_total;
                    
                    // Update cart total
                    document.getElementById("cart-total").innerHTML = "QAR " + data.cart_total;
                }
            } else {
                alert(data.message || 'Error updating cart');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });

        return;
    }

    // Remove Item
    const removeBtn = e.target.closest(".remove-item-btn");
    if (removeBtn) {
        e.preventDefault();
        e.stopImmediatePropagation();
        
        if (!confirm('Remove this item from cart?')) {
            return;
        }
        
        let itemID = removeBtn.dataset.itemId;
        let url = removeBtn.dataset.url;

        fetch(url, {
            method: "GET",
            headers: { 
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": "{{ csrf_token }}"
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const row = document.getElementById("cart-row-" + itemID);
                row.style.opacity = "0";
                setTimeout(() => {
                    row.remove();
                    
                    // Reload if cart is empty
                    if (data.cart_count === 0) {
                        location.reload();
                    } else {
                        // Update cart total
                        document.getElementById("cart-total").innerHTML = "QAR " + data.cart_total;
                    }
                }, 250);
            } else {
                alert(data.message || 'Error removing item');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }
});
</script>
{% endblock %}