{% extends 'base.html' %}
{% load static %}
{% block title %}My Coupons ‚Äî Al Ameen Optics{% endblock %}

{% block content %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet">

<style>
:root {
  --obsidian: #0d0d0f; --charcoal: #1a1a1f; --graphite: #2e2e36;
  --gold: #b8976a; --gold-light: #d4b896; --gold-pale: #f5ede0;
  --sand: #f7f3ed; --ivory: #faf8f5; --white: #ffffff;
  --muted: #8a8a95; --border: #e8e4dc; --border-dark: #d4cfc5;
  --success: #2a6b2e; --success-bg: #edf7ee; --success-border: #b2d9b5;
  --danger: #b02020; --danger-bg: #fceaea; --danger-border: #f0b0b0;
  --info: #1a4fa0; --info-bg: #eaf1fc; --info-border: #9dbff0;
  --teal: #0e9b8a; --teal-bg: #e6faf7;
  --orange: #c4560a; --orange-bg: #fff3e8;
  --purple: #5e3a8a; --purple-bg: #f3edfb;
  --radius: 12px; --radius-lg: 18px; --radius-xl: 24px;
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.05); --shadow: 0 4px 24px rgba(0,0,0,0.09);
  --transition: all 0.25s cubic-bezier(0.4,0,0.2,1);
  --font-display: 'Cormorant Garamond', serif; --font-body: 'DM Sans', sans-serif;
}
*, *::before, *::after { box-sizing: border-box; }
body { font-family: var(--font-body); background: var(--sand); }

/* ‚îÄ‚îÄ BREADCRUMB ‚îÄ‚îÄ */
.mc-breadcrumb { background: var(--white); border-bottom: 1px solid var(--border); padding: 14px 0; }
.mc-breadcrumb-inner { max-width: 1200px; margin: 0 auto; padding: 0 28px; display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--muted); }
.mc-breadcrumb a { color: var(--muted); text-decoration: none; transition: color 0.2s; }
.mc-breadcrumb a:hover { color: var(--gold); }

/* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
.mc-hero { background: var(--obsidian); padding: 56px 28px; text-align: center; position: relative; overflow: hidden; }
.mc-hero::before { content: 'SAVINGS'; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 18rem; font-weight: 900; color: rgba(255,255,255,0.025); pointer-events: none; white-space: nowrap; font-family: var(--font-display); letter-spacing: 0.1em; }
.mc-hero-eyebrow { font-size: 10px; font-weight: 700; letter-spacing: 0.22em; text-transform: uppercase; color: var(--gold); margin-bottom: 12px; position: relative; }
.mc-hero-title { font-family: var(--font-display); font-size: clamp(2.6rem, 6vw, 5.5rem); font-weight: 600; color: var(--white); margin: 0 0 12px; letter-spacing: -0.01em; position: relative; line-height: 1.05; }
.mc-hero-sub { font-size: 14px; color: rgba(255,255,255,0.45); position: relative; }

/* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
.mc-stats { max-width: 1200px; margin: -28px auto 0; padding: 0 28px; position: relative; z-index: 2; }
.mc-stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
@media (max-width: 640px) { .mc-stats-grid { grid-template-columns: 1fr; } }
.stat-card { background: var(--white); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 22px 24px; display: flex; align-items: center; gap: 16px; box-shadow: var(--shadow); transition: var(--transition); }
.stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 32px rgba(0,0,0,0.10); }
.stat-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.stat-icon.ic-teal   { background: var(--teal-bg); color: var(--teal); }
.stat-icon.ic-orange { background: var(--orange-bg); color: var(--orange); }
.stat-icon.ic-gold   { background: var(--gold-pale); color: var(--gold); }
.stat-val { font-family: var(--font-display); font-size: 2rem; font-weight: 700; color: var(--obsidian); line-height: 1; }
.stat-lbl { font-size: 11px; color: var(--muted); margin-top: 3px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.08em; }

/* ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ */
.mc-main { max-width: 1200px; margin: 0 auto; padding: 48px 28px 80px; }

/* ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ */
.mc-section-head { display: flex; align-items: center; gap: 16px; margin-bottom: 28px; }
.mc-section-head-label { font-family: var(--font-display); font-size: 1.8rem; font-weight: 600; color: var(--obsidian); white-space: nowrap; }
.mc-section-head-line { flex: 1; height: 1px; background: var(--border); }
.mc-section-head-count { font-size: 11px; font-weight: 700; color: var(--muted); white-space: nowrap; background: var(--sand); border: 1px solid var(--border); padding: 3px 10px; border-radius: 20px; }

/* ‚îÄ‚îÄ COUPON GRID ‚îÄ‚îÄ */
.mc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 24px; }
@media (max-width: 480px) { .mc-grid { grid-template-columns: 1fr; } }

/* ‚îÄ‚îÄ COUPON CARD ‚îÄ‚îÄ */
.cc-card { background: var(--white); border: 1px solid var(--border); border-radius: var(--radius-xl); overflow: hidden; display: flex; flex-direction: column; transition: var(--transition); box-shadow: var(--shadow-sm); }
.cc-card:hover { transform: translateY(-4px); box-shadow: var(--shadow); border-color: var(--gold); }
.cc-card.cc-disabled { opacity: 0.5; pointer-events: none; }

/* Card top */
.cc-top { padding: 22px 22px 18px; display: flex; align-items: flex-start; justify-content: space-between; gap: 14px; position: relative; overflow: hidden; }
.cc-top::after { content: ''; position: absolute; top: -30px; right: -30px; width: 120px; height: 120px; border-radius: 50%; opacity: 0.07; background: var(--white); }
.cc-top-pct      { background: linear-gradient(135deg, #c4560a, #f97316); }
.cc-top-fixed    { background: linear-gradient(135deg, #0e9b8a, #0ea5e9); }
.cc-top-shipping { background: linear-gradient(135deg, #5e3a8a, #667eea); }

.cc-eyebrow { font-size: 9px; color: rgba(255,255,255,0.45); text-transform: uppercase; letter-spacing: 0.14em; margin-bottom: 5px; }
.cc-code { font-family: 'Courier New', monospace; font-size: 1.3rem; font-weight: 900; color: var(--white); letter-spacing: 0.18em; text-transform: uppercase; }
.cc-disc-badge { flex-shrink: 0; background: rgba(255,255,255,0.18); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.25); border-radius: 10px; padding: 10px 14px; text-align: center; }
.cc-disc-val  { font-size: 1.5rem; font-weight: 900; color: var(--white); line-height: 1; }
.cc-disc-unit { font-size: 11px; color: rgba(255,255,255,0.7); font-weight: 600; margin-top: 2px; }

/* Notch divider */
.cc-notch { display: flex; align-items: center; background: var(--sand); }
.cc-notch::before, .cc-notch::after { content: ''; width: 18px; height: 18px; border-radius: 50%; background: var(--white); flex-shrink: 0; }
.cc-notch-dash { flex: 1; border-top: 2px dashed var(--border-dark); margin: 0 4px; }

/* Body */
.cc-body { padding: 16px 22px 12px; flex: 1; }
.cc-name { font-size: 14px; font-weight: 700; color: var(--obsidian); margin-bottom: 5px; }
.cc-desc { font-size: 12px; color: var(--muted); line-height: 1.55; margin-bottom: 12px; }
.cc-pills { display: flex; flex-wrap: wrap; gap: 6px; }
.cc-pill { font-size: 10px; font-weight: 600; color: #555; background: var(--sand); padding: 4px 10px; border-radius: 20px; display: inline-flex; align-items: center; gap: 4px; border: 1px solid var(--border); }
.cc-pill.pill-gold { background: var(--gold-pale); color: #7a5a30; border-color: var(--gold-light); }

/* Usage bar */
.cc-usage { padding: 8px 22px 0; }
.cc-usage-top { display: flex; justify-content: space-between; font-size: 10px; color: var(--muted); margin-bottom: 5px; font-weight: 600; }
.cc-usage-track { height: 4px; background: var(--border); border-radius: 20px; overflow: hidden; }
.cc-usage-fill  { height: 100%; border-radius: 20px; background: linear-gradient(90deg, var(--obsidian), var(--graphite)); transition: width 0.6s ease; }

/* Action */
.cc-action { padding: 14px 22px 18px; }
.btn-copy-code {
  width: 100%; background: var(--obsidian); color: var(--white); border: none;
  padding: 12px; border-radius: 10px; font-size: 12px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.07em; cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 8px;
  font-family: var(--font-body); transition: var(--transition);
}
.btn-copy-code:hover { background: var(--charcoal); transform: translateY(-1px); }
.btn-copy-code.copied { background: var(--teal); }
.badge-used { display: flex; align-items: center; justify-content: center; gap: 6px; width: 100%; background: var(--sand); color: var(--muted); padding: 12px; border-radius: 10px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; border: 1px solid var(--border); }

/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
.mc-empty { text-align: center; padding: 64px 40px; background: var(--white); border: 1px solid var(--border); border-radius: var(--radius-xl); }
.mc-empty-icon { width: 72px; height: 72px; border-radius: 50%; background: var(--sand); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 28px; margin: 0 auto 20px; }
.mc-empty h3 { font-family: var(--font-display); font-size: 1.8rem; font-weight: 600; color: var(--obsidian); margin: 0 0 8px; }
.mc-empty p  { font-size: 14px; color: var(--muted); margin: 0 0 24px; }
.mc-empty .btn-browse { display: inline-flex; align-items: center; gap: 7px; padding: 12px 28px; background: var(--obsidian); color: var(--white); border-radius: var(--radius); font-size: 13px; font-weight: 700; text-decoration: none; transition: var(--transition); font-family: var(--font-body); letter-spacing: 0.04em; }
.mc-empty .btn-browse:hover { background: var(--charcoal); transform: translateY(-1px); }

/* ‚îÄ‚îÄ HISTORY TABLE ‚îÄ‚îÄ */
.history-card { background: var(--white); border: 1px solid var(--border); border-radius: var(--radius-xl); overflow: hidden; box-shadow: var(--shadow-sm); margin-top: 56px; }
.history-head { background: var(--obsidian); padding: 18px 28px; display: flex; align-items: center; justify-content: space-between; }
.history-head h3 { font-family: var(--font-display); font-size: 1.4rem; font-weight: 600; color: var(--white); margin: 0; }
.history-head span { font-size: 11px; color: rgba(255,255,255,0.4); }
.history-table { width: 100%; border-collapse: collapse; }
.history-table thead th { background: var(--sand); color: var(--muted); padding: 12px 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; text-align: left; border-bottom: 1px solid var(--border); }
.history-table tbody tr { border-bottom: 1px solid var(--sand); transition: background 0.15s; }
.history-table tbody tr:last-child { border-bottom: none; }
.history-table tbody tr:hover { background: var(--ivory); }
.history-table td { padding: 14px 20px; font-size: 13px; vertical-align: middle; }
.ht-code { font-family: 'Courier New', monospace; background: var(--obsidian); color: var(--white); padding: 3px 10px; border-radius: 5px; font-size: 11px; font-weight: 700; letter-spacing: 0.08em; }
.ht-order a { color: var(--info); font-weight: 600; text-decoration: none; }
.ht-order a:hover { text-decoration: underline; }
.ht-disc { color: var(--teal); font-weight: 700; font-family: var(--font-display); font-size: 15px; }
.ht-date { color: var(--muted); font-size: 12px; }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.mc-toast { position: fixed; bottom: 28px; left: 50%; transform: translateX(-50%) translateY(80px); background: var(--obsidian); color: var(--white); padding: 12px 24px; border-radius: 40px; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 9px; box-shadow: 0 6px 24px rgba(0,0,0,0.22); z-index: 9999; transition: transform 0.35s cubic-bezier(0.34,1.56,0.64,1); white-space: nowrap; pointer-events: none; }
.mc-toast.show { transform: translateX(-50%) translateY(0); }
.mc-toast-tick { color: #1bcfb4; }

@media (max-width: 768px) {
  .mc-hero { padding: 40px 20px; }
  .mc-main { padding: 36px 20px 60px; }
  .mc-stats { padding: 0 20px; }
  .history-table thead { display: none; }
  .history-table tr { display: block; padding: 14px 20px; border-bottom: 1px solid var(--sand); }
  .history-table td { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; font-size: 12px; }
  .history-table td::before { content: attr(data-label); font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); }
}
</style>

<!-- BREADCRUMB -->
<div class="mc-breadcrumb">
  <div class="mc-breadcrumb-inner">
    <a href="{% url 'home' %}">Home</a>
    <span style="opacity:0.35">‚Ä∫</span>
    <span>My Coupons</span>
  </div>
</div>

<!-- HERO -->
<div class="mc-hero">
  <div class="mc-hero-eyebrow">Al Ameen Optics</div>
  <h1 class="mc-hero-title">My Coupons</h1>
  <p class="mc-hero-sub">Your exclusive discounts and offers</p>
</div>

<!-- STATS -->
<div class="mc-stats">
  <div class="mc-stats-grid">
    <div class="stat-card">
      <div class="stat-icon ic-teal">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><circle cx="7" cy="7" r="1" fill="currentColor"/></svg>
      </div>
      <div>
        <div class="stat-val">{{ available_coupons|length }}</div>
        <div class="stat-lbl">Available</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon ic-orange">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20"/></svg>
      </div>
      <div>
        <div class="stat-val">{{ used_coupons|length }}</div>
        <div class="stat-lbl">Times Used</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon ic-gold">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>
      </div>
      <div>
        <div class="stat-val">QAR {{ total_saved|default:"0" }}</div>
        <div class="stat-lbl">Total Saved</div>
      </div>
    </div>
  </div>
</div>

<!-- MAIN -->
<div class="mc-main">

  <!-- Available Coupons -->
  <div class="mc-section-head">
    <div class="mc-section-head-label">Available Coupons</div>
    <div class="mc-section-head-line"></div>
    <div class="mc-section-head-count">{{ available_coupons|length }} coupon{{ available_coupons|length|pluralize }}</div>
  </div>

  {% if available_coupons %}
  <div class="mc-grid">
    {% for coupon in available_coupons %}
    <div class="cc-card {% if not coupon.can_use %}cc-disabled{% endif %}">

      <div class="cc-top {% if coupon.discount_type == 'percentage' %}cc-top-pct{% elif coupon.discount_type == 'fixed_amount' %}cc-top-fixed{% else %}cc-top-shipping{% endif %}">
        <div>
          <div class="cc-eyebrow">Coupon Code</div>
          <div class="cc-code">{{ coupon.code }}</div>
        </div>
        <div class="cc-disc-badge">
          {% if coupon.discount_type == 'percentage' %}
            <div class="cc-disc-val">{{ coupon.discount_value|floatformat:0 }}%</div>
            <div class="cc-disc-unit">OFF</div>
          {% elif coupon.discount_type == 'fixed_amount' %}
            <div class="cc-disc-val">{{ coupon.discount_value|floatformat:0 }}</div>
            <div class="cc-disc-unit">QAR OFF</div>
          {% else %}
            <div class="cc-disc-val" style="font-size:1.1rem;">FREE</div>
            <div class="cc-disc-unit">SHIPPING</div>
          {% endif %}
        </div>
      </div>

      <div class="cc-notch"><div class="cc-notch-dash"></div></div>

      <div class="cc-body">
        <div class="cc-name">{{ coupon.name }}</div>
        {% if coupon.description %}<div class="cc-desc">{{ coupon.description|truncatewords:20 }}</div>{% endif %}
        <div class="cc-pills">
          <span class="cc-pill">
            <svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
            Until {{ coupon.valid_until|date:"d M Y" }}
          </span>
          {% if coupon.minimum_order_amount %}
          <span class="cc-pill">
            <svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>
            Min. QAR {{ coupon.minimum_order_amount }}
          </span>
          {% endif %}
          {% if coupon.maximum_discount_amount %}
          <span class="cc-pill pill-gold">Cap: QAR {{ coupon.maximum_discount_amount }}</span>
          {% endif %}
        </div>
      </div>

      {% if coupon.usage_limit %}
      <div class="cc-usage">
        <div class="cc-usage-top">
          <span>{{ coupon.times_used }} / {{ coupon.usage_limit }} claimed</span>
          <span>{% widthratio coupon.times_used coupon.usage_limit 100 %}%</span>
        </div>
        <div class="cc-usage-track">
          <div class="cc-usage-fill" style="width:{% widthratio coupon.times_used coupon.usage_limit 100 %}%"></div>
        </div>
      </div>
      {% endif %}

      <div class="cc-action">
        {% if coupon.can_use %}
        <button class="btn-copy-code" onclick="copyCode(this,'{{ coupon.code }}')">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
          Copy Code
        </button>
        {% else %}
        <div class="badge-used">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>
          Already Used / Unavailable
        </div>
        {% endif %}
      </div>

    </div>
    {% endfor %}
  </div>

  {% else %}
  <div class="mc-empty">
    <div class="mc-empty-icon">üè∑</div>
    <h3>No Coupons Yet</h3>
    <p>Exclusive discounts and offers will appear here</p>
    <a href="{% url 'promotions:promotions' %}" class="btn-browse">Browse Active Deals ‚Üí</a>
  </div>
  {% endif %}

  <!-- History -->
  <div class="history-card">
    <div class="history-head">
      <h3>Coupon History</h3>
      <span>{{ used_coupons|length }} record{{ used_coupons|length|pluralize }}</span>
    </div>
    {% if used_coupons %}
    <div style="overflow-x:auto;">
      <table class="history-table">
        <thead>
          <tr>
            <th>Code</th><th>Order</th><th>Discount</th><th>Date Used</th>
          </tr>
        </thead>
        <tbody>
          {% for usage in used_coupons %}
          <tr>
            <td data-label="Code"><span class="ht-code">{{ usage.coupon.code }}</span></td>
            <td data-label="Order" class="ht-order"><a href="{% url 'orders:order_detail' usage.order.id %}">#{{ usage.order.order_number }}</a></td>
            <td data-label="Discount"><span class="ht-disc">‚àíQAR {{ usage.discount_amount }}</span></td>
            <td data-label="Date" class="ht-date">{{ usage.created_at|date:"d M Y, H:i" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div style="text-align:center;padding:48px 20px;">
      <div style="font-size:36px;margin-bottom:14px;opacity:0.25">üïê</div>
      <p style="font-size:14px;color:var(--muted);margin:0;">Your coupon usage will appear here after checkout</p>
    </div>
    {% endif %}
  </div>

</div>

<!-- TOAST -->
<div class="mc-toast" id="mcToast">
  <span class="mc-toast-tick">‚úì</span>
  <span id="mcToastMsg">Code copied!</span>
</div>

<script>
function copyCode(btn, code) {
  navigator.clipboard.writeText(code).then(() => {
    btn.classList.add('copied');
    btn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg> Copied!';
    showMcToast('Code "' + code + '" copied to clipboard');
    setTimeout(() => {
      btn.classList.remove('copied');
      btn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg> Copy Code';
    }, 2500);
  }).catch(() => {
    const t = document.createElement('textarea'); t.value = code;
    document.body.appendChild(t); t.select(); document.execCommand('copy');
    document.body.removeChild(t); showMcToast('Code "' + code + '" copied!');
  });
}
function showMcToast(msg) {
  const t = document.getElementById('mcToast');
  document.getElementById('mcToastMsg').textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}
</script>
{% endblock %}