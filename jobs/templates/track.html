{% extends 'base.html' %}
{% load static %}

{% block title %}Track Your Order — Al Ameen Optics{% endblock %}

{% block extra_styles %}
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&display=swap');

:root {
  --aa-gold: #c8a96e;
  --aa-dark: #1a2a3a;
  --aa-ink:  #0d1b2a;
  --aa-sand: #f5f0eb;
  --aa-mid:  #6b7c8d;
  --aa-border: #e0e8ef;
  --aa-radius: 12px;
}

.track-hero {
  background: linear-gradient(135deg, var(--aa-dark) 0%, #2c3e50 100%);
  padding: 80px 20px 60px;
  text-align: center;
  color: #fff;
}
.track-hero h1 { font-size: clamp(2rem, 5vw, 3.5rem); font-weight: 300; letter-spacing: .05em; margin-bottom: 12px; }
.track-hero p  { font-size: 1rem; color: rgba(255,255,255,.7); }

.track-form-wrap { max-width: 600px; margin: -30px auto 0; position: relative; z-index: 10; }
.track-card { background: #fff; border-radius: var(--aa-radius); box-shadow: 0 8px 40px rgba(0,0,0,.12); padding: 36px; }
.track-input { height: 52px; border-radius: 8px; border: 2px solid var(--aa-border); font-size: 1rem; font-weight: 500; transition: border-color .2s; }
.track-input:focus { border-color: var(--aa-gold); box-shadow: 0 0 0 3px rgba(200,169,110,.15); }
.btn-track { height: 52px; background: var(--aa-dark); color: #fff; border: none; border-radius: 8px; font-weight: 600; font-size: 1rem; letter-spacing: .05em; cursor: pointer; transition: background .2s, transform .2s; width: 100%; margin-top: 12px; }
.btn-track:hover { background: var(--aa-gold); transform: translateY(-1px); }

/* Result card */
.result-section { max-width: 860px; margin: 40px auto 60px; padding: 0 20px; }

.job-header-card { background: var(--aa-dark); color: #fff; border-radius: var(--aa-radius) var(--aa-radius) 0 0; padding: 28px 32px; }
.job-header-card .job-num { font-size: 1.6rem; font-weight: 700; }
.status-pill { display: inline-block; padding: 6px 18px; border-radius: 50px; font-size: .85rem; font-weight: 700; letter-spacing: .05em; text-transform: uppercase; }
.status-received    { background: #fff3cd; color: #856404; }
.status-processing  { background: #cff4fc; color: #055160; }
.status-lens_order  { background: #cfe2ff; color: #084298; }
.status-fitting     { background: #cff4fc; color: #055160; }
.status-qa          { background: #cfe2ff; color: #084298; }
.status-ready       { background: #d1e7dd; color: #0a3622; }
.status-dispatched  { background: #d1e7dd; color: #0a3622; }
.status-delivered   { background: #d1e7dd; color: #0a3622; }
.status-on_hold     { background: #e2e3e5; color: #41464b; }
.status-cancelled   { background: #f8d7da; color: #842029; }

/* Progress steps */
.steps-track { display: flex; justify-content: space-between; align-items: flex-start; padding: 32px; background: var(--aa-sand); border-bottom: 1px solid var(--aa-border); overflow-x: auto; gap: 0; }
.step-item { display: flex; flex-direction: column; align-items: center; gap: 8px; flex: 1; min-width: 80px; position: relative; }
.step-item:not(:last-child)::after { content: ''; position: absolute; left: calc(50% + 20px); right: calc(-50% + 20px); top: 18px; height: 2px; background: var(--aa-border); z-index: 0; }
.step-item.done::after  { background: var(--aa-gold); }
.step-circle { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: .9rem; font-weight: 700; position: relative; z-index: 1; transition: all .3s; }
.step-circle.done    { background: var(--aa-gold); color: #fff; box-shadow: 0 0 0 4px rgba(200,169,110,.25); }
.step-circle.active  { background: var(--aa-dark); color: #fff; box-shadow: 0 0 0 4px rgba(26,42,58,.2); }
.step-circle.pending { background: var(--aa-border); color: var(--aa-mid); }
.step-label { font-size: .72rem; font-weight: 600; text-align: center; color: var(--aa-mid); letter-spacing: .03em; line-height: 1.3; }
.step-item.done .step-label, .step-item.active .step-label { color: var(--aa-dark); }

/* Detail grid */
.detail-grid { background: #fff; border-radius: 0 0 var(--aa-radius) var(--aa-radius); padding: 32px; }
.detail-section-title { font-size: .8rem; font-weight: 700; text-transform: uppercase; letter-spacing: .12em; color: var(--aa-gold); margin: 24px 0 12px; border-top: 1px solid var(--aa-border); padding-top: 20px; }
.detail-section-title:first-child { margin-top: 0; border-top: none; padding-top: 0; }
.info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap: 16px; }
.info-cell .label { font-size: .75rem; color: var(--aa-mid); text-transform: uppercase; letter-spacing: .07em; }
.info-cell .value { font-weight: 600; color: var(--aa-dark); margin-top: 2px; }

/* Rx table */
.rx-table { width: 100%; border-collapse: collapse; font-size: .9rem; }
.rx-table th, .rx-table td { padding: 10px 14px; border: 1px solid var(--aa-border); text-align: center; }
.rx-table th { background: var(--aa-sand); font-weight: 700; color: var(--aa-dark); }
.rx-table td:first-child { text-align: left; font-weight: 600; background: rgba(200,169,110,.07); }

/* History timeline */
.timeline { position: relative; padding-left: 28px; }
.timeline::before { content:''; position:absolute; left:8px; top:0; bottom:0; width:2px; background:var(--aa-border); }
.tl-item { position: relative; margin-bottom: 20px; }
.tl-dot { position: absolute; left: -24px; width: 16px; height: 16px; border-radius: 50%; background: var(--aa-gold); border: 2px solid #fff; box-shadow: 0 0 0 2px var(--aa-gold); }
.tl-content { background: var(--aa-sand); border-radius: 8px; padding: 12px 16px; }
.tl-content .status-name { font-weight: 700; color: var(--aa-dark); }
.tl-content .tl-date { font-size: .8rem; color: var(--aa-mid); margin-top: 4px; }

/* Note box */
.note-box { background: #e8f4fd; border-left: 4px solid #1a6fa8; border-radius: 0 8px 8px 0; padding: 14px 18px; margin-top: 16px; color: #1a2a3a; font-size: .95rem; }
</style>
{% endblock %}

{% block content %}

<!-- Hero -->
<div class="track-hero">
  <div class="mb-3">
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="rgba(200,169,110,.8)" stroke-width="1.5"><path d="M20 7H4a2 2 0 00-2 2v6a2 2 0 002 2h16a2 2 0 002-2V9a2 2 0 00-2-2z"/><path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/></svg>
  </div>
  <h1>Track Your Job</h1>
  <p>Enter your job number and phone number to see real-time progress.</p>
</div>

<!-- Search Form -->
<div class="track-form-wrap px-3">
  <div class="track-card">
    <form method="POST">
      {% csrf_token %}
      {% if error %}
      <div class="alert alert-danger alert-dismissible fade show py-2 mb-3" role="alert">
        <i class="mdi mdi-alert-circle-outline"></i> {{ error }}
        <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
      </div>
      {% endif %}
      <div class="row g-3">
        <div class="col-md-6">
          <label class="font-weight-bold small d-block mb-1">Job Number</label>
          <input type="text" class="form-control track-input" name="job_number" placeholder="e.g. JOB2025001" value="{{ request.POST.job_number }}" required>
        </div>
        <div class="col-md-6">
          <label class="font-weight-bold small d-block mb-1">Mobile Number</label>
          <input type="tel" class="form-control track-input" name="phone" placeholder="Last 6 digits of your phone" value="{{ request.POST.phone }}" required>
        </div>
      </div>
      <button type="submit" class="btn-track mt-3">
        <i class="mdi mdi-magnify"></i> Track My Job
      </button>
      <p class="text-muted text-center small mt-3 mb-0">Your job number is on your receipt slip.<br>Enter the last 6 digits of your registered phone number.</p>
    </form>
  </div>
</div>

<!-- Result -->
{% if job %}
<div class="result-section">

  <!-- Job Header -->
  <div class="job-header-card">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
      <div>
        <div class="job-num">{{ job.job_number }}</div>
        <div class="mt-1" style="font-size:.9rem;color:rgba(255,255,255,.7);">Created {{ job.created_at|date:"d F Y" }}</div>
      </div>
      <div class="text-right">
        <span class="status-pill status-{{ job.status }}">{{ job.get_status_display }}</span>
        <div class="mt-2" style="font-size:.85rem;color:rgba(255,255,255,.6);">
          {% if job.promised_date %}Ready by: <strong style="color:#fff;">{{ job.promised_date|date:"d M Y" }}</strong>{% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Progress Steps -->
  {% with steps="received,processing,lens_order,fitting,qa,ready,dispatched,delivered" %}
  <div class="steps-track">
    {% for step_key in steps.split:',' %}
    {% endfor %}
    <!-- Progress steps rendered below -->
  </div>
  {% endwith %}

  {% comment %}Progress Steps — manual list for clarity{% endcomment %}
  <div class="steps-track">
    {% with progress=job.progress_percent %}
    {% for step_name, step_label in steps_data %}
    <div class="step-item {% if job.status == step_name %}active{% elif job.progress_percent >= forloop.counter0|divisibleby:1 and job.status != 'cancelled' and job.status != 'on_hold' %}pending{% endif %}">
      <div class="step-circle pending">{{ forloop.counter }}</div>
      <div class="step-label">{{ step_label }}</div>
    </div>
    {% endfor %}
    {% endwith %}
  </div>

  <div class="detail-grid">

    <!-- Customer -->
    <div class="detail-section-title">Customer Information</div>
    <div class="info-grid">
      <div class="info-cell"><div class="label">Name</div><div class="value">{{ job.customer_name }}</div></div>
      <div class="info-cell"><div class="label">Phone</div><div class="value">{{ job.customer_phone }}</div></div>
      <div class="info-cell"><div class="label">Job Type</div><div class="value">{{ job.get_job_type_display }}</div></div>
      <div class="info-cell"><div class="label">Priority</div><div class="value">{{ job.get_priority_display }}</div></div>
    </div>

    <!-- Prescription -->
    {% if job.re_sphere or job.le_sphere %}
    <div class="detail-section-title">Your Prescription</div>
    <div class="table-responsive">
      <table class="rx-table">
        <thead><tr><th></th><th>Sphere</th><th>Cylinder</th><th>Axis</th><th>Add</th></tr></thead>
        <tbody>
          <tr>
            <td>Right Eye (OD)</td>
            <td>{{ job.re_sphere|default:"—" }}</td>
            <td>{{ job.re_cylinder|default:"—" }}</td>
            <td>{{ job.re_axis|default:"—" }}</td>
            <td>{{ job.re_add|default:"—" }}</td>
          </tr>
          <tr>
            <td>Left Eye (OS)</td>
            <td>{{ job.le_sphere|default:"—" }}</td>
            <td>{{ job.le_cylinder|default:"—" }}</td>
            <td>{{ job.le_axis|default:"—" }}</td>
            <td>{{ job.le_add|default:"—" }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    {% if job.pd_distance %}<p class="small mt-2 text-muted">PD Distance: <strong>{{ job.pd_distance }}</strong>{% if job.pd_near %} &nbsp;·&nbsp; PD Near: <strong>{{ job.pd_near }}</strong>{% endif %}</p>{% endif %}
    {% endif %}

    <!-- Lens Details -->
    {% if job.lens_brand or job.lens_type %}
    <div class="detail-section-title">Lens & Frame Details</div>
    <div class="info-grid">
      {% if job.frame_description %}<div class="info-cell"><div class="label">Frame</div><div class="value">{{ job.frame_description }}</div></div>{% endif %}
      {% if job.lens_brand %}<div class="info-cell"><div class="label">Lens Brand</div><div class="value">{{ job.lens_brand }}</div></div>{% endif %}
      {% if job.lens_type %}<div class="info-cell"><div class="label">Lens Type</div><div class="value">{{ job.lens_type }}</div></div>{% endif %}
      {% if job.lens_index %}<div class="info-cell"><div class="label">Index</div><div class="value">{{ job.lens_index }}</div></div>{% endif %}
      {% if job.lens_coating %}<div class="info-cell"><div class="label">Coating</div><div class="value">{{ job.lens_coating }}</div></div>{% endif %}
    </div>
    {% endif %}

    <!-- Payment -->
    <div class="detail-section-title">Payment</div>
    <div class="info-grid">
      <div class="info-cell"><div class="label">Total Amount</div><div class="value">QAR {{ job.total_amount }}</div></div>
      <div class="info-cell"><div class="label">Advance Paid</div><div class="value text-success">QAR {{ job.advance_paid }}</div></div>
      <div class="info-cell">
        <div class="label">Balance Due</div>
        <div class="value {% if job.balance_due > 0 %}text-danger{% else %}text-success{% endif %}">
          {% if job.balance_due > 0 %}QAR {{ job.balance_due }}{% else %}✓ Fully Paid{% endif %}
        </div>
      </div>
    </div>

    <!-- Customer Note -->
    {% if job.customer_notes %}
    <div class="note-box mt-4">
      <strong><i class="mdi mdi-information-outline"></i> Note from our team:</strong><br>
      {{ job.customer_notes }}
    </div>
    {% endif %}

    <!-- Status History -->
    {% if history %}
    <div class="detail-section-title">Status History</div>
    <div class="timeline">
      {% for h in history %}
      <div class="tl-item">
        <div class="tl-dot"></div>
        <div class="tl-content">
          <div class="status-name">{{ h.get_new_status_display|default:h.new_status|title }}</div>
          {% if h.note %}<div class="small mt-1">{{ h.note }}</div>{% endif %}
          <div class="tl-date">{{ h.created_at|date:"d M Y, H:i" }}</div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- Contact -->
    <div class="mt-4 pt-3 border-top text-center">
      <p class="text-muted small">Have a question about your order?</p>
      <a href="{% url 'content:contact' %}" class="btn btn-outline-dark px-4 mr-2"><i class="mdi mdi-phone"></i> Contact Us</a>
      {% if user.is_authenticated %}
      <a href="{% url 'jobs:my_jobs' %}" class="btn btn-dark px-4"><i class="mdi mdi-format-list-bulleted"></i> All My Jobs</a>
      {% endif %}
    </div>

  </div>
</div>
{% endif %}

{% endblock %}