{% extends 'base.html' %}
{% load static %}

{% block title %}Chat - {{ conversation.conversation_id }}{% endblock %}

{% block content %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --ink:       #0f0f0f;
  --ink-light: #2d2d2d;
  --gold:      #c9a84c;
  --gold-soft: rgba(201,168,76,.12);
  --ivory:     #faf8f3;
  --ivory-dk:  #f2ede4;
  --mist:      #ede9e1;
  --grey:      #9a9690;
  --online:    #3eb87a;
  --warn:      #e07d3c;
  --danger:    #e05c5c;
  --info:      #5c95e0;
  --panel-w:   300px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'DM Sans', sans-serif; background: var(--ivory); color: var(--ink); }

/* ── SHELL ─── */
.shell { display: flex; height: 100vh; overflow: hidden; }

/* ── LEFT RAIL ─── */
.left-rail {
  width: 240px; flex-shrink: 0;
  background: var(--ink);
  display: flex; flex-direction: column;
  border-right: 1px solid rgba(255,255,255,.05);
}
.rail-head {
  padding: 18px 18px 16px;
  border-bottom: 1px solid rgba(255,255,255,.06);
}
.back-link {
  display: inline-flex; align-items: center; gap: 7px;
  color: rgba(255,255,255,.55); font-size: 12.5px; text-decoration: none;
  transition: color .2s;
}
.back-link:hover { color: #fff; }
.back-link svg { width: 15px; height: 15px; }

.conv-id-badge {
  margin-top: 14px;
  font-family: 'DM Mono', monospace; font-size: 11px;
  color: var(--gold); background: rgba(201,168,76,.08);
  padding: 5px 10px; border-radius: 6px; display: inline-block;
  border: 1px solid rgba(201,168,76,.25);
}

.rail-section { padding: 16px 18px; border-bottom: 1px solid rgba(255,255,255,.06); }
.rail-section h3 { font-size: 10px; font-family: 'DM Mono', monospace; color: rgba(255,255,255,.35); letter-spacing: .08em; text-transform: uppercase; margin-bottom: 12px; }

.info-row { display: flex; flex-direction: column; gap: 3px; margin-bottom: 10px; }
.info-row:last-child { margin-bottom: 0; }
.info-key { font-size: 10.5px; color: rgba(255,255,255,.35); font-family: 'DM Mono', monospace; }
.info-val { font-size: 12.5px; color: rgba(255,255,255,.85); font-weight: 500; }

/* Action selects */
.action-select {
  width: 100%; padding: 8px 12px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.1);
  border-radius: 8px; color: #fff;
  font-family: 'DM Sans', sans-serif; font-size: 12.5px;
  cursor: pointer; outline: none; transition: border-color .2s;
  margin-bottom: 8px; appearance: none;
  -webkit-appearance: none;
}
.action-select:focus { border-color: var(--gold); }
.action-select option { background: #1e1e1e; }

.assign-btn {
  width: 100%; padding: 9px 14px;
  background: var(--gold); border: none; border-radius: 8px;
  font-family: 'DM Sans', sans-serif; font-size: 12.5px; font-weight: 600;
  color: var(--ink); cursor: pointer; transition: all .2s;
}
.assign-btn:hover { background: #d4b055; transform: translateY(-1px); }

/* Quick replies */
.qr-list { display: flex; flex-direction: column; gap: 6px; max-height: 160px; overflow-y: auto; }
.qr-list::-webkit-scrollbar { width: 3px; }
.qr-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,.15); border-radius: 3px; }
.qr-btn {
  padding: 8px 12px; border-radius: 7px;
  background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08);
  color: rgba(255,255,255,.7); font-family: 'DM Sans', sans-serif; font-size: 12px;
  cursor: pointer; text-align: left; transition: all .2s;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.qr-btn:hover { background: rgba(201,168,76,.12); border-color: rgba(201,168,76,.3); color: var(--gold); }

/* ── CHAT CENTER ─── */
.chat-center { flex: 1; display: flex; flex-direction: column; min-width: 0; }

.chat-topbar {
  display: flex; align-items: center; gap: 14px;
  padding: 14px 22px;
  background: #fff; border-bottom: 1px solid var(--mist);
  flex-shrink: 0;
}
.chat-topbar h2 { font-size: 15px; font-weight: 600; flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.chat-topbar p  { font-size: 12px; color: var(--grey); }

.status-tag {
  padding: 5px 11px; border-radius: 7px;
  font-size: 11.5px; font-weight: 600; font-family: 'DM Mono', monospace;
}
.s-open      { background: rgba(62,184,122,.12); color: #26895a; }
.s-progress  { background: rgba(201,168,76,.15);  color: #8a6a1a; }
.s-waiting   { background: rgba(224,125,60,.12);  color: #a04d15; }
.s-resolved  { background: rgba(154,150,144,.1);  color: var(--grey); }
.s-closed    { background: rgba(154,150,144,.08); color: var(--grey); }

/* Messages */
.msgs-area {
  flex: 1; overflow-y: auto; padding: 20px 22px;
  display: flex; flex-direction: column; gap: 14px;
  background: var(--ivory);
}
.msgs-area::-webkit-scrollbar { width: 5px; }
.msgs-area::-webkit-scrollbar-thumb { background: var(--mist); border-radius: 5px; }

.msg-row { display: flex; gap: 10px; animation: up .25s ease both; }
@keyframes up { from { opacity:0; transform:translateY(7px); } to { opacity:1; transform:translateY(0); } }
.msg-row.agent { flex-direction: row-reverse; }

.msg-av {
  width: 34px; height: 34px; border-radius: 50%; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 700; color: #fff; align-self: flex-end;
  font-family: 'DM Mono', monospace;
}
.av-customer { background: var(--info); }
.av-agent    { background: var(--ink); border: 2px solid var(--gold); }
.av-system   { background: var(--grey); font-size: 10px; }

.msg-content { display: flex; flex-direction: column; gap: 4px; max-width: 70%; }
.agent .msg-content { align-items: flex-end; }

.bubble {
  padding: 11px 15px; border-radius: 16px 16px 16px 4px;
  font-size: 13.5px; line-height: 1.6; word-break: break-word;
}
.bubble-customer { background: #fff; color: var(--ink); box-shadow: 0 1px 3px rgba(0,0,0,.05); }
.bubble-agent    { background: var(--ink); color: #fff; border-radius: 16px 16px 4px 16px; }
.bubble-system   {
  background: none; border: none; padding: 4px 0;
  font-size: 11px; color: var(--grey); font-family: 'DM Mono', monospace;
  text-align: center; align-self: center;
}

.msg-meta { font-size: 10.5px; color: var(--grey); padding: 0 4px; display: flex; align-items: center; gap: 6px; }

/* Attachment */
.attach-preview { max-width: 220px; border-radius: 10px; overflow: hidden; margin-top: 6px; }
.attach-preview img { width: 100%; display: block; }
.attach-file {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 8px 12px; background: var(--ivory-dk); border-radius: 8px;
  font-size: 12.5px; color: var(--ink); text-decoration: none;
  border: 1px solid var(--mist); transition: background .2s;
}
.attach-file:hover { background: var(--mist); }
.attach-file svg { width: 16px; height: 16px; color: var(--grey); }

/* Typing */
.typing-row { display: flex; gap: 10px; align-items: flex-end; }
.typing-bubble { background: #fff; padding: 12px 15px; border-radius: 16px 16px 16px 4px; display: flex; gap: 5px; box-shadow: 0 1px 3px rgba(0,0,0,.05); }
.t-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--grey); animation: bounce 1.2s ease infinite; }
.t-dot:nth-child(2) { animation-delay:.16s; }
.t-dot:nth-child(3) { animation-delay:.32s; }
@keyframes bounce { 0%,60%,100% { transform:translateY(0); opacity:.5; } 30% { transform:translateY(-7px); opacity:1; } }

/* Input */
.input-zone { padding: 14px 22px 18px; background: #fff; border-top: 1px solid var(--mist); flex-shrink: 0; }
.input-inner {
  display: flex; align-items: flex-end; gap: 10px;
  background: var(--ivory-dk); border: 1.5px solid var(--mist);
  border-radius: 14px; padding: 10px 12px;
  transition: border-color .2s, box-shadow .2s;
}
.input-inner:focus-within { border-color: var(--gold); box-shadow: 0 0 0 3px rgba(201,168,76,.1); background: #fff; }

.attach2-btn {
  background: none; border: none; cursor: pointer;
  width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
  border-radius: 8px; flex-shrink: 0; transition: background .2s;
}
.attach2-btn:hover { background: var(--mist); }
.attach2-btn svg { width: 18px; height: 18px; color: var(--grey); }

.msg-ta {
  flex: 1; border: none; background: transparent; outline: none; resize: none;
  font-family: 'DM Sans', sans-serif; font-size: 13.5px; color: var(--ink);
  min-height: 22px; max-height: 120px; line-height: 1.5; padding: 4px 2px;
}
.msg-ta::placeholder { color: var(--grey); }

.send2-btn {
  background: var(--ink); border: none; cursor: pointer;
  width: 36px; height: 36px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  transition: transform .2s, background .2s;
}
.send2-btn:hover { background: #2d2d2d; transform: scale(1.07); }
.send2-btn:active { transform: scale(.95); }
.send2-btn svg { width: 16px; height: 16px; color: #fff; }

.char-count { font-size: 10.5px; color: var(--grey); font-family: 'DM Mono', monospace; text-align: right; margin-top: 6px; }
</style>

<div class="shell">

  <!-- ── LEFT RAIL ───────────────────────────────── -->
  <aside class="left-rail">
    <div class="rail-head">
      <a class="back-link" href="{% url 'chat:agent_dashboard' %}">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
        Dashboard
      </a>
      <div class="conv-id-badge">{{ conversation.conversation_id }}</div>
    </div>

    <!-- Customer info -->
    <div class="rail-section">
      <h3>Customer</h3>
      <div class="info-row">
        <span class="info-key">Name</span>
        <span class="info-val">{{ conversation.get_display_name }}</span>
      </div>
      {% if conversation.guest_email %}
      <div class="info-row">
        <span class="info-key">Email</span>
        <span class="info-val" style="font-size:11.5px; word-break:break-all;">{{ conversation.guest_email }}</span>
      </div>
      {% endif %}
      <div class="info-row">
        <span class="info-key">Subject</span>
        <span class="info-val">{{ conversation.subject }}</span>
      </div>
      <div class="info-row">
        <span class="info-key">Started</span>
        <span class="info-val">{{ conversation.created_at|date:"M d, Y · H:i" }}</span>
      </div>
      {% if conversation.ip_address %}
      <div class="info-row">
        <span class="info-key">IP</span>
        <span class="info-val" style="font-size:11px; font-family:'DM Mono',monospace;">{{ conversation.ip_address }}</span>
      </div>
      {% endif %}
    </div>

    <!-- Controls -->
    <div class="rail-section">
      <h3>Controls</h3>
      <select class="action-select" id="statusSelect">
        {% for val, label in conversation.STATUS_CHOICES %}
        <option value="{{ val }}" {% if conversation.status == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      <select class="action-select" id="prioritySelect">
        {% for val, label in conversation.PRIORITY_CHOICES %}
        <option value="{{ val }}" {% if conversation.priority == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      {% if not conversation.assigned_to or conversation.assigned_to != request.user %}
      <button class="assign-btn" id="assignBtn">Assign to Me</button>
      {% else %}
      <button class="assign-btn" style="background:rgba(62,184,122,.15);color:#26895a;cursor:default;">
        ✓ Assigned to You
      </button>
      {% endif %}
    </div>

    <!-- Quick Replies -->
    {% if quick_replies %}
    <div class="rail-section" style="flex:1; overflow:hidden; display:flex; flex-direction:column;">
      <h3>Quick Replies</h3>
      <div class="qr-list">
        {% for qr in quick_replies %}
        <button class="qr-btn" data-id="{{ qr.id }}" title="{{ qr.message }}">{{ qr.title }}</button>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </aside>

  <!-- ── CHAT CENTER ─────────────────────────────── -->
  <div class="chat-center">

    <div class="chat-topbar">
      <div style="flex:1;min-width:0;">
        <h2>{{ conversation.subject }}</h2>
        <p>{{ conversation.get_display_name }} · {{ messages.count }} message{{ messages.count|pluralize }}</p>
      </div>
      {% if conversation.status == 'open' %}
        <span class="status-tag s-open">Open</span>
      {% elif conversation.status == 'in_progress' %}
        <span class="status-tag s-progress">In Progress</span>
      {% elif conversation.status == 'waiting' %}
        <span class="status-tag s-waiting">Waiting</span>
      {% elif conversation.status == 'resolved' %}
        <span class="status-tag s-resolved">Resolved</span>
      {% else %}
        <span class="status-tag s-closed">Closed</span>
      {% endif %}
    </div>

    <!-- Messages area -->
    <div class="msgs-area" id="msgsArea">
      {% for msg in messages %}
        {% if msg.message_type == 'system' %}
        <div class="msg-row">
          <div class="msg-content" style="width:100%;align-items:center;">
            <div class="bubble bubble-system">— {{ msg.message }} —</div>
            <span class="msg-meta">{{ msg.created_at|date:"H:i" }}</span>
          </div>
        </div>
        {% elif msg.is_from_customer %}
        <div class="msg-row customer">
          <div class="msg-av av-customer">{{ msg.sender_name|slice:":2"|upper }}</div>
          <div class="msg-content">
            <div class="bubble bubble-customer">{{ msg.message }}</div>
            {% if msg.attachment %}
            <div class="attach-preview">
              {% if msg.message_type == 'image' %}
                <img src="{{ msg.attachment.url }}" alt="Attachment">
              {% else %}
                <a class="attach-file" href="{{ msg.attachment.url }}" target="_blank">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                  Download file
                </a>
              {% endif %}
            </div>
            {% endif %}
            <span class="msg-meta">{{ msg.sender_name }} · {{ msg.created_at|date:"H:i" }}</span>
          </div>
        </div>
        {% else %}
        <div class="msg-row agent">
          <div class="msg-av av-agent">{{ msg.sender_name|slice:":2"|upper }}</div>
          <div class="msg-content">
            <div class="bubble bubble-agent">{{ msg.message }}</div>
            {% if msg.attachment %}
            <div class="attach-preview">
              {% if msg.message_type == 'image' %}
                <img src="{{ msg.attachment.url }}" alt="Attachment">
              {% else %}
                <a class="attach-file" href="{{ msg.attachment.url }}" target="_blank" style="background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.15);color:#fff;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                  Download file
                </a>
              {% endif %}
            </div>
            {% endif %}
            <span class="msg-meta">{{ msg.sender_name }} · {{ msg.created_at|date:"H:i" }}</span>
          </div>
        </div>
        {% endif %}
      {% empty %}
        <p style="color:var(--grey);font-size:13px;text-align:center;margin:auto;">No messages yet.</p>
      {% endfor %}
    </div>

    <!-- Typing indicator -->
    <div class="typing-row" id="typingRow" style="display:none; padding: 0 22px 10px;">
      <div class="msg-av av-customer" style="width:34px;height:34px;font-size:11px;">?</div>
      <div class="typing-bubble"><div class="t-dot"></div><div class="t-dot"></div><div class="t-dot"></div></div>
    </div>

    <!-- Input -->
    <div class="input-zone">
      <div class="input-inner">
        <button class="attach2-btn" id="attachBtn" type="button" aria-label="Attach">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
        </button>
        <textarea class="msg-ta" id="msgTa" rows="1" placeholder="Reply to customer…" aria-label="Message"></textarea>
        <button class="send2-btn" id="sendBtn" type="button" aria-label="Send">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>
      <div class="char-count" id="charCount">0 / 1000</div>
      <input type="file" id="fileInput" style="display:none" accept="image/*,.pdf,.doc,.docx">
    </div>

  </div><!-- /chat-center -->

</div><!-- /shell -->
{% endblock %}

{% block extra_js %}
<script>
const CONV_ID    = '{{ conversation.conversation_id }}';
const CSRF       = '{{ csrf_token }}';
const msgInput   = document.getElementById('msgInput');
const messagesEl = document.getElementById('chatMessages');
let lastId = {{ messages.last.id|default:0 }};

// ── Helpers ──────────────────────────────────────────
function scrollBottom() { messagesEl.scrollTop = messagesEl.scrollHeight; }

function showToast(msg, ok=true) {
    const t = document.createElement('div');
    t.style.cssText = `position:fixed;top:20px;right:20px;z-index:9999;padding:12px 22px;
        border-radius:8px;font-size:.85rem;font-weight:600;color:#fff;
        background:${ok?'#1bcfb4':'#fe7c96'};box-shadow:0 4px 12px rgba(0,0,0,.15)`;
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 3000);
}

function post(url, data) {
    const fd = new FormData();
    fd.append('csrfmiddlewaretoken', CSRF);
    Object.entries(data).forEach(([k,v]) => fd.append(k,v));
    return fetch(url, {
        method: 'POST',
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        body: fd
    }).then(r => r.json());
}

// ── Send Reply ────────────────────────────────────────
function sendReply() {
    const text = msgInput.value.trim();
    if (!text) return;
    document.getElementById('sendBtn').disabled = true;

    // ✅ FIXED URL
    post(`/chat/conversation/${CONV_ID}/send/`, { message: text })
    .then(data => {
        if (data.success) {
            msgInput.value = '';
            appendBubble(data.message);
            lastId = data.message.id;
        } else {
            showToast('Failed to send', false);
        }
    })
    .catch(() => showToast('Error sending message', false))
    .finally(() => { document.getElementById('sendBtn').disabled = false; });
}

function appendBubble(msg) {
    const isCustomer = msg.is_from_customer;
    const div = document.createElement('div');
    div.className = `msg msg--${isCustomer ? 'customer' : 'staff'}`;
    const color = isCustomer ? 'e0e0e0&color=333' : '667eea&color=fff';
    div.innerHTML = `
      <div class="msg__avatar">
        <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(msg.sender_name)}&background=${color}&size=32">
      </div>
      <div class="msg__body">
        <div class="msg__bubble">${escHtml(msg.message)}</div>
        <span class="msg__meta">${escHtml(msg.sender_name)} · ${msg.created_at}</span>
      </div>`;
    messagesEl.appendChild(div);
    scrollBottom();
}

function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ── Poll new messages ─────────────────────────────────
setInterval(() => {
    // ✅ FIXED URL
    fetch(`/chat/conversation/${CONV_ID}/messages/?last_message_id=${lastId}`, {
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success || !data.messages.length) return;
        data.messages.forEach(msg => {
            if (msg.id > lastId) {
                lastId = msg.id;
                appendBubble(msg);
            }
        });
    })
    .catch(() => {}); // silently ignore poll errors
}, 3000);

// ── Assign to me ──────────────────────────────────────
const assignBtn = document.getElementById('assignBtn');
if (assignBtn) {
    assignBtn.addEventListener('click', () => {
        // ✅ FIXED URL
        post(`/chat/agent/conversation/${CONV_ID}/assign/`, {})
        .then(data => {
            if (data.success) { showToast('Assigned to you!'); assignBtn.remove(); }
        });
    });
}

// ── Resolve quick button ──────────────────────────────
document.getElementById('resolveBtn').addEventListener('click', () => {
    document.getElementById('statusSelect').value = 'resolved';
    // ✅ FIXED URL
    post(`/chat/agent/conversation/${CONV_ID}/status/`, { status: 'resolved' })
    .then(() => showToast('Marked as resolved ✓'));
});

// ── Status change ─────────────────────────────────────
document.getElementById('statusSelect').addEventListener('change', function() {
    // ✅ FIXED URL
    post(`/chat/agent/conversation/${CONV_ID}/status/`, { status: this.value })
    .then(() => showToast('Status updated'));
});

// ── Priority change ───────────────────────────────────
document.getElementById('prioritySelect').addEventListener('change', function() {
    // ✅ FIXED URL
    post(`/chat/agent/conversation/${CONV_ID}/priority/`, { priority: this.value })
    .then(() => showToast('Priority updated'));
});

// ── Send button & keyboard ────────────────────────────
document.getElementById('sendBtn').addEventListener('click', sendReply);
msgInput.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); sendReply(); }
});

// ── Quick replies ─────────────────────────────────────
document.querySelectorAll('.qr-chip').forEach(chip => {
    chip.addEventListener('click', () => {
        msgInput.value = chip.dataset.message;
        msgInput.focus();
        // ✅ FIXED URL
        fetch(`/chat/agent/quick-reply/${chip.dataset.id}/`, {
            headers: {'X-Requested-With': 'XMLHttpRequest'}
        });
    });
});

// ── Init ──────────────────────────────────────────────
scrollBottom();
</script>
{% endblock %}