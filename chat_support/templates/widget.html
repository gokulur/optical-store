{% load static %}
{% csrf_token %}
 
<style>
.chat-widget-wrap {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 9999;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}
.chat-launch-btn {
    width: 62px; height: 62px; border-radius: 50%;
    background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
    border: none; cursor: pointer;
    box-shadow: 0 4px 20px rgba(0,0,0,.35);
    display: flex; align-items: center; justify-content: center;
    position: relative;
    transition: all .3s cubic-bezier(.34,1.56,.64,1);
}
.chat-launch-btn:hover  { transform: scale(1.1); box-shadow: 0 6px 30px rgba(0,0,0,.45); }
.chat-launch-btn:active { transform: scale(.95); }
.chat-launch-btn .ico-chat,
.chat-launch-btn .ico-close { width: 28px; height: 28px; color: #fff; transition: all .3s; }
.chat-launch-btn .ico-close { display: none; position: absolute; }
.chat-launch-btn.open .ico-chat  { display: none; }
.chat-launch-btn.open .ico-close { display: block; }
.chat-notif-badge {
    position: absolute; top: -4px; right: -4px;
    background: #ff3b30; color: #fff;
    width: 22px; height: 22px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; border: 2px solid #fff;
    animation: pulse-badge 2s infinite;
}
@keyframes pulse-badge { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }
.chat-launch-btn.has-notif { animation: pulse-btn 2s infinite; }
@keyframes pulse-btn {
    0%{box-shadow:0 0 0 0 rgba(26,26,26,.7)}
    70%{box-shadow:0 0 0 10px rgba(26,26,26,0)}
    100%{box-shadow:0 0 0 0 rgba(26,26,26,0)}
}
.chat-window {
    position: absolute; bottom: 78px; right: 0;
    width: 380px; max-width: calc(100vw - 40px);
    height: 600px; max-height: calc(100vh - 120px);
    background: #fff; border-radius: 18px;
    box-shadow: 0 12px 50px rgba(0,0,0,.22);
    display: flex; flex-direction: column;
    overflow: hidden;
    opacity: 0; transform: translateY(20px) scale(.95); visibility: hidden;
    transition: all .3s cubic-bezier(.34,1.56,.64,1);
}
.chat-window.open { opacity: 1; transform: translateY(0) scale(1); visibility: visible; }
.cw-header {
    background: linear-gradient(135deg, #1a1a1a 0%, #2c2c2c 100%);
    padding: 18px 20px;
    display: flex; align-items: center; gap: 12px;
    flex-shrink: 0;
}
.cw-av { position: relative; width: 42px; height: 42px; flex-shrink: 0; }
.cw-av img { width: 100%; height: 100%; border-radius: 50%; border: 2px solid rgba(255,255,255,.2); }
.cw-av .online-dot {
    position: absolute; bottom: 0; right: 0;
    width: 13px; height: 13px; border-radius: 50%;
    background: #4caf50; border: 2px solid #1a1a1a;
    animation: pulse-dot 2s infinite;
}
@keyframes pulse-dot {
    0%,100%{box-shadow:0 0 0 0 rgba(76,175,80,.7)}
    50%{box-shadow:0 0 0 4px rgba(76,175,80,0)}
}
.cw-info { flex: 1; min-width: 0; }
.cw-info h4 { font-size: 15px; font-weight: 700; color: #fff; margin: 0 0 3px; }
.cw-info p  { font-size: 12px; color: rgba(255,255,255,.75); margin: 0; display: flex; align-items: center; gap: 5px; }
.cw-info p span { width: 6px; height: 6px; border-radius: 50%; background: #4caf50; animation: blink 1.5s infinite; display: inline-block; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }
.cw-min-btn {
    background: rgba(255,255,255,.1); border: none;
    width: 32px; height: 32px; border-radius: 8px;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: background .2s; flex-shrink: 0;
}
.cw-min-btn:hover { background: rgba(255,255,255,.2); }
.cw-min-btn svg { width: 20px; height: 20px; color: #fff; }
.cw-screen { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.cw-screen.hidden { display: none; }
.cw-msgs {
    flex: 1; overflow-y: auto; padding: 18px 16px;
    background: #f8f9fa; display: flex; flex-direction: column; gap: 14px;
}
.cw-msgs::-webkit-scrollbar { width: 5px; }
.cw-msgs::-webkit-scrollbar-thumb { background: #ddd; border-radius: 5px; }
.cw-msg-row { display: flex; gap: 10px; animation: msg-in .25s ease both; }
@keyframes msg-in { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
.cw-msg-row.mine { flex-direction: row-reverse; }
.cw-msg-row .av { width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0; }
.cw-msg-row .av img { width: 100%; height: 100%; border-radius: 50%; }
.cw-msg-body { display: flex; flex-direction: column; gap: 3px; max-width: 82%; }
.mine .cw-msg-body { align-items: flex-end; }
.cw-bubble {
    padding: 11px 14px; border-radius: 14px 14px 14px 4px;
    background: #fff; font-size: 13.5px; line-height: 1.55; color: #333;
    box-shadow: 0 1px 3px rgba(0,0,0,.06); word-break: break-word;
}
.mine .cw-bubble {
    background: linear-gradient(135deg, #1a1a1a 0%, #2c2c2c 100%);
    color: #fff; border-radius: 14px 14px 4px 14px;
}
.cw-bubble.system {
    background: none; font-size: 11px; color: #999;
    text-align: center; box-shadow: none; padding: 2px 0;
}
.cw-bubble.error-bub {
    background: #fff0f0; border: 1px solid #fcc; color: #c0392b; font-size: 12px;
}
.cw-time { font-size: 11px; color: #aaa; padding: 0 4px; }
.cw-quick { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.cw-qbtn {
    background: #fff; border: 1.5px solid #e0e0e0;
    padding: 11px 10px; border-radius: 10px;
    font-size: 12.5px; font-weight: 600; color: #333;
    cursor: pointer; text-align: left; transition: all .2s;
}
.cw-qbtn:hover {
    border-color: #1a1a1a; background: #f8f9fa;
    transform: translateY(-2px); box-shadow: 0 2px 8px rgba(0,0,0,.1);
}
.cw-input-zone {
    padding: 14px 16px; background: #fff;
    border-top: 1px solid #efefef; flex-shrink: 0;
}
.cw-input-row {
    display: flex; align-items: center; gap: 8px;
    background: #f8f9fa; border: 1.5px solid #e0e0e0;
    border-radius: 26px; padding: 6px 8px 6px 14px;
    transition: all .2s;
}
.cw-input-row:focus-within {
    border-color: #1a1a1a; background: #fff;
    box-shadow: 0 0 0 3px rgba(26,26,26,.08);
}
.cw-input-row input {
    flex: 1; border: none; background: transparent;
    font-size: 14px; color: #333; outline: none; font-family: inherit;
}
.cw-input-row input::placeholder { color: #bbb; }
.cw-att-btn, .cw-send-btn {
    background: none; border: none; cursor: pointer;
    width: 34px; height: 34px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; transition: all .2s;
}
.cw-att-btn:hover { background: rgba(0,0,0,.05); }
.cw-att-btn svg { width: 20px; height: 20px; color: #888; }
.cw-send-btn { background: #1a1a1a; }
.cw-send-btn:hover { background: #333; transform: scale(1.08); }
.cw-send-btn:active { transform: scale(.94); }
.cw-send-btn svg { width: 17px; height: 17px; color: #fff; }
.cw-send-btn:disabled { background: #ccc; cursor: not-allowed; transform: none !important; }
input[type=file].cw-file { display: none; }
.cw-gform {
    flex: 1; padding: 28px 20px; display: flex; flex-direction: column;
    gap: 12px; justify-content: center; background: #fff; overflow-y: auto;
}
.cw-gform h3 { font-size: 17px; font-weight: 700; color: #1a1a1a; margin-bottom: 2px; }
.cw-gform p  { font-size: 13px; color: #777; line-height: 1.5; margin-bottom: 4px; }
.cw-ginput {
    width: 100%; padding: 12px 14px;
    background: #f8f9fa; border: 1.5px solid #e0e0e0;
    border-radius: 10px; font-size: 14px; color: #333;
    outline: none; transition: border-color .2s, box-shadow .2s;
    font-family: inherit; box-sizing: border-box;
}
.cw-ginput:focus { border-color: #1a1a1a; box-shadow: 0 0 0 3px rgba(26,26,26,.08); background: #fff; }
.cw-ginput::placeholder { color: #bbb; }
.cw-gsubmit {
    width: 100%; padding: 13px; margin-top: 4px;
    background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
    border: none; border-radius: 10px; color: #fff;
    font-size: 15px; font-weight: 600; font-family: inherit;
    cursor: pointer; transition: all .2s;
}
.cw-gsubmit:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,.25); }
.cw-gsubmit:active { transform: translateY(0); }
.cw-gerr { font-size: 12px; color: #e05c5c; min-height: 16px; }
.cw-footer { padding: 10px; text-align: center; background: #f8f9fa; border-top: 1px solid #efefef; flex-shrink: 0; }
.cw-footer p { margin: 0; font-size: 11px; color: #bbb; }
.cw-typing { display: flex; align-items: center; gap: 5px; padding: 8px 12px; }
.cw-typing span { width: 7px; height: 7px; border-radius: 50%; background: #aaa; animation: typing-dot .9s ease-in-out infinite; }
.cw-typing span:nth-child(2) { animation-delay: .15s; }
.cw-typing span:nth-child(3) { animation-delay: .3s; }
@keyframes typing-dot { 0%,60%,100%{transform:translateY(0);opacity:.4} 30%{transform:translateY(-5px);opacity:1} }
@media(max-width:480px){
    .chat-window { width: calc(100vw - 40px); height: calc(100vh - 100px); }
    .cw-quick { grid-template-columns: 1fr; }
}
</style>

<div class="chat-widget-wrap" id="chatWrap">

  <button class="chat-launch-btn" id="chatLaunchBtn" aria-label="Open Chat">
    <svg class="ico-chat" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
    </svg>
    <svg class="ico-close" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
    </svg>
    <span class="chat-notif-badge" id="chatBadge" style="display:none">1</span>
  </button>

  <div class="chat-window" id="chatWindow">

    <div class="cw-header">
      <div class="cw-av">
        <img src="https://ui-avatars.com/api/?name=Al+Ameen&background=1a1a1a&color=fff&size=84&bold=true" alt="Support">
        <span class="online-dot"></span>
      </div>
      <div class="cw-info">
        <h4>Al Ameen Support</h4>
        <p><span></span>{% if is_online %}Online â€” we reply instantly{% else %}We'll reply soon{% endif %}</p>
      </div>
      <button class="cw-min-btn" id="chatMinBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
      </button>
    </div>

    <!-- Screen A: Chat -->
    <div class="cw-screen" id="screenChat">
      <div class="cw-msgs" id="cwMsgs">
        <div class="cw-msg-row">
          <div class="av"><img src="https://ui-avatars.com/api/?name=Support&background=4A90E2&color=fff&size=64" alt="Support"></div>
          <div class="cw-msg-body">
            <div class="cw-bubble">ğŸ‘‹ Welcome to <strong>Al Ameen Optics</strong>!<br>How can we help you today?</div>
            <span class="cw-time">Just now</span>
          </div>
        </div>
        <div class="cw-quick" id="cwQuick">
          <button class="cw-qbtn" data-msg="I need help tracking my order">ğŸ“¦ Track Order</button>
          <button class="cw-qbtn" data-msg="I'd like to book an eye test">ğŸ‘ï¸ Book Eye Test</button>
          <button class="cw-qbtn" data-msg="I have a question about products">ğŸ›ï¸ Product Info</button>
          <button class="cw-qbtn" data-msg="I need help with my prescription">ğŸ“‹ Prescription Help</button>
        </div>
      </div>
      <div class="cw-input-zone">
        <div class="cw-input-row">
          <button class="cw-att-btn" id="cwAttBtn" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
            </svg>
          </button>
          <input type="text" id="cwInput" placeholder="Type your messageâ€¦" autocomplete="off">
          <button class="cw-send-btn" id="cwSendBtn" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="22" y1="2" x2="11" y2="13"/>
              <polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </svg>
          </button>
        </div>
        <input type="file" class="cw-file" id="cwFile" accept="image/*,.pdf,.doc,.docx">
      </div>
      <div class="cw-footer"><p>Powered by Al Ameen Optics Support</p></div>
    </div>

    <!-- Screen B: Guest form -->
    <div class="cw-screen hidden" id="screenGuest">
      <div class="cw-gform">
        <h3>Almost thereâ€¦</h3>
        <p>Just your name so our team knows who they're chatting with.</p>
        <input class="cw-ginput" id="guestName" type="text" placeholder="Your name *" autocomplete="name">
        <input class="cw-ginput" id="guestEmail" type="email" placeholder="Email address (optional)" autocomplete="email">
        <span class="cw-gerr" id="guestErr"></span>
        <button class="cw-gsubmit" id="guestSubmit">Start Chatting â†’</button>
      </div>
      <div class="cw-footer"><p>Powered by Al Ameen Optics Support</p></div>
    </div>

  </div>
</div>

<script>
(function(){
'use strict';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIX 1 â€” CSRF TOKEN: Read from cookie (most reliable method).
   The hidden input approach fails if {% csrf_token %} doesn't
   render inside a <form>, or if the DOM isn't ready yet.
   Reading the cookie works regardless of DOM state.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getCsrfToken() {
    // Try cookie first (always set by Django's CsrfViewMiddleware)
    var cookieMatch = document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/);
    if (cookieMatch) return decodeURIComponent(cookieMatch[1]);
    // Fallback: hidden input rendered by {% csrf_token %}
    var inp = document.querySelector('[name=csrfmiddlewaretoken]');
    if (inp) return inp.value;
    // Last resort: meta tag (if you add <meta name="csrf-token"> to base.html)
    var meta = document.querySelector('meta[name="csrf-token"]');
    if (meta) return meta.getAttribute('content');
    console.error('[Chat] CSRF token not found! Messages will fail with 403.');
    return '';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIX 2 â€” URL BUILDER: Use Django-resolved URLs directly.
   The old .replace() hack was fragile â€” if the URL structure
   changed or had i18n prefix variations it could silently break.
   We now use window.CHAT_URLS injected by the template below.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var URLS = window.CHAT_URLS || {};

/* â”€â”€ User context from Django â”€â”€ */
var USER_IS_AUTH = {{ request.user.is_authenticated|yesno:"true,false" }};
var USER_NAME    = "{{ request.user.get_full_name|default:request.user.username|default:''|escapejs }}";

/* â”€â”€ DOM refs â”€â”€ */
var launchBtn   = document.getElementById('chatLaunchBtn');
var chatWindow  = document.getElementById('chatWindow');
var minBtn      = document.getElementById('chatMinBtn');
var badge       = document.getElementById('chatBadge');
var screenChat  = document.getElementById('screenChat');
var screenGuest = document.getElementById('screenGuest');
var cwMsgs      = document.getElementById('cwMsgs');
var cwInput     = document.getElementById('cwInput');
var cwSend      = document.getElementById('cwSendBtn');
var cwAtt       = document.getElementById('cwAttBtn');
var cwFile      = document.getElementById('cwFile');
var cwQuick     = document.getElementById('cwQuick');
var guestName   = document.getElementById('guestName');
var guestEmail  = document.getElementById('guestEmail');
var guestErr    = document.getElementById('guestErr');
var guestSubmit = document.getElementById('guestSubmit');

/* â”€â”€ State â”€â”€ */
var isOpen      = false;
var convId      = null;
var lastId      = 0;
var pollTimer   = null;
var pendingMsg  = '';
var pendingFile = null;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIX 3 â€” RESTORE convId CAREFULLY.
   If the stored conversation_id is stale/deleted on the server,
   the GET /messages/ call will return 404 HTML â†’ poll crashes.
   We validate it first before trusting it.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var storedConvId = localStorage.getItem('aa_conv_id');
if (storedConvId) {
    // We'll validate asynchronously; set convId tentatively
    convId = storedConvId;
}

/* â”€â”€ Toggle â”€â”€ */
function toggle() {
    isOpen = !isOpen;
    chatWindow.classList.toggle('open', isOpen);
    launchBtn.classList.toggle('open', isOpen);
    if (isOpen) {
        hideBadge();
        launchBtn.classList.remove('has-notif');
        cwInput.focus();
        if (convId && !pollTimer) startPoll();
    } else {
        clearInterval(pollTimer);
        pollTimer = null;
    }
}
launchBtn.addEventListener('click', toggle);
minBtn.addEventListener('click', toggle);

function showBadge() { badge.style.display = 'flex'; launchBtn.classList.add('has-notif'); }
function hideBadge()  { badge.style.display = 'none'; }

function esc(s) {
    return String(s)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
var nowTime = function() {
    return new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
};
function scrollB() { setTimeout(function(){ cwMsgs.scrollTop = cwMsgs.scrollHeight; }, 60); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIX 4 â€” apiPost: Always fetch a fresh CSRF token per call.
   The old code read CSRF_TOKEN once at startup â€” if the cookie
   rotated (after login/logout) the stale token caused 403s.

   Also: response.ok check now logs the full server error body
   so you can debug 500s, 403s, 404s from the browser console.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function apiPost(url, fields, file) {
    var csrf = getCsrfToken();
    if (!csrf) {
        return Promise.reject(new Error('No CSRF token â€” check Django middleware.'));
    }

    var fd = new FormData();
    fd.append('csrfmiddlewaretoken', csrf);
    if (fields) {
        Object.keys(fields).forEach(function(k) {
            if (fields[k] !== null && fields[k] !== undefined) {
                fd.append(k, fields[k]);
            }
        });
    }
    if (file) fd.append('attachment', file);

    return fetch(url, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: fd,
    }).then(function(res) {
        if (!res.ok) {
            return res.text().then(function(body) {
                console.error('[Chat] POST', url, 'failed: HTTP', res.status);
                console.error('[Chat] Server response preview:', body.substring(0, 500));
                // Provide human-readable error messages
                if (res.status === 403) throw new Error('CSRF verification failed (403). Check CSRF_TRUSTED_ORIGINS in settings.py.');
                if (res.status === 404) throw new Error('Endpoint not found (404). Check chat/urls.py routing.');
                if (res.status === 405) throw new Error('Method not allowed (405). View may be missing @require_POST.');
                if (res.status === 500) throw new Error('Server error (500). Check Django error logs.');
                throw new Error('HTTP ' + res.status);
            });
        }
        return res.json().catch(function(e) {
            console.error('[Chat] Response was not JSON despite 200 OK:', e);
            throw new Error('Server returned non-JSON response. Check view returns JsonResponse.');
        });
    });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIX 5 â€” apiGet: Handle 404 gracefully.
   If the stored conversation no longer exists server-side,
   clear it from localStorage so next open starts fresh.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function apiGet(url) {
    return fetch(url, {
        credentials: 'same-origin',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
    }).then(function(res) {
        if (res.status === 404) {
            // Stale conversation â€” wipe it
            console.warn('[Chat] Conversation not found (404), clearing stored ID.');
            convId = null;
            localStorage.removeItem('aa_conv_id');
            localStorage.removeItem('aa_guest_name');
            localStorage.removeItem('aa_guest_email');
            return { success: false, messages: [], _stale: true };
        }
        if (!res.ok) {
            console.error('[Chat] GET', url, 'failed: HTTP', res.status);
            return { success: false, messages: [] };
        }
        return res.json().catch(function() {
            return { success: false, messages: [] };
        });
    }).catch(function(e) {
        console.warn('[Chat] poll error:', e);
        return { success: false, messages: [] };
    });
}

/* â”€â”€ Bubbles â”€â”€ */
function addBubble(text, isMe, senderName, timeStr, isSys) {
    var row = document.createElement('div');
    if (isSys) {
        row.className = 'cw-msg-row';
        row.innerHTML = '<div class="cw-msg-body" style="width:100%;align-items:center">'
            + '<div class="cw-bubble system">â€” ' + esc(text) + ' â€”</div></div>';
    } else {
        row.className = 'cw-msg-row' + (isMe ? ' mine' : '');
        var myName = USER_IS_AUTH ? USER_NAME : (localStorage.getItem('aa_guest_name') || 'You');
        var avName = isMe ? myName : (senderName || 'Support');
        var avBg   = isMe ? '1a1a1a&color=fff' : '4A90E2&color=fff';
        row.innerHTML = '<div class="av"><img src="https://ui-avatars.com/api/?name='
            + encodeURIComponent(avName) + '&background=' + avBg + '&size=64" alt=""></div>'
            + '<div class="cw-msg-body">'
            + '<div class="cw-bubble">' + esc(text).replace(/\n/g,'<br>') + '</div>'
            + '<span class="cw-time">' + (timeStr || nowTime()) + '</span>'
            + '</div>';
    }
    cwMsgs.appendChild(row);
    scrollB();
}

function addErrorBubble(msg) {
    var row = document.createElement('div');
    row.className = 'cw-msg-row';
    row.innerHTML = '<div class="cw-msg-body" style="width:100%">'
        + '<div class="cw-bubble error-bub">âš ï¸ ' + esc(msg) + '</div></div>';
    cwMsgs.appendChild(row);
    scrollB();
}

/* â”€â”€ Send flow â”€â”€ */
function handleSend(text, file) {
    text = (text || '').trim();
    if (!text && !file) return;
    cwInput.value = '';

    /* Remove quick-reply buttons after first message */
    if (cwQuick && cwQuick.parentNode) cwQuick.remove();

    function proceed(name, email) {
        addBubble(text || 'ğŸ“ File', true, name, nowTime());
        cwSend.disabled = true;
        if (!convId) {
            createConv(text, file, name, email || '');
        } else {
            postMsg(text, file);
        }
    }

    if (USER_IS_AUTH) {
        proceed(USER_NAME, '');
    } else {
        var saved = localStorage.getItem('aa_guest_name');
        if (saved) {
            proceed(saved, localStorage.getItem('aa_guest_email') || '');
        } else {
            pendingMsg  = text;
            pendingFile = file || null;
            showScreen(screenGuest);
            setTimeout(function(){ guestName.focus(); }, 100);
        }
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIX 6 â€” createConv: Use URLS.startChat (Django-resolved).
   No more fragile string replacement.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function createConv(text, file, name, email) {
    apiPost(URLS.startChat, {
        subject:      'Website Inquiry',
        message:      text || '',
        guest_name:   name,
        guest_email:  email,
    }, file)
    .then(function(d) {
        if (d && d.success && d.conversation_id) {
            convId = d.conversation_id;
            localStorage.setItem('aa_conv_id', convId);
            lastId = 0;
            startPoll();
            console.log('[Chat] Conversation started:', convId);
        } else {
            console.error('[Chat] start_chat bad response:', d);
            addErrorBubble('Could not start chat session. Please try again.');
            cwSend.disabled = false;
        }
    })
    .catch(function(e) {
        console.error('[Chat] createConv failed:', e);
        addErrorBubble(e.message || 'Connection error. Please check your network.');
        cwSend.disabled = false;
    });
}

 
function postMsg(text, file) {
    /* URLS.sendMessage is a template string like:
       "/en/chat/conversation/__CONV_ID__/send/"
       We replace the placeholder with the real conv id. */
    var url = URLS.sendMessage.replace('__CONV_ID__', convId);
    apiPost(url, { message: text || '' }, file)
    .then(function(d) {
        if (d && d.success) {
            lastId = Math.max(lastId, d.message.id);
        } else {
            console.error('[Chat] send_message bad response:', d);
            addErrorBubble(d && d.error ? d.error : 'Message failed. Please try again.');
        }
    })
    .catch(function(e) {
        console.error('[Chat] postMsg failed:', e);
        addErrorBubble(e.message || 'Message not sent â€” please try again.');
    })
    .finally(function() { cwSend.disabled = false; });
}

/* â”€â”€ Guest form â”€â”€ */
guestSubmit.addEventListener('click', function() {
    var nm = guestName.value.trim();
    var em = guestEmail.value.trim();
    if (!nm) { guestErr.textContent = 'Please enter your name.'; return; }
    guestErr.textContent = '';
    localStorage.setItem('aa_guest_name',  nm);
    localStorage.setItem('aa_guest_email', em);

    showScreen(screenChat);
    cwSend.disabled = true;
    var msg = pendingMsg || 'Hello, I need some help.';
    addBubble(msg, true, nm, nowTime());
    createConv(msg, pendingFile, nm, em);
    pendingMsg = ''; pendingFile = null;
    cwInput.focus();
});
guestName.addEventListener('keydown',  function(e){ if (e.key === 'Enter') guestEmail.focus(); });
guestEmail.addEventListener('keydown', function(e){ if (e.key === 'Enter') guestSubmit.click(); });

function showScreen(el) {
    [screenChat, screenGuest].forEach(function(s){ s.classList.toggle('hidden', s !== el); });
}

/* â”€â”€ Poll for staff replies â”€â”€ */
function startPoll() {
    if (pollTimer || !convId) return;
    pollTimer = setInterval(function() {
        var url = URLS.getMessages
            .replace('__CONV_ID__', convId)
            .replace('__LAST_ID__', lastId);
        apiGet(url).then(function(d) {
            if (!d.success || !d.messages || !d.messages.length) return;
            d.messages.forEach(function(m) {
                if (m.id <= lastId) return;
                lastId = m.id;
                if (!m.is_from_customer) {
                    addBubble(m.message, false, m.sender_name, m.created_at,
                              m.message_type === 'system');
                    if (!isOpen) showBadge();
                }
            });
        });
    }, 3000);
}

/* â”€â”€ Events â”€â”€ */
cwSend.addEventListener('click', function(){ handleSend(cwInput.value); });
cwInput.addEventListener('keypress', function(e){
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(cwInput.value); }
});
cwAtt.addEventListener('click', function(){ cwFile.click(); });
cwFile.addEventListener('change', function(){
    if (cwFile.files[0]) { handleSend('', cwFile.files[0]); cwFile.value = ''; }
});
document.querySelectorAll('.cw-qbtn').forEach(function(b){
    b.addEventListener('click', function(){ handleSend(b.dataset.msg); });
});

/* â”€â”€ Restore history for returning visitors â”€â”€ */
if (convId) {
    var histUrl = URLS.getMessages
        .replace('__CONV_ID__', convId)
        .replace('__LAST_ID__', '0');
    apiGet(histUrl).then(function(d) {
        if (d._stale) return; // conversation was deleted, already cleared
        if (d.success && d.messages && d.messages.length) {
            d.messages.forEach(function(m) {
                lastId = Math.max(lastId, m.id);
                addBubble(m.message, m.is_from_customer, m.sender_name,
                          m.created_at, m.message_type === 'system');
            });
        }
        startPoll();
    }).catch(function(){ startPoll(); });
}

/* â”€â”€ Show notification badge after 6s if chat is closed â”€â”€ */
setTimeout(function(){ if (!isOpen) showBadge(); }, 6000);

}());
</script>

 
<script>
window.CHAT_URLS = {
    startChat:   "{% url 'chat:start_chat' %}",
    sendMessage: "{% url 'chat:send_message' conversation_id='__CONV_ID__' %}",
    getMessages: "{% url 'chat:get_messages' conversation_id='__CONV_ID__' %}?last_message_id=__LAST_ID__",
};
</script>