{% load static %}
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     AL AMEEN OPTICS ‚Äî CHAT WIDGET
     Drop anywhere inside <body> on any page.
     No base.html needed. Self-contained.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<style>
.chat-widget-wrap {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 9999;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* ‚îÄ‚îÄ LAUNCHER BUTTON ‚îÄ‚îÄ */
.chat-launch-btn {
    width: 62px; height: 62px; border-radius: 50%;
    background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
    border: none; cursor: pointer;
    box-shadow: 0 4px 20px rgba(0,0,0,.35);
    display: flex; align-items: center; justify-content: center;
    position: relative;
    transition: all .3s cubic-bezier(.34,1.56,.64,1);
}
.chat-launch-btn:hover  { transform: scale(1.1); box-shadow: 0 6px 30px rgba(0,0,0,.45); }
.chat-launch-btn:active { transform: scale(.95); }
.chat-launch-btn .ico-chat,
.chat-launch-btn .ico-close { width: 28px; height: 28px; color: #fff; transition: all .3s; }
.chat-launch-btn .ico-close { display: none; position: absolute; }
.chat-launch-btn.open .ico-chat  { display: none; }
.chat-launch-btn.open .ico-close { display: block; }
.chat-notif-badge {
    position: absolute; top: -4px; right: -4px;
    background: #ff3b30; color: #fff;
    width: 22px; height: 22px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; border: 2px solid #fff;
    animation: pulse-badge 2s infinite;
}
@keyframes pulse-badge { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }
.chat-launch-btn.has-notif { animation: pulse-btn 2s infinite; }
@keyframes pulse-btn { 0%{box-shadow:0 0 0 0 rgba(26,26,26,.7)} 70%{box-shadow:0 0 0 10px rgba(26,26,26,0)} 100%{box-shadow:0 0 0 0 rgba(26,26,26,0)} }

/* ‚îÄ‚îÄ CHAT WINDOW ‚îÄ‚îÄ */
.chat-window {
    position: absolute; bottom: 78px; right: 0;
    width: 380px; max-width: calc(100vw - 40px);
    height: 600px; max-height: calc(100vh - 120px);
    background: #fff; border-radius: 18px;
    box-shadow: 0 12px 50px rgba(0,0,0,.22);
    display: flex; flex-direction: column;
    overflow: hidden;
    opacity: 0; transform: translateY(20px) scale(.95); visibility: hidden;
    transition: all .3s cubic-bezier(.34,1.56,.64,1);
}
.chat-window.open {
    opacity: 1; transform: translateY(0) scale(1); visibility: visible;
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.cw-header {
    background: linear-gradient(135deg, #1a1a1a 0%, #2c2c2c 100%);
    padding: 18px 20px;
    display: flex; align-items: center; gap: 12px;
    flex-shrink: 0;
}
.cw-av {
    position: relative; width: 42px; height: 42px; flex-shrink: 0;
}
.cw-av img { width: 100%; height: 100%; border-radius: 50%; border: 2px solid rgba(255,255,255,.2); }
.cw-av .online-dot {
    position: absolute; bottom: 0; right: 0;
    width: 13px; height: 13px; border-radius: 50%;
    background: #4caf50; border: 2px solid #1a1a1a;
    animation: pulse-dot 2s infinite;
}
@keyframes pulse-dot { 0%,100%{box-shadow:0 0 0 0 rgba(76,175,80,.7)} 50%{box-shadow:0 0 0 4px rgba(76,175,80,0)} }
.cw-info { flex: 1; min-width: 0; }
.cw-info h4 { font-size: 15px; font-weight: 700; color: #fff; margin: 0 0 3px; }
.cw-info p  { font-size: 12px; color: rgba(255,255,255,.75); margin: 0; display: flex; align-items: center; gap: 5px; }
.cw-info p span { width: 6px; height: 6px; border-radius: 50%; background: #4caf50; animation: blink 1.5s infinite; display: inline-block; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }
.cw-min-btn {
    background: rgba(255,255,255,.1); border: none;
    width: 32px; height: 32px; border-radius: 8px;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: background .2s; flex-shrink: 0;
}
.cw-min-btn:hover { background: rgba(255,255,255,.2); }
.cw-min-btn svg { width: 20px; height: 20px; color: #fff; }

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.cw-screen { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.cw-screen.hidden { display: none; }

/* ‚îÄ‚îÄ MESSAGES AREA ‚îÄ‚îÄ */
.cw-msgs {
    flex: 1; overflow-y: auto; padding: 18px 16px;
    background: #f8f9fa; display: flex; flex-direction: column; gap: 14px;
}
.cw-msgs::-webkit-scrollbar { width: 5px; }
.cw-msgs::-webkit-scrollbar-thumb { background: #ddd; border-radius: 5px; }

/* message rows */
.cw-msg-row { display: flex; gap: 10px; animation: msg-in .25s ease both; }
@keyframes msg-in { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
.cw-msg-row.mine { flex-direction: row-reverse; }
.cw-msg-row .av { width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0; }
.cw-msg-row .av img { width: 100%; height: 100%; border-radius: 50%; }
.cw-msg-body { display: flex; flex-direction: column; gap: 3px; max-width: 82%; }
.mine .cw-msg-body { align-items: flex-end; }
.cw-bubble {
    padding: 11px 14px; border-radius: 14px 14px 14px 4px;
    background: #fff; font-size: 13.5px; line-height: 1.55; color: #333;
    box-shadow: 0 1px 3px rgba(0,0,0,.06); word-break: break-word;
}
.mine .cw-bubble {
    background: linear-gradient(135deg, #1a1a1a 0%, #2c2c2c 100%);
    color: #fff; border-radius: 14px 14px 4px 14px;
}
.cw-bubble.system { background: none; font-size: 11px; color: #999; text-align: center; box-shadow: none; padding: 2px 0; }
.cw-time { font-size: 11px; color: #aaa; padding: 0 4px; }

/* quick options */
.cw-quick { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.cw-qbtn {
    background: #fff; border: 1.5px solid #e0e0e0;
    padding: 11px 10px; border-radius: 10px;
    font-size: 12.5px; font-weight: 600; color: #333;
    cursor: pointer; text-align: left; transition: all .2s;
}
.cw-qbtn:hover { border-color: #1a1a1a; background: #f8f9fa; transform: translateY(-2px); box-shadow: 0 2px 8px rgba(0,0,0,.1); }

/* typing dots */
.cw-typing { display: flex; align-items: center; gap: 4px; padding: 10px 16px; background: #f8f9fa; flex-shrink: 0; }
.cw-typing span { width: 8px; height: 8px; background: #bbb; border-radius: 50%; animation: typing 1.4s infinite; }
.cw-typing span:nth-child(2){animation-delay:.2s}
.cw-typing span:nth-child(3){animation-delay:.4s}
@keyframes typing { 0%,60%,100%{transform:translateY(0);opacity:.5} 30%{transform:translateY(-8px);opacity:1} }

/* ‚îÄ‚îÄ GUEST FORM SCREEN ‚îÄ‚îÄ */
.cw-gform {
    flex: 1; padding: 28px 20px; display: flex; flex-direction: column;
    gap: 12px; justify-content: center; background: #fff;
}
.cw-gform h3 { font-size: 17px; font-weight: 700; color: #1a1a1a; margin-bottom: 2px; }
.cw-gform p  { font-size: 13px; color: #777; line-height: 1.5; margin-bottom: 4px; }
.cw-ginput {
    width: 100%; padding: 12px 14px;
    background: #f8f9fa; border: 1.5px solid #e0e0e0;
    border-radius: 10px; font-size: 14px; color: #333;
    outline: none; transition: border-color .2s, box-shadow .2s;
    font-family: inherit;
}
.cw-ginput:focus { border-color: #1a1a1a; box-shadow: 0 0 0 3px rgba(26,26,26,.08); background: #fff; }
.cw-ginput::placeholder { color: #bbb; }
.cw-gsubmit {
    width: 100%; padding: 13px; margin-top: 4px;
    background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
    border: none; border-radius: 10px; color: #fff;
    font-size: 15px; font-weight: 600; font-family: inherit;
    cursor: pointer; transition: all .2s;
}
.cw-gsubmit:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,.25); }
.cw-gsubmit:active { transform: translateY(0); }
.cw-gerr { font-size: 12px; color: #e05c5c; min-height: 16px; }

/* ‚îÄ‚îÄ INPUT ZONE ‚îÄ‚îÄ */
.cw-input-zone { padding: 14px 16px; background: #fff; border-top: 1px solid #efefef; flex-shrink: 0; }
.cw-input-row {
    display: flex; align-items: center; gap: 8px;
    background: #f8f9fa; border: 1.5px solid #e0e0e0;
    border-radius: 26px; padding: 6px 8px 6px 14px;
    transition: all .2s;
}
.cw-input-row:focus-within { border-color: #1a1a1a; background: #fff; box-shadow: 0 0 0 3px rgba(26,26,26,.08); }
.cw-input-row input {
    flex: 1; border: none; background: transparent;
    font-size: 14px; color: #333; outline: none; font-family: inherit;
}
.cw-input-row input::placeholder { color: #bbb; }
.cw-att-btn, .cw-send-btn {
    background: none; border: none; cursor: pointer;
    width: 34px; height: 34px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; transition: all .2s;
}
.cw-att-btn:hover { background: rgba(0,0,0,.05); }
.cw-att-btn svg { width: 20px; height: 20px; color: #888; }
.cw-send-btn { background: #1a1a1a; }
.cw-send-btn:hover { background: #333; transform: scale(1.08); }
.cw-send-btn:active { transform: scale(.94); }
.cw-send-btn svg { width: 17px; height: 17px; color: #fff; }
input[type=file].cw-file { display: none; }

/* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
.cw-footer { padding: 10px; text-align: center; background: #f8f9fa; border-top: 1px solid #efefef; flex-shrink: 0; }
.cw-footer p { margin: 0; font-size: 11px; color: #bbb; }

@media(max-width:480px){
  .chat-window { width: calc(100vw - 40px); height: calc(100vh - 100px); }
  .cw-quick { grid-template-columns: 1fr; }
}
</style>

<div class="chat-widget-wrap" id="chatWrap">

  <!-- LAUNCHER -->
  <button class="chat-launch-btn" id="chatLaunchBtn" aria-label="Open Chat">
    <svg class="ico-chat" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
    </svg>
    <svg class="ico-close" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
    </svg>
    <span class="chat-notif-badge" id="chatBadge" style="display:none">1</span>
  </button>

  <!-- CHAT WINDOW -->
  <div class="chat-window" id="chatWindow">

    <!-- HEADER (same on all screens) -->
    <div class="cw-header">
      <div class="cw-av">
        <img src="https://ui-avatars.com/api/?name=Al+Ameen&background=1a1a1a&color=fff&size=84&bold=true" alt="Support">
        <span class="online-dot"></span>
      </div>
      <div class="cw-info">
        <h4>Al Ameen Support</h4>
        <p><span></span>
          {% if is_online %}Online ‚Äî we reply instantly{% else %}We'll reply soon{% endif %}
        </p>
      </div>
      <button class="cw-min-btn" id="chatMinBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </button>
    </div>

    <!-- SCREEN A: Welcome + messages (default) -->
    <div class="cw-screen" id="screenChat">
      <div class="cw-msgs" id="cwMsgs">
        <!-- Welcome bubble -->
        <div class="cw-msg-row">
          <div class="av"><img src="https://ui-avatars.com/api/?name=Support&background=4A90E2&color=fff&size=64" alt="Support"></div>
          <div class="cw-msg-body">
            <div class="cw-bubble">üëã Welcome to <strong>Al Ameen Optics</strong>!<br>How can we help you today?</div>
            <span class="cw-time">Just now</span>
          </div>
        </div>
        <!-- Quick options -->
        <div class="cw-quick" id="cwQuick">
          <button class="cw-qbtn" data-msg="I need help tracking my order">üì¶ Track Order</button>
          <button class="cw-qbtn" data-msg="I'd like to book an eye test">üëÅÔ∏è Book Eye Test</button>
          <button class="cw-qbtn" data-msg="I have a question about products">üõçÔ∏è Product Info</button>
          <button class="cw-qbtn" data-msg="I need help with my prescription">üìã Prescription Help</button>
        </div>
      </div>
      <div class="cw-typing hidden" id="cwTyping" style="display:none">
        <span></span><span></span><span></span>
      </div>
      <div class="cw-input-zone">
        <div class="cw-input-row">
          <button class="cw-att-btn" id="cwAttBtn" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
          </button>
          <input type="text" id="cwInput" placeholder="Type your message‚Ä¶" autocomplete="off">
          <button class="cw-send-btn" id="cwSendBtn" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
        <input type="file" class="cw-file" id="cwFile" accept="image/*,.pdf,.doc,.docx">
      </div>
      <div class="cw-footer"><p>Powered by Al Ameen Optics Support</p></div>
    </div>

    <!-- SCREEN B: Guest details form (only shown for non-logged-in users) -->
    <div class="cw-screen hidden" id="screenGuest">
      <div class="cw-gform">
        <h3>Almost there‚Ä¶</h3>
        <p>Just your name so our team knows who they're chatting with. Takes 5 seconds.</p>
        <input class="cw-ginput" id="guestName" type="text" placeholder="Your name *" autocomplete="name">
        <input class="cw-ginput" id="guestEmail" type="email" placeholder="Email address (optional)" autocomplete="email">
        <span class="cw-gerr" id="guestErr"></span>
        <button class="cw-gsubmit" id="guestSubmit">Start Chatting ‚Üí</button>
      </div>
      <div class="cw-footer"><p>Powered by Al Ameen Optics Support</p></div>
    </div>

  </div><!-- /chat-window -->
</div><!-- /wrap -->

<script>
(function(){
'use strict';

/* ‚îÄ‚îÄ Django injects these via template ‚îÄ‚îÄ */
const USER_IS_AUTH = {{ request.user.is_authenticated|yesno:"true,false" }};
const USER_NAME    = "{{ request.user.get_full_name|default:request.user.username|default:'' }}";

/* ‚îÄ‚îÄ DOM ‚îÄ‚îÄ */
const launchBtn  = document.getElementById('chatLaunchBtn');
const chatWindow = document.getElementById('chatWindow');
const minBtn     = document.getElementById('chatMinBtn');
const badge      = document.getElementById('chatBadge');

const screenChat  = document.getElementById('screenChat');
const screenGuest = document.getElementById('screenGuest');

const cwMsgs  = document.getElementById('cwMsgs');
const cwInput = document.getElementById('cwInput');
const cwSend  = document.getElementById('cwSendBtn');
const cwAtt   = document.getElementById('cwAttBtn');
const cwFile  = document.getElementById('cwFile');
const cwQuick = document.getElementById('cwQuick');

const guestName   = document.getElementById('guestName');
const guestEmail  = document.getElementById('guestEmail');
const guestErr    = document.getElementById('guestErr');
const guestSubmit = document.getElementById('guestSubmit');

/* ‚îÄ‚îÄ STATE ‚îÄ‚îÄ */
let isOpen  = false;
let convId  = localStorage.getItem('aa_conv_id') || null;
let lastId  = 0;
let timer   = null;
let pendingMsg  = '';
let pendingFile = null;

/* ‚îÄ‚îÄ CSRF ‚îÄ‚îÄ */
const csrf = () => (document.cookie.match(/csrftoken=([^;]+)/) || [])[1] || '';

/* ‚îÄ‚îÄ TOGGLE ‚îÄ‚îÄ */
function toggle() {
  isOpen = !isOpen;
  chatWindow.classList.toggle('open', isOpen);
  launchBtn.classList.toggle('open', isOpen);
  if (isOpen) {
    hideBadge();
    launchBtn.classList.remove('has-notif');
    if (convId && !timer) startPoll();
    else cwInput.focus();
  } else {
    clearInterval(timer); timer = null;
  }
}
launchBtn.addEventListener('click', toggle);
minBtn.addEventListener('click', toggle);

/* ‚îÄ‚îÄ BADGE ‚îÄ‚îÄ */
function showBadge() { badge.style.display = 'flex'; launchBtn.classList.add('has-notif'); }
function hideBadge() { badge.style.display = 'none'; }

/* ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ */
const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const now = () => new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
const scrollB = () => setTimeout(() => { cwMsgs.scrollTop = cwMsgs.scrollHeight; }, 60);

/* ‚îÄ‚îÄ BUILD BUBBLE ‚îÄ‚îÄ */
function addBubble(text, isMe, senderName, timeStr, isSys) {
  const row = document.createElement('div');
  if (isSys) {
    row.className = 'cw-msg-row';
    row.innerHTML = `<div class="cw-msg-body" style="width:100%;align-items:center"><div class="cw-bubble system">‚Äî ${esc(text)} ‚Äî</div></div>`;
  } else {
    row.className = 'cw-msg-row' + (isMe ? ' mine' : '');
    const avSrc = isMe
      ? `https://ui-avatars.com/api/?name=${encodeURIComponent(USER_IS_AUTH ? USER_NAME : (localStorage.getItem('aa_guest_name')||'G'))}&background=1a1a1a&color=fff&size=64`
      : `https://ui-avatars.com/api/?name=${encodeURIComponent(senderName||'Support')}&background=4A90E2&color=fff&size=64`;
    row.innerHTML = `
      <div class="av"><img src="${avSrc}" alt="${esc(senderName||'')}"></div>
      <div class="cw-msg-body">
        <div class="cw-bubble">${esc(text).replace(/\n/g,'<br>')}</div>
        <span class="cw-time">${timeStr || now()}</span>
      </div>`;
  }
  cwMsgs.appendChild(row);
  scrollB();
}

/* ‚îÄ‚îÄ SEND FLOW ‚îÄ‚îÄ */
function handleSend(text, file) {
  text = (text || '').trim();
  if (!text && !file) return;
  cwInput.value = '';
  if (cwQuick) cwQuick.remove();

  if (!convId) {
    // Need to create conversation first
    if (USER_IS_AUTH) {
      // Logged in ‚Äî create immediately
      addBubble(text || 'üìé', true, USER_NAME, now());
      createConv(text, file, USER_NAME, '');
    } else {
      // Guest ‚Äî check if we already have their name stored
      const savedName = localStorage.getItem('aa_guest_name');
      if (savedName) {
        addBubble(text || 'üìé', true, savedName, now());
        createConv(text, file, savedName, localStorage.getItem('aa_guest_email') || '');
      } else {
        // Show guest form, remember what they typed
        pendingMsg  = text;
        pendingFile = file || null;
        showScreen(screenGuest);
        guestName.focus();
      }
    }
  } else {
    // Conversation exists ‚Äî just send
    addBubble(text || 'üìé', true, USER_IS_AUTH ? USER_NAME : (localStorage.getItem('aa_guest_name')||'You'), now());
    postMsg(text, file);
  }
}

/* ‚îÄ‚îÄ CREATE CONVERSATION ‚îÄ‚îÄ */
function createConv(text, file, name, email) {
  const fd = new FormData();
  fd.append('subject', 'Website Inquiry');
  if (text) fd.append('message', text);
  if (file) fd.append('attachment', file);
  fd.append('guest_name',  name);
  fd.append('guest_email', email);
  fd.append('csrfmiddlewaretoken', csrf());

  fetch('/chat/start/', {
    method: 'POST',
    headers: {'X-Requested-With':'XMLHttpRequest'},
    body: fd
  })
  .then(r => r.json())
  .then(d => {
    if (d.success) {
      convId = d.conversation_id;
      localStorage.setItem('aa_conv_id', convId);
      startPoll();
    }
  })
  .catch(console.error);
}

/* ‚îÄ‚îÄ POST MESSAGE ‚îÄ‚îÄ */
function postMsg(text, file) {
  const fd = new FormData();
  if (text) fd.append('message', text);
  if (file) fd.append('attachment', file);
  fd.append('csrfmiddlewaretoken', csrf());

  fetch(`/chat/conversation/${convId}/send/`, {
    method: 'POST',
    headers: {'X-Requested-With':'XMLHttpRequest'},
    body: fd
  })
  .then(r => r.json())
  .then(d => { if (d.success) lastId = Math.max(lastId, d.message.id); })
  .catch(console.error);
}

/* ‚îÄ‚îÄ GUEST FORM ‚îÄ‚îÄ */
guestSubmit.addEventListener('click', () => {
  const nm = guestName.value.trim();
  const em = guestEmail.value.trim();
  if (!nm) { guestErr.textContent = 'Please enter your name.'; return; }
  guestErr.textContent = '';
  localStorage.setItem('aa_guest_name',  nm);
  localStorage.setItem('aa_guest_email', em);

  showScreen(screenChat);
  const msg = pendingMsg || 'Hello, I need some help.';
  addBubble(msg, true, nm, now());
  createConv(msg, pendingFile, nm, em);
  pendingMsg = ''; pendingFile = null;
});
guestName.addEventListener('keydown',  e => { if (e.key === 'Enter') guestEmail.focus(); });
guestEmail.addEventListener('keydown', e => { if (e.key === 'Enter') guestSubmit.click(); });

/* ‚îÄ‚îÄ SCREEN SWITCH ‚îÄ‚îÄ */
function showScreen(el) {
  [screenChat, screenGuest].forEach(s => s.classList.toggle('hidden', s !== el));
}

/* ‚îÄ‚îÄ POLL ‚îÄ‚îÄ */
function startPoll() {
  if (timer) return;
  timer = setInterval(() => {
    if (!convId) return;
    fetch(`/chat/conversation/${convId}/messages/?last_message_id=${lastId}`, {
      headers: {'X-Requested-With':'XMLHttpRequest'}
    })
    .then(r => r.json())
    .then(d => {
      if (!d.success || !d.messages.length) return;
      d.messages.forEach(m => {
        if (m.id <= lastId) return;
        lastId = m.id;
        if (!m.is_from_customer) {
          addBubble(m.message, false, m.sender_name, m.created_at, m.message_type === 'system');
          if (!isOpen) showBadge();
        }
      });
    })
    .catch(() => {});
  }, 3000);
}

/* ‚îÄ‚îÄ EVENTS ‚îÄ‚îÄ */
cwSend.addEventListener('click', () => handleSend(cwInput.value));
cwInput.addEventListener('keypress', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(cwInput.value); }
});
cwAtt.addEventListener('click', () => cwFile.click());
cwFile.addEventListener('change', () => {
  if (cwFile.files[0]) handleSend('', cwFile.files[0]);
});
document.querySelectorAll('.cw-qbtn').forEach(b => {
  b.addEventListener('click', () => handleSend(b.dataset.msg));
});

/* ‚îÄ‚îÄ RESTORE returning visitor ‚îÄ‚îÄ */
if (convId) startPoll();

/* ‚îÄ‚îÄ Show badge after 6s if window closed ‚îÄ‚îÄ */
setTimeout(() => { if (!isOpen) showBadge(); }, 6000);

}());
</script>